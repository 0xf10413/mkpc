<!DOCTYPE html>

<html>

<head>
	<title>vanilla-picker</title>
	<style type="text/css">
	#ctn > * {
		position: absolute;
		left: 0;
		top: 0;
	}
	canvas {
		opacity: 1;/*0.2;*/
	}
	#cursors {
		position: absolute;
		left: 150px;
		top: 10px;
	}
	</style>
	<script type="text/javascript" src="mk/maps.js"></script>
</head>

<body>
	<div id="ctn">
		<img id="model" alt="Map" style="display:none" />
		<canvas width="128" height="52" id="canvas"></canvas>
	</div>
	<div id="cursors">
		x0 : <input type="range" name="x0" id="x0" min="-200" max="100" step="1" value="-150" onchange="redrawCanvas()" /><br />
		x1 : <input type="range" name="x1" id="x1" min="-50" max="50" step="1" value="-10" onchange="redrawCanvas()" /><br />
		y0 : <input type="range" name="y0" id="y0" min="-200" max="-100" step="1" value="-130" onchange="redrawCanvas()" /><br />
		y1 : <input type="range" name="y1" id="y1" min="-50" max="50" step="1" value="5" onchange="redrawCanvas()" />
	</div>
	<script>
	var strMap = "map41";
	document.getElementById("model").src = "images/selectors/select_"+strMap+".png";
	var oMaps = listMaps();
	var oMap = oMaps[strMap];
	var canvas = document.getElementById("canvas");
	var canvasW = canvas.width;
	var canvasH = canvas.height;
	var ctx = canvas.getContext("2d");
	ctx.fillStyle = "rgb("+ oMap.bgcolor +")";
	var oMapImg = document.createElement("img");
	oMapImg.src = "images/maps/"+strMap+"."+(oMap.ext||"png");
	function redrawCanvas() {
		ctx.fillRect(0,0,canvasW,canvasH);
		var imgW = oMapImg.naturalWidth;
		var imgH = oMapImg.naturalHeight;
		if (!oMap.w) oMap.w = 512;
		if (!oMap.h) oMap.h = 512;
		if (imgW != oMap.w || imgH != oMap.h) {
			alert("Fail!");
			return;
		}
		if (!oMap.iW) oMap.iW = imgW;
		if (!oMap.iH) oMap.iH = imgH;
		//var x0 = -163, x1 = -42;
		//var y0 = -154, y1 = 16;
		var x0 = -150, x1 = -10, y0 = -130, y1 = 5;
		x0 = +document.getElementById("x0").value;
		x1 = +document.getElementById("x1").value;
		y0 = +document.getElementById("y0").value;
		y1 = +document.getElementById("y1").value;
		y1 += oMap.iH;
		var y = y0;
		var a = (canvasW-2*x0+2*y0*(x1-x0)/(y1-y0));
		var b = -2*(x1-x0)/(y1-y0);
		var c = y0+a/b;
		var y0_ = -a/b;
		var y1_ = (oMap.h-oMap.iH)/2;
		var x0_ = x0+(oMap.w-oMap.iW)/2;
		var l = Math.log((y1 + a/b)/c)/(b*canvasH);
		for (var i=0;i<canvasH;i++) {
			var x = x0_ + (y-y0)*(x1-x0)/(y1-y0);
			var y = y0_ + c*Math.exp(b*l*i);
			var y_ = y0_ + c*Math.exp(b*l*(i+1));
			var dy = y_-y;
			ctx.drawImage(oMapImg, x,y+y1_,oMap.w-2*x,dy, 0,i,canvasW,1);
			//y += dy;
		}
	}
	oMapImg.onload = function() {
		redrawCanvas();
	};
	var x = 1;
	function cycle() {
		canvas.style.opacity = x;
		x = 1-x;
	}
	//setInterval(cycle, 500);
	</script>
</body>

</html>