var pause,chatting=!1,aPlayers=new Array,aPlaces=new Array,aScores=new Array,aTeams=new Array,aPseudos=new Array,fInfos,formulaire,baseCp,customDecorData={},nBasePersos,customPersos,selectedDifficulty,updateCtnFullScreen,isFirstLoad=!0,edittingCircuit,noDS,cupOpts,bListMaps;void 0===edittingCircuit&&(edittingCircuit=!1),void 0===noDS&&(noDS=!1),void 0===cupOpts&&(cupOpts={}),noDS&&(bListMaps=listMaps,listMaps=function(){NBCIRCUITS=40;for(var e=bListMaps(),t={},a=1;a<=NBCIRCUITS;a++)t["map"+a]=e["map"+a];return t});var isOnline="OL"==page,isMCups=isCup&&4<NBCIRCUITS,clRuleVars={},clGlobalVars,selectPerso,selectedTeams,challenges,clRewards,cupNames,challengesForCircuit;function xhr(t,a,n,o){var i;if(o=o||1e3,window.XMLHttpRequest||window.ActiveXObject)if(window.ActiveXObject)try{i=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){i=new ActiveXObject("Microsoft.XMLHTTP")}else i=new XMLHttpRequest;i.open("POST",t,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.setRequestHeader("If-Modified-Since","Wed, 15 Nov 1995 00:00:00 GMT");try{i.onload=function(){200==i.status?n(i.responseText)||setTimeout(function(){xhr(t,a,n,2*o)},o):i.onerror()},i.onerror=function(){setTimeout(function(){xhr(t,a,n,2*o)},o)}}catch(e){i.onreadystatechange=function(){4!=i.readyState||n(i.responseText)||setTimeout(function(){xhr(t,a,n,2*o)},o)}}i.send(a)}function MarioKart(){var oMaps=listMaps(),aAvailableMaps=new Array;for(circuits in void 0===Array.isArray&&(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),oMaps){aAvailableMaps.push(circuits);var oMap=oMaps[circuits];oMap.w||(oMap.w=512),oMap.h||(oMap.h=512),oMap.tours||(oMap.tours=3),isCup||oMap.ext||(oMap.ext="png"),oMap.ref=+circuits.replace("map",""),oMap.aipoints&&oMap.aipoints[0]&&oMap.aipoints[0].length&&!Array.isArray(oMap.aipoints[0][0])&&(oMap.aipoints=[oMap.aipoints]),oMap.horspistes||(oMap.horspistes={},oMap.horspiste&&(oMap.horspistes.herbe=oMap.horspiste,delete oMap.horspiste))}var iWidth=80,iHeight=39,iRendering=optionOf("quality"),iQuality,iSmooth;resetQuality();var bMusic=!!optionOf("music"),iSfx=!!optionOf("sfx"),gameMenu,primaryColor="#FEFF3F",refreshDatas=isOnline,finishing=!1,destructions=new Array,nbNews=new Array,connecte=1;for(i=0;i<6;i++)destructions.push(new Array);var aIDs=new Array,tnCourse=0,identifiant;"undefined"!=typeof mId&&(identifiant=mId),"undefined"==typeof cShared&&(cShared="AR"==page&&0<nid),"undefined"!=typeof shareLink&&shareLink.options&&shareLink.options.team&&(selectedTeams=1);var myCircuit=null!=document.getElementById("changeRace");function setQuality(e){iRendering=e,resetQuality(),bRunning&&resetScreen(),xhr("changeParam.php","param=0&value="+e,function(e){return 1==e})}function resetQuality(){iSmooth=5==iRendering?!(iQuality=1):(iQuality=iRendering,!0)}function openFullscreen(e){return e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():void 0}var $mkScreen=document.getElementById("mariokartcontainer");$mkScreen.dataset||($mkScreen.dataset={}),updateCtnFullScreen=function(e){if($mkScreen.dataset.fs=e?1:"",e){var t=Math.min(screen.width/(iWidth*iScreenScale),screen.height/(iHeight*iScreenScale)),a=Math.round(100*t),n=$mkScreen.scrollWidth,o=$mkScreen.style.zoom;if($mkScreen.style.zoom=a+"%",n!=$mkScreen.scrollWidth||o==$mkScreen.style.zoom||100==a){for(var i=0;i<oContainers.length;i++)oContainers[i].style.left=Math.round((screen.width/t-iScreenScale*iWidth)/2+i*(iWidth*iScreenScale+2))+"px",oContainers[i].style.top=Math.round((screen.height/t-iScreenScale*iHeight)/2)+"px";updateHudFullScreen()}else if($mkScreen.style.zoom="",!formulaire||!formulaire.screenscale.disabled){var r=window.innerWidth-20,l=window.innerHeight-20,t=Math.round(Math.min(r/iWidth,l/iHeight));$mkScreen.dataset.fakefs=1;for(i=0;i<oContainers.length;i++)oContainers[i].style.left=Math.round((window.innerWidth-t*iWidth)/2+i*(iWidth*iScreenScale+2))+"px",oContainers[i].style.top=Math.round((window.innerHeight-t*iHeight)/2)+"px";updateHudFullScreen(),$mkScreen.dataset.lastsc||($mkScreen.dataset.lastsc=iScreenScale),setScreenScale(t,!0),window.nsevent||(window.nsevent=function(e){27==e.keyCode&&(e.preventDefault(),updateCtnFullScreen(!1))},window.addEventListener("keydown",window.nsevent))}$mkScreen.className="fullscreen"}else{if($mkScreen.dataset.fakefs&&formulaire&&formulaire.screenscale.disabled)return;$mkScreen.style.zoom="",$mkScreen.className="",$mkScreen.dataset.fakefs&&(setScreenScale(+$mkScreen.dataset.lastsc,!0),$mkScreen.dataset.lastsc="",$mkScreen.dataset.fakefs="",window.nsevent&&(window.removeEventListener("keydown",window.nsevent),delete window.nsevent));for(i=0;i<oContainers.length;i++)oContainers[i].style.left=10+i*(iWidth*iScreenScale+2)+"px",oContainers[i].style.top="";updateHudFullScreen()}};var hudScreens=new Array,oMusicHandler,muteOnBlur,unmuteOnResume,objets;function updateHudFullScreen(){for(var e=0;e<hudScreens.length;e++)hudScreens[e].style.left=oContainers[e].style.left,hudScreens[e].style.top=oContainers[e].style.top}function removeHUD(){for(var e=0;e<hudScreens.length;e++)$mkScreen.removeChild(hudScreens[e]);hudScreens.length=0}function setScreenScale(e,t){if(e!==iScreenScale){var a=iScreenScale;if(-1!=e){iScreenScale=e,t||xhr("changeParam.php","param=1&value="+e,function(e){return 1==e}),bRunning&&resetScreen();for(var n=0;n<oContainers.length;n++){var o,i=oContainers[n].firstChild;i&&(i.aScreenScale||(i.aScreenScale=a),i.style.width=iWidth*iScreenScale+"px",i.style.height=iHeight*iScreenScale+"px",i.style.transformOrigin=i.style.WebkitTransformOrigin=i.style.MozTransformOrigin="top left",i.style.transform=i.style.WebkitTransform=i.style.MozTransform="scale("+iScreenScale/i.aScreenScale+")",(o=document.getElementById("fb-root"))&&(o.style.display="none"))}reposKeyboard(),setSRest()}else{formulaire.screenscale.value=a;var r=openFullscreen($mkScreen);r.then&&r.catch?r.then(function(){updateCtnFullScreen(!0),document.onfullscreenchange=function(){updateCtnFullScreen(document.fullscreenElement===$mkScreen)}}).catch(function(){updateCtnFullScreen(!0)}):updateCtnFullScreen(!0)}}}function reposKeyboard(){var e=4.8*virtualButtonW,t=2.6*virtualButtonH;document.getElementById("virtualkeyboard").style.width=Math.round(e)+"px",document.getElementById("virtualkeyboard").style.height=Math.round(t)+"px",document.getElementById("virtualkeyboard").style.left=(iScreenScale*iWidth-e)/2+"px",document.getElementById("virtualkeyboard").style.top=40*iScreenScale+"px"}function setMusic(e){bMusic=!!e,-1!=gameMenu&&updateMenuMusic(gameMenu,!0),xhr("changeParam.php","param=2&value="+e,function(e){return 1==e})}function setSfx(e){iSfx=!!e,xhr("changeParam.php","param=3&value="+e,function(e){return 1==e})}function removeMenuMusic(e){clearTimeout(oMusicHandler),oMusicEmbed&&document.body.contains(oMusicEmbed)&&(e?document.body.removeChild(oMusicEmbed):fadeOutMusic(oMusicEmbed,1,.8),oMusicEmbed=void 0),muteOnBlur&&(window.removeEventListener("blur",muteOnBlur),muteOnBlur=void 0),unmuteOnResume&&(window.removeEventListener("focus",unmuteOnResume),unmuteOnResume=void 0)}function removeIfExists(e){document.body.contains(e)&&document.body.removeChild(e),oMusicEmbed==e&&(oMusicEmbed=void 0)}function removeGameMusics(){if(bMusic||iSfx){for(var e=document.getElementsByClassName("gamemusic");e.length;)document.body.removeChild(e[0]);oMusicEmbed=void 0}}function clearResources(){oMapImg&&oMapImg.clear&&oMapImg.clear()}function pauseSounds(){if(bMusic||iSfx){clLocalVars.forcePause||(playSoundEffect("musics/events/pause.mp3").className="");for(var e=document.getElementsByClassName("gamemusic"),t=0;t<e.length;t++)muteSound(e[t])}}function unpauseSounds(){(bMusic||iSfx)&&(playSoundEffect("musics/events/pause.mp3").className="",setTimeout(function(){if(!pause)for(var e=document.getElementsByClassName("gamemusic"),t=0;t<e.length;t++)unmuteSound(e[t])},300))}function setMusicVolume(e,t){isOriginalEmbed(e)?e.volume=t:onPlayerReady(e,function(e){e.setVolume(Math.round(100*t))})}function fadeInMusic(e,t,a){e.fadingOut||(e.fadingIn=!0,(t/=a)<1?(setMusicVolume(e,t),e.fadingIn=!1,setTimeout(function(){fadeInMusic(e,t,a)},100)):setMusicVolume(e,1))}function fadeOutMusic(e,t,a,n){e.fadingIn||(e.fadingOut=!0,.2<(t*=a)?(setMusicVolume(e,t),setTimeout(function(){fadeOutMusic(e,t,a,n)},100)):(e.fadingOut=!1)===n?(pauseMusic(e),setMusicVolume(e,1)):-1!==n&&stopMusic(e))}function updateMenuMusic(e,t){var a;e==gameMenu&&!t||(gameMenu=e,removeMenuMusic(!bMusic),bMusic&&(playMusicSmoothly("musics/menu/"+(gameMenu?"selection-remix":"main-remix")+".mp3",t?0:void 0),gameMenu||loopAfterIntro(oMusicEmbed,60.15,54.9),a=oMusicEmbed,muteOnBlur=function(){oMusicEmbed==a&&(clearTimeout(oMusicHandler),a.pause())},window.addEventListener("blur",muteOnBlur),unmuteOnResume=function(){oMusicEmbed==a&&a.play()},window.addEventListener("focus",unmuteOnResume)))}function playMusicSmoothly(e,t){void 0===t&&(t=1e3),(oMusicEmbed=document.createElement("audio")).setAttribute("loop",!0),oMusicEmbed.style.position="absolute",oMusicEmbed.style.left="-1000px",oMusicEmbed.style.top="-1000px";var a=document.createElement("source");a.type="audio/mpeg",a.src=e,oMusicEmbed.appendChild(a),clearTimeout(oMusicHandler),t?oMusicHandler=setTimeout(function(){oMusicEmbed.play()},t):oMusicEmbed.setAttribute("autoplay",!0),document.body.appendChild(oMusicEmbed)}objets=isOnline&&isBattle?["fauxobjet","fauxobjet","fauxobjet","fauxobjet","banane","banane","banane","banane","banane","banane","banane","carapace","carapace","carapace","carapace","carapace","carapace","carapace","carapace","carapace","bobomb","bobomb","bobomb","bobomb","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapace","bobomb","bobomb","banane","carapace","carapace","carapace","carapace","carapace","banane","banane","fauxobjet","carapacerouge","carapacerouge","carapacerouge","banane","banane","banane","banane","banane","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacebleue","carapacebleue","carapacerouge","megachampi","megachampi","megachampi","megachampi","etoile","etoile","etoile","etoile","champi","champi","champi","champi"]:["fauxobjet","fauxobjet","fauxobjet","fauxobjet","banane","banane","banane","banane","banane","banane","banane","carapace","carapace","carapace","carapace","carapace","carapace","carapace","carapace","carapace","bobomb","bobomb","bobomb","bobomb","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapace","bobomb","bobomb","bobomb","bobomb","bobomb","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","bobomb","bobomb","bobomb","bobomb","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacerouge","carapacebleue","carapacebleue","carapacebleue","carapacerouge","carapacerouge","megachampi","megachampi","megachampi","megachampi","champi","champi","champi","champi","champi","champi","carapacebleue","megachampi","megachampi","megachampi","megachampi","megachampi","megachampi","megachampi","megachampi","megachampi","etoile","etoile","etoile","etoile","etoile","megachampi","megachampi","megachampi","megachampi","megachampi","megachampi","megachampi","etoile","etoile","etoile","etoile","etoile","etoile","billball","billball","megachampi","megachampi","etoile","etoile","etoile","etoile","etoile","billball","billball","billball","billball","billball","eclair","eclair","eclair"];var oBgLayers=new Array,oPlayers=new Array;if(!pause)for(joueurs in baseCp&&(cp=baseCp),baseCp={},customPersos={},nBasePersos=0,cp)aPlayers.push(joueurs),baseCp[joueurs]=cp[joueurs],nBasePersos++;var bananes=new Array,fauxobjets=new Array,carapaces=new Array,bobombs=new Array,carapacesRouge=new Array,carapacesBleue=new Array,strPlayer=new Array,oMap,iDificulty=5,iTeamPlay=selectedTeams,iRecord,iTrajet,jTrajets,iLapTimes,gPersos=new Array,gRecord,gSelectedPerso,gOverwriteRecord,oMapImg,oPlanDiv,oPlanDiv2,oPlanCtn,oPlanCtn2,oPlanImg,oPlanImg2,oPlanWidth,oPlanSize,oPlanRealSize,oCharWidth,oObjWidth,oCoinWidth,oExpWidth,oPlanWidth2,oPlanSize2,oCharWidth2,oObjWidth2,oCoinWidth2,oExpWidth2,oCharRatio,oPlanRatio;function resetGame(e){oMap=oMaps[e],loadMap()}pause&&(strPlayer=fInfos.player,oMap=oMaps["map"+fInfos.map],clSelected=fInfos.cl,"CM"!=course?iDificulty=fInfos.difficulty:(iTrajet=fInfos.my_route,gPersos=fInfos.perso,jTrajets=fInfos.cpu_route,gRecord=fInfos.my_record,gOverwriteRecord=fInfos.ow_record,2==gOverwriteRecord&&(gOverwriteRecord=1),iRecord=fInfos.record,iLapTimes=fInfos.lap_times,gSelectedPerso=fInfos.selPerso));var oPlanCharacters=new Array,oPlanObjects=new Array,oPlanCoins=new Array,oPlanDecor={},oPlanAssets={},oPlanFauxObjets=new Array,oPlanBananes=new Array,oPlanBobOmbs=new Array,oPlanCarapaces=new Array,oPlanCarapacesRouges=new Array,oPlanCarapacesBleues=new Array,oPlanEtoiles=new Array,oPlanBillballs=new Array,oPlanTeams=new Array,oPlanCharacters2=new Array,oPlanObjects2=new Array,oPlanCoins2=new Array,oPlanDecor2={},oPlanAssets2={},oPlanFauxObjets2=new Array,oPlanBananes2=new Array,oPlanBobOmbs2=new Array,oPlanCarapaces2=new Array,oPlanCarapacesRouges2=new Array,oPlanCarapacesBleues2=new Array,oPlanEtoiles2=new Array,oPlanBillballs2=new Array,oPlanTeams2=new Array,gameSettings,oChallengeCpts;function posImg(e,t,a,n,o,i){var r=-t/oPlanRealSize,l=-a/oPlanRealSize;return e.style.transform=e.style.WebkitTransform=e.style.MozTransform="translate("+-Math.round(i*r+o/2)+"px, "+-Math.round(i*l+o/2)+"px) rotate("+Math.round(180-n)+"deg)",e}function posImgRel(e,t,a,n,o,i,r,l){var s=-t/oPlanRealSize,c=-a/oPlanRealSize;return e.style.transform=e.style.WebkitTransform=e.style.MozTransform="translate("+(Math.round(r)-Math.round(i*s+o/2))+"px, "+(Math.round(l)-Math.round(i*c+o/2))+"px) rotate("+Math.round(180-n)+"deg)",e}function setPlanPos(){var p=oPlayers[0],e=Math.round(p.rotation-180),t=direction(1,e),a=direction(0,e);function c(e,t,a){var n=document.createElement("img");return n.src="images/map_icons/"+e+".png",n.style.position="absolute",n.style.width=t+"px",n.className="pixelated",a.appendChild(n),n}function h(e,t,a,n,o,i,r){var l;return posImg(e,t,a,p.rotation,n,o),0<=i&&e.team!=i&&(l=i?"red":"blue",e.team=i,e.style.background="radial-gradient(ellipse at center, "+l+" 0%,transparent "+r+"%)"),e}function m(e,t,a,n,o){if(e.length!=t.length){for(;e.length<t.length;)e.push(c(a,n,o));for(;e.length>t.length;)o.removeChild(e[0]),e.shift()}}var n=p.x/oPlanRealSize,o=p.y/oPlanRealSize;function i(e,t,a){for(var n in e)if(oMap[n]){if(e[n].length<oMap[n].length)for(var o=e[n].length;o<oMap[n].length;o++){var i=(s=oMap[n][o])[1][2]*a/oMap.w,r=s[1][3]*a/oMap.w,l=c(s[0].src,i,t);l.style.height=r+"px",l.style.transformOrigin=l.style.WebkitTransformOrigin=l.style.MozTransformOrigin=Math.round(100*s[2][0])+"% "+Math.round(100*s[2][1])+"%",e[n].push(l)}for(o=0;o<oMap[n].length;o++){var s,i=(s=oMap[n][o])[1][2]*a/oMap.w;posImg(e[n][o],s[1][0]+s[1][2]*(.5-s[2][0]),s[1][1]+s[1][2]/2-s[1][3]*s[2][1],Math.round(180*(Math.PI-s[2][2])/Math.PI),i,a)}}}function r(e,t,a){for(var n=0;n<aKarts.length;n++){var o,i,r,l,s,c=!0;aKarts[n].loose&&(isOnline||aKarts[n]==p?e[n].style.opacity=.25:(e[n].style.display="none",iTeamPlay&&t==oCharWidth&&(oPlanTeams[n].style.display="none",oPlanTeams2[n].style.display="none"),c=!1)),c&&(o=aKarts[n].billball?1.5:aKarts[n].size,i=Math.round(t*o),e[n].style.width=i+"px",posImg(e[n],aKarts[n].x,aKarts[n].y,aKarts[n].rotation-360*aKarts[n].tourne/21,i,a),iTeamPlay&&t==oCharWidth&&(r=Math.round(oCharWidth2*o),l=Math.round(oTeamWidth*o),s=Math.round(oTeamWidth2*o),posImgRel(oPlanTeams[n],aKarts[n].x,aKarts[n].y,Math.round(p.rotation),i,oPlanSize,(i-l)/2,(i-l)/2),oPlanTeams[n].style.width=l+"px",oPlanTeams[n].style.height=l+"px",posImgRel(oPlanTeams2[n],aKarts[n].x,aKarts[n].y,Math.round(p.rotation),r,oPlanSize2,(r-s)/2,(r-s)/2),oPlanTeams2[n].style.width=s+"px",oPlanTeams2[n].style.height=s+"px"))}}function l(e){for(var t=0;t<oMap.arme.length;t++)isNaN(oMap.arme[t][2])?e[t].style.display="block":e[t].style.display="none"}function s(e,t,a,n){if(e.length!=oMap.coins.length){m(e,oMap.coins,"coin",t,a);for(var o=0;o<e.length;o++)posImg(e[o],oMap.coins[o].x,oMap.coins[o].y,Math.round(p.rotation),t,n)}}function u(i,r,l,e){if(oMap.decor)for(var t in oMap.decor){var a=!i[t].length,n=decorBehaviors[t],s=getDecorExtra(n).custom;if(!n.hidden&&(oMap.decor[t].length!=i[t].length||n.movable)){var c=r;if(n.size_ratio&&(c*=n.size_ratio.w),m(i[t],oMap.decor[t],t,c,l),a&&s){for(var o=0;o<i[t].length;o++){i[t][o].src="images/map_icons/empty.png"}!function(n,o){getCustomDecorData(s,function(e){c=r*o.size_ratio.w;for(var t=0;t<i[n].length;t++){var a=i[n][t];a.src=e.map,a.style.width=c+"px"}m(i[n],oMap.decor[n],n,c,l)})}(t,n)}var p,u,d=n.rotatable;!d||(u=i[t][0])&&u.naturalWidth&&(p=Math.round(c*(u.naturalWidth-u.naturalHeight)/(2*u.naturalWidth)));for(o=0;o<oMap.decor[t].length;o++)d?posImgRel(i[t][o],oMap.decor[t][o][0],oMap.decor[t][o][1],Math.round(oMap.decor[t][o][4]),c,e,0,p):h(i[t][o],oMap.decor[t][o][0],oMap.decor[t][o][1],c,e)}}}oPlanCtn.style.transform=oPlanCtn.style.WebkitTransform=oPlanCtn.style.MozTransform="translate("+-Math.round(oPlanSize*(n*t-o*a)-oPlanWidth/2)+"px, "+-Math.round(oPlanSize*(n*a+o*t)-oPlanWidth/2)+"px) rotate("+e+"deg)",i(oPlanAssets,oPlanCtn,oPlanSize),i(oPlanAssets2,oPlanCtn2,oPlanSize2),r(oPlanCharacters,oCharWidth,oPlanSize),r(oPlanCharacters2,oCharWidth2,oPlanSize2),l(oPlanObjects),l(oPlanObjects2),oMap.coins&&(s(oPlanCoins,oCoinWidth,oPlanCtn,oPlanSize),s(oPlanCoins2,oCoinWidth2,oPlanCtn2,oPlanSize2)),u(oPlanDecor,oObjWidth,oPlanCtn,oPlanSize),u(oPlanDecor2,oObjWidth2,oPlanCtn2,oPlanSize2),m(oPlanFauxObjets,fauxobjets,"objet",oObjWidth,oPlanCtn),m(oPlanFauxObjets2,fauxobjets,"objet",oObjWidth2,oPlanCtn2);for(var d=0;d<fauxobjets.length;d++)h(oPlanFauxObjets[d],fauxobjets[d][3],fauxobjets[d][4],oObjWidth,oPlanSize,fauxobjets[d][2],200),h(oPlanFauxObjets2[d],fauxobjets[d][3],fauxobjets[d][4],oObjWidth2,oPlanSize2,fauxobjets[d][2],200),oPlanFauxObjets[d].style.zIndex=oPlanFauxObjets2[d].style.zIndex=2;m(oPlanBananes,bananes,"banane",oObjWidth,oPlanCtn),m(oPlanBananes2,bananes,"banane",oObjWidth2,oPlanCtn2);for(d=0;d<bananes.length;d++)h(oPlanBananes[d],bananes[d][3],bananes[d][4],oObjWidth,oPlanSize,bananes[d][2],100),h(oPlanBananes2[d],bananes[d][3],bananes[d][4],oObjWidth2,oPlanSize2,bananes[d][2],100),oPlanBananes[d].style.zIndex=oPlanBananes2[d].style.zIndex=2;function g(e,t){switch(t){case 0:e="explosionB";break;case 1:e="explosionR"}return"images/map_icons/"+e+".png"}function y(e,t,a,n,o){m(e,bobombs,"bob-omb",t,a);for(var i=0;i<bobombs.length;i++)bobombs[i][8]<=0?(posImg(e[i],bobombs[i][3],bobombs[i][4],Math.round(p.rotation),o,n).src=g("explosion",bobombs[i][2]),e[i].style.width=o+"px",e[i].style.opacity=Math.max(1+bobombs[i][8]/10,0),e[i].style.background=""):h(e[i],bobombs[i][3],bobombs[i][4],t,n,bobombs[i][2],100).style.zIndex=2}y(oPlanBobOmbs,oObjWidth,oPlanCtn,oPlanSize,oExpWidth),y(oPlanBobOmbs2,oObjWidth2,oPlanCtn2,oPlanSize2,oExpWidth2),m(oPlanCarapaces,carapaces,"carapace",oObjWidth,oPlanCtn),m(oPlanCarapaces2,carapaces,"carapace",oObjWidth2,oPlanCtn2);for(d=0;d<carapaces.length;d++){var f=h(oPlanCarapaces[d],carapaces[d][3],carapaces[d][4],oObjWidth,oPlanSize,carapaces[d][2],200),S=h(oPlanCarapaces2[d],carapaces[d][3],carapaces[d][4],oObjWidth2,oPlanSize2,carapaces[d][2],200),v=carapaces[d][7]<0;v&&!f.red?(f.red=1,f.src="images/map_icons/carapace-rouge.png",S.src="images/map_icons/carapace-rouge.png"):!v&&f.red&&(f.red=void 0,f.src="images/map_icons/carapace.png",S.src="images/map_icons/carapace.png"),S.style.zIndex=2}m(oPlanCarapacesRouges,carapacesRouge,"carapace-rouge",oObjWidth,oPlanCtn),m(oPlanCarapacesRouges2,carapacesRouge,"carapace-rouge",oObjWidth2,oPlanCtn2);for(d=0;d<carapacesRouge.length;d++)h(oPlanCarapacesRouges[d],carapacesRouge[d][3],carapacesRouge[d][4],oObjWidth,oPlanSize,carapacesRouge[d][2],200),h(oPlanCarapacesRouges2[d],carapacesRouge[d][3],carapacesRouge[d][4],oObjWidth2,oPlanSize2,carapacesRouge[d][2],200).style.zIndex=2,carapacesRouge[d][6]&&(oPlanCarapacesRouges[d].style.zIndex=2);function b(e,t,a,n,o){m(e,carapacesBleue,"carapace-bleue",t,o);for(var i=0;i<carapacesBleue.length;i++)carapacesBleue[i][6]<=0?(posImg(e[i],carapacesBleue[i][3],carapacesBleue[i][4],Math.round(p.rotation),n,a).src=g("explosionB",carapacesBleue[i][2]),e[i].style.width=n+"px",e[i].style.opacity=Math.max(1+carapacesBleue[i][6]/10,0),e[i].style.background=""):h(e[i],carapacesBleue[i][3],carapacesBleue[i][4],t,a,carapacesBleue[i][2],200).style.zIndex=2}b(oPlanCarapacesBleues,oObjWidth,oPlanSize,oExpWidth,oPlanCtn),b(oPlanCarapacesBleues2,oObjWidth2,oPlanSize2,oExpWidth2,oPlanCtn2);for(var M=new Array,C=new Array,d=0;d<aKarts.length;d++)aKarts[d].etoile?M.push(aKarts[d]):aKarts[d].billball&&C.push(aKarts[d]);m(oPlanEtoiles,M,"etoile",oObjWidth,oPlanCtn),m(oPlanEtoiles2,M,"etoile",oObjWidth2,oPlanCtn2);for(d=0;d<M.length;d++)h(oPlanEtoiles[d],M[d].x,M[d].y,oObjWidth,oPlanSize),h(oPlanEtoiles2[d],M[d].x,M[d].y,oStarWidth2,oPlanSize2).style.width=oStarWidth2+"px",oPlanEtoiles[d].style.zIndex=oPlanEtoiles2[d].style.zIndex=2;m(oPlanBillballs,C,"billball",oObjWidth,oPlanCtn),m(oPlanBillballs2,C,"billball",oObjWidth2,oPlanCtn2);for(d=0;d<C.length;d++)posImg(oPlanBillballs[d],C[d].x,C[d].y,Math.round(p.rotation),oBBWidth,oPlanSize).style.width=oBBWidth+"px",posImg(oPlanBillballs2[d],C[d].x,C[d].y,Math.round(p.rotation),oBBWidth2,oPlanSize2).style.width=oBBWidth2+"px",oPlanBillballs[d].style.zIndex=oPlanBillballs2[d].style.zIndex=2}function removePlan(){try{document.body.removeChild(oPlanDiv)}catch(e){}try{document.body.removeChild(oPlanDiv2)}catch(e){}}function loadMap(){var e,t=isCup?complete?oMap.img:"mapcreate.php"+oMap.map:"images/maps/map"+oMap.map+"."+oMap.ext;gameSettings=(gameSettings=localStorage.getItem("settings"))?JSON.parse(gameSettings):{},(oMap.ext?"gif"===oMap.ext:t.match(/\.gif$/g))?gameSettings.nogif?((e=new Image).onload=function(){(oMapImg=document.createElement("canvas")).width=e.naturalWidth,oMapImg.height=e.naturalHeight,oMapImg.getContext("2d").drawImage(e,0,0),startGame()},e.src=t):((oMapImg=GIF()).onloadone=startGame,oMapImg.onloadall=function(){oPlanImg&&(oPlanImg.src=t),oPlanImg2&&(oPlanImg2.src=t)},oMapImg.load(t)):((oMapImg=new Image).onload=startGame,oMapImg.src=t),oMap.assets=[];for(var a=["oils","pivots","pointers","flippers","bumpers","flowers"],n=0;n<a.length;n++){var o=a[n];if(oMap[o]){function r(e){var t=this.canvas.getContext("2d");t.resetTransform?t.resetTransform():t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.canvas.width,this.canvas.height);var a=e[1][2],n=e[1][3],o=Math.max(a,n),i=e[2][2];t.translate(o/2,o/2),t.rotate(i),t.translate(-o/2,-o/2);try{t.drawImage(this.img,(o-a)/2,(o-n)/2,a,n)}catch(e){}var r=Math.cos(i),l=Math.sin(i),s=.5-e[2][0],c=.5-e[2][1];this.x=e[1][0]-o/2+s*a*r-c*n*l,this.y=e[1][1]-o/2+c*n*r+s*a*l}for(var i=0;i<oMap[o].length;i++)!function(e,t){var a=document.createElement("canvas");a.width=a.height=Math.max(t[1][2],t[1][3]);var n=new Image,o="assets/"+t[0];n.src="images/map_icons/"+o+".png";var i={img:n,canvas:a,src:o,redraw:r,x:t[1][0],y:t[1][1],w:t[1][2],h:t[1][3]};switch(n.onload=function(){i.redraw(t)},t[0]=i,e){case"flippers":t[3]=[0,16+Math.floor(16*Math.random())]}oMap.assets.push(i)}(o,oMap[o][i])}}1<strPlayer.length&&updateCtnFullScreen(!1),formulaire.screenscale.disabled=!0,formulaire.quality.disabled=!0,formulaire.music.disabled=!0,formulaire.sfx.disabled=!0,iTeamPlay=isTeamPlay(),setSRest(),document.body.style.cursor="progress";for(n=0;n<strPlayer.length;n++){var l=n*(iWidth*iScreenScale+2),s=document.createElement("div");s.style.position="absolute",s.style.left=oContainers[n].style.left,s.style.top=oContainers[n].style.top,s.style.width=iWidth*iScreenScale+"px",s.style.height=iHeight*iScreenScale+"px";var c=document.createElement("div");c.id="temps"+n,c.style.right=Math.round(iScreenScale/2)+"px",c.style.top=Math.round(iScreenScale/3)+"px",c.style.fontSize=2*iScreenScale+"pt",s.appendChild(c);var p=document.createElement("div");p.id="compteur"+n,p.style.left=Math.round(iScreenScale/3)+"px",p.style.bottom=Math.round(-iScreenScale/4)+"px",p.style.fontSize=2*iScreenScale+"pt",pause&&fInfos.replay||(p.innerHTML="BB"!=course?(oMap.sections?"Section":toLanguage("Lap","Tour"))+' <span id="tour'+n+'">1</span>/'+oMap.tours:'&nbsp;<img src="'+balloonSrc(aTeams[n])+'" style="width: '+2*iScreenScale+'" /><img src="'+balloonSrc(aTeams[n])+'" style="width: '+2*iScreenScale+'" /><img src="'+balloonSrc(aTeams[n])+'" style="width: '+2*iScreenScale+'" /><img src="'+balloonSrc(aTeams[n])+'" style="width: '+2*iScreenScale+'" />'),s.appendChild(p);var u=document.createElement("div");u.id="drift"+n;var d=document.createElement("img");d.alt=".",d.src="images/drift.png",d.className="driftimg pixelated",u.appendChild(d),s.appendChild(u);var h=document.createElement("table");h.id="objet"+n,h.setAttribute("border",1),h.setAttribute("cellpadding",0),h.setAttribute("cellspacing",0),h.innerHTML='<tr><td id="roulette'+n+'" valign="middle"></td></tr>',pause&&fInfos.replay||(h.style.left=Math.round(iScreenScale/3)+"px",h.style.top=Math.round(iScreenScale/3)+"px",h.style.width=9*iScreenScale+"px",h.style.height=8*iScreenScale+"px",h.style.visibility="visible"),s.appendChild(h);var m=document.createElement("div");m.id="lakitu"+n,m.className="pixelated",m.innerHTML="<div></div>",m.style.width=9*iScreenScale+"px",m.style.height=Math.round(6.6*iScreenScale)+"px",m.style.fontSize=Math.round(2.3*iScreenScale)+"px",s.appendChild(m),d.style.width=8*iScreenScale+"px",u.style.left=36*iScreenScale+"px",u.style.top=Math.round(32*iScreenScale)+"px",d.style.left="0px",d.style.top="0px";var g=document.createElement("div");g.id="infoPlace"+n,g.style.right=Math.round(iScreenScale/3)+"px",g.style.bottom=Math.round(3*-iScreenScale)+"px",g.style.fontSize=10*iScreenScale+"pt",s.appendChild(g);var y=document.getElementById("infos"+n);y||((y=document.getElementById("infos0").cloneNode(!0)).id="infos"+n,$mkScreen.appendChild(y)),y.style.left=10+35*iScreenScale+l+"px",y.style.top=10+8*iScreenScale+"px",y.style.fontSize=10*iScreenScale+"pt",y.innerHTML='<tr><td id="decompte'+n+'">3</td></tr>';var f=document.getElementById("scroller").cloneNode(!0);f.id="scroller"+n,f.style.width=8*iScreenScale+"px",f.style.height=7*iScreenScale+"px",f.style.lineHeight=iScreenScale+"px",f.setAttribute("width",8*iScreenScale+"px"),f.setAttribute("height",7*iScreenScale+"px"),f.style.top=Math.round(3+.2*iScreenScale)+"px",f.style.left=Math.round(4+.5*iScreenScale)+"px",f.getElementsByTagName("div")[0].style.left=Math.round(.1*iScreenScale+1)+"px",s.appendChild(f),$mkScreen.appendChild(s),hudScreens[n]=s}(oChallengeCpts=document.createElement("div")).id="challenge-cpts",oChallengeCpts.style.right=Math.round(iScreenScale/2)+"px",oChallengeCpts.style.top=Math.round(3.2*iScreenScale)+"px",oChallengeCpts.style.fontSize=Math.round(1.8*iScreenScale)+"px",oChallengeCpts.style.visibility="hidden",s.appendChild(oChallengeCpts),initMap();for(var S=8*iScreenScale-3,i=0;i<document.getElementsByClassName("aObjet").length;i++)document.getElementsByClassName("aObjet")[i].style.width=S+"px";removeMenuMusic(),bMusic&&!isOnline&&loadMapMusic()}function getShapeType(e){return"number"==typeof e[0]?"rectangle":"polygon"}function classifyByShape(e){for(var t={rectangle:[],polygon:[]},a=0;a<e.length;a++)t[getShapeType(e[a])].push(e[a]);return t}function initMap(){if(oMap.collision&&(oMap.collision=classifyByShape(oMap.collision)),oMap.pivots)for(var e=0;e<oMap.pivots.length;e++){var t=oMap.pivots[e][1],a=t[0],n=t[1],o=Math.round(t[2]/2),i=Math.round(t[3]/2);oMap.collision.polygon.push([[a-o,n],[a,n-i],[a+o,n],[a,n+i]])}if(oMap.horspistes)for(var r in oMap.horspistes)oMap.horspistes[r]=classifyByShape(oMap.horspistes[r]);if(oMap.flowers)for(e=0;e<oMap.flowers.length;e++){var l=oMap.flowers[e][1],a=l[0],n=l[1],o=Math.round(l[2]/2),i=Math.round(l[3]/2);oMap.horspistes.herbe.rectangle.push([a-o,n-o,2*o,2*i])}if(oMap.trous)for(e=0;e<4;e++){for(var s={rectangle:[],polygon:[]},c=0;c<oMap.trous[e].length;c++){var p=oMap.trous[e][c];6==p.length&&(p=[[p[0],p[1],p[2],p[3]],[p[4],p[5]]]),s[getShapeType(p[0])].push(p)}oMap.trous[e]=s}if(oMap.flows){for(var u={rectangle:[],polygon:[]},e=0;e<oMap.flows.length;e++){var d=oMap.flows[e];u[getShapeType(d[0])].push(d)}oMap.flows=u}if(oMap.accelerateurs)for(e=0;e<oMap.accelerateurs.length;e++){(h=oMap.accelerateurs[e])[2]?(h[2]++,h[3]++):(h[2]=9,h[3]=9)}if(oMap.sauts)for(var h,e=0;e<oMap.sauts.length;e++){(h=oMap.sauts[e]).length<5&&(h[4]=(h[2]+h[3])/45+1)}if(oMap.cannons){for(var m={rectangle:[],polygon:[]},e=0;e<oMap.cannons.length;e++){var g=oMap.cannons[e];m[getShapeType(g[0])].push(g)}oMap.cannons=m}}var timer=0,timerMS,lapTimers=new Array,oLapTimeDiv;iScreenScale=optionOf("screenscale");var fMaxRotInc=6,fTurboDriftCpt=80,fTurboDriftCpt2=160;function addNewItem(e,t,a){if(t.push(a),e==oPlayers[0]&&clLocalVars.myItems&&clLocalVars.myItems.push(a),-1!=a[2]){var n;switch(t){case bananes:n=50;break;case carapaces:case carapacesRouge:n=60;break;case fauxobjets:n=65;break;case carapacesBleue:n=60;break;case bobombs:n=40;break;default:n=60}var o=50-n,i=50-n;switch(t){case bananes:case bobombs:i+=5;break;case fauxobjets:i-=5}for(var r=0;r<oPlayers.length;r++){var l=document.createElement("div");l.className="sprite-hallow",l.style.position="absolute",l.style.left=o+"%",l.style.top=i+"%",l.style.width=2*n+"%",l.style.height=2*n+"%",l.style.borderRadius=n+"%",l.style.backgroundColor=a[2]?"red":"blue",l.style.opacity=.25;var s=a[0][r].div.firstChild;s?a[0][r].div.insertBefore(l,s):a[0][r].div.appendChild(l)}}}function arme(e,t){var a=aKarts[e];if(a.using[0]){var n=a.x,o=a.y;switch(a.using[2]){case"banane":var i=n-(l=30/(a.speed+5))*direction(0,a.rotation),r=o-l*direction(1,a.rotation);tombe(i,r)||addNewItem(a,bananes,[new Sprite("banane"),-1,a.team,i,r,0]),playIfShould(a,"musics/events/put.mp3");break;case"fauxobjet":var l=30/(a.speed+5);addNewItem(a,fauxobjets,[new Sprite("objet"),-1,a.team,n-l*direction(0,a.rotation),o-l*direction(1,a.rotation),0]),playIfShould(a,"musics/events/put.mp3");break;case"carapace":var s=angleShoot(a,t),c=t?7.5:15;addNewItem(a,carapaces,[new Sprite("carapace"),-1,a.team,n+c*direction(0,s),o+c*direction(1,s),0,s,10]),playDistSound(a,"musics/events/throw.mp3",50);break;case"carapacerouge":s=angleShoot(a,t);t?addNewItem(a,carapaces,[new Sprite("carapace-rouge"),-1,a.team,n+7.5*direction(0,s),o+7.5*direction(1,s),0,s,-1]):addNewItem(a,carapacesRouge,[new Sprite("carapace-rouge"),-1,a.team,n+15*direction(0,s),o+15*direction(1,s),0,s,a.id,-1]),playDistSound(a,"musics/events/throw.mp3",50);break;case"bobomb":s=angleShoot(a,t);addNewItem(a,bobombs,t?[new Sprite("bob-omb"),-1,a.team,n+5*direction(0,s),o+5*direction(1,s),0,s,2,42]:[new Sprite("bob-omb"),-1,a.team,n,o,0,s,15,30]),playDistSound(a,"musics/events/throw.mp3",50);break;default:return}detruit(a.using[0],a.using[1])}else{if(25!=a.roulette)return;a==oPlayers[0]&&(clLocalVars.itemsUsed=!0);var p,u,d=a.arme;switch(a.arme){case"champi":case"champiX2":case"champiX3":d="champi",p=20,a.maxspeed=11,a.speed=11,playIfShould(a,"musics/events/boost.mp3");break;case"etoile":p=60;for(var h=0;h<strPlayer.length;h++)a.sprite[h].img.src=getStarSrc(a.personnage);a.cpu||a.etoile||(isOnline||(a.sprite[0].img.onload=function(){bCounting=!1,this.onload=void 0,reprendre(!1)},bCounting=pause=!0),shouldPlaySound(a)&&!oPlayers[1]&&postStartMusic("musics/events/starman.mp3")),0<a.speedinc&&(a.speedinc*=5),delete a.shift,a.protect=!0;break;case"billball":p=Math.max(Math.min(Math.round(distanceToFirst(a)/6),120),50);for(h=0;h<strPlayer.length;h++)a.sprite[h].img.src="images/sprites/sprite_billball.png",resetSpriteHeight(a.sprite[h]);a.cpu||isOnline||(a.sprite[0].img.onload=function(){bCounting=!1,this.onload=void 0,reprendre(!1)},bCounting=pause=!0),a.rotinc=0,a.size=2.5,a.z=2,a.protect=!0,a.champi=0,delete a.shift,resetPowerup(a),playIfShould(a,"musics/events/boost.mp3"),stopDrifting(e);break;case"megachampi":p=50,a.size=1,updateDriftSize(e),a.protect=!0,a.megachampi||!shouldPlaySound(a)||oPlayers[1]||postStartMusic("musics/events/megamushroom.mp3");break;case"eclair":for(p=100,h=0;h<aKarts.length;h++){var m=aKarts[h];friendlyFire(m,a)||(m.protect?m.megachampi=m.megachampi<8||m.etoile?m.megachampi:8:(m.size=.6,updateDriftSize(h),m.arme=!1,m.using[0]&&(m.using[0][m.using[1]][5]&&(m.using[0][m.using[1]][5]=0),m.using=[!1]),m.champi=0,m.spin(20),m.roulette=0,stopDrifting(h),supprArme(h)))}!iSfx||finishing||a.cpu||playSoundEffect("musics/events/lightning.mp3"),$mkScreen.style.opacity=.7;break;case"banane":a.using=[bananes,bananes.length,"banane"],addNewItem(a,bananes,[new Sprite("banane"),-1,a.team,a.x-5*direction(0,a.rotation),a.y-5*direction(1,a.rotation),a.z]),playIfShould(a,"musics/events/item_store.mp3");break;case"fauxobjet":a.using=[fauxobjets,fauxobjets.length,"fauxobjet"],addNewItem(a,fauxobjets,[new Sprite("objet"),-1,a.team,a.x-5*direction(0,a.rotation),a.y-5*direction(1,a.rotation),a.z]),playIfShould(a,"musics/events/item_store.mp3");break;case"carapace":a.using=[carapaces,carapaces.length,"carapace"],addNewItem(a,carapaces,[new Sprite("carapace"),-1,a.team,a.x-5*direction(0,a.rotation),a.y-5*direction(1,a.rotation),a.z,-1,10]),playIfShould(a,"musics/events/item_store.mp3");break;case"carapacerouge":a.using=[carapacesRouge,carapacesRouge.length,"carapacerouge"],addNewItem(a,carapacesRouge,[new Sprite("carapace-rouge"),-1,a.team,a.x-5*direction(0,a.rotation),a.y-5*direction(1,a.rotation),a.z,-1,-1,-1]),playIfShould(a,"musics/events/item_store.mp3");break;case"carapacebleue":for(var g=aKarts[aKarts.length-1].id,y=1,h=0;h<aKarts.length;h++)aKarts[h].place==y&&(h=(aKarts[h].tours<=oMap.tours||"BB"==course)&&!sameTeam(a.team,aKarts[h].team)?(g=aKarts[h].id,aKarts.length):(y++,-1));addNewItem(a,carapacesBleue,[new Sprite("carapace-bleue"),-1,a.team,a.x,a.y,g,5]),playDistSound(a,"musics/events/throw.mp3",50);break;case"bobomb":a.using=[bobombs,bobombs.length,"bobomb"],addNewItem(a,bobombs,[new Sprite("bob-omb"),-1,a.team,a.x-5*direction(0,a.rotation),a.y-5*direction(1,a.rotation),a.z,-1,15,30]),playIfShould(a,"musics/events/item_store.mp3")}switch(p&&(a[d]=p),a.arme){case"champiX2":u="champi";break;case"champiX3":u="champiX2"}u?(a.arme=u,kartIsPlayer(a)&&(document.getElementById("roulette"+e).innerHTML='<img alt="."class="pixelated" src="images/items/'+u+'.gif" style="width: '+Math.round(8*iScreenScale-3)+'px;" />')):supprArme(e)}}var aKarts=new Array,bRunning=!1,bCounting=!1,musicIdInc=0,mapMusic,endingMusic,endGPMusic,challengeMusic,carEngine,carEngine2,carEngine3,carDrift,carSpark;function loadMusic(e,t){var a,n,o,i=isOriginalMusic(e);return i?(n=document.createElement("audio")).setAttribute("loop",!0):(a=youtube_parser(e),(n=document.createElement("iframe")).id="youtube-video-"+musicIdInc++,n.src="https://www.youtube.com/embed/"+a+"?"+(t?"autoplay=1&amp;":"")+"loop=1&amp;playlist="+a+"&amp;enablejsapi=1&amp;allow=autoplay",n.setAttribute("enablejsapi",1),n.setAttribute("allow","autoplay")),n.className="gamemusic",i&&((o=document.createElement("source")).type="audio/mpeg",n.src=e,n.appendChild(o),t&&n.setAttribute("autoplay",!0)),n}function pauseMusic(e){isOriginalEmbed(e)?e.pause():onPlayerReady(e,function(e){e.pauseVideo()}),oMusicEmbed==e&&(oMusicEmbed=void 0)}function bufferMusic(e){isOriginalEmbed(e)||onPlayerReady(e,function(e){e.setVolume(0),e.playVideo(),setTimeout(function(){e.seekTo(0,!0),e.setVolume(100),e.pauseVideo()},1e3)})}function stopMusic(e){e&&(e.permanent?pauseMusic:removeIfExists)(e)}function unpauseMusic(e){document.body.contains(e)&&(isOriginalEmbed(e)?e.play():onPlayerReady(e,function(e){e.playVideo()}),oMusicEmbed=e)}function muteSound(e){isOriginalEmbed(e)?e.muted=!0:onPlayerReady(e,function(e){e.mute()})}function unmuteSound(e){isOriginalEmbed(e)?e.muted=!1:onPlayerReady(e,function(e){e.unMute()})}function onPlayerReady(t,e){try{t.yt?t.tasks?t.tasks.push(e):e(t.yt):(t.tasks=[e],t.yt=new YT.Player(t.id,{events:{onReady:function(){for(var e=0;e<t.tasks.length;e++)t.tasks[e](t.yt);t.tasks=void 0}}}))}catch(e){}}function updateMusic(e,t){e!=oMusicEmbed&&removeIfExists(oMusicEmbed),document.body.contains(e)&&(isOriginalEmbed(e)?t&&(e.volume=1,e.currentTime=0,e.play(),e.playbackRate=1.2):onPlayerReady(e,function(e){t&&(e.setPlaybackRate(1.25),e.seekTo(0,!0),e.setVolume(100),e.playVideo())}),oMusicEmbed=e)}function fastenMusic(e){isOriginalEmbed(e)?e.playbackRate=1.2:onPlayerReady(e,function(e){e.setPlaybackRate(1.25)})}function shouldPlaySound(e){return iSfx&&kartIsPlayer(e)&&!finishing&&!e.loose}function shouldPlayMusic(e){return bMusic&&kartIsPlayer(e)&&!finishing&&!e.loose}function playIfShould(e,t){if(shouldPlaySound(e))return playSoundEffect(t)}function playSoundEffect(e){var t=loadMusic(e,!0);return t.removeAttribute("loop"),t.onended=function(){document.body.removeChild(this)},document.body.appendChild(t),t}function playDistSound(e,t,a){if(iSfx){var n=a/distKart(e);if(1<=n){var o=playSoundEffect(t);return o.volume=Math.min(.05*n*n,1),o}}}function startMusic(e,t,a){var n,o=loadMusic(e,t);return document.body.appendChild(o),a?(pauseMusic(o),n=oMusicEmbed,setTimeout(function(){oMusicEmbed==o&&(stopMusic(n),unpauseMusic(o))},a),oMusicEmbed=o):t&&(stopMusic(oMusicEmbed),oMusicEmbed=o),o}function postStartMusic(e){return oMusicEmbed&&fadeOutMusic(oMusicEmbed,1,.6,!1),startMusic(e,!0,200)}function postResumeMusic(e,t){var a;oMusicEmbed!=e&&(fadeOutMusic(a=oMusicEmbed,1,t,!0),e&&setTimeout(function(){oMusicEmbed!=a&&oMusicEmbed||(fadeInMusic(e,.2,t),unpauseMusic(e))},500))}function stopStarMusic(e){shouldPlaySound(e)&&!oPlayers[1]&&postResumeMusic(mapMusic,.9)}function stopMegaMusic(e){shouldPlaySound(e)&&!oPlayers[1]&&postResumeMusic(mapMusic,.92)}function resetPowerup(e){e.etoile&&(e.etoile=0,stopStarMusic(e)),e.megachampi&&(e.megachampi=0,stopMegaMusic(e))}function isOriginalMusic(e){return-1!=e.indexOf("mp3")}function isOriginalEmbed(e){return"audio"==e.tagName.toLowerCase()}var willPlayEndMusic=!1,isEndMusicPlayed=!1,forceStartMusic=!1,forcePrepareEnding=!1,playingCarEngine,oMusicEmbed;function loadMapMusic(){var e;startMapMusic(!1),loadEndingMusic(),mapMusic.blur(),endingMusic.blur(),isMobile()||isChatting()||(e=document.createElement("input"),document.body.appendChild(e),e.focus(),e.blur(),document.body.removeChild(e))}function startMapMusic(e){e?updateMusic(mapMusic,!0):((mapMusic=startMusic(oMap.music?"musics/maps/map"+oMap.music+".mp3":oMap.yt)).permanent=1,bufferMusic(mapMusic))}function loadEndingMusic(){var e=getEndingSrc(strPlayer[0]);(endingMusic=startMusic(e)).permanent=1,bufferMusic(endingMusic)}function loopWithoutGap(){playingCarEngine!=this||this.currentTime>this.duration-.44&&(this.currentTime=0,this.play())}function loopAfterIntro(e,t,a){var n;e.looper||(n=t+(a-=.15),e.looper=function(){this.currentTime>=n&&(this.currentTime-=a)},e.addEventListener("timeupdate",e.looper,!1))}function startEngineSound(){carEngine=loadMusic("musics/events/engine.mp3",!0),carEngine2=loadMusic("musics/events/engine2.mp3",!1),carEngine3=loadMusic("musics/events/engine3.mp3",!1),carDrift=loadMusic("musics/events/drift.mp3",!1),carSpark=loadMusic("musics/events/spark.mp3",!1),(playingCarEngine=carEngine).addEventListener("timeupdate",loopWithoutGap,!1),carEngine2.addEventListener("timeupdate",loopWithoutGap,!1),carEngine.permanent=1,carEngine2.permanent=1,carEngine3.permanent=1,carDrift.permanent=1,carSpark.permanent=1,document.body.appendChild(carEngine),document.body.appendChild(carEngine2),document.body.appendChild(carEngine3),document.body.appendChild(carDrift),document.body.appendChild(carSpark)}function updateEngineSound(e){iSfx&&e!=playingCarEngine&&(playingCarEngine&&playingCarEngine.pause(),(playingCarEngine=e)&&playingCarEngine.play())}function startEndMusic(){bMusic&&(removeMenuMusic(!0),removeIfExists(mapMusic)),iSfx&&(playingCarEngine=void 0,removeIfExists(carEngine),removeIfExists(carEngine2),removeIfExists(carEngine3),removeIfExists(carDrift),removeIfExists(carSpark)),bMusic&&(willPlayEndMusic=!0,setTimeout(function(){for(var e=document.getElementsByClassName("gamemusic"),t=[],a=0;a<e.length;a++)e[a].permanent||t.push(e[a]);for(a=0;a<t.length;a++)document.body.removeChild(t[a]);willPlayEndMusic&&(isEndMusicPlayed=!(willPlayEndMusic=!1),unpauseMusic(endingMusic))},200)),iSfx&&"BB"!=course&&(playSoundEffect("musics/events/goal.mp3").className="")}function handleEndRace(){(bMusic||iSfx)&&startEndMusic();var e=["next_circuit"];challengeCheck("end_game",e),challengeCheck("end_gp",e),clGlobalVars.nbcircuits++}function startGame(){resetScreen();var o=strPlayer.length+aPlayers.length;if(!isOnline)if("BB"==course)for(var e=0;e<o;e++)aPlaces[e]=e+1;else"CM"==course&&(aPlaces=[1]);var t=oMap.sections?oMap.checkpoint.length-1:0,a=null==oMap.startrotation?180:oMap.startrotation,i=oMap.startdirection||0,n=a*Math.PI/180,r=Math.cos(n),l=Math.sin(n),s=27,c=130,p=Math.max(2,Math.round((1+Math.sqrt((c+4*(o-1)*s)/c))/2));function u(e,t){var a=((t+1)%p-(p-1)/2)*s/(p-.5),n=t*Math.min(12,c/o);i||(a=-a),a+=9,e.x-=a*r+n*l,e.y+=a*l-n*r}function d(e){return{acceleration:.2+.8*Math.pow(e[0],2),speed:.875+.25*e[1],handling:.2+.8*e[2],mass:.5+e[3]}}for(e=0;e<strPlayer.length;e++){var h=aPlaces[e],m={id:e,x:oMap.startposition[0],y:oMap.startposition[1],z:0,personnage:strPlayer[e],speed:0,speedinc:0,heightinc:0,stats:d(cp[strPlayer[e]]),rotation:a,rotincdir:0,rotinc:0,changeView:0,size:1,sprite:new Sprite(strPlayer[e]),cpu:!1,aipoints:oMap.aipoints[0],tourne:0,tombe:0,protect:!1,roulette:0,arme:!1,maxspeed:5.7,driftinc:0,driftcpt:0,drift:0,turbodrift:0,jumped:!1,champi:0,etoile:0,megachampi:0,eclair:0,using:[!1]};isOnline&&(m.id=identifiant),isOnline&&(m.nick=aPseudos[e]),m.team=iTeamPlay?aTeams[e]:-1,"BB"!=course?(u(m,h),m.time=0,m.tours=1,m.demitours=t,m.billball=0):(v=(S=isOnline?h-1:e)%oMap.startposition.length,m.x=oMap.startposition[v][0],m.y=oMap.startposition[v][1],m.rotation=90*oMap.startposition[v][2],m.loose=!1,m.ballons=[createBalloonSprite(m)],m.reserve=4),m.place=h,m.initialPlace=m.place,oPlayers.push(m),aKarts.push(m)}for(e=0;e<aPlayers.length;e++){var g=aPlayers[e],y=e+strPlayer.length,h=aPlaces[y],f=2*(iDificulty-4)+Math.round(Math.random());"BB"==course&&(f=2);var S,v,b={id:y,speed:0,speedinc:.5,heightinc:0,stats:d([.5,.5,.5,cp[g][3]]),rotation:a,rotincdir:0,rotinc:0,x:oMap.startposition[0],y:oMap.startposition[1],z:0,size:1,personnage:g,sprite:new Sprite(g),tourne:0,tombe:0,protect:!1,roulette:0,arme:!1,champi:0,etoile:0,megachampi:0,eclair:0,using:[!1],cpu:!isOnline,aipoint:0,lastAItime:0,aipoints:oMap.aipoints[0],maxspeed:5.7};isOnline?b.id=aIDs[e]:b.aipoints=oMap.aipoints[y%oMap.aipoints.length]||[],isOnline&&(b.nick=aPseudos[y]),b.team=iTeamPlay?aTeams[y]:-1,-1==b.team&&!b.nick||(b.marker=createMarker(b)),"BB"!=course?(u(b,h),b.tours=1,b.demitours=t,b.billball=0,isOnline||(b.speed=f<2?0:5.7,b.tourne=f?0:42),b.place=h):(v=(S=isOnline?h-1:y)%oMap.startposition.length,b.x=oMap.startposition[v][0],b.y=oMap.startposition[v][1],b.rotation=90*oMap.startposition[v][2],b.loose=!1,b.aipoint=oMap.startposition[v][3],simplified&&(b.lastAI=oMap.startposition[v][3]+[-6,-1,6,1][oMap.startposition[v][2]]),b.ballons=[createBalloonSprite(b)],b.reserve=4,b.place=S+1,simplified||(b.speed=b.maxspeed)),b.initialPlace=b.place,aKarts.push(b)}if(oMap.decor){for(var M in oMap.decor){decorBehaviors[M]||(decorBehaviors[M]={type:M});var C=getDecorExtra(P=decorBehaviors[M]);(k=C.custom)&&(decorBehaviors[k.type]&&(Object.assign(P,decorBehaviors[k.type]),P.type=M),function(i){getCustomDecorData(k,function(e){var t,a,n,o={w:e.size.hd.w/e.original_size.hd.w,h:e.size.hd.h/e.original_size.hd.h};1!==(i.size_ratio=o).w&&(t=i.hitbox||DEFAULT_DECOR_HITBOX,n=1,i.hitbox=n+(t-n)*o.w),1!==o.h&&(a=i.hitboxH||DEFAULT_DECOR_HITBOX_H,n=.8,i.hitboxH=n+(a-n)*o.h)})}(P)),P.preinit&&P.preinit(oMap.decor[M])}var x={};for(var M in oMap.decor){var P,k,C=getDecorExtra(P=decorBehaviors[M]),w=(k=C.custom)?k.type:M,y=0;x[w]?y=x[w]:x[w]=0;for(var T=oMap.decor[M],e=0;e<T.length;e++){var I=T[e];I[2]=new Sprite(M),P.init&&P.init(I,e,e+y),gameSettings.ld&&P.hidable?I[2][0].unshow():k&&function(n,o){for(var e=0;e<oPlayers.length;e++)n[2][e].img.src="images/map_icons/empty.png";getCustomDecorData(k,function(e){for(var t=0;t<oPlayers.length;t++){n[2][t].img.src=e.hd,e.size.nb_sprites&&(n[2][t].nbSprites=e.size.nb_sprites),n[2][t].w=Math.round(n[2][t].w*o.size_ratio.w),n[2][t].h=Math.round(n[2][t].h*o.size_ratio.h);var a=(o.size_ratio.w-o.size_ratio.h)/(o.size_ratio.w+o.size_ratio.h);a*=n[2][t].w/(2*n[2][t].h),n[2][t].z+=a}})}(I,P)}x[w]+=T.length}}function E(e){this.tourne||(isOnline?playIfShould(this,"musics/events/spin.mp3"):playDistSound(this,"musics/events/spin.mp3","BB"==course?80:50)),this.tourne=e}function L(){return tombe(this.x+this.speed*direction(0,this.rotation),this.y+this.speed*direction(1,this.rotation))}function B(){return ralenti(this.x+this.speed*direction(0,this.rotation),this.y+this.speed*direction(1,this.rotation))}for(e=0;e<aKarts.length;e++){aKarts[e].spin=E,aKarts[e].falling=L,aKarts[e].exiting=B;for(var D=0;D<strPlayer.length;D++)!function(e){e.nbSprites=24,e.img.onload=function(){e.w=this.naturalWidth/e.nbSprites,e.h=this.naturalHeight,delete this.onload}}(aKarts[e].sprite[D])}if("CM"!=course){for(e=0;e<oMap.arme.length;e++)oMap.arme[e][2]=0;for(e=0;e<oPlayers.length;e++){document.getElementById("infoPlace"+e).innerHTML=toPlace(oPlayers[e].place),document.getElementById("infoPlace"+e).style.display="block";var z=-1!=oPlayers[e].team?oPlayers[e].team?"#F96":"#69F":"";document.getElementById("infoPlace"+e).style.color=z,"BB"!=course&&(document.getElementById("compteur"+e).style.color=z)}}else{oMap.arme=[],aKarts[0].arme="champiX3",aKarts[0].roulette=25;for(e=0;e<gPersos.length;e++){var H=gPersos[e];aKarts.push({speed:f<2?0:5.7,speedinc:.5,heightinc:0,stats:d(cp[H]),rotation:a,rotincdir:0,rotinc:0,x:aKarts[0].x,y:aKarts[0].y,z:0,size:1,personnage:H,sprite:new Sprite(H),tourne:0,tombe:0,protect:!1,roulette:0,arme:!1,champi:0,etoile:0,megachampi:0,using:[!1],cpu:!1,aipoint:0,aipoints:oMap.aipoints[0],maxspeed:5.7,place:1}),aKarts[aKarts.length-1].sprite[0].div.style.opacity=.5}document.getElementById("roulette0").innerHTML='<img alt="."class="pixelated" src="images/items/champiX3.gif" style="width: '+Math.round(8*iScreenScale-3)+'px;" />'}if(gameControls=getGameControls(),challengesForCircuit={end_game:[],each_frame:[],each_hit:[],each_kill:[],each_item:[],each_coin:[],end_gp:[]},clGlobalVars=clGlobalVars||{nbcircuits:0},addCreationChallenges("track",getMapId(oMap)),isCup)if(isMCups){var O=cupIDs[Math.floor((oMap.ref-1)/4)];for(var O in addCreationChallenges("cup",O),challenges.mcup)addCreationChallenges("mcup",O)}else for(var O in challenges.cup)addCreationChallenges("cup",O);var R,j={};for(var A in challengesForCircuit)for(var V=challengesForCircuit[A],e=0;e<V.length;e++){j[V[e].id]=!0}for(var F in clRuleVars)j[F]||delete clRuleVars[F];if(clSelected&&!j[clSelected.id]&&(clSelected=void 0),reinitLocalVars(),1==strPlayer.length&&!gameSettings.nomap){oPlanWidth=Math.round(19.4*iScreenScale),oPlanWidth2=oMap.w>=oMap.h?oPlanWidth:oPlanWidth*(oMap.w/oMap.h);var N,_,K=oMap.w<=oMap.h?oPlanWidth:oPlanWidth*(oMap.h/oMap.w);if(oMap.iW&&oMap.iH&&(N=Math.min(oMap.w/oMap.iW,oMap.h/oMap.iH),oPlanWidth2*=N,K*=N),oPlanWidth2=Math.round(oPlanWidth2),K=Math.round(K),oPlanSize=59*iScreenScale,oPlanSize2=oPlanWidth2,oPlanRealSize=oMap.w,oCharRatio=.8,oPlanRatio=.5,(oPlanDiv=document.createElement("div")).style.backgroundColor="rgb("+oMap.bgcolor+")",oPlanDiv.style.position="absolute",oPlanDiv.style.left=15+iScreenScale*iWidth+"px",oPlanDiv.style.top="9px",oPlanDiv.style.width=oPlanWidth+"px",oPlanDiv.style.height=oPlanWidth+"px",oPlanDiv.style.overflow="hidden",(oPlanDiv2=document.createElement("div")).style.backgroundColor="rgb("+oMap.bgcolor+")",oPlanDiv2.style.position="absolute",oPlanDiv2.style.left=15+iScreenScale*iWidth+"px",oPlanDiv2.style.top=10+Math.round(iScreenScale/4)+oPlanWidth+"px",oPlanDiv2.style.width=oPlanWidth+"px",oPlanDiv2.style.height=oPlanWidth+"px",oPlanDiv2.style.overflow="hidden",(oPlanCtn=document.createElement("div")).style.position="absolute",oPlanCtn.style.transformOrigin=oPlanCtn.style.WebkitTransformOrigin=oPlanCtn.style.MozTransformOrigin="left",(oPlanCtn2=document.createElement("div")).style.position="absolute",oPlanCtn2.style.left=Math.round((oPlanWidth-oPlanWidth2)/2)+"px",oPlanCtn2.style.top=Math.round((oPlanWidth-K)/2)+"px",oPlanCtn2.style.width=oPlanWidth2+"px",oPlanCtn2.style.height=K+"px",oMapImg.src?((oPlanImg=document.createElement("img")).src=oMapImg.src,oPlanImg.style.width=oPlanSize+"px"):(_=Math.round(oPlanSize*oMap.h/oMap.w),(oPlanImg=document.createElement("canvas")).width=oPlanSize,oPlanImg.height=_,oPlanImg.getContext("2d").drawImage(oMapImg,0,0,oPlanSize,_)),oPlanImg.style.position="absolute",oPlanImg.style.left="0px",oPlanImg.style.top="0px",oPlanCtn.appendChild(oPlanImg),oMapImg.src?(oPlanImg2=document.createElement("img")).src=oMapImg.src:((oPlanImg2=document.createElement("canvas")).width=oPlanSize,oPlanImg2.height=_,oPlanImg2.getContext("2d").drawImage(oMapImg,0,0,oPlanSize,_)),oPlanImg2.style.position="absolute",oPlanImg2.style.left="0px",oPlanImg2.style.top="0px",oPlanImg2.style.width=oPlanWidth2+"px",oPlanCtn2.appendChild(oPlanImg2),oMap.decor)for(var M in oMap.decor)oPlanDecor[M]=new Array,oPlanDecor2[M]=new Array;for(var W=["oils","pivots","pointers","flippers","bumpers","flowers"],e=0;e<W.length;e++){var G=W[e];oMap[G]&&(oPlanAssets[G]=new Array,oPlanAssets2[G]=new Array)}if(oPlanImg.onload=function(){oMapImg.seekFrame&&oMapImg.seekFrame(2)},oCharWidth=2*iScreenScale,oTeamWidth=Math.round(2.4*iScreenScale),oBBWidth=2*iScreenScale,oStarWidth2=Math.round(1.5*iScreenScale),oObjWidth=Math.round(1.5*iScreenScale),oCoinWidth=Math.round(1.2*iScreenScale),oExpWidth=7*iScreenScale,oCharWidth2=Math.round(oCharRatio*oCharWidth),oTeamWidth2=Math.round(oCharRatio*oTeamWidth),oBBWidth2=Math.round(oCharRatio*oBBWidth),oObjWidth2=Math.round(oPlanRatio*oObjWidth),oCoinWidth2=Math.round(oPlanRatio*oCoinWidth),oExpWidth2=Math.round(oPlanRatio*oExpWidth),iTeamPlay)for(e=0;e<aTeams.length;e++){var q=document.createElement("div");q.style.position="absolute",q.style.zIndex=1,q.style.width=oTeamWidth+"px",q.style.height=oTeamWidth+"px",q.style.borderRadius=Math.round(oTeamWidth/2)+"px",q.style.opacity=.5,q.style.backgroundColor=aTeams[e]?"red":"blue",oPlanTeams.push(q),oPlanCtn.appendChild(q);var $=document.createElement("div");$.style.position="absolute",$.style.zIndex=1,$.style.width=oTeamWidth2+"px",$.style.height=oTeamWidth2+"px",$.style.borderRadius=Math.round(oTeamWidth2/2)+"px",$.style.opacity=.5,$.style.backgroundColor=aTeams[e]?"red":"blue",oPlanTeams2.push($),oPlanCtn2.appendChild($)}for(e=0;e<aKarts.length;e++){var U=document.createElement("img");U.style.position="absolute",U.style.zIndex=1,U.style.width=oCharWidth+"px",U.src=getMapIcSrc(aKarts[e].personnage),U.className="pixelated",oPlanCharacters.push(U);var J=document.createElement("img");J.style.position="absolute",J.style.zIndex=1,J.style.width=oCharWidth2+"px",J.src=getMapIcSrc(aKarts[e].personnage),J.className="pixelated",oPlanCharacters2.push(J)}if("CM"==course&&1<oPlanCharacters.length){for(e=0;e<oPlanCharacters.length;e++)e&&(oPlanCharacters[e].style.opacity=.5),oPlanCtn.appendChild(oPlanCharacters[e]);for(e=0;e<oPlanCharacters2.length;e++)e&&(oPlanCharacters2[e].style.opacity=.5),oPlanCtn2.appendChild(oPlanCharacters2[e])}else{for(e=oPlanCharacters.length-1;0<=e;e--)oPlanCtn.appendChild(oPlanCharacters[e]);for(e=oPlanCharacters2.length-1;0<=e;e--)oPlanCtn2.appendChild(oPlanCharacters2[e])}for(e=0;e<oMap.arme.length;e++){fSprite=oMap.arme[e],fSprite[2]=new Sprite("objet");var Y=document.createElement("img");Y.src="images/map_icons/objet.png",Y.style.position="absolute",Y.style.display="none",Y.style.width=oObjWidth,Y.className="pixelated",posImg(Y,fSprite[0],fSprite[1],Math.round(m.rotation),oObjWidth,oPlanSize),oPlanCtn.appendChild(Y),oPlanObjects.push(Y);var X=document.createElement("img");X.src="images/map_icons/objet.png",X.style.position="absolute",X.style.display="none",X.style.width=oObjWidth2,X.className="pixelated",posImg(X,fSprite[0],fSprite[1],Math.round(m.rotation),oObjWidth2,oPlanSize2),oPlanCtn2.appendChild(X),oPlanObjects2.push(X)}oPlanDiv.appendChild(oPlanCtn),document.body.appendChild(oPlanDiv),oPlanDiv2.appendChild(oPlanCtn2),document.body.appendChild(oPlanDiv2),setPlanPos()}setTimeout(render,500),bMusic&&((R=playSoundEffect("musics/events/"+("BB"!=course?"start":"startbb")+".mp3")).pause(),setTimeout(function(){R.play()},300),R.blur()),bCounting=!0;for(var Q=new Array,e=0;e<strPlayer.length;e++)Q[e]=[document.createElement("div"),new Image],Q[e][0].id="oCounts"+e,Q[e][0].style.position="absolute",Q[e][0].style.width=12*iScreenScale+"px",Q[e][0].style.height=12*iScreenScale+"px",Q[e][0].style.overflow="hidden",Q[e][0].style.top=4*iScreenScale+"px",Q[e][0].style.left=8*iScreenScale+"px",Q[e][0].style.zIndex=1e4,Q[e][1].src="images/lakitu_depart.png",Q[e][1].style.position="absolute",Q[e][1].style.left="0px",Q[e][1].height=12*iScreenScale,Q[e][1].className="pixelated",Q[e][0].appendChild(Q[e][1]),oContainers[e].appendChild(Q[e][0]),Q[e].scrollLeft=0;var Z,ee,te,ae,ne=0;(bMusic||iSfx)&&((ae=loadMusic("musics/events/countdown.mp3")).removeAttribute("loop"),document.body.appendChild(ae),(ee=loadMusic("musics/events/go.mp3")).removeAttribute("loop"),document.body.appendChild(ee),ee.blur(),isMobile()||isChatting()||(te=document.createElement("input"),document.body.appendChild(te),te.focus(),te.blur(),document.body.removeChild(te)));var oe,ie=fInfos&&fInfos.replay,re=function(){if(ne){for(var i=0;i<strPlayer.length;i++)Q[i][0].scrollLeft=12*ne*iScreenScale;if(!(ne<3)){for(var t,a,n,i=0;i<strPlayer.length;i++)document.getElementById("infos"+i).innerHTML="<tr><td>"+toLanguage("&nbsp; &nbsp; GO !","PARTEZ !")+"</td></tr>",document.getElementById("infos"+i).style.left=10+20*iScreenScale+i*(iWidth*iScreenScale+2)+"px",document.getElementById("infos"+i).style.fontSize=8*iScreenScale+"pt",1==oPlayers[i].speed?oPlayers[i].speed=11:1<oPlayers[i].speed&&(oPlayers[i].spin(42),oPlayers[i].speed=0,oPlayers[i].speedinc=0);if(oChallengeCpts.style.visibility="visible",!isOnline&&"BB"==course)for(i=strPlayer.length;i<aKarts.length;i++){var e=aKarts[i],o=1+Math.round(Math.random());for(D=0;D<o;D++)addNewBalloon(e),e.reserve--}if((bMusic||iSfx)&&(ee.play(),ee.onended=function(){document.body.removeChild(ae),document.body.removeChild(ee)}),forcePrepareEnding=!0,setTimeout(function(){for(var e,t=kartIsPlayer(oPlayers[0])&&!oPlayers[0].loose&&!finishing||ie,a=0;a<strPlayer.length;a++)oContainers[a].removeChild(Q[a][0]),(t||a)&&(document.getElementById("infos"+a).style.display="none");t&&(document.getElementById("infos0").style.top=7*iScreenScale+10+"px",document.getElementById("infos0").style.left=Math.round(25*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.fontSize=4*iScreenScale+"pt",e="CM"!=course?3*iScreenScale:Math.round(2.5*iScreenScale),document.getElementById("infos0").innerHTML='<tr><td><input type="button" style="font-size: '+e+'pt; width: 100%;" value=" &nbsp; '+toLanguage("  RESUME  ","REPRENDRE")+' &nbsp; " id="reprendre" /></td></tr><tr><td style="font-size:'+2*iScreenScale+'px">&nbsp;</td></tr><tr><td><input type="button" style="font-size: '+e+'pt; width: 100%;" value=" &nbsp; '+toLanguage("  RETRY  ","RÉESSAYER")+' &nbsp; " id="recommencer" /></td></tr>'+("CM"!=course?"":'<tr><td style="font-size:'+2*iScreenScale+'px">&nbsp;</td></tr><tr><td><input type="button" style="font-size: '+e+'pt; width: 100%;" value="'+toLanguage("  CHANGE RACE  ","CHANGER CIRCUIT")+'" id="changecircuit" /></td></tr>')+'<tr><td style="font-size:'+2*iScreenScale+'px">&nbsp;</td></tr><tr><td><input type="button" id="quitter" value=" &nbsp; '+toLanguage("QUIT","QUITTER")+' &nbsp; " style="font-size: '+e+'pt; width: 100%;" /></td></tr>',document.getElementById("infos0").onkeydown=function(e){var t;switch(e.keyCode){case 38:t=-1;break;case 40:t=1}if(t){var a=document.activeElement;if(a){var n=Array.prototype.slice.call(document.querySelectorAll("#infos0 input, #infos0 button")),o=a,i=n.indexOf(a);if(-1!=i){var r=i;do{if((r+=t)<0&&(r+=n.length),r>=n.length&&(r=0),(o=n[r])&&"none"!=o.style.display&&"hidden"!=o.style.visibility){o.focus();break}}while(r!=i)}}}},document.getElementById("reprendre").onclick=reprendre,document.getElementById("recommencer").onclick=function(){pause=!0,removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,map:oMap.ref,difficulty:iDificulty,cl:clSelected},"CM"==course&&(fInfos.perso=gPersos,fInfos.cpu_route=jTrajets,fInfos.my_record=gRecord,fInfos.ow_record=gOverwriteRecord,fInfos.lap_times=iLapTimes),document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,resetScores()&&("GP"==course?fInfos.map-=(oMap.ref+3)%4:delete fInfos.map),document.onmousedown=void 0,document.onkeydown=void 0,document.onkeyup=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,setTimeout(MarioKart,500)},"CM"==course&&(document.getElementById("changecircuit").onclick=function(){pause=!0,removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,perso:new Array,cl:clSelected},document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,document.onkeydown=void 0,document.onkeyup=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,setTimeout(MarioKart,500)}),document.getElementById("quitter").onclick=quitter,bMusic&&!oMusicEmbed&&(unpauseMusic(mapMusic),forceStartMusic=!0)),bCounting=!1},1e3),pause&&fInfos.replay){var c=pause=!1,p=!1,u=!1,d=[iTrajet];function h(){var e=aKarts[0];e.tourne=0,e.driftcpt=0,getDriftImg(e.driftinc=0).src="images/drift.png",document.getElementById("drift0").style.display="none",aDriftInc=0}function m(){c&&(c=!1,aKarts[0].tourne=0);var e=aKarts[0].sprite[0];e.div.ahallowed&&(e.div.ahallowed=!1,e.div.style.backgroundColor="",e.div.style.backgroundImage="",e.div.style.backgroundRepeat="",e.div.style.backgroundSize="",e.img.style.opacity=1)}for(i=0;i<aKarts.length;i++)aKarts[i].cpu=!0;for(i=0;i<gPersos.length;i++)d.push(jTrajets[i]);clearInterval(Z),function e(){if(!pause){for(var t=0;t<d.length;t++){var a=aKarts[t],n=d[t][timer];if(n){a.tombe&&(a.tombe--,a.tombe||(a.sprite[0].img.style.display="block"),t||(oContainers[0].style.opacity=Math.abs(a.tombe-10)/10)),a.x=n[0],a.y=n[1],a.z=n[2],a.rotation=n[3];for(var o=(n[4]||"0000").split(""),i=0;i<4;i++)o[i]=+o[i];var r,l=0;o[2]?l=1:o[3]&&(l=-1),a.rotincdir=a.stats.handling*l,a.z?(t||(p||(u=p=!0,h()),1.18<a.z&&(u=!1),u?o[1]&&!a.driftinc&&l&&(a.driftinc=l,a.tourne=0<l?18:4):c?(a.tourne-=1+Math.round(.5*(11-Math.abs(11-a.tourne))),a.tourne<8&&((r=a.sprite[0]).div.ahallowed||(r.div.ahallowed=!0,r.div.style.backgroundImage="url('images/halo.png')",r.div.style.backgroundRepeat="no-repeat",r.div.style.backgroundSize="contain",r.img.style.opacity=.7),a.tourne<0&&(a.tourne=0))):!o[1]||a.driftinc||a.tombe||(c=!0,h(),a.tourne=19)),o[0]&&(a.tombe=20,a.sprite[0].img.style.display="none",m())):t||p&&(p=!1,a.driftinc&&(document.getElementById("drift"+t).style.display="block"),m()),a.driftinc&&(t||(o[1]?document.getElementById("drift"+t).style.top=Math.round(iScreenScale*(32-correctZ(a.z))+(a.sprite[t].h-32)*fSpriteScale*.15)+"px":h())),t||handleDriftCpt(t)}else{null==a.aipoint&&(a.aipoint=0,a.lastAItime=0,a.arme=!1,a.maxspeed=5.7,t||(a.tourne=0,h(),m())),ai(a);var s=iSfx;iSfx=!1,move(t),iSfx=s}}showTimer(67*++timer),oPlayers[0].cpu=!1,moveDecor(),oPlayers[0].cpu=!0,setTimeout(timer!=iTrajet.length?e:function(){var e=aKarts[0];e.tours=oMap.tours+1,e.demitours=0,e.aipoint=0,e.changeView=180,e.maxspeed=5.7,e.speed=5.7,e.tourne=0,h(),m(),document.onkeyup=void 0,document.getElementById("infos0").style.display="";var t=document.getElementById("infos0").getElementsByTagName("input")[0];t&&t.focus(),showTimer(timerMS=iRecord),(bMusic||iSfx)&&startEndMusic(),cycle()},67),render()}}(),pause=!1,setTimeout(function(){continuer(),document.querySelector("#enregistrer input").style.display="none"},1e3),document.onkeyup=function(e){var t,a=gameControls[e.keyCode];"pause"!=a||bCounting?"quit"==a&&quitter():(document.getElementById("infos0").style.display="none"==document.getElementById("infos0").style.display?"":"none",(t=document.getElementById("infos0").getElementsByTagName("input")[0])&&t.focus())}}else{document.onkeydown=function(e){if(forceStartMusic)try{mapMusic.yt&&mapMusic.yt.playVideo(),forceStartMusic=!1}catch(e){}else if(forcePrepareEnding)try{endingMusic.yt&&(endingMusic.yt.setVolume(0),endingMusic.yt.playVideo(),setTimeout(function(){endingMusic.yt.seekTo(0,!0),endingMusic.yt.setVolume(100),endingMusic.yt.pauseVideo()},1e3)),forcePrepareEnding=!1}catch(e){}if(!clLocalVars.fastForward){var t=gameControls[e.keyCode];if(t){var a,n,o=document.activeElement;if(!o||"INPUT"!=o.tagName||"button"==o.type||"submit"==o.type)switch(e.preventDefault&&e.preventDefault(),t){case"up":oPlayers[0].speedinc=oPlayers[0].stats.acceleration*oPlayers[0].size,oPlayers[0].etoile&&(oPlayers[0].speedinc*=5);break;case"left":oPlayers[0].rotincdir=oPlayers[0].stats.handling,oPlayers[0].driftinc||oPlayers[0].tourne||oPlayers[0].fell||!oPlayers[0].ctrl||oPlayers[0].cannon||(oPlayers[0].jumped&&(oPlayers[0].driftinc=1),oPlayers[0].driftinc&&(clLocalVars.drifted=!0));break;case"right":oPlayers[0].rotincdir=-oPlayers[0].stats.handling,oPlayers[0].driftinc||oPlayers[0].tourne||oPlayers[0].fell||!oPlayers[0].ctrl||oPlayers[0].cannon||(oPlayers[0].jumped&&(oPlayers[0].driftinc=-1),oPlayers[0].driftinc&&(clLocalVars.drifted=!0));break;case"down":oPlayers[0].speedinc-=.2;break;case"jump":if(pause)break;oPlayers[0].ctrl=!0,oPlayers[0].z||oPlayers[0].heightinc?oPlayers[0].jumped||oPlayers[0].fell||oPlayers[0].ctrled||oPlayers[0].billball||oPlayers[0].tourne||oPlayers[0].figuring||oPlayers[0].figstate||oPlayers[0].driftinc||stuntKart(oPlayers[0]):oPlayers[0].driftinc||oPlayers[0].tourne||(oPlayers[0].z=1,oPlayers[0].heightinc=.5,oPlayers[0].jumped=!0,oPlayers[0].rotincdir&&(oPlayers[0].driftinc=0<oPlayers[0].rotincdir?1:-1),oPlayers[0].driftinc&&(clLocalVars.drifted=!0));break;case"pause":if(isOnline)break;pause?reprendre(!0):bCounting||(document.getElementById("infos0").style.display="",pause=!0,pauseSounds(),(a=document.getElementById("recommencer"))&&("CM"==course||clSelected)?a.focus():(n=document.getElementById("reprendre"))&&n.focus());break;case"balloon":if(pause)return;if("BB"==course&&oPlayers[0].tourne<5&&oPlayers[0].reserve&&oPlayers[0].ballons.length<3&&!oPlayers[0].sprite[0].div.style.opacity){for(oPlayers[0].ballons[oPlayers[0].ballons.length]=createBalloonSprite(oPlayers[0]),oPlayers[0].reserve--,document.getElementById("compteur0").innerHTML="&nbsp;",i=0;i<oPlayers[0].reserve;i++)document.getElementById("compteur0").innerHTML+='<img src="'+balloonSrc(oPlayers[0].team)+'" style="width: '+2*iScreenScale+'" />';playIfShould(oPlayers[0],"musics/events/balloon.mp3")}break;case"quit":bCounting||quitter();break;case"cheat":isOnline||"GP"==course||"CM"==course||openCheats();break;case"up_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=oPlayers[1].stats.acceleration*oPlayers[1].size,oPlayers[1].etoile&&(oPlayers[1].speedinc*=5);break;case"left_p2":if(!oPlayers[1])return;oPlayers[1].rotincdir=oPlayers[1].stats.handling,oPlayers[1].driftinc||oPlayers[1].tourne||oPlayers[1].fell||!oPlayers[1].ctrl||oPlayers[1].cannon||oPlayers[1].jumped&&(oPlayers[1].driftinc=1);break;case"right_p2":if(!oPlayers[1])return;oPlayers[1].rotincdir=-oPlayers[1].stats.handling,oPlayers[1].driftinc||oPlayers[1].tourne||oPlayers[1].fell||!oPlayers[1].ctrl||oPlayers[1].cannon||oPlayers[1].jumped&&(oPlayers[1].driftinc=-1);break;case"down_p2":if(!oPlayers[1])return;oPlayers[1].speedinc-=.2;break;case"jump_p2":if(pause)break;if(!oPlayers[1])return;return oPlayers[1].ctrl=!0,oPlayers[1].z||oPlayers[1].heightinc?oPlayers[1].jumped||oPlayers[1].ctrled||oPlayers[1].fell||oPlayers[1].billball||oPlayers[1].tourne||oPlayers[1].figuring||oPlayers[1].figstate||oPlayers[1].driftinc||stuntKart(oPlayers[1]):oPlayers[1].driftinc||oPlayers[1].tourne||(oPlayers[1].z=1,oPlayers[1].heightinc=.5,oPlayers[1].jumped=!0,oPlayers[1].rotincdir&&(oPlayers[1].driftinc=0<oPlayers[1].rotincdir?1:-1)),!1;case"balloon_p2":if(pause)return;if(!oPlayers[1])return;if("BB"==course&&oPlayers[0].tourne<5&&oPlayers[1].reserve&&oPlayers[1].ballons.length<3&&!oPlayers[1].sprite[0].div.style.opacity)for(oPlayers[1].ballons[oPlayers[1].ballons.length]=createBalloonSprite(oPlayers[1]),oPlayers[1].reserve--,document.getElementById("compteur1").innerHTML="&nbsp;",i=0;i<oPlayers[1].reserve;i++)document.getElementById("compteur1").innerHTML+='<img src="'+balloonSrc(oPlayers[1].team)+'" style="width: '+2*iScreenScale+'" />'}}}},document.onkeyup=function(e){var t=gameControls[e.keyCode];if(t){var a,n=document.activeElement;if(!n||"INPUT"!=n.tagName||"button"==n.type||"submit"==n.type)switch(t){case"item":case"item_back":oPlayers[0].tourne||oPlayers[0].cannon||pause||arme(0,"item_back"===t);break;case"up":oPlayers[0].speedinc=0;break;case"left":case"right":oPlayers[0].rotincdir=0;break;case"down":oPlayers[0].speedinc=0;break;case"jump":if(pause)break;delete oPlayers[0].ctrl,oPlayers[0].driftinc&&(oPlayers[0].driftinc=0,oPlayers[0].driftcpt>=fTurboDriftCpt&&(oPlayers[0].turbodrift=15,clLocalVars.miniTurbo++,clSelected&&clRuleVars[clSelected.id]&&(a=clRuleVars[clSelected.id].mini_turbo)&&updateChallengeHud("miniTurbo",clLocalVars.miniTurbo+a.miniTurbo),oPlayers[0].driftcpt>=fTurboDriftCpt2&&(oPlayers[0].turbodrift+=15,clLocalVars.superTurbo++,clSelected&&clRuleVars[clSelected.id]&&(a=clRuleVars[clSelected.id].super_turbo)&&updateChallengeHud("superTurbo",clLocalVars.superTurbo+a.superTurbo)),oPlayers[0].turbodrift0=oPlayers[0].turbodrift,getDriftImg(0).src="images/drift.png"),oPlayers[0].driftcpt=0,document.getElementById("drift0").style.display="none",oPlayers[0].driftSound&&(oPlayers[0].driftSound.pause(),oPlayers[0].driftSound=void 0)),oPlayers[0].ctrled=!1,oPlayers[0].jumped&&(oPlayers[0].z||oPlayers[0].heightinc)&&(oPlayers[0].ctrled=!0);break;case"rear":showRearView(0);break;case"item_p2":case"item_back_p2":oPlayers[1].tourne||oPlayers[1].cannon||pause||arme(1,"item_back_p2"===t);break;case"up_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=0;break;case"left_p2":case"right_p2":if(!oPlayers[1])return;oPlayers[1].rotincdir=0;break;case"down_p2":if(!oPlayers[1])return;oPlayers[1].speedinc=0;break;case"jump_p2":if(pause)break;if(!oPlayers[1])return;delete oPlayers[1].ctrl,oPlayers[1].driftinc&&(oPlayers[1].driftinc=0,oPlayers[1].driftcpt>=fTurboDriftCpt&&(oPlayers[1].turbodrift=15,oPlayers[1].driftcpt>=fTurboDriftCpt2&&(oPlayers[1].turbodrift+=15),oPlayers[1].turbodrift0=oPlayers[1].turbodrift,getDriftImg(1).src="images/drift.png"),oPlayers[1].driftcpt=0,document.getElementById("drift1").style.display="none",oPlayers[1].driftSound&&(oPlayers[1].driftSound.pause(),oPlayers[1].driftSound=void 0)),oPlayers[1].ctrled=!1,oPlayers[1].jumped&&(oPlayers[1].z||oPlayers[1].heightinc)&&(oPlayers[1].ctrled=!0);break;case"rear_p2":if(!oPlayers[1])return;showRearView(1)}}},window.releaseOnBlur=function(){for(var e=0;e<oPlayers.length;e++)oPlayers[e].speedinc=0,oPlayers[e].rotincdir=0,stopDrifting(e)},window.addEventListener("blur",window.releaseOnBlur),isMobile()&&(document.onmousedown=function(e){return!!pause||(!(!oPlayers[0].tourne&&!oPlayers[0].cannon)||("BB"==course?(document.onkeydown({keyCode:findKeyCode("balloon")}),!1):!oPlayers[0].arme&&!oPlayers[0].using[0]||(arme(0),!1)))}),isOnline&&(window.onbeforeunload=function(){return language?"Caution, if you leave the game, you are considered loser":"Attention, si vous quittez la partie, vous êtes considéré comme perdant"}),pause=!1,"CM"==course&&(iTrajet=new Array),clearInterval(Z),clLocalVars.delayedStart&&(oPlayers[0].speed=0,t=oPlayers[0].speedinc,oPlayers[0].speedinc=0,a=1e3*clLocalVars.delayedStart/67,pause=!0,clLocalVars.fastForward=!0,n=reprendre,reprendre=function(){},function e(){pause&&(timer<a?(setTimeout(e,1),runOneFrame()):(delete clLocalVars.fastForward,oPlayers[0].speedinc=t,(reprendre=n)(!1)))}()),cycle(),bRunning=!0}return void(fInfos=void 0)}for(var i=0;i<strPlayer.length;i++)document.getElementById("decompte"+i).innerHTML--,oPlayers[i].speed+=oPlayers[i].speedinc;(bMusic||iSfx)&&(ae.currentTime=0,ae.play())}else{for(i=0;i<strPlayer.length;i++)document.getElementById("infos"+i).style.display="";(bMusic||iSfx)&&ae.play(),document.body.style.cursor="default"}ne++,setTimeout(re,1e3)};iSfx&&!fInfos.replay&&setTimeout(startEngineSound,bMusic?2600:1100),isOnline?(oe=tnCourse-(new Date).getTime(),setTimeout(re,oe),iTeamPlay&&function(e){var t=oPlayers[0].team,a=document.createElement("div");a.style.position="absolute",a.style.zIndex=1e4,a.style.left="0px",a.style.top=12*iScreenScale+"px",a.style.width=iScreenScale*iWidth+"px",a.style.textAlign="center",a.style.fontSize=6*iScreenScale+"px",a.style.fontWeight="bold",a.style.color=t?"#F96":"#69F",a.innerHTML=toLanguage("You are ","Vous êtes ")+(t?toLanguage("red","rouge"):toLanguage("blue","bleu"));var n=Math.min(1500,e-1e3);500<n&&setTimeout(function(){oContainers[0].appendChild(a),setTimeout(function(){oContainers[0].removeChild(a)},n)},500)}(oe)):setTimeout(re,bMusic?3e3:1500),oMapImg.image&&(Z=setTimeout(function(){Z=setInterval(function(){for(var e=0;e<oPlayers.length;e++){var t=oPlayers[e];redrawCanvas(e,t.x,t.y,t.rotation)}},100)},100)),clLocalVars.backwardsStart&&showRearView(0),isOnline||(document.body.style.cursor="default")}function youtube_parser(e){var t=e.match(/.*(?:youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=)([^#\&\?]*).*/);return!(!t||11!=t[1].length)&&t[1]}var fSpriteScale=0,fLineScale=0,oContainers=[document.createElement("div")];oContainers[0].className="game-container",oContainers[0].tabindex=1,formulaire=null,updateCtnFullScreen(1==$mkScreen.dataset.fs),function(){for(var e,t=0;t<2;t++){(e=document.getElementById("infos"+t))&&$mkScreen.removeChild(e)}(e=document.createElement("table")).id="infos0",e.setAttribute("cellspacing",1),e.setAttribute("cellpadding",0),e.style.display="none",$mkScreen.appendChild(e)}(),$mkScreen.appendChild(oContainers[0]),pause&&fInfos.player[1]&&(oContainers[1]=oContainers[0].cloneNode(!1),oContainers[1].style.left=12+iWidth*iScreenScale+"px",$mkScreen.appendChild(oContainers[1]));var oScreens=new Array,aStrips=new Array,iCamHeight=24,iCamDist=32,iViewHeight=-10,fFocal=1/Math.tan(Math.PI*Math.PI/360);function resetScreen(){fSpriteScale=iScreenScale/4,fLineScale=1/iScreenScale*iQuality,aStrips=[];for(var e=0;e<strPlayer.length;e++){var t=oContainers[e];t.style.width=iWidth*iScreenScale+"px",t.style.height=iHeight*iScreenScale+"px";var a=document.createElement("canvas");a.style.position="absolute",oScreens.push(a),oContainers[e].appendChild(a),a.width=iWidth/fLineScale,a.height=iHeight/fLineScale,a.style.width=iWidth*iScreenScale+iScreenScale+"px",a.style.left=-iScreenScale/2+"px",a.style.top=iScreenScale+"px",a.style.height=iHeight*iScreenScale+"px"}for(e=0;e<oBgLayers.length;e++)oBgLayers[e].suppr();for(var n=0,o=0;o<iHeight;o+=fLineScale){var i=o+iViewHeight,r=i/((iCamHeight-i)/iCamDist),l=fFocal/(fFocal+r),s=Math.floor(iWidth/l);0<l&&s<iViewCanvasWidth&&(0==o&&(n=r-1),aStrips.push({viewy:o,mapz:r,scale:l,stripwidth:s,mapzspan:r-n}),n=r)}for(e=0;e<oMap.fond.length;e++)oBgLayers[e]=new BGLayer(oMap.fond[e],2==oMap.fond.length?1:e+1);(oViewCanvas=document.createElement("canvas")).width=iViewCanvasWidth,oViewCanvas.height=iViewCanvasHeight}function reprendre(e){setTimeout(function(){pause&&(pause=!1,cycle())},67),e&&(unpauseSounds(),document.getElementById("infos0").style.display="none")}function quitter(){if(isOnline)document.location.href=isMCups?(complete?"map":"circuit")+".php?mid="+nid:isCup?complete?(isBattle?"battle":"map")+".php?"+(isSingle?"i":"cid")+"="+nid:(isBattle?"arena":"circuit")+".php?"+(isSingle?"id":"cid")+"="+nid:"index.php";else{pause=!0,displayCommands(),removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),document.getElementById("infos"+e).style.display="none";($mkScreen.style.opacity=1)==strPlayer.length&&removePlan(),document.onmousedown=void 0,document.onkeydown=void 0,document.onkeyup=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,oBgLayers.length=0,aPlayers=[],aScores=[],clRuleVars={},clGlobalVars=void 0,setTimeout(function(){pause=!1,MarioKart()},500)}}function classement(){for(var e=aKarts.length,t=0;t<e;t++){for(var a=aKarts[t],n=aScores[t],o=1,i=0;i<e;i++){var r=aScores[i];a!=aKarts[i]&&n<=r&&(n<r||i<t)&&o++}a.place=o}for(var l=new Array,t=1;t<=e;t++)for(i=0;i<e;i++){(o=aKarts[i].place)==t&&(l.push(i),i=e)}document.getElementById("infos0").style.display="none";for(var s,c=strPlayer.length-1,t=0;t<l.length;t++){var p=l[t],u=aKarts[p].personnage,d=1==aKarts[p].team?1:0;document.getElementById("fJ"+t).style.backgroundColor=0!=p?p!=c?d?"red":"":d?"brown":"navy":rankingColor(aKarts[p].team),document.getElementById("fJ"+t).style.opacity=u!=strPlayer?"":.8,document.getElementById("j"+t).innerHTML=toPerso(u),document.getElementById("pts"+t).innerHTML=aScores[p]}if(iTeamPlay){for(var h=[0,0],t=0;t<aScores.length;t++)h[aTeams[t]]+=aScores[t];s=createTeamTable(h)}document.getElementById("octn").onclick=continuer,setTimeout(function(){document.getElementById("infos0").style.display="",s&&(s.style.visibility="visible");var e=document.body.scrollTop;document.getElementById("octn").focus(),document.body.scrollTop=e},500)}function createTeamTable(e){var t=e[0]>e[1]||e[0]==e[1]&&e[0]==oPlayers[0].team?[0,1]:[1,0],a=document.createElement("table");a.id="team-table";for(var n='<tr style="font-size: '+2*iScreenScale+'px; background-color: white; color: black;"><td>Places</td><td>'+toLanguage("Team","Équipe")+"</td><td>Pts</td></tr>",o=0;o<t.length;o++){var i=t[o];n+='<tr id="fJ'+o+'" style="background-color:'+(i?"red":"blue")+'"><td>'+toPlace(o+1)+' </td><td class="maj" id="j'+o+'">'+(i?toLanguage("Red","Rouge"):toLanguage("Blue","Bleue"))+'</td><td id="pts'+o+'">'+e[i]+"</td></tr>"}return a.style.visibility="hidden",a.style.position="absolute",a.style.zIndex=2e4,a.style.left=3*iScreenScale+10+"px",a.style.top=10*iScreenScale+"px",a.style.backgroundColor="blue",a.style.color=primaryColor,a.style.opacity=.7,a.style.textAlign="center",a.style.fontSize=Math.round(1.5*iScreenScale+4)+"pt",a.style.fontFamily="Courier",a.style.fontWeight="bold",a.style.fontFamily="arial",a.innerHTML=n,$mkScreen.appendChild(a),a}function resetScores(){for(var e=0;e<strPlayer.length;e++)aPlaces[e]=aPlayers.length+e+1;for(e=0;e<aPlayers.length;e++)aPlaces[e+strPlayer.length]=e+1;clGlobalVars=void 0;var t=!(clRuleVars={});aScores.length=aPlaces.length;for(e=0;e<aScores.length;e++)0!==aScores[e]&&(t=!0,aScores[e]=0);return t}function continuer(){document.getElementById("infos0").style.border=0,document.getElementById("infos0").style.top=10*iScreenScale+10+"px",document.getElementById("infos0").style.left=Math.round(20*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.background="transparent",document.getElementById("infos0").style.fontSize=4*iScreenScale+"pt",document.getElementById("infos0").innerHTML='<tr><td id="continuer"></td></tr><tr><td'+("CM"!=course?' style="font-size: '+3*iScreenScale+'px;">&nbsp;</td></tr>':' id="enregistrer"></td></tr><tr><td id="revoir"></td></tr><tr><td id="classement"></td></tr><tr><td id="changercircuit">')+'</td></tr><tr><td><input type="button" id="quitter" value="'+toLanguage("QUIT","QUITTER")+'" style="font-size: '+3*iScreenScale+'pt; width: 100%;" /></td></tr>';var oTeamTable=document.getElementById("team-table");oTeamTable&&$mkScreen.removeChild(oTeamTable);var oContinue=document.createElement("input"),forceClic3,oQuit,oSave,oReplay,oChangeRace,oClassement;function nextRace(){pause=!0,removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),document.getElementById("infos"+e).style.display="none";fInfos={player:strPlayer,difficulty:iDificulty,cl:clSelected},"GP"==course&&(fInfos.map=oMap.ref+1),($mkScreen.style.opacity=1)==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,setTimeout(MarioKart,500)}oContinue.type="button",oContinue.style.fontSize=3*iScreenScale+"pt",oContinue.style.width="100%","CM"!=course?oMap.ref%4||"GP"!=course?(isSingle&&!isOnline?oContinue.value="        "+toLanguage("  REPLAY","REJOUER")+"        ":"BB"==course?oContinue.value=toLanguage("      NEXT BATTLE\t   ","BATAILLE SUIVANTE"):oContinue.value=toLanguage("       NEXT RACE\t   ","COURSE SUIVANTE"),forceClic3=!0,oContinue.onclick=function(){forceClic3=!1,nextRace()},isOnline&&setTimeout(function(){forceClic3&&nextRace()},5e3)):(oContinue.value=toLanguage("           NEXT           ","         SUIVANT          "),oContinue.onclick=function(){$mkScreen=document.body,pause=!0;var posX=[29,22,36],posY=[15,17,19],oPlace;document.body.innerHTML=toLanguage("You are","Vous &ecirc;tes")+' <span id="position"></span> !<br /><a href="javascript:location.reload()" style="color: white;">'+toLanguage("Back","Retour")+'</a><img alt="." src="images/podium.gif" style="position: absolute; left: '+20*iScreenScale+"px; top: "+20*iScreenScale+"px; width: "+24*iScreenScale+'px;" />';for(var placement=new Array,i=1;i<=aKarts.length;i++)for(var j=0;j<aKarts.length;j++)aKarts[j].place==i&&(placement.push(aKarts[j].personnage),j=aKarts.length);document.body.style.fontSize=2*iScreenScale+"pt";for(var i=0,saveUrl,saveParams;i<placement.length;i++)placement[i]==strPlayer&&(oPlace=i+1),i<3?document.body.innerHTML+='<img alt="." src="'+getWinnerSrc(placement[i])+'" style="width: '+4*iScreenScale+"px; position: absolute; left: "+iScreenScale*posX[i]+"px; top: "+iScreenScale*(posY[i]+(isCustomPerso(placement[i])?6:0))+"px;"+(isCustomPerso(placement[i])?"transform:translateY(-100%);-webkit-transform:translateY(-100%);-moz-transform:translateY(-100%);-o-transform:translateY(-100%);-ms-transform:translateY(-100%);":"")+'" />':oPlace&&(i=placement.length);document.getElementById("position").innerHTML=toPlace(oPlace),oPlace<=3?(document.body.innerHTML+='<img alt="." src="images/cups/cup'+oPlace+'.png" style="width: '+3*iScreenScale+"px; position: absolute; left: "+30*iScreenScale+"px; top: "+25*iScreenScale+'px;" />',saveParams="pts="+(4-oPlace),"MK"==page?(saveUrl="saveGP.php",saveParams+="&change="+(oMap.map-4)/4):nid&&(saveUrl="cupsave.php",saveParams+=isMCups?"&cup="+cupIDs[oMap.ref/4-1]:"&cup="+nid),saveUrl&&xhr(saveUrl,saveParams,function(reponse){if(reponse){var newPerso,uwPerso,uwPerso;try{newPerso=eval(reponse)}catch(e){return!1}return newPerso&&(uwPerso=toPerso(newPerso),uwPerso=uwPerso.charAt(0).toUpperCase()+uwPerso.substring(1),document.body.innerHTML+='<div style="position: absolute; left: '+16*iScreenScale+"px; top: "+30*iScreenScale+'px; text-align: center">'+toLanguage("You can now play<br />with "+uwPerso+" !","Vous pouvez d&eacute;sormais<br />jouer avec "+uwPerso+" !")+'<br /><img src="'+getWinnerSrc(newPerso)+'" style="width: '+4*iScreenScale+'px" /></div>'),!0}return!1}),bMusic&&(endGPMusic=startMusic("musics/menu/congrats.mp3",!0,700))):bMusic&&(endGPMusic=startMusic("musics/menu/toobad.mp3",!0,700)),reinitChallengeVars(),clLocalVars.endGP=!0,challengeCheck("end_gp",["finish_gp"])}):(oQuit=document.getElementById("quitter"),oContinue.style.fontSize=oQuit.style.fontSize=3*iScreenScale+"px",oSave=oContinue.cloneNode(!1),oReplay=oContinue.cloneNode(!1),oChangeRace=oContinue.cloneNode(!1),oClassement=oContinue.cloneNode(!1),oContinue.value=gSelectedPerso?toLanguage("        FACE WITH        ","     AFFRONTER     "):toLanguage("          RETRY          ","     RÉESSAYER     "),oContinue.onclick=function(){pause=!0,removeGameMusics(),removeHUD(),clearResources(),$mkScreen.removeChild(oContainers[0]),fInfos={player:strPlayer,map:oMap.ref,difficulty:iDificulty,perso:gPersos,cpu_route:jTrajets,my_record:gRecord,ow_record:gOverwriteRecord,lap_times:iLapTimes,cl:clSelected},gSelectedPerso?(fInfos.player=[gSelectedPerso],fInfos.perso=[strPlayer[0]],fInfos.cpu_route=[iTrajet]):2==gOverwriteRecord&&lapTimers.length==oMap.tours&&(fInfos.cpu_route=[iTrajet],fInfos.perso=strPlayer,fInfos.lap_times=lapTimers),document.getElementById("infos0").style.display="none",1==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,setTimeout(MarioKart,500)},oSave.value="   "+toLanguage("SAVE","ENREGISTRER")+"   ",oSave.onclick=function(){document.getElementById("infos0").style.display="none";var oForm=document.createElement("form");oForm.style.color="black",oForm.style.position="absolute",oForm.style.left=5*iScreenScale+10+"px",oForm.style.top=5*iScreenScale+10+"px",oForm.style.fontSize=4*iScreenScale+"pt",oForm.style.backgroundColor="#FF6",oForm.style.opacity=.8,oForm.style.border="double 4px black",oForm.style.textAlign="center",oForm.style.width=70*iScreenScale-10+"px",oForm.style.zIndex=2e4,oForm.onsubmit=function(){var nom=this.pseudo.value;if(nom){document.body.style.cursor="progress",oValide.style.visibility="hidden",aPara2.style.visibility="hidden";var params="name="+nom+"&perso="+strPlayer[0]+"&time="+getActualGameTimeMS();switch(page){case"MK":params+="&circuit="+oMap.map;break;case"CI":params+="&creation="+oMap.id;break;case"MA":params+="&map="+oMap.map}xhr("records.php",params,function(reponse){if(reponse){var enregistre;document.body.style.cursor="default";try{enregistre=eval(reponse)}catch(e){return!1}function showBackUi(e){oInput.disabled=!0,oCheckbox.disabled=!0,oValide.parentNode.removeChild(oValide),aPara2.style.fontSize=Math.round(2.5*iScreenScale)+"px",e&&(aPara2.innerHTML=toLanguage("Congratulations "+nom+", your score has been saved successfully ! You places ","F&eacute;licitations "+nom+", votre score a bien &eacute;t&eacute; enregistr&eacute; ! Vous &ecirc;tes ")+toPlace(enregistre[0])+toLanguage(" out of "+enregistre[1]+" in this race !"," sur "+enregistre[1]+" au classement de ce circuit !"),oSave.style.display="none"),aPara2.style.visibility="",oRetour.focus()}if(Array.isArray(enregistre))if(oCheckbox.checked){oSave.style.display="none",oValide.style.display="none";var aSmall=document.createElement("span");aSmall.style.fontSize=Math.round(2.5*iScreenScale)+"px",aSmall.innerHTML=toLanguage("Saving ghost...","Enregistrement du fantôme..."),aPara2.appendChild(aSmall),aPara2.style.visibility="";var oRequest="map="+oMap.map+"&perso="+strPlayer[0]+"&time="+getActualGameTimeMS()+"&times="+JSON.stringify(lapTimers);for(i=0;i<iTrajet.length;i++)oRequest+="&p"+i+"="+iTrajet[i].toString().replace(/\,/g,"_");xhr("saveghost.php",oRequest,function(e){return 1==e&&(gRecord=getActualGameTimeMS(),gOverwriteRecord=gOverwriteRecord&&2,showBackUi(!0),!0)})}else showBackUi(!0);else{switch(showBackUi(!1),enregistre){case 0:aPara2.innerHTML=toLanguage("You did a better score on this race before.<br />Your score has not been registered.","Vous avez fait un meilleur score sur ce circuit.<br />Votre temps n'a donc pas &eacute;t&eacute; enregistr&eacute;.");break;case 1:aPara2.innerHTML=toLanguage('This nick is already used, please choose another one. If it\'s you, <a href="forum.php" target="_blank" style="color: orange">log-in</a> to your account and try again.','Ce pseudo est déjà utilisé, veuillez en choisir un autre. S\'il s\'agit de vous, <a href="forum.php" target="_blank" style="color: orange">connectez-vous</a> et réessayez.');break;default:aPara2.innerHTML=toLanguage("An unknown error occured, please try again later","Une erreur inconnue est survenue, veuillez réessayer ultérieurement")}0!=enregistre&&(oValide.style.visibility="",oValide.style.marginRight=2*iScreenScale+"px",aPara3.insertBefore(oValide,oRetour),oCheckbox.disabled=!1,oInput.disabled=!1,oInput.select())}return!0}return!1}),recorder=nom}return!1};var aPara1=document.createElement("p");aPara1.innerHTML=toLanguage("Nick : ","Pseudo : "),aPara1.style.margin=iScreenScale+"px";var oInput=document.createElement("input");oInput.type="text",oInput.name="pseudo",oInput.value=recorder,oInput.size=15,oInput.maxlength=18,oInput.style.fontSize=3*iScreenScale+"px",oInput.onkeydown=function(e){e.stopPropagation()},oInput.onkeyup=function(e){e.stopPropagation()},aPara1.appendChild(oInput);var aPara12=aPara1.cloneNode(!1),oCheckLabel=document.createElement("label");oCheckLabel.style.display="inline-block";var oCheckbox=document.createElement("input");oCheckbox.type="checkbox",oCheckbox.name="saveghost",oCheckbox.checked=!0,oCheckbox.style.transform=oCheckbox.style.WebkitTransform=oCheckbox.style.MozTransform="scale("+(iScreenScale/6).toFixed(1)+")",oCheckLabel.appendChild(oCheckbox);var oCheckSpan=document.createElement("span");oCheckSpan.style.fontSize=2*iScreenScale+"px",oCheckSpan.innerHTML=" "+toLanguage("Save ghost","Enregistrer le fantôme"),oCheckLabel.appendChild(oCheckSpan),aPara12.appendChild(oCheckLabel),("MK"!=page||gRecord<=timerMS)&&(oCheckbox.checked=!1,aPara12.style.display="none");var aPara2=aPara1.cloneNode(!1),oValide=document.createElement("input");oValide.type="submit",oValide.value="     "+toLanguage("Submit","Valider")+"     ",oValide.style.fontSize=5*iScreenScale+"px",oValide.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",oRetour.style.fontSize=4*iScreenScale+"px"},aPara2.appendChild(oValide);var aPara3=aPara1.cloneNode(!1),oRetour=document.createElement("input");oRetour.type="button",oRetour.value="     "+toLanguage("Back","Retour")+"     ",oRetour.style.fontSize=4*iScreenScale+"px",oRetour.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",oValide.style.fontSize=4*iScreenScale+"px"},oRetour.onclick=function(){$mkScreen.removeChild(oForm),document.getElementById("infos0").style.display="",oContinue.focus()},aPara3.appendChild(oRetour),oForm.appendChild(aPara1),oForm.appendChild(aPara12),oForm.appendChild(aPara2),oForm.appendChild(aPara3),$mkScreen.appendChild(oForm),oForm.style.height=oForm.scrollHeight+"px",oInput.select()},gSelectedPerso&&(oSave.style.display="none"),document.getElementById("enregistrer").appendChild(oSave),oReplay.value=toLanguage("REPLAY","REVOIR"),oReplay.onclick=function(){pause=!0,removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),null==(fInfos={player:strPlayer,map:oMap.ref,my_route:iTrajet,replay:!0,perso:gPersos,selPerso:gSelectedPerso,cpu_route:jTrajets,my_record:gRecord,ow_record:gOverwriteRecord,record:timerMS,lap_times:iLapTimes,cl:clSelected}).record&&(fInfos.record=iRecord),null==fInfos.lap_times&&(fInfos.lap_times=lapTimers),document.getElementById("infos"+e).style.display="none";1==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,setTimeout(MarioKart,500)},document.getElementById("revoir").appendChild(oReplay),oChangeRace.value=toLanguage("     CHANGE RACE     ","   CHANGER CIRCUIT   "),oChangeRace.onclick=function(){pause=!0,removeGameMusics(),removeHUD(),clearResources();for(var e=0;e<strPlayer.length;e++)$mkScreen.removeChild(oContainers[e]),document.getElementById("infos"+e).style.display="none";fInfos={player:strPlayer,perso:new Array,cl:clSelected},gSelectedPerso&&(fInfos.player=[gSelectedPerso]),1==strPlayer.length&&removePlan(),oBgLayers.length=0,document.onmousedown=void 0,setTimeout(MarioKart,500)},document.getElementById("changercircuit").appendChild(oChangeRace),oClassement.value="RECORDS",oClassement.onclick=function(){open(rankingsLink(oMap))},gSelectedPerso&&(oClassement.style.display="none"),document.getElementById("classement").appendChild(oClassement)),document.getElementById("continuer").appendChild(oContinue),document.getElementById("quitter").onclick=quitter,isChatting()||oContinue.focus()}function rankingColor(e){switch(e){case 0:return"#69F";case 1:return"#F96";default:return"#990"}}var iViewCanvasHeight=240,iViewCanvasWidth=600,iViewYOffset=10,oViewCanvas;function Sprite(e){for(var s=new Array,t=0;t<strPlayer.length;t++){this[t]={};var a=new Image;a.style.position="absolute",a.style.left="200px",a.alt=".",a.className="pixelated",a.src=getSpriteSrc(e);var n=document.createElement("div");n.style.width="32px",n.style.height="32px",n.style.position="absolute",n.style.overflow="hidden",n.style.zIndex=1e4,n.className="pixelated",n.style.display="none",n.appendChild(a),oContainers[t].appendChild(n),this[t].i=t,this[t].w=32,this[t].h=32,this[t].z=0,this[t].draw=function(e,t,a,n){n=n||0;var o=this.i,i=this.w*fSpriteScale*a,r=this.h*fSpriteScale*a,l=t-r*this.z-(r-i)/2;isNaN(l)||l>iHeight*iScreenScale||t+n*iScreenScale<9*iScreenScale?s[o][0].style.display="none":(s[o][0].style.display="block",s[o][0].style.left=Math.round(e-i/2)+"px",s[o][0].style.top=Math.round(l-r/2)+"px",this.h!=this.w?s[o][1].style.width=Math.round(i)*this.nbSprites+"px":s[o][1].style.width="",s[o][1].style.height=Math.round(r)+"px",s[o][0].style.width=Math.round(i)+"px",s[o][0].style.height=Math.round(r)+"px",s[o][1].style.left=-(Math.round(i)*s[o][2])+"px")},this[t].setState=function(e){s[this.i][2]=e},this[t].getState=function(){return s[this.i][2]},this[t].div=n,this[t].img=a,s.push([n,a,0])}var o=this;this[0].unshow=function(){o[0].suppr(),o[0].unshown=!0},this[0].suppr=function(){if(!o[0].unshown)for(var e=0;e<strPlayer.length;e++)oContainers[e].removeChild(s[e][0])}}function BGLayer(e,n){var o=new Array,i=new Image;i.src="images/map_bg/fond_"+e+".png",iSmooth||(i.className="pixelated");for(var t=0;t<oContainers.length;t++)o[t]=document.createElement("div"),o[t].style.height=10*iScreenScale+"px",o[t].style.width=iWidth*iScreenScale+"px",o[t].style.position="absolute",function(e){setTimeout(function(){e.style.backgroundImage="url('"+i.src+"')"},500)}(o[t]),o[t].style.backgroundSize="auto 100%",iSmooth||(o[t].className="pixelated"),oContainers[t].appendChild(o[t]);return{draw:function(e,t){var a;i.naturalWidth&&(a=(e-360*Math.ceil(e/360))*(10*iScreenScale*i.naturalWidth/i.naturalHeight*n/360),o[t].style.backgroundPosition=Math.round(a)+"px 0")},suppr:function(){for(var e=0;e<strPlayer.length;e++)oContainers[e].removeChild(o[e])}}}function GIF(){var a,n,o,i,d,r,m,l=[0,4,2,1],s=[8,8,4,2],c={GCExt:249,COMMENT:254,APPExt:255,UNKNOWN:1,IMAGE:44,EOF:59,EXT:33},p=function(e){this.data=new Uint8ClampedArray(e),this.pos=0;var n=this.data.length;this.getString=function(e){for(var t="";e--;)t+=String.fromCharCode(this.data[this.pos++]);return t},this.readSubBlocks=function(){var e,t,a="";do{for(t=e=this.data[this.pos++];t--;)a+=String.fromCharCode(this.data[this.pos++])}while(0!==e&&this.pos<n);return a},this.readSubBlocksB=function(){var e,t,a=[];do{for(t=e=this.data[this.pos++];t--;)a.push(this.data[this.pos++])}while(0!==e&&this.pos<n);return a}};function u(e){for(var t=[],a=0;a<e;a++)t.push([o.data[o.pos++],o.data[o.pos++],o.data[o.pos++]]);return t}function t(){var e,t=function(e){var t,a=r/e,n=0;for(i!==r&&(d=new Uint8Array(r),i=r),t=0;t<4;t++)for(toLine=l[t];toLine<a;toLine+=s[t])d.set(m.subArray(n,n+e),toLine*e),n+=e},a={};M.frames.push(a),a.disposalMethod=M.disposalMethod,a.time=M.length,a.delay=10*M.delayTime,M.length+=a.delay,M.transparencyGiven?a.transparencyIndex=M.transparencyIndex:a.transparencyIndex=void 0,a.leftPos=o.data[o.pos++]+(o.data[o.pos++]<<8),a.topPos=o.data[o.pos++]+(o.data[o.pos++]<<8),a.width=o.data[o.pos++]+(o.data[o.pos++]<<8),a.height=o.data[o.pos++]+(o.data[o.pos++]<<8),e=o.data[o.pos++],a.localColourTableFlag=!!(128&e),a.localColourTableFlag&&(a.localColourTable=u(1<<1+(7&e))),r!==a.width*a.height&&(m=new Uint8Array(a.width*a.height),r=a.width*a.height),function(e,t){for(var a,n,o,i,r,l,s=n=0,c=[],p=1<<e,u=1+p,d=e+1,h=!1;!h;){for(i=o,a=o=0;a<d;a++)t[s>>3]&1<<(7&s)&&(o|=1<<a),s++;if(o===p){for(c=[],d=e+1,a=0;a<p;a++)c[a]=[a];c[p]=[],c[u]=null}else{if(o===u)return h=!0;for(o>=c.length?c.push(c[i].concat(c[i][0])):i!==p&&c.push(c[i].concat(c[o][0])),l=(r=c[o]).length,a=0;a<l;a++)m[n++]=r[a];c.length===1<<d&&d<12&&d++}}}(o.data[o.pos++],o.readSubBlocksB()),64&e?(a.interlaced=!0,t(a.width)):a.interlaced=!1,function(e){var t,a,n,o,i,r,l,s,c,p,u;e.image=document.createElement("canvas"),e.image.width=M.width,e.image.height=M.height,e.image.ctx=e.image.getContext("2d"),t=e.localColourTableFlag?e.localColourTable:M.globalColourTable,null===M.lastFrame&&(M.lastFrame=e);(r=2===M.lastFrame.disposalMethod||3===M.lastFrame.disposalMethod)||e.image.ctx.drawImage(M.lastFrame.image,0,0,M.width,M.height);a=e.image.ctx.getImageData(e.leftPos,e.topPos,e.width,e.height),u=e.transparencyIndex,n=a.data,c=e.interlaced?d:m;for(o=c.length,l=i=0;l<o;l++)s=c[l],p=t[s],u!==s?(n[i++]=p[0],n[i++]=p[1],n[i++]=p[2],n[i++]=255):(r&&(n[i+3]=0),i+=4);e.image.ctx.putImageData(a,e.leftPos,e.topPos),M.lastFrame=e,M.waitTillDone||"function"!=typeof M.onload||S()}(a)}function h(){M.loading=!1,M.frameCount=M.frames.length,M.lastFrame=null,o=void 0,M.complete=!0,M.disposalMethod=void 0,M.transparencyGiven=void 0,M.delayTime=void 0,M.transparencyIndex=void 0,M.waitTillDone=void 0,d=r=d=m=void 0,(M.currentFrame=0)<M.frames.length&&(M.image=M.frames[0].image,"function"==typeof M.onloadone&&(M.onloadone.bind(M)({type:"load",path:[M]}),delete M.onloadone)),S(),"function"==typeof M.onloadall&&M.onloadall.bind(M)({type:"loadall",path:[M]}),M.playOnLoad&&M.play()}function g(){var e,t=o.data[o.pos++];t===c.GCExt?(o.pos++,e=o.data[o.pos++],M.disposalMethod=(28&e)>>2,M.transparencyGiven=!!(1&e),M.delayTime=o.data[o.pos++]+(o.data[o.pos++]<<8),M.transparencyIndex=o.data[o.pos++],o.pos++):t===c.COMMENT?M.comment+=o.readSubBlocks():t===c.APPExt?(o.pos+=1,"NETSCAPE"===o.getString(8)?o.pos+=8:(o.pos+=3,o.readSubBlocks())):(t===c.UNKNOWN&&(o.pos+=13),o.readSubBlocks())}function y(){if(void 0!==M.cancel&&!0===M.cancel)return h(),void("function"==typeof M.cancelCallback&&M.cancelCallback.bind(M)({type:"canceled",path:[M]}));var e=o.data[o.pos++];if(e===c.IMAGE){if(t(),M.firstFrameOnly)return void h()}else{if(e===c.EOF)return void h();g()}M.frames.length&&"function"==typeof M.onloadone&&(M.image=M.frames[0].image,M.onloadone.bind(M)({type:"load",path:[M]}),delete M.onloadone),"function"==typeof M.onprogress&&M.onprogress({bytesRead:o.pos,totalBytes:o.data.length,frame:M.frames.length}),n=setTimeout(y,0)}function f(e){"function"==typeof M.onerror&&M.onerror.bind(this)({type:e,path:[this]}),M.onload=M.onerror=void 0,M.loading=!1}function S(){M.currentFrame=0,M.nextFrameAt=M.lastFrameAt=(new Date).valueOf(),"function"==typeof M.onload&&M.onload.bind(M)({type:"load",path:[M]}),M.onerror=M.onload=void 0}function v(e){var t;(o=new p(e)).pos+=6,M.width=o.data[o.pos++]+(o.data[o.pos++]<<8),M.height=o.data[o.pos++]+(o.data[o.pos++]<<8),t=o.data[o.pos++],M.colorRes=(112&t)>>4,M.globalColourCount=1<<1+(7&t),M.bgColourIndex=o.data[o.pos++],o.pos++,128&t&&(M.globalColourTable=u(M.globalColourCount)),n=setTimeout(y,0)}function b(){var e,t;0!==M.playSpeed?(e=M.playSpeed<0?(--M.currentFrame,M.currentFrame<0&&(M.currentFrame=M.frames.length-1),t=M.currentFrame,--t<0&&(t=M.frames.length-1),-M.frames[t].delay/M.playSpeed):(M.currentFrame+=1,M.currentFrame%=M.frames.length,M.frames[M.currentFrame].delay/M.playSpeed),M.image=M.frames[M.currentFrame].image,a=setTimeout(b,e)):M.pause()}var M={onload:null,onerror:null,onprogress:null,onloadall:null,paused:!1,playing:!1,waitTillDone:!0,loading:!1,firstFrameOnly:!1,width:null,height:null,frames:[],comment:"",length:0,currentFrame:0,frameCount:0,playSpeed:1,lastFrame:null,image:null,playOnLoad:!0,load:function(e){var t=new XMLHttpRequest;t.responseType="arraybuffer",t.onload=function(e){404===e.target.status?f("File not found"):200<=e.target.status&&e.target.status<300?v(t.response):f("Loading error : "+e.target.status)},t.open("GET",e,!0),t.send(),t.onerror=function(e){f("File error")},this.src=e,this.loading=!0},cancel:function(e){return!M.complete&&(M.cancelCallback=e,M.cancel=!0)},play:function(){M.playing||(M.paused=!1,M.playing=!0,b())},pause:function(){M.paused=!0,M.playing=!1,clearTimeout(a)},seek:function(e){clearTimeout(a),e<0&&(e=0),e*=1e3,e%=M.length;for(var t=0;e>M.frames[t].time+M.frames[t].delay&&t<M.frames.length;)t+=1;M.currentFrame=t,M.playing?b():M.image=M.frames[M.currentFrame].image},seekFrame:function(e){clearTimeout(a),M.currentFrame=e%M.frames.length,M.playing?b():M.image=M.frames[M.currentFrame].image},togglePlay:function(){M.paused||!M.playing?M.play():M.pause()},clear:function(){clearTimeout(a),clearTimeout(n),M.frames.length=0}};return M}function createMarker(l){for(var e={div:new Array},t=0;t<strPlayer.length;t++){var a=document.createElement("div");a.style.display="none",a.style.position="absolute",a.style.opacity=.7;var n=-1==l.team?"#EEE":1==l.team?"red":"blue",o=12*iScreenScale,i=3*iScreenScale,r=Math.PI/4,s=Math.round(iScreenScale/4),c=Math.cos(r),p=Math.sin(r),u=document.createElement("div");u.style.position="absolute",u.style.width=s+"px",u.style.height=i+"px",u.style.backgroundColor=n,u.style.left="0px",u.style.bottom="0px",u.style.transform=u.style.WebkitTransform=u.style.MozTransform="rotate("+Math.round(180*r/Math.PI)+"deg)",u.style.transformOrigin=u.style.WebkitTransformOrigin=u.style.MozTransformOrigin="bottom left",a.appendChild(u);var d=document.createElement("div");d.style.position="absolute",d.style.width=o+"px",d.style.height=s+"px",d.style.backgroundColor=n,d.style.left=Math.round(i*Math.sin(r))+"px",d.style.bottom=Math.round(i*c-s*p)+"px",a.appendChild(d);var h=document.createElement("div");h.style.color=-1==l.team?"#555":n,h.style.whiteSpace="nowrap";var m=-1==l.team?"#EEE":1==l.team?"#fcc":"#ccf",g=Math.ceil(iScreenScale/4)+"px";h.style.textShadow="-"+g+" 0 "+m+", 0 "+g+" "+m+", "+g+" 0 "+m+", 0 -"+g+" "+m,l.nick?h.innerHTML=l.nick:(h.style.textTransform="capitalize",h.innerHTML=toPerso(l.personnage)),h.style.position="absolute",h.style.left=Math.round(i*p)+"px",h.style.bottom=Math.round(i*c)+"px",h.style.width=Math.round(o-.5*iScreenScale)+"px",h.style.overflow="hidden",h.style.fontSize=Math.round(1.5*iScreenScale)+"px",h.style.textAlign="right",a.appendChild(h),e.div.push(a),oContainers[t].appendChild(a)}return e.draw=function(e,t,a,n,o){o=o||0;var i,r=this.div[e];a>iHeight*iScreenScale||a+o*iScreenScale<12*iScreenScale?r.style.display="none":(r.style.display="block",i=Math.round(l.sprite[e].h*fSpriteScale*n),r.style.left=Math.round(t)+"px",r.style.top=Math.round(a-i/2)+"px")},e}function redrawCanvas(e,t,a,n){var o=oViewCanvas.getContext("2d");o.fillStyle="rgb("+oMap.bgcolor+")",o.fillRect(0,0,oViewCanvas.width,oViewCanvas.height),o.save(),o.translate(iViewCanvasWidth/2,iViewCanvasHeight-iViewYOffset),o.rotate((180+n)*Math.PI/180),oMapImg.image?o.drawImage(oMapImg.image,-t,-a):o.drawImage(oMapImg,-t,-a);for(var i=0;i<oMap.assets.length;i++){var r=oMap.assets[i];o.drawImage(r.canvas,r.x-t,r.y-a)}o.restore(),oScreens[e].getContext("2d").imageSmoothingEnabled=iSmooth;for(var l=oScreens[e].getContext("2d"),s=1/fLineScale,c=iViewCanvasHeight-iViewYOffset-1,p=iWidth*s,i=0;i<aStrips.length;i++){var u=aStrips[i];try{l.drawImage(oViewCanvas,(iViewCanvasWidth-u.stripwidth)/2,c-u.mapz,u.stripwidth,u.mapzspan,0,(iHeight-u.viewy)*s,p,1)}catch(e){}}}var decorBehaviors={taupe:{spin:20,init:function(e,t,a){3<e.length||(e[3]=0,e[4]=a%2?9:0)},move:function(e){if(e[4]++,0<=e[4])if(e[4]){if(e[3]+=e[4]<4?2:-1,10==e[4]){e[4]=-20,e[3]=10;for(var t=0;t<oPlayers.length;t++)e[2][t].img.style.display="none"}}else{for(t=0;t<oPlayers.length;t++)e[2][t].img.style.display="block";e[3]=0}}},poisson:{spin:20,movable:!0,preinit:function(e){this.scope={limite:new Array};for(var t=0;t<e.length;t++)this.scope.limite[t]=[0,0]},init:function(e,t,a){3<e.length||(e[3]=[3,0][a%2],e[4]=[-1,1][a%2])},move:function(e,t){if(e[3]+=e[4],e[3]){if(3==e[3]){e[4]=-1;for(var a=0;a<2;a++){var n=Math.floor(9*Math.random())-4;10<Math.abs(this.scope.limite[t][a]+n)&&(n=-n),this.scope.limite[t][a]+=n,e[a]+=n}}}else e[4]=1}},cheepcheep:{spin:20,movable:!0,preinit:function(e){this.preinit=decorBehaviors.poisson.preinit.bind(this),this.init=decorBehaviors.poisson.init.bind(this),this.move_=decorBehaviors.poisson.move.bind(this),this.preinit(e)},move:function(e,t,a){if(this.move_(e,t,a),e[3]%3==0)for(var n=0;n<oPlayers.length;n++)e[2][n].setState(e[3]?1:0)}},plante:{spin:20,init:function(e,t,a){3<e.length||(e[3]=void 0,e[4]=(1+2*a)%8)},move:function(e){if(e[4]++,4==e[4])for(var t=0;t<oPlayers.length;t++)e[2][t].setState(1);else if(8==e[4]){for(t=0;t<oPlayers.length;t++)e[2][t].setState(0);e[4]=0}}},thwomp:{spin:20,init:function(e,t,a){3<e.length||(e[3]=[20,0][a%2],e[4]=[0,10][a%2])},move:function(e){e[4]<0?(e[4]++,e[4]||(e[4]=-1,e[3]<20?e[3]+=2:e[4]=20)):e[4]?e[4]--:(e[3]-=8,e[3]<0&&(e[3]=0,e[4]=-15))}},spectre:{spin:20,init:function(e,t,a){decorBehaviors.thwomp.init(e,t,a)},move:function(e){decorBehaviors.thwomp.move(e)}},tree:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=50,e[2][t].h=100,e[2][t].z=.12}},crabe:{spin:20,movable:!0,transparent:!0,init:function(e,t,a){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=3,e[2][n].h=30,e[2][n].w=16*e[2][n].h/17;null==e[4]&&(e[4]=1e4*Math.sin(a+1)%Math.PI);var o=e[5];for(null==o&&(o=137*a%400),e[5]=0;e[5]!=o;)this.move(e)},hSpeed:.7,handleState:function(e,t){if(0==(t%=16))for(var a=0;a<strPlayer.length;a++)e[2][a].setState(0);else if(4==t||12==t)for(a=0;a<strPlayer.length;a++)e[2][a].setState(1);else if(8==t)for(a=0;a<strPlayer.length;a++)e[2][a].setState(2)},move:function(e){var t,a,n=e[5]+50,o=Math.min(n%100,99-n%100);5<=o&&(t=this.hSpeed*Math.cos(e[4]),a=this.hSpeed*Math.sin(e[4]),o<8&&(t*=.5,a*=.5),this.handleState(e,n),n%200<100?(e[0]+=t,e[1]+=a):(e[0]-=t,e[1]-=a)),e[5]++,400<=e[5]&&(e[5]=0)}},goomba:{spin:20,movable:!0,transparent:!0,dodgable:!0,preinit:function(e){this.init_=decorBehaviors.crabe.init.bind(this),this.move=decorBehaviors.crabe.move.bind(this)},init:function(e,t,a){this.init_(e,t,a);for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=2,e[2][n].w=32,e[2][n].h=36},handleState:function(e,t){if(0==(t%=8))for(var a=0;a<strPlayer.length;a++)e[2][a].setState(0);else if(4==t)for(a=0;a<strPlayer.length;a++)e[2][a].setState(1)},hSpeed:.3},firesnake:{spin:42,minSpeedToSpin:3.2,unbreaking:!0,movable:!0,transparent:!0,dodgable:!0,hitbox:6,hitboxH:7,init:function(e,t,a){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=3,e[2][n].img.style.display="none";e[3]=10,e[4]||(e[4]=(1+50*a)%280),e[5]||(e[5]=0),e[6]||(e[6]=0),e[7]=[e[0],e[1]],e[8]=[e[0],e[1]],e[9]=[e[0],e[1]],e[0]=-10,e[1]=-10},move:function(e,t,a){var n=timer+a;switch(oPlayers[0].cpu&&(n=1e4*Math.random()),e[5]){case 0:if(e[4]--,e[4]<=0){for(var o=0;o<strPlayer.length;o++)e[2][o].img.style.display="block";e[0]=e[7][0]+10*Math.sin(n),e[1]=e[7][1]+10*Math.sin(n+1),e[8][0]=e[0],e[8][1]=e[1],e[9][0]=e[0]+10*Math.sin(n+2),e[9][1]=e[1]+10*Math.sin(n+3),e[3]=50,e[5]=1}break;case 1:if(e[3]-=4,e[3]<=0){e[3]=0,e[4]=20,e[5]=2,e[6]=5;for(o=0;o<strPlayer.length;o++)e[2][o].setState(1)}var i=e[3]/40;e[9][0]+=i*(e[8][0]-e[9][0]),e[9][1]+=i*(e[8][1]-e[9][1]),e[0]=e[9][0],e[1]=e[9][1];break;case 2:var r=(18-e[4])/18;if(0<=r){var l=a%2?1:-1;if(e[0]=e[9][0]-4*r*l*Math.cos(4*r)+r*Math.sin(n),e[1]=e[9][1]-4*r*l*Math.sin(4*r)+r*Math.sin(n+1),e[3]=Math.max(1.2*Math.sin(4*r)+.3*r*Math.sin(n+1),0),e[4]%6==3)for(o=0;o<strPlayer.length;o++)e[2][o].setState(3-e[2][o].getState())}e[4]--,e[4]<=0&&(e[5]=3,e[8][0]=e[0],e[8][1]=e[1],e[4]=0,e[9][0]=e[7][0]+10*Math.sin(n),e[9][1]=e[7][1]+10*Math.sin(n+1));break;case 3:e[4]++;i=Math.min(e[4]/20,1);e[0]=e[8][0]+i*(e[9][0]-e[8][0]),e[1]=e[8][1]+i*(e[9][1]-e[8][1]),e[3]=30*i*(1-i),1==i&&(e[6]--,e[6]<=0?(e[5]=4,e[4]=1):(e[5]=2,e[4]=20,e[5]=2));break;case 4:if(e[4]-=.2,e[4]<0){for(o=0;o<strPlayer.length;o++)e[2][o].img.style.display="none",e[2][o].img.style.opacity=1,e[2][o].setState(0);e[0]=-10,e[1]=-10,e[4]=50,e[5]=0,e[6]=0}else for(o=0;o<strPlayer.length;o++)e[2][o].img.style.opacity=e[4]}}},fireplant:{hitbox:7,unbreaking:!0,preinit:function(){oMap.decor.fireball?this.fireball0=oMap.decor.fireball.length:(this.fireball0=0,oMap.decor.fireball=new Array);for(var e=0;e<oMap.decor[this.type].length;e++)oMap.decor.fireball.push([-10,-10])},init:function(e,t,a){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=4,e[2][n].w=54,e[2][n].h=40*e[2][n].w/24,e[2][n].z=.16;null==e[4]&&(e[4]=1e4*Math.sin(a+1)%(2*Math.PI)),null==e[5]&&(e[5]=17*a%65),e[6]=e[4],e[7]=0},move:function(e,t){if(e[5]--,e[4]=e[6]+.5*Math.sin(e[7]),e[7]+=.05,e[7]%=2*Math.PI,-1==e[5])for(var a=0;a<strPlayer.length;a++)e[2][a].setState(e[2][a].getState()+1);else if(-7==e[5]){var n=oMap.decor.fireball[this.fireball0+t];n[0]=e[0],n[1]=e[1];for(a=0;a<strPlayer.length;a++)n[2][a].img.style.display="block",n[2][a].setState(0);n[3]=10,n[4]=e[4],n[5]=0,n[6]=35}else if(-9==e[5]){for(a=0;a<strPlayer.length;a++)e[2][a].setState((e[2][a].getState()+1)%4);e[5]=Math.round(60+10*Math.sin(e[7]))}}},fireball:{spin:42,unbreaking:!0,movable:!0,transparent:!0,hitboxH:6,init:function(e,t){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=4,e[2][a].img.style.display="none"},move:function(e){if(0<=e[6]){if(e[0]+=7*Math.cos(e[4]),e[1]+=7*Math.sin(e[4]),e[3]+=e[5],e[3]<0&&(e[3]=0,e[5]=5),e[5]-=3,e[6]--,e[6]<0){e[0]=-10,e[1]=-10;for(var t=0;t<strPlayer.length;t++)e[2][t].img.style.display="none"}else if(e[6]%2==0)for(t=0;t<strPlayer.length;t++)e[2][t].setState((e[2][t].getState()+3)%4)}}},piranhaplant:{spin:20,preinit:function(e){this.init_=decorBehaviors.plante.init.bind(this),this.move=decorBehaviors.plante.move.bind(this)},init:function(e,t,a){this.init_(e,t,a);for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=2,e[2][n].w=32,e[2][n].h=48,e[2][n].z=.1}},firebar:{spin:42,transparent:!0,unbreaking:!0,movable:!0,init:function(e,t,a){for(var n=0;n<strPlayer.length;n++)e[2][n].w=32,e[2][n].h=192,e[2][n].z=.035;null==e[4]&&(e[4]=[[e[0],e[1],0,40],[e[0],e[1],20,40]]),null==e[5]&&(e[5]=Math.round(1e4*Math.abs(Math.sin(a+3)))%e[4].length),null==e[6]&&(e[6]=2*Math.round(1e4*Math.abs(Math.sin(a+2))%1)-1),null==e[7]&&(e[7]=Math.round(1e4*Math.abs(Math.sin(a+1)))%40)},move:function(e,t){if(e[7])e[7]--;else{var a=e[4][e[5]],n=a[0]-e[0],o=a[1]-e[1],i=a[2]-e[3],r=0<i?4:8,l=Math.hypot(n,o),s=!0;.88<l?(e[0]+=.88*n/l,e[1]+=.88*o/l,s=!1):(e[0]=a[0],e[1]=a[1]);var c=e[3];if(r<Math.abs(i)?(e[3]+=Math.sign(i)*r,s=!1):e[3]=a[2],c!=e[3])for(var p=Math.max(0,1-e[3]/20),u=0;u<strPlayer.length;u++){var d=e[2][u].img;d.style.transform=d.style.WebkitTransform=d.style.MozTransform="scale("+p+")"}s&&(e[7]=a[3],e[5]+=e[6],e[5]<0?(e[5]+=2,e[6]=1):e[5]>=e[4].length&&(e[5]-=2,e[6]=-1))}}},fire3star:{unbreaking:!0,transparent:!0,hidden:!0,preinit:function(e){oMap.decor.fireballs||(oMap.decor.fireballs=new Array);for(var t=0;t<e.length;t++){var a,n=e[t];null==n[3]&&(n[3]=18),null==n[4]?(a=getDecorParams(this,t),n[4]=Math.PI/2+a.dir,isNaN(n[4])&&(n[4]=1e4*Math.sin(t+2)%Math.PI),n[5]=.1):null==n[5]&&(n[5]=.1*(t%2?1:-1)),null==n[6]&&(n[6]=1e4*Math.sin(t+1)%Math.PI);for(var o=[],i=0;i<3;i++){for(var r=[],l=0;l<2;l++){var s=[n[0],n[1],void 0,n[3]];oMap.decor.fireballs.push(s),r.push(s)}o.push(r)}s=[n[0],n[1],void 0,correctZInv(n[3])];oMap.decor.fireballs.push(s),o.push([s]),n[7]=o}},init:function(e,t,a){this.move(e,t,a)},move:function(e,t){for(var a=e[0],n=e[1],o=e[3],i=e[4],r=e[5],l=e[6],s=Math.cos(i),c=Math.sin(i),p=e[7],u=0;u<3;u++)for(var d=l+2*u*Math.PI/3,h=Math.cos(d),m=Math.sin(d),g=p[u],y=0;y<2;y++){var f=g[y],S=7.5*(y+1);f[0]=a+S*s*h,f[1]=n-S*c*h,f[3]=correctZInv(o+S*m)}e[6]+=r,e[6]%=2*Math.PI}},firering:{unbreaking:!0,transparent:!0,hidden:!0,preinit:function(e){oMap.decor.fireballs||(oMap.decor.fireballs=new Array);for(var t=0;t<e.length;t++){var a,n=e[t];null==n[3]&&(n[3]=18),null==n[4]?(a=getDecorParams(this,t),n[4]=Math.PI/2+a.dir,isNaN(n[4])&&(n[4]=1e4*Math.sin(t+2)%Math.PI),n[5]=.1):null==n[5]&&(n[5]=.1*(t%2?1:-1)),null==n[6]&&(n[6]=1e4*Math.sin(t+1)%Math.PI);for(var o=[],i=0;i<5;i++){var r=[n[0],n[1],void 0,n[3]];oMap.decor.fireballs.push(r),o.push(r)}n[7]=o}},init:function(e,t,a){this.move(e,t,a)},move:function(e,t){for(var a=e[0],n=e[1],o=e[3],i=e[4],r=e[5],l=e[6],s=Math.cos(i),c=Math.sin(i),p=e[7],u=0;u<p.length;u++){var d=l+2*u*Math.PI/5,h=Math.cos(d),m=Math.sin(d),g=p[u];g[0]=a+15*s*h,g[1]=n-15*c*h,g[3]=correctZInv(o+15*m)}e[6]+=r,e[6]%=2*Math.PI}},fireballs:{unbreaking:!0,transparent:!0,spin:42,movable:!0,hitboxH:6,init:function(e,t){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=1,e[2][a].w=24,e[2][a].h=e[2][a].w}},billball:{hitbox:10,unbreaking:!0,transparent:!0,spin:42,movable:!0,rotatable:!0,dodgable:!0,preinit:function(e){for(var t=0;t<e.length;t++){var a=getDecorParams(this,t);null==(i=e[t])[3]&&(i[3]=3),null==i[4]&&(i[4]=90+180*a.dir/Math.PI,isNaN(i[4])&&(i[4]=180))}for(t=1;t<4;t++){var n=oMap.decor["billball"+t];if(n){for(var o=0;o<n.length;o++){var i=n[o];e.push([i[0],i[1],null,null,180-90*t])}n.length=0}}var r=getDecorExtra(this,!0),l=0;if(r.nb)for(t=l=e.length;t<r.nb;t++)e.push(e[t%l].slice(0));else l=Math.round(4*e.length/5);for(t=0;t<e.length;t++){a=getDecorParams(this,t);(i=e[t])[6]=[i[0],i[1],i[3],i[4],a.length||460]}this.initPos=[];for(t=0;t<l;t++){var s=e[t][6].slice();s.push(0),this.initPos.push(s)}},init:function(e,t){this.easeInOut=decorBehaviors.truck.easeInOut,null==e[5]&&(e[5]=1+20*t);for(var a=0;a<strPlayer.length;a++)e[2][a].w=80,e[2][a].h=80,e[5]&&(e[0]=-10,e[1]=-10,e[2][a].img.style.display="none")},move:function(e,t){if(!t)for(var a=0;a<this.initPos.length;a++){(o=this.initPos[a])[o.length-1]&&o[o.length-1]--}if(0<e[5]){if(e[5]--,e[5]<=0){e[5]=0,e[0]=e[6][0],e[1]=e[6][1];for(a=0;a<strPlayer.length;a++)e[2][a].img.style.display="block"}}else if(e[5]<0){if(e[5]<=-10){for(var n=1,a=e[5]=0;a<100;a++){var o,i=oPlayers[0].cpu?Math.floor(Math.random()*this.initPos.length):Math.round(1e4*Math.abs(Math.sin(timer+a)))%this.initPos.length;if(!(o=this.initPos[i])[o.length-1])break}var r=this.initPos[i];r[r.length-1]=20;for(a=0;a<5;a++)e[6][a]=this.initPos[i][a];e[0]=e[6][0],e[1]=e[6][1],e[3]=e[6][2],e[4]=e[6][3]}else n=1-e[5]/-10,e[3]=e[6][2]*Math.sqrt(n),e[5]--;for(a=0;a<oPlayers.length;a++)e[2][a].img.style.opacity=n}else{var l=(180-e[4])*Math.PI/180,s=e[6][4];e[0]+=5*Math.cos(l),e[1]+=5*Math.sin(l),(e[0]-e[6][0])*(e[0]-e[6][0])+(e[1]-e[6][1])*(e[1]-e[6][1])>s*s&&(e[5]=-1)}for(a=0;a<oPlayers.length;a++){var c=(p=nearestAngle(getApparentRotation(oPlayers[a])+90-e[4],180,360))%180/180,c=this.easeInOut(c),p=180*Math.floor(p/180)+180*c,u=Math.round(11*p/180)%22;21<u&&(u-=22),e[2][a].setState(u)}}},tortitaupe:{spin:20,preinit:function(e){this.init_=decorBehaviors.taupe.init.bind(this),this.move=decorBehaviors.taupe.move.bind(this)},init:function(e,t,a){this.init_(e,t,a);for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=1,e[2][n].w=24,e[2][n].h=36}},topitaupe:{spin:20,preinit:function(e){this.init=decorBehaviors.taupe.init.bind(this),this.move=decorBehaviors.taupe.move.bind(this)}},coconut:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=100,e[2][t].h=100,e[2][t].z=.36}},palm:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=100,e[2][t].h=100,e[2][t].z=.38}},mountaintree:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=112,e[2][t].w=64*e[2][t].h/126,e[2][t].z=.15}},mariotree:{hidable:!0,hitbox:3,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=104,e[2][t].w=e[2][t].h/2,e[2][t].z=.12}},fir:{hidable:!0,hitbox:4,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].h=112,e[2][t].w=e[2][t].h,e[2][t].z=.38}},movingtree:{hitbox:11.5,movable:!0,unbreaking:!0,init:function(e,t,a){for(var n,o=0;o<strPlayer.length;o++){e[2][o].nbSprites=1,e[2][o].w=85,e[2][o].h=139*e[2][o].w/115,e[2][o].z=.12,e[3]=0,e[4]||(n=a%2?1:-1,e[4]=[[e[0]+25*n,e[1]],[e[0],e[1]-25*n],[e[0]-25*n,e[1]],[e[0],e[1]+25*n]]),null==e[5]&&(e[5]=a%e[4].length),null==e[6]&&(e[6]=0)}},move:function(e){var t,a,n,o;e[6]?e[6]--:(a=(t=e[4][e[5]])[0]-e[0])*a+(n=t[1]-e[1])*n<1?(e[5]=(e[5]+1)%e[4].length,e[6]=10):(o=Math.hypot(a,n),e[0]+=1.1*a/o,e[1]+=1.1*n/o)}},sinistertree:{hidable:!0,hitbox:9,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=117,e[2][t].h=126,e[2][t].z=.37}},pokey:{spin:42,movable:!0,dodgable:!0,init:function(e,t,a){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=5,e[2][n].h=82,e[2][n].w=23*e[2][n].h/45,e[2][n].z=.1;e[3]=0,null==e[4]&&(e[4]=[15,15]),2==e[4].length&&e[4].unshift(e[0],e[1]),null==e[5]&&(e[5]=[1e4*Math.sin(a+1)%Math.PI,.025*Math.sign(Math.sin(1+100*a))]),null==e[6]&&(e[6]=Math.floor(1e4*Math.pow(Math.sin(a+1),2))%16),this.repos(e)},repos:function(e){var t=e[5][0],a=e[4];e[0]=a[0]+a[2]*Math.cos(t),e[1]=a[1]+a[3]*Math.sin(t)},move:function(e){e[5][0]=(e[5][0]+e[5][1])%(2*Math.PI),e[6]++;if(e[6]%2==0){var t=e[6]/2,a=[0,1,2,1,0,3,4,3];a.length<=t&&(t=0,e[6]=0);for(var n=0;n<strPlayer.length;n++)e[2][n].setState(a[t])}this.repos(e)}},falltree:{hidable:!0,hitbox:5,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=72,e[2][t].h=150*e[2][t].w/100,e[2][t].z=.24}},peachtree:{hidable:!0,hitbox:5,unbreaking:!0,init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=1,e[2][t].w=27,e[2][t].h=4*e[2][t].w,e[2][t].z=.01}},box:{breaking:!0,bonus:!0},snowman:{breaking:!0,spin:42},snowball:{hitbox:7,spin:42,unbreaking:!0,movable:!0,defaultspeed:3.5,boostspeed:8,jumpspeed:function(e){return+e+4},jumpheight:32,spritesize:56,ondie:function(e){return-100<e?"wait":"respawn"},preinit:function(e){e.length&&null==e[0][4]&&(this.init=decorBehaviors.cannonball.init.bind(this),this.move_=decorBehaviors.cannonball.move.bind(this),this.move=function(e,t,a){for(var n=0;n<oPlayers.length;n++)e[2][n].setState((e[2][n].getState()+1)%3);this.move_(e,t,a)},this.setdir=decorBehaviors.cannonball.setdir.bind(this),this.autojump=decorBehaviors.cannonball.autojump.bind(this))},init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=3,e[2][t].w=56,e[2][t].h=56,e[2][t].z=.28;e[3]=0,e[4].unshift([e[0],e[1]]),e[5]=[1,0]},move:function(e){for(var t=3.5,a=0;a<oPlayers.length;a++)e[2][a].setState((e[2][a].getState()+1)%3);for(;0<t;){if(e[5][0]<e[4].length){var n=e[4][e[5][0]];n[2]&&3.5==t&&(t=n[2]);var o,i,r=n[0],l=n[1],s=r-e[0],c=l-e[1],p=Math.hypot(s,c);e[3]=0,p<t?(e[0]=r,e[1]=l,e[5][0]++,t-=p):(e[0]+=s*t/p,e[1]+=c*t/p,t=0,n[3]&&(o=e[4][e[5][0]-1],(i=(1-p/Math.hypot(r-o[0],l-o[1]))/n[3][1])<1&&(e[3]=4*n[3][0]*i*(1-i))))}else if(t=0,e[5][1]++,e[5][1]<10)for(var u=0;u<oPlayers.length;u++)e[2][u].img.style.opacity=1-e[5][1]/10;else if(10==e[5][1]){e[3]=10,e[0]=-100,e[1]=-100;for(u=0;u<oPlayers.length;u++)e[2][u].img.style.opacity="",e[2][u].img.style.display="none"}else if(104<=e[5][1]){e[5][0]=1,e[5][1]=0,e[0]=e[4][0][0],e[1]=e[4][0][1];for(u=0;u<oPlayers.length;u++)e[2][u].img.style.display="block";e[3]=0}}}},cannonball:{hitbox:8,spin:42,unbreaking:!0,movable:!0,defaultspeed:5,jumpspeed:function(e){return 6+1.5*e},jumpheight:48,boostspeed:11,spritesize:60,ondie:function(){return"suppr"},setdir:function(e,t,a,n){n=n||e;var o=oMap.w+oMap.h;e[4][0][0]=n[0]+o*t,e[4][0][1]=n[1]+o*a,e[4][1][0]=n[0]-o*t,e[4][1][1]=n[1]-o*a},autojump:function(e,t,a,n){e[6][4]&&n<this.boostspeed&&(t*=this.boostspeed/n,a*=this.boostspeed/n,n=this.boostspeed);var o=Math.hypot(t,a);e[4][2]=[e[0]+t,e[1]+a],e[5][2]={jump:1,loop:[0]},e[6][0]=2,e[6][2]=n,e[6][3]=o,this.setdir(e,t/o,a/o,e[4][2])},init:function(e,t,a){for(var n,o=0;o<strPlayer.length;o++)e[2][o].nbSprites||(e[2][o].nbSprites=1,e[2][o].w=this.spritesize,e[2][o].h=this.spritesize,e[2][o].z=.33);e[3]=0,e[4]||(e[4]=[[],[]],n=getDecorParams(this,t).dir,isNaN(n)&&(n=1e4*Math.sin(a+2)%Math.PI),this.setdir(e,Math.sin(n),Math.cos(n)),e[5]||(e[5]={0:{autoDir:!0,pos0:[e[0],e[1]]},1:{autoDir:!0,loop:[0]}})),e[5]||(e[5]={}),e[6]=[0,0,5]},move:function(e,t,a){var n=e[6][2];for(e[6][4]&&(n=Math.max(this.boostspeed,n),e[6][4]--);0<n;){var o,i=e[4][e[6][0]],r=i[0],l=i[1],s=r-e[0],c=l-e[1],p=Math.hypot(s,c),u=e[5][e[6][0]];if(p<n){e[0]=r,e[1]=l,u&&u.loop?(o=u.loop[0],e[6][1]?(e[6][1]--,e[6][1]||(o=e[6][0]+1)):u.loop[1]&&(e[6][1]=u.loop[1]),e[6][0]=o):e[6][0]++,u&&u.speed?e[6][2]=u.speed:e[6][2]=this.defaultspeed,u&&u.jump?(o=e[4][e[6][0]],e[6][3]=Math.hypot(o[0]-r,o[1]-l)):e[6][3]=0,e[3]=0,n-=p}else{var d,h,m=s*n/p,g=c*n/p;if(u)if(isNaN(u.flipper)||((d=oMap.flippers[u.flipper])[3][0]||(d[3][1]=Math.max(0,Math.floor(p/n)-2))),u.autoDir)if(e[6][1]<0){for(var y=Math.max(0,1+e[6][1]/10),f=0;f<oPlayers.length;f++)e[2][f].img.style.opacity=y;if(y)e[6][1]--;else switch(this.ondie(e[6][1])){case"wait":e[0]=3*oMap.w,e[1]=3*oMap.h,e[6][1]--;break;case"suppr":oMap.decor[this.type][t][2][0].suppr(),oMap.decor[this.type].splice(t,1);break;case"respawn":for(f=0;f<oPlayers.length;f++)e[2][f].img.style.opacity="";e[0]=e[5][0].pos0[0],e[1]=e[5][0].pos0[1],e[4]=null,e[5]=null,this.init(e,t,a)}g=m=0}else{var S=inCannon(e[0],e[1]);if(S&&(C=17,this.autojump(e,S[0],S[1],C)),u.jump||(e[3]=0,e[6][3]=0),!e[3]){var v=oMap.decor[this.type];oMap.decor[this.type]=[];var b,M=sauts(e[0],e[1],m,g);if(M){var C=this.jumpspeed(M),x=32*M,P=s*x/p,k=c*x/p;this.autojump(e,P,k,C)}else if(canMoveTo(e[0],e[1],0,m,g))if(b=touche_asset(e[0],e[1],e[0]+m,e[1]+g))switch(b[0]){case"bumpers":var w=m,T=g,I=b[1],E=e[0]+w,L=e[1]+T,B=I[1][0],D=I[1][1],z=e[0]-B,H=e[1]-D,O=Math.hypot(z,H),R=z/O,j=H/O,A=w*R+T*j,V=E-A*R,F=L-A*j;w=e[0]+2*(V-e[0])-E,T=e[1]+2*(F-e[1])-L;var N=Math.hypot(w,T);this.setdir(e,w/N,T/N),g=m=0}else tombe(e[0]+m,e[1]+g)?e[6][1]=-1:accelere(e[0]+m,e[1]+g)&&(e[6][4]=20);else{var w,T,_=getHorizontality(e[0],e[1],m,g),K=Math.hypot(_[0],_[1]),W=m*(w=_[0]/K)+g*(T=_[1]/K),P=2*W*w-m,k=2*W*T-g,G=Math.hypot(P,k);this.setdir(e,P/G,k/G),g=m=0}oMap.decor[this.type]=v}}e[0]+=m,e[1]+=g,e[6][3]&&(h=(p-n)/e[6][3],h=Math.max(Math.min(h,1),0),e[3]=this.jumpheight*h*(1-h)),n=0}}}},truck:{hitbox:8,spin:42,unbreaking:!0,movable:!0,rotatable:!0,dodgable:!0,preinit:function(e){for(var t=0;t<e.length;t++){var a,n=e[t];null==n[5]&&(a=getDecorParams(this,t),n[5]=a.traject)}},init:function(e){for(var t=0;t<strPlayer.length;t++)e[2][t].nbSprites=22,e[2][t].w=118,e[2][t].h=56*e[2][t].w/111,e[2][t].z=.72;var a=getDecorExtra(this,!0);if(a.path||(a.path=oMap.aipoints),!e[6]){var n=1/0,o=null!=e[5];o||(e[5]=0);for(var i=e[6]=0;i<a.path.length;i++)if(!o||i==e[5])for(var r=a.path[i],t=0;t<r.length;t++){var l=((s=r[t])[0]-e[0])*(s[0]-e[0])+(s[1]-e[1])*(s[1]-e[1]);l<n&&(n=l,e[5]=i,e[6]=t)}}(r=a.path[e[5]]).length<2&&(r.length||(r=[[e[0],e[1]]]),r.push([r[0][0]+.001,r[0][1]+.001]),a.path[e[5]]=r);var s=r[e[6]],c=(e[6]+1)%r.length,p=r[c];(s[0]-e[0])*(p[0]-s[0])+(s[1]-e[1])*(p[1]-s[1])<0&&(e[6]=c,s=p);var u=s[0]-e[0];aimY=s[1]-e[1],e[4]=180*Math.atan2(u,aimY)/Math.PI},move:function(e){var t=4,a=e[0],n=e[1],o=getDecorExtra(this,!0);o.path||(o.path=oMap.aipoints);var i,r=o.path[e[5]];do{var l=r[e[6]],s=l[0]-a,c=l[1]-n,p=Math.hypot(s,c);p<t?(a+=s,n+=c,t-=p,++e[6]>=r.length&&(e[6]=0)):(a+=s*t/p,n+=c*t/p,t=0)}while(0<t);e[0]=a,e[1]=n,(s||c)&&(i=nearestAngle(180*Math.atan2(s,c)/Math.PI,e[4],360),e[4]<i-8?e[4]+=8:e[4]>i+8?e[4]-=8:e[4]=i);for(var u=0;u<oPlayers.length;u++){var d=nearestAngle(getApparentRotation(oPlayers[u])-e[4],180,360),a=d%180/180;a=this.easeInOut(a),d=180*Math.floor(d/180)+180*a;var h=Math.round(11*d/180)%22;21<h&&(h-=22),e[2][u].setState(h)}},easeInOut:function(e){return(e*=2)<1?e*e/2:-(--e*(e-2)-1)/2}},movingthwomp:{spin:20,hitbox:8,movable:!0,init:function(e,t){for(var a=0;a<strPlayer.length;a++)e[2][a].nbSprites=3,e[2][a].w=48,e[2][a].h=64;if(null==e[4]){e[4]=[[e[0],e[1],0,20,20],[e[0],e[1],20,5,30],[e[0],e[1],20,30,5],[e[0],e[1],0,20,20]];var n=getDecorParams(this,t);if(!isNaN(n.dir))for(var o=n.length*Math.sin(n.dir),i=n.length*Math.cos(n.dir),t=2;t<4;t++)e[4][t][0]+=o,e[4][t][1]+=i}null==e[5]&&(e[5]=0),null==e[6]&&(e[6]=1),null==e[7]&&(e[7]=0)},move:function(e,t){if(e[7]){if(e[7]--,!e[7])if((p=e[4][e[5]])[2]!=e[3]&&(c=1),null!=c)for(var a=0;a<strPlayer.length;a++)e[2][a].setState(c)}else{var n=(p=e[4][e[5]])[0]-e[0],o=p[1]-e[1],i=p[2]-e[3],r=0<i?2:8,l=Math.hypot(n,o),s=!0;if(2<l?(e[0]+=2*n/l,e[1]+=2*o/l,s=!1):(e[0]=p[0],e[1]=p[1]),r<Math.abs(i)?(e[3]+=Math.sign(i)*r,s=!1):e[3]=p[2],s){e[7]=p[0<e[6]?3:4],e[5]+=e[6],e[5]<0?(e[5]+=2,e[6]=1):e[5]>=e[4].length&&(e[5]-=2,e[6]=-1);var c,p=e[4][e[5]];c=!i||0<e[3]?0:2;for(a=0;a<strPlayer.length;a++)e[2][a].setState(c)}}}},chomp:{hitbox:9,spin:42,unbreaking:!0,movable:!0,init:function(e,t,a){for(var n=0;n<strPlayer.length;n++)e[2][n].nbSprites=8,e[2][n].w=92,e[2][n].h=60*e[2][n].w/70,e[2][n].z=.33;if(null==e[3]&&(e[3]=1e4*Math.abs(Math.sin(a+1))%3),null==e[4]){e[4]=[];for(var o=1e4*Math.sin(a+2)%Math.PI,i=2*Math.PI/6*Math.sign(Math.sin(1+80*a)),n=0;n<6;n++){var r=o+n*i;e[4].push([e[0]+40*Math.cos(r),e[1]+40*Math.sin(r)])}}null==e[5]&&(e[5]=0),null==e[6]&&(e[6]=a%2?1:-1)},move:function(e,t){e[3]+=e[6],e[3]<0&&(e[3]=0,e[6]=1.5),e[6]-=.5;for(var a=2.5;0<a;){var n=(s=e[4][e[5]])[0],o=s[1],i=n-e[0],r=o-e[1],l=Math.hypot(i,r);l<a?(e[0]=n,e[1]=o,e[5]++,e[5]>=e[4].length&&(e[5]=0),a-=l):(e[0]+=i*a/l,e[1]+=r*a/l,a=0)}var s=e[4][e[5]],c=e[4][(e[5]?e[5]:e[4].length)-1],p=180*Math.atan2(s[0]-c[0],s[1]-c[1])/Math.PI;if(!isNaN(p))for(var u=0;u<oPlayers.length;u++){var d=nearestAngle(getApparentRotation(oPlayers[u])-p,180,360),h=Math.round(8*d/360)%8;e[2][u].setState(h)}},easeInOut:function(e){return(e*=2)<1?e*e/2:-(--e*(e-2)-1)/2}},pendulum:{hitbox:8,spin:42,unbreaking:!0,movable:!0,init:function(e,t,a){for(var n,o=0;o<strPlayer.length;o++)e[2][o].nbSprites=1,e[2][o].w=60,e[2][o].h=3*e[2][o].w,e[2][o].z=.1,e[2][o].div.style.transformOrigin=e[2][o].div.style.WebkitTransformOrigin=e[2][o].div.style.MozTransformOrigin="50% 83%";e[5]=[e[0],e[1],0,-1],null==e[4]&&(e[4]=1e4*Math.sin(a+1)%(Math.PI/3),n=getDecorParams(this,t).dir,isNaN(n)?(e[5][2]=1e4*Math.sin(a+1)%Math.PI,e[5][3]=0<Math.sin(1200*(a+1)+1)?1:-1):(e[5][2]=n,e[5][3]=1))},move:function(e){var t=Math.PI/3,a=e[4],n=e[5][2],o=.99*t;Math.abs(a)>o&&(a=o*Math.sign(a),e[5][3]=-e[5][3]),a+=Math.sqrt(2*(Math.cos(a)-Math.cos(t)))/16*e[5][3],e[4]=a;e[0]=e[5][0]+30*Math.sin(a)*Math.sin(n),e[1]=e[5][1]+30*Math.sin(a)*Math.cos(n);for(var i=-6*(1-Math.cos(a)),r=0;r<strPlayer.length;r++){var l=getApparentRotation(oPlayers[r]),s=-a/5*Math.sin(l*Math.PI/180-n);e[2][r].div.style.transform=e[2][r].div.style.WebkitTransform=e[2][r].div.style.MozTransform="translateY("+i+"%) rotate("+Math.round(180*s/Math.PI)+"deg)"}}}},DEFAULT_DECOR_HITBOX=5,DEFAULT_DECOR_HITBOX_H=4,touchedObject;for(var type in decorBehaviors)decorBehaviors[type].type=type;function getDecorParams(e,t){var a=e.type;return oMap.decorparams&&oMap.decorparams[a]&&oMap.decorparams[a][t]?oMap.decorparams[a][t]:{}}function getDecorExtra(e,t){var a=e.type,n={};return oMap.decorparams&&oMap.decorparams.extra&&oMap.decorparams.extra[a]&&(n=oMap.decorparams.extra[a],t&&n.custom&&(n=getDecorExtra(decorBehaviors[n.custom.type]))),n}function getDecorActualType(e){var t=getDecorExtra(decorBehaviors[e.type]);return t.custom?t.custom.type:e.type}function getApparentRotation(e,t){var a=e.rotation,n=e.changeView;return e.tours==oMap.tours+1&&n<180&&(n+=15,t&&(e.changeView=n)),n&&(a+=a<360-n?n:n-360),a}function render(){collisionTest=COL_OBJ,collisionTeam=void 0,clLocalVars.currentKart=void 0;for(var e=0;e<strPlayer.length;e++)if(oPlayers[e].tombe<=10){var t=oPlayers[e].x,a=oPlayers[e].y,n=getApparentRotation(oPlayers[e],!0);redrawCanvas(e,t,a,n);for(var o=correctZ(oPlayers[e].z),i=iWidth/2*iScreenScale,r=(iHeight-iViewYOffset-o)*iScreenScale,l=0;l<aKarts.length;l++)if((w=aKarts[l]).cpu||w!=oPlayers[e]){for(var s=w.x-t,c=w.y-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),h=-iCamHeight,m=iCamDist+d,g=correctCamZ(w.z,m),y=h/m*iCamDist+iCamHeight-iViewHeight+g,f=-u/(d+iCamDist)*iCamDist,S=n-w.rotation;S<0;)S+=360;for(;360<S;)S-=360;var v=Math.round(11*S/180)+w.tourne%21;21<v&&(v-=22),w.figstate&&(v=(v+21-w.figstate)%21),w.sprite[e].setState(v),w.sprite[e].div.style.zIndex=Math.round(1e4-d);var b=(iWidth/2+f)*iScreenScale,M=(iHeight-y)*iScreenScale,C=fFocal/(fFocal+d)*w.size;if(w.sprite[e].draw(b,M,C,g),"BB"==course){var x=w.ballons.length,P=fFocal/(fFocal+d)*w.size,k=P*(6+(w.sprite[e].h-32)/5);for(D=1;D<=x;D++)w.ballons[D-1][e].draw((iWidth/2+f+2.5*(D-x/2)*P)*iScreenScale,(iHeight-y-k)*iScreenScale,P/2,k),w.ballons[D-1][e].div.style.zIndex=w.sprite[e].div.style.zIndex}!w.marker||w.loose||w.tombe||(w.marker.draw(e,b,M,C,g),w.marker.div[e].style.zIndex=Math.round(10001-d))}for(l=0;l<oMap.arme.length;l++){var w=oMap.arme[l];isNaN(w[2])?(s=w[0]-t,c=w[1]-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),y=(h=-iCamHeight)/(m=iCamDist+d)*iCamDist+iCamHeight-iViewHeight,f=-u/(d+iCamDist)*iCamDist,w[2][e].div.style.zIndex=Math.round(1e4-d),w[2][e].draw((iWidth/2+f)*iScreenScale,(iHeight-y)*iScreenScale,fFocal/(fFocal+d))):e||(w[2]?w[2]--:w[2]=new Sprite("objet"))}if(oMap.decor)for(var T in oMap.decor)for(var I,l=0;l<oMap.decor[T].length;l++){(w=oMap.decor[T][l])[2][0].unshown||(s=w[0]-t,c=w[1]-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),h=-iCamHeight,m=iCamDist+d,I=correctCamZ(w[3]?w[3]:0,m),y=h/m*iCamDist+iCamHeight-iViewHeight+I,f=-u/(d+iCamDist)*iCamDist,w[2][e].div.style.zIndex=Math.round(1e4-d),w[2][e].draw((iWidth/2+f)*iScreenScale,(iHeight-y)*iScreenScale,fFocal/(fFocal+d)*1.2,I))}if(oMap.coins)for(l=0;l<oMap.coins.length;l++){s=(w=oMap.coins[l]).x-t,c=w.y-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),y=(h=-iCamHeight)/(m=iCamDist+d)*iCamDist+iCamHeight-iViewHeight,f=-u/(d+iCamDist)*iCamDist;w.sprite[e].div.style.zIndex=Math.round(1e4-d);var E=Math.abs(Math.cos(w.theta-p));w.sprite[e].w=24*E,w.sprite[e].z=.5*(E-1),w.sprite[e].draw((iWidth/2+f)*iScreenScale,(iHeight-y)*iScreenScale,fFocal/(fFocal+d))}for(l=0;l<bananes.length;l++){s=(w=bananes[l])[3]-t,c=w[4]-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),h=-iCamHeight,m=iCamDist+d,g=correctCamZ(w[5],m),y=h/m*iCamDist+iCamHeight-iViewHeight,f=-u/(d+iCamDist)*iCamDist;w[0][e].div.style.zIndex=Math.round(1e4-d),w[0][e].draw((iWidth/2+f)*iScreenScale,(iHeight-y-g)*iScreenScale,fFocal/(fFocal+d)/1.5,g)}for(l=0;l<fauxobjets.length;l++){s=(w=fauxobjets[l])[3]-t,c=w[4]-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),h=-iCamHeight,m=iCamDist+d,g=correctCamZ(w[5],m),y=h/m*iCamDist+iCamHeight-iViewHeight,f=-u/(d+iCamDist)*iCamDist;w[0][e].div.style.zIndex=Math.round(1e4-d),w[0][e].draw((iWidth/2+f)*iScreenScale,(iHeight-y-g)*iScreenScale,fFocal/(fFocal+d),g)}for(l=0;l<carapaces.length;l++){var L=8*direction(0,(w=carapaces[l])[6]),B=8*direction(1,w[6]);if(e||-1==w[6])te=w[3],ae=w[4];else{te=w[3]+L,ae=w[4]+B;for(var D=0;D<oPlayers.length;D++)w[0][D].setState(1-w[0][D].getState())}var z,H,O,R,j,A,V,s=w[3]-t,c=w[4]-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),h=-iCamHeight,m=iCamDist+d,g=correctCamZ(w[5],m),y=h/m*iCamDist+iCamHeight-iViewHeight,f=-u/(d+iCamDist)*iCamDist;w[0][e].div.style.zIndex=Math.round(1e4-d),w[0][e].draw((iWidth/2+f)*iScreenScale,(iHeight-y-g)*iScreenScale,fFocal/(fFocal+d)/1.5,g),e||(z=w[3],H=w[4],O=te,R=ae,-1!=w[6]&&tombe(z,H)||touche_banane(z,H)||touche_banane(O,R)||touche_crouge(z,H)||touche_crouge(O,R)||touche_cverte(z,H,l)||touche_cverte(O,R,l)?(detruit(carapaces,l,!0),l--):-1==w[6]||canMoveTo(w[3],w[4],0,L,B)?(w[3]=te,w[4]=ae):(w[7]--,0<w[7]?(j=getHorizontality(w[3],w[4],L,B),A=180*Math.atan2(-j[1],j[0])/Math.PI,V=normalizeAngle(w[6]-A,180),w[6]=normalizeAngle(w[6]-2*V+180,360)):(detruit(carapaces,l),l--)))}for(l=0;l<carapacesRouge.length;l++)if((w=carapacesRouge[l])[0][e].div.style.opacity){if(!e){for(var F=w[0][0].div.style.opacity-.2,D=0;D<strPlayer.length;D++)w[0][D].div.style.opacity=F;F<.01&&(detruit(carapacesRouge,l),l--)}}else for(var N=0;N<2;N++){if(e||-1==w[6])te=w[3],ae=w[4];else{if(!N)for(D=0;D<oPlayers.length;D++)w[0][D].setState(1-w[0][D].getState());var _,K=oMap.aipoints[0];if(-1!=w[8]){L=K[w[8]][0]-w[3],B=K[w[8]][1]-w[4];var W=K[w[8]];w[3]>W[0]-10&&w[3]<W[0]+10&&w[4]>W[1]-10&&w[4]<W[1]+10&&(w[8]<K.length-1?w[8]++:w[8]=0),L/=Q=Math.sqrt(L*L+B*B)/5,B/=Q}else{if("BB"!=course)for(D=0;D<K.length;D++){W=K[D];w[3]>W[0]-35&&w[3]<W[0]+35&&w[4]>W[1]-35&&w[4]<W[1]+35&&(w[8]=D+1,w[8]==K.length&&(w[8]=0),D=K.length)}L=5*direction(0,w[6]),B=5*direction(1,w[6])}te=w[3]+L,ae=w[4]+B;for(var G=1e3,D=0;D<aKarts.length;D++){var q,$=aKarts[D];if($.id==w[7]||sameTeam(w[2],$.team)||$.tombe||$.loose||(q=Math.pow($.x-te,2)+Math.pow($.y-ae,2))<G&&(te=$.x,ae=$.y,G=q,_=$),_&&_.using[0]&&_.using[0]!=fauxobjets){for(var U=Math.atan2(w[4]-ae,w[3]-te)-(90-_.rotation)*Math.PI/180,J=2*Math.PI;U<0;)U+=J;for(;J<U;)U-=J;U>Math.PI&&(U=J-U),2<Math.abs(U)?(isOnline?(detruit(carapacesRouge,l),l--):w[0][e].div.style.opacity=.8,te-=5*direction(0,_.rotation),ae-=5*direction(1,_.rotation),detruit(_.using[0],_.using[1],!0),N=1):(_.using[0][_.using[1]][3]-=2*direction(0,_.rotation),_.using[0][_.using[1]][4]-=2*direction(1,_.rotation))}}}!e&&(-1!=w[7]&&(tombe(te,ae)||!canMoveTo(w[3],w[4],0,L,B))||touche_banane(te,ae)||touche_banane(w[3],w[4])||touche_crouge(te,ae,l)||touche_crouge(w[3],w[4],l)||touche_cverte(te,ae)||touche_cverte(w[3],w[4]))?e||(isOnline?(detruit(carapacesRouge,l),l--):w[0][e].div.style.opacity=.8,N=1):(w[3]=te,w[4]=ae,N&&(s=w[3]-t,c=w[4]-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),h=-iCamHeight,m=iCamDist+d,g=correctCamZ(w[5],m),y=h/m*iCamDist+iCamHeight-iViewHeight,f=-u/(d+iCamDist)*iCamDist,w[0][e].div.style.zIndex=Math.round(1e4-d),w[0][e].draw((iWidth/2+f)*iScreenScale,(iHeight-y-g)*iScreenScale,fFocal/(fFocal+d)/1.5,g)))}for(l=0;l<carapacesBleue.length;l++){for(var s=(w=carapacesBleue[l])[3]-t,c=w[4]-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),y=(h=-iCamHeight)/(m=iCamDist+d)*iCamDist+iCamHeight-iViewHeight,f=-u/(d+iCamDist)*iCamDist,Y=-1,D=0;D<aKarts.length;D++)if(aKarts[D].id==w[5]){Y=D;break}if(-1==Y){Y=aKarts.length-1;var X=1;for(D=0;D<aKarts.length;D++)aKarts[D].place==X&&(D=(aKarts[D].tours<=oMap.tours||"BB"==course)&&!sameTeam(w[2],aKarts[D].team)?(w[5]=aKarts[D].id,Y=D,aKarts.length):(X++,-1))}var Q,L=w[3]-aKarts[Y].x,B=w[4]-aKarts[Y].y,Z=1;if(0<w[6]){if(!e){if(100<Math.abs(L*B)){L/=Q=Math.sqrt(Math.pow(L,2)+Math.pow(B,2))/10,B/=Q;for(D=0;D<oPlayers.length;D++)w[0][D].setState(1-w[0][D].getState())}else if(w[0][e].setState(Math.round(Math.random())),w[6]--,w[6])f+=w[6]-2.5,y-=Math.abs(5-w[6]);else{for(D=0;D<strPlayer.length;D++)makeSpriteExplode(w,"explosionB",D),"block"==w[0][D].div.style.display&&(ie=D);isOnline||null==ie?playDistSound(aKarts[Y],"musics/events/boom.mp3",200):(w[0][ie].img.onload=function(){bCounting=!1,w[0][ie].img.onload=void 0,reprendre(!1),playDistSound(aKarts[Y],"musics/events/boom.mp3",200)},pause=bCounting=!0),L*=aKarts[Y].speed/2,B*=aKarts[Y].speed/2;for(D=0;D<oPlayers.length;D++)w[0][D].setState(0);w[0][e].div.style.opacity=1}w[3]-=L,w[4]-=B}}else if(bCounting||(Z=10),!e){isOnline&&w[5]==oPlayers[0].id&&w[6]<-10&&(w[6]=0),w[6]--;for(D=0;D<oPlayers.length;D++)w[0][D].div.style.opacity=Math.max(1+w[6]/10,0);var ee=isOnline&&w[5]!=oPlayers[0].id?-70:-10;w[6]<ee&&(detruit(carapacesBleue,l),Z=!1,l--)}Z&&(w[0][e].div.style.zIndex=Math.round(1e4-d),w[0][e].draw((iWidth/2+f)*iScreenScale,(iHeight-y-(0<w[6]?15+aKarts[Y].speed:0))*iScreenScale,fFocal/(fFocal+d)*Z))}for(l=0;l<bobombs.length;l++){var te,ae,ne,s=(w=bobombs[l])[3]-t,c=w[4]-a,p=n*Math.PI/180,u=s*Math.cos(p)-c*Math.sin(p),d=s*Math.sin(p)+c*Math.cos(p),y=(h=-iCamHeight)/(m=iCamDist+d)*iCamDist+iCamHeight-iViewHeight,f=-u/(d+iCamDist)*iCamDist,Z=1,oe=0;if(-1!=w[6])if(w[7]){e||(w[7]--,L=15*direction(0,w[6]),B=15*direction(1,w[6]),te=w[3]+L,ae=w[4]+B,w[3]=te,w[4]=ae),oe=w[7]}else{if(tombe(Math.round(w[3]),Math.round(w[4]))&&(detruit(bobombs,l),Z=!1,l--),e||30==--w[8]&&(w[8]-=12),!w[8]&&!e){for(var ie,D=0;D<strPlayer.length;D++)makeSpriteExplode(w,"explosion",D),"block"==w[0][D].div.style.display&&(ie=D);isOnline||null==ie?playDistSound({x:w[3],y:w[4]},"musics/events/boom.mp3",200):(w[0][ie].img.onload=function(){bCounting=!1,w[0][ie].img.onload=void 0,reprendre(!1),playDistSound({x:w[3],y:w[4]},"musics/events/boom.mp3",200)},pause=bCounting=!0),w[0][e].div.style.opacity=1}if(w[8]<=0&&(bCounting||(Z=10),!e)){for(D=0;D<oPlayers.length;D++)w[0][D].div.style.opacity=1+w[8]/10;w[8]<-10&&(detruit(bobombs,l),Z=!1,l--)}}Z&&(w[0][e].div.style.zIndex=Math.round(1e4-d),ne=correctCamZ(w[5]+2*(8-Math.abs(oe-8)),m),w[0][e].draw((iWidth/2+f)*iScreenScale,(iHeight-y-ne)*iScreenScale,fFocal/(fFocal+d)*Z,ne))}if(oPlayers[e].sprite[e].div.style.zIndex=1e4,oPlayers[e].sprite[e].draw(i,r,oPlayers[e].size,o),"BB"==course){x=oPlayers[e].ballons.length,k=(oPlayers[e].sprite[e].h-32)*oPlayers[e].size/5;for(l=0;l<x;l++)oPlayers[e].ballons[l][e].draw(i+(2*oPlayers[e].size+2.5*(l-x/2)*oPlayers[e].size)*iScreenScale,r-(6*oPlayers[e].size+k)*iScreenScale,oPlayers[e].size/2,6*oPlayers[e].size+k)}for(l=0;l<aKarts.length;l++){var re=aKarts[l],le=re.sprite[e];0<re.figstate&&re.figuring?le.div.hallowed||(le.div.hallowed=!0,le.div.style.backgroundImage="url('images/halo.png')",le.div.style.backgroundRepeat="no-repeat",le.div.style.backgroundSize="contain",le.img.style.opacity=.7):le.div.hallowed&&(le.div.hallowed=!1,le.div.style.backgroundImage="",le.div.style.backgroundRepeat="",le.div.style.backgroundSize="",le.img.style.opacity=1)}for(l=0;l<oBgLayers.length;l++)oBgLayers[l].draw(n,e);1!=strPlayer.length||gameSettings.nomap||setPlanPos()}}function makeSpriteExplode(e,t,a){switch(e[2]){case 0:t="explosionB";break;case 1:t="explosionR"}e[0][a].img.src="images/sprites/sprite_"+t+".png";var n=e[0][a].div.getElementsByClassName("sprite-hallow");n.length&&e[0][a].div.removeChild(n[0])}function correctZ(e){return 7*Math.pow(e/7,.7)}function correctZInv(e){return 7*Math.pow(e/7,1/.7)}function correctCamZ(e,t){return correctZ(e)*iCamDist/t}function direction(e,t){return Math[["sin","cos"][e]](t*Math.PI/180)}function randObj(e){return objets[Math.floor(120*Math.random()/aKarts.length+120*(e.place-1)/aKarts.length)]}function possibleObjs(e,t){for(var a=Math.floor(120*(e.place-1)/aKarts.length),n=Math.floor(120*e.place/aKarts.length),o={},i=a;i<n;i++)t[objets[i]]||(o[objets[i]]=!0);return o}function otherObjects(e,t){for(var a={},n=0;n<t.length;n++)a[t[n]]=!0;var o=possibleObjs(e,a);return 0<Object.getOwnPropertyNames(o).length}function friendlyFire(e,t){return e==t||iTeamPlay&&e.team==t.team}function sameTeam(e,t){return-1!=e&&e==t}function addNewBalloon(e,t){e.ballons.push(createBalloonSprite(e,t))}function createBalloonSprite(e,t){return void 0===t&&(t=e.team),new Sprite(1==t?"ballonR":"ballon")}function balloonSrc(e){return"images/sprites/sprite_"+(1==e?"ballonR":"ballon")+".png"}function detruit(e,t,a){if(e[t]){if(isOnline){for(var n=[bananes,fauxobjets,carapaces,carapacesRouge,carapacesBleue,bobombs].indexOf(e),o=0;o<nbNews[n].length;o++)nbNews[n][o]>t?nbNews[n][o]--:nbNews[n][o]==t&&(nbNews[n].splice(o,1),o--);destructions[n].push(e[t][1])}supprime(e,t,a)}}function supprime(e,t,a){e[t][0][0].suppr();for(var n,o=0;o<aKarts.length;o++){var i=aKarts[o].using;i[0]==e&&t<=i[1]&&(t!=i[1]?i[1]--:(aKarts[o].using=[!1],a&&playIfShould(aKarts[o],"musics/events/hit.mp3")&&(a=!1)))}"object"==typeof a&&playDistSound(a,"musics/events/hit.mp3",80),!clLocalVars.myItems||-1!=(n=clLocalVars.myItems.indexOf(e[t]))&&clLocalVars.myItems.splice(n,1),e.splice(t,1)}function supprArme(e){var t=aKarts[e];t.arme=!1,t.roulette=0,kartIsPlayer(t)&&(document.getElementById("roulette"+e).innerHTML="",document.getElementById("scroller"+e).style.visibility="hidden",removeIfExists(t.rouletteSound))}function stopDrifting(e){var t=aKarts[e];kartIsPlayer(t)&&(aKarts[e].driftinc=0,aKarts[e].driftcpt=0,aKarts[e].turbodrift=0,getDriftImg(e).src="images/drift.png",document.getElementById("drift"+e).style.display="none",t.driftSound&&(t.driftSound.pause(),t.driftSound=void 0),t.sparkSound&&(t.sparkSound.pause(),t.sparkSound=void 0))}function showRearView(e){var t,a=oPlayers[e],n=180-a.changeView;a.changeView=n,a.sprite[0].setState(11),!bCounting||(t=document.getElementById("oCounts"+e))&&(t.style.visibility=a.changeView?"hidden":"visible")}function resetSpriteHeight(e){e.lastW=e.w,e.lastH=e.h,e.w=32,e.h=32}function resumeSpriteSize(e){e.lastW&&(e.w=e.lastW,delete e.lastW),e.lastH&&(e.h=e.lastH,delete e.lastH)}function updateProtectFlag(e){e.protect=e.etoile||e.megachampi||e.billball||e.cannon}function colKart(e){for(var t=aKarts[e],a=0;a<e;a++){var n,o,i,r,l,s,c,p,u,d,h,m,g,y,f,S,v,b=aKarts[a],M=t.protect?t.etoile||t.billball?2:1:0,C=b.protect?b.etoile||b.billball?2:1:0,x="BB"==course&&!t.champi!=!b.champi;t.cpu&&b.cpu&&M==C&&!x||!friendlyFire(t,b)&&("BB"!=course||t.ballons.length&&b.ballons.length)&&Math.pow(t.x-b.x,2)+Math.pow(t.y-b.y,2)<1e3&&(t.z<=1.175||t.billball)&&(b.z<=1.175||b.billball)&&!t.tourne&&!b.tourne&&(n=kartInstantSpeed(t),i=[(o=kartInstantSpeed(b))[0]-n[0],o[1]-n[1]],r=[t.x-b.x,t.y-b.y],l=5*(b.size+t.size)*(b.size+t.size),(s=projete(0,0,r[0],r[1],r[0]-i[0],r[1]-i[1]))<0&&(s=0),1<s&&(s=1),(p=(c=[r[0]-s*i[0],r[1]-s*i[1]])[0]*c[0]+c[1]*c[1])<=l&&(M||C?M!=C&&p<l/2&&((u=M<C?t:b).loose||u.cannon||(d=M<C?b:t,h=aKarts.indexOf(u),handleHit2(d,u),loseBall(h),stopDrifting(h),u.spin(62),u.using[0]&&(u.using[0][u.using[1]][5]&&(u.using[0][u.using[1]][5]=0),u.using=[!1]),supprArme(h))):(x&&((u=t.champi?b:t).loose||u.cannon||(d=t.champi?t:b,h=aKarts.indexOf(u),handleHit2(d,u),loseBall(h),stopDrifting(h),d.ballons.length<3&&addNewBalloon(d,u.team),u.spin(62))),l<r[0]*r[0]+r[1]*r[1]&&(t.cpu&&b.cpu||(g=(m=[r[1],-r[0]])[0]*r[1]-r[0]*m[1])&&(y=(m[0]*i[1]-m[1]*i[0])/g,f=(r[1]*i[0]-r[0]*i[1])/g,r[0]*=y,r[1]*=y,m[0]*=f,m[1]*=f,S=b.stats.mass*b.size/(t.stats.mass*t.size),v=[r[0]*S,r[1]*S],(!t.pushVector||t.pushVector[0]*t.pushVector[0]+t.pushVector[1]*t.pushVector[1]<v[0]*v[0]+v[1]*v[1])&&(t.pushVector=v),v=[(m[0]+n[0]-o[0])/S,(m[1]+n[1]-o[1])/S],(!b.pushVector||b.pushVector[0]*b.pushVector[0]+b.pushVector[1]*b.pushVector[1]<v[0]*v[0]+v[1]*v[1])&&(b.pushVector=v),b.cpu||b.colSound||(b.colSound=playIfShould(b,"musics/events/colkart.mp3"),b.colSound&&function(e){e.colSound.onended=function(){e.colSound=void 0,document.body.removeChild(this)}}(b)))))))}}function pointInRectangle(e,t,a){return e>a[0]&&e<=a[0]+a[2]&&t>a[1]&&t<=a[1]+a[3]}function pointInPolygon(e,t,a){for(var n=!1,o=0,i=a.length-1;o<a.length;i=o++){var r=a[o][0],l=a[o][1],s=a[i][0],c=a[i][1];t<l!=t<c&&e<(s-r)*(t-l)/(c-l)+r&&(n=!n)}return n}function canMoveTo(e,t,a,n,o,i){var r=e+n,l=t+o;if(oMap.decor)for(var s in oMap.decor)for(var c=decorBehaviors[s],p=c.hitbox||DEFAULT_DECOR_HITBOX,u=c.hitboxH||DEFAULT_DECOR_HITBOX_H,d=0;d<oMap.decor[s].length;d++){if(r>(S=oMap.decor[s][d])[0]-p&&r<S[0]+p&&l>S[1]-p&&l<S[1]+p&&Math.abs((S[3]?S[3]:0)-a)<u){if(null==S[3]&&e>S[0]-p&&e<S[0]+p&&t>S[1]-p&&t<S[1]+p)continue;if(!i||c.unbreaking){if(collisionDecor=s,collisionTest==COL_KART&&(c.breaking&&4<collisionPlayer.speed&&(oMap.decor[s][d][2][0].suppr(),oMap.decor[s].splice(d,1),collisionPlayer.turbodrift&&(collisionPlayer.turbodrift=0),c.bonus&&(isOnline&&collisionPlayer!=oPlayers[0]||addNewItem(collisionPlayer,bananes,[new Sprite("banane"),-1,collisionPlayer.team,r+2.5*n,l+2.5*o,0]))),c.transparent))break;return}oMap.decor[s][d][2][0].suppr(),oMap.decor[s].splice(d,1);break}}if(1.175<a)return 1;if(!oMap.collision)return 1;if(!isCup)if("BB"==course||oMap.map<=20){if(e>oMap.w-5||t>oMap.h-5||e<4||t<4)return 1}else if(e>=oMap.w||t>=oMap.h||e<0||t<0)return 1;for(var h=oMap.collision.rectangle,d=0;d<h.length;d++)if(pointInRectangle(e,t,h[d]))return 1;for(var m=oMap.collision.polygon,d=0;d<m.length;d++)if(pointInPolygon(e,t,m[d]))return 1;if(!isCup)if("BB"==course||oMap.map<=20){if(r>oMap.w-5||l>oMap.h-5||r<4||l<4)return}else if(r>=oMap.w||l>=oMap.h||r<0||l<0)return;for(var g=[e,t],y=[n,o],f=[0<n,0<o],d=0;d<h.length;d++)for(var S=h[d],v=0;v<2;v++){var b=f[v];if(b?g[v]<=S[v]&&g[v]+y[v]>=S[v]:g[v]>=S[v]+S[v+2]&&g[v]+y[v]<=S[v]+S[v+2]){var M=1-v,C=g[M]+((b?S[v]:S[v]+S[v+2])-g[v])*y[M]/y[v];if(C>=S[M]&&C<=S[M]+S[2+M])return}}for(d=0;d<m.length;d++)for(var x=m[d],v=0;v<x.length;v++){var P=x[v],k=x[(v+1)%x.length];if(secants(e,t,r,l,P[0],P[1],k[0],k[1]))return}return 1}function getLineHorizontality(e,t,a,n,o){for(var i=null,r=1,l=0;l<o.length;l++){var s=o[l],c=secants(e,t,a,n,s.x1,s.y1,s.x2,s.y2);c&&c[0]<r&&(r=c[0],i={dir:[s.x2-s.x1,s.y2-s.y1],t:r})}return i}function secants(e,t,a,n,o,i,r,l){var s=-a*l+a*i+e*l-e*i+r*n-r*t-o*n+o*t,c=(-r*t+o*t-e*i+e*l+r*i-o*l)/s;if(0<=c&&c<=1){var p=(e*n-a*t+a*i-e*i-o*n+o*t)/s;if(0<=p&&p<=1)return[c,p]}return null}function intersectionLineLine(e,t,a,n,o,i,r,l){return 1}function projete(e,t,a,n,o,i){var r=(o-a)*(o-a)+(i-n)*(i-n);return r?(-a*o+a*a+e*o-e*a-n*i+n*n+t*i-t*n)/r:1}function intersectionLineCircle(e,t,a,n,o,i,r){var l=a*a,s=i*i,c=r*r,p=-s*(o*o)+2*s*t*o+2*i*r*n*o-2*i*r*e*o-s*(t*t)-2*i*r*n*t+2*i*r*e*t-c*(n*n)+2*c*e*n-c*(e*e)+l*c+l*s;if(0<=p){var u=s+c,d=r*o-r*t+i*n-i*e;return(Math.sqrt(p)-d)/u}return NaN}function followCircleWithAngle(e,t,a,n,o,i){var r=Math.hypot(o,i),l=Math.hypot(a-e,n-t),s=Math.atan2(i,o)-Math.atan2(n-t,a-e),c=Math.sin(s);if(r&&c){var p=l/(2*c);return[a-i*p/r,n+o*p/r,p]}return[a,n,l]}function nextAiStop(e,t,a,n,o,i,r,l,s){var c=Math.hypot(a,n),p=Math.hypot(r,l),u=r*n-a*l;if(c&&p&&u)for(var d=-1;d<2;d+=2)for(var h=-1;h<2;h+=2){var m=(a*(-s*h*p+r*(i-t)-l*o)+r*s*d*c+n*r*e)/u,g=(n*(-s*h*p+r*i+l*(e-o))+l*s*d*c-a*l*t)/u,y=l*s*-h/p,f=h*(r*s)/p,S=projete(m+n*s*-d/c,g+d*(a*s)/c,e,t,e+a,t+n),v=projete(m+y,g+f,o,i,o+r,i+l);if(S<=1&&0<=v)return S}return 0<a*r+n*l?1:0}function aiMarginLimitSpeed(e,t,a,n,o,i,r,l,s,c){for(var p=Math.hypot(r,l),u=1/0,d=-1;d<2;d+=2){var h=aiMarginLimitRadius(e,t,a,n,o+d*l*s/p,i-d*r*s/p,r,l);h<u&&(u=h)}return 2*u*c}function aiMarginLimitRadius(e,t,a,n,o,i,r,l){var s=o-e,c=i-t,p=a*a*l*l-2*a*n*r*l+n*n*r*r,u=a*a*(l*l*l*l+r*r*l*l)+a*n*r*l*(-2*l*l-2*r*r)+n*n*r*r*(l*l+r*r);if(p&&u)for(var d=-1;d<2;d+=2){var h=Math.hypot(a,n),m=Math.hypot(r,l),g=(n*(-d*s*h*l*m+d*c*h*r*m+a*(s*r*l-c*r*r))+n*n*(s*l*l-c*r*l))/p,y=-(a*(d*c*h*r*m-d*s*h*l*m)+a*n*(s*l*l-c*r*l)+a*a*(s*r*l-c*r*r))/p,f=(n*l*l*(d*c*h*r*m-d*s*h*l*m)+a*r*l*(d*c*h*r*m-d*s*h*l*m)+n*n*l*(s*l*l*l-c*r*l*l+s*r*r*l-c*r*r*r)+a*a*l*(s*l*l*l-c*r*l*l+s*r*r*l-c*r*r*r))/u,S=-(n*r*l*(d*c*h*r*m-d*s*h*l*m)+a*r*r*(d*c*h*r*m-d*s*h*l*m)+n*n*r*(s*l*l*l-c*r*l*l+s*r*r*l-c*r*r*r)+a*a*(s*r*l*l*l-c*r*r*l*l+s*r*r*r*l-c*r*r*r*r))/u,v=rotateVector(a,n,Math.atan2(S,f)-Math.atan2(y,g));if(0<=v[0]*r-v[1]*l)return Math.hypot(g,y)}return 1/0}function rotateVector(e,t,a){var n=Math.cos(a),o=Math.sin(a);return[e*n-t*o,e*o+t*n]}function getHorizontality(e,t,a,n){var o,i={t:1},r=e+a,l=t+n;if(isCup||("BB"==course||oMap.map<=20?((r>oMap.w-5||r<4)&&(i.dir=[0,oMap.h]),(l>oMap.h-5||l<4)&&(i.dir=[oMap.w,0])):((r>=oMap.w||r<0)&&(i.dir=[0,oMap.h]),(l>=oMap.h||l<0)&&(i.dir=[oMap.w,0]))),oMap.decor)for(var s in oMap.decor)for(var c=0;c<oMap.decor[s].length;c++){var p=oMap.decor[s][c],u=decorBehaviors[s].hitbox||DEFAULT_DECOR_HITBOX;(m=getLineHorizontality(e,t,r,l,g=[{x1:p[0]-u,y1:p[1]-u,x2:p[0]+u,y2:p[1]-u},{x1:p[0]-u,y1:p[1]-u,x2:p[0]-u,y2:p[1]+u},{x1:p[0]-u,y1:p[1]+u,x2:p[0]+u,y2:p[1]+u},{x1:p[0]+u,y1:p[1]-u,x2:p[0]+u,y2:p[1]+u}]))&&m.t<i.t&&(i=m)}if(oMap.collision){for(var d=oMap.collision.rectangle,c=0;c<d.length;c++){(m=getLineHorizontality(e,t,r,l,g=[{x1:(p=d[c])[0],y1:p[1],x2:p[0]+p[2],y2:p[1]},{x1:p[0],y1:p[1],x2:p[0],y2:p[1]+p[3]},{x1:p[0]+p[2],y1:p[1],x2:p[0]+p[2],y2:p[1]+p[3]},{x1:p[0],y1:p[1]+p[3],x2:p[0]+p[2],y2:p[1]+p[3]}]))&&m.t<i.t&&(i=m)}for(var h=oMap.collision.polygon,c=0;c<h.length;c++){for(var m,g=[],y=h[c],f=0;f<y.length;f++){var S=y[f],v=y[(f+1)%y.length];g.push({x1:S[0],y1:S[1],x2:v[0],y2:v[1]})}(m=getLineHorizontality(e,t,r,l,g))&&m.t<i.t&&(i=m)}}return i.dir?(o=Math.hypot(i.dir[0],i.dir[1]),i.dir[0]/=o,i.dir[1]/=o):i.dir=[.7,.7],i.dir}function normalizeAngle(e,t){return e-t*Math.round(e/t)}function nearestAngle(e,t,a){return e+a*Math.round((t-e)/a)}function objet(e,t){for(var a=0;a<oMap.arme.length;a++){var n=oMap.arme[a];if(e>n[0]-7&&e<n[0]+7&&t>n[1]-7&&t<n[1]+7&&isNaN(n[2])){for(var o=0;o<strPlayer.length;o++)n[2][o].div.style.display="none";return n[2]=20,touchedObject=a,1}}}function touche_piece(e,t){if(oMap.coins)for(var a=0;a<oMap.coins.length;a++){var n=oMap.coins[a];if(e>n.x-5&&e<n.x+5&&t>n.y-5&&t<n.y+5)return n.sprite[0].suppr(),oMap.coins.splice(a,1),1}}function sauts(e,t,a,n){if(!oMap.sauts)return!1;for(var o=[e,t],i=[a,n],r=[0<a,0<n],l=0;l<oMap.sauts.length;l++){var s=oMap.sauts[l];if(pointInRectangle(e,t,s))return s[4];for(var c=0;c<2;c++){var p=r[c];if(p?o[c]<=s[c]&&o[c]+i[c]>=s[c]:o[c]>=s[c]+s[c+2]&&o[c]+i[c]<=s[c]+s[c+2]){var u=1-c,d=o[u]+((p?s[c]:s[c]+s[c+2])-o[c])*i[u]/i[c];if(d>=s[u]&&d<=s[u]+s[2+u])return s[4]}}}return!1}function ralenti(e,t){for(var a in oMap.horspistes){for(var n=oMap.horspistes[a],o=n.rectangle,i=0;i<o.length;i++)if(pointInRectangle(e,t,o[i]))return a;for(var r=n.polygon,i=0;i<r.length;i++)if(pointInPolygon(e,t,r[i]))return a}return!1}function getOffroadProps(e,t){switch(t){case"herbe":return{speed:1.9+e.speedinc/2};case"glace":return{speed:2.8+e.speedinc/2,sliding:8};case"eau":return{speed:2.7,sliding:5};case"choco":return{speed:2.1,sliding:4}}}function accelere(e,t){if(oMap.accelerateurs)for(var a=0;a<oMap.accelerateurs.length;a++){if(pointInRectangle(e,t,oMap.accelerateurs[a]))return 1}}function flowShift(e,t,a){if(oMap.flows){for(var n=oMap.flows.rectangle,o=0;o<n.length;o++){if(pointInRectangle(e,t,(i=n[o])[0])&&(!a||i[2]))return[i[1][0],i[1][1],0]}for(var i,r=oMap.flows.polygon,o=0;o<r.length;o++){if(pointInPolygon(e,t,(i=r[o])[0])&&(!a||i[2]))return[i[1][0],i[1][1],0]}}if(oMap.spinners)for(var l=oMap.spinners,o=0;o<l.length;o++){var s=l[o],c=e-s[0],p=t-s[1];if(c*c+p*p<s[2]*s[2])return[p*s[3],-c*s[3],s[3]]}return[0,0,0]}function tombe(e,t,a){if(e>oMap.w||t>oMap.h||e<0||t<0){var n=null!=oMap.startposition[2]?oMap.startposition[2]:null!=oMap.startrotation?oMap.startrotation/90:2;return"BB"==course||[oMap.startposition[0],oMap.startposition[1],n]}if(!oMap.trous)return!1;for(var o,i=0;i<4;i++){for(var r=oMap.trous[i].rectangle,l=0;l<r.length;l++){if(pointInRectangle(e,t,(s=r[l])[0])){if(null==a)return!0;if(o=[s[1][0],s[1][1],i],i%2-a)return o}}for(var s,c=oMap.trous[i].polygon,l=0;l<c.length;l++){if(pointInPolygon(e,t,(s=c[l])[0])){if(null==a)return!0;if(o=[s[1][0],s[1][1],i],i%2-a)return o}}}return o||!1}function inCannon(e,t){if(!oMap.cannons)return!1;for(var a=oMap.cannons.rectangle,n=0;n<a.length;n++){if(pointInRectangle(e,t,(o=a[n])[0]))return o[1]}for(var o,i=oMap.cannons.polygon,n=0;n<i.length;n++){if(pointInPolygon(e,t,(o=i[n])[0]))return o[1]}return!1}function getActualGameTimeMS(){return null!=timerMS?timerMS:67*(timer-1)}function getActualGameTime(){return getActualGameTimeMS()/1e3}var lambdaReturnsTrue=function(e){return!0};function addChallengeHud(e,t){var a,n;clHud[e]||((a=document.createElement("div")).innerHTML="<span>"+t.title+":</span> <span>"+t.value+"</span>"+(null!=t.out_of?"/<span>"+t.out_of+"</span>":""),n=a.getElementsByTagName("span"),oChallengeCpts.appendChild(a),clHud[e]={$cpt:a,$label:n[0],$value:n[1],$outOf:n[2]})}function updateChallengeHud(e,t){clHud[e]&&(clHud[e].$value.innerText=t)}var challengeRules={finish_circuit:{verify:"end_game",success:lambdaReturnsTrue},finish_circuit_first:{verify:"end_game",success:function(e){return 1==oPlayers[0].place}},finish_circuit_time:{verify:"end_game",success:function(e){return getActualGameTime()<=e.value}},finish_arena:{verify:"end_game",success:lambdaReturnsTrue},finish_arena_first:{verify:"end_game",success:function(e){return 1==oPlayers[0].place}},hit:{verify:"each_hit",initLocalVars:function(e){clLocalVars.myItems=[],clLocalVars.nbHits=0},initSelected:function(e){addChallengeHud("hits",{title:toLanguage("Hits","Touchés"),value:clLocalVars.nbHits,out_of:e.value})},success:function(e){if(clLocalVars.nbHits>=e.value)return!0}},eliminate:{verify:"each_kill",initLocalVars:function(e){clLocalVars.myItems=[],clLocalVars.killed=[],clLocalVars.nbKills=0,clLocalVars.nbHits=0},initSelected:function(e){addChallengeHud("kills",{title:toLanguage("Defeated","Eliminés"),value:clLocalVars.nbKills,out_of:e.value})},success:function(e){if(clLocalVars.nbKills>=e.value)return!0}},survive:{verify:"each_frame",success:function(e){if(getActualGameTime()>=e.value)return!0}},reach_zone:{verify:"each_frame",initLocalVars:function(e){e.zones||(e.zones=classifyByShape(e.value))},success:function(e){for(var t=e.zones,a=oPlayers[0].x,n=oPlayers[0].y,o=t.rectangle,i=0;i<o.length;i++)if(pointInRectangle(a,n,o[i]))return!0;for(var r=t.polygon,i=0;i<r.length;i++)if(pointInPolygon(a,n,r[i]))return!0}},reach_zones:{verify:"each_frame",initLocalVars:function(e){e.zones||(e.zones=classifyByShape(e.value)),clLocalVars.reached=[],clLocalVars.reached.length=e.value.length;for(var t=0;t<clLocalVars.reached.length;t++)clLocalVars.reached[t]=!1;clLocalVars.nbPass=0},initSelected:function(e){addChallengeHud("zones",{title:toLanguage("Zones","Zones"),value:clLocalVars.nbPass,out_of:e.value.length})},success:function(e){for(var t=e.zones,a=e.value,n=oPlayers[0].x,o=oPlayers[0].y,i=t.rectangle,r=[],l=0;l<i.length;l++)pointInRectangle(n,o,i[l])&&r.push(a.indexOf(i[l]));for(var s=t.polygon,l=0;l<s.length;l++)pointInPolygon(n,o,s[l])&&r.push(a.indexOf(s[l]));r.sort();for(l=0;l<r.length;l++){var c=r[l];if(!clLocalVars.reached[c]){if(e.ordered&&c&&!clLocalVars.reached[c-1])break;if(clLocalVars.reached[c]=!0,clLocalVars.nbPass++,iSfx&&playSoundEffect("musics/events/clpass.mp3"),updateChallengeHud("zones",clLocalVars.nbPass),clLocalVars.nbPass>=a.length)return!0}}}},hit_items:{verify:"each_item",initLocalVars:function(e){clLocalVars.nbItems=0,clLocalVars.itemsHit=[],clLocalVars.itemsHit.length=oMap.arme.length},initSelected:function(e){addChallengeHud("items",{title:toLanguage("Items","Objets"),value:clLocalVars.nbItems,out_of:oMap.arme.length})},success:function(e){if(clLocalVars.nbItems>=oMap.arme.length)return!0}},collect_coins:{verify:"each_coin",initLocalVars:function(e){clLocalVars.nbCoins=0,e.nb||(e.nb=e.value.length)},initSelected:function(e){if(!oMap.coins){oMap.coins=[];for(var t=0;t<e.value.length;t++){for(var a=e.value[t],n={x:a[0],y:a[1],theta:2*Math.PI*Math.random(),sprite:new Sprite("coin")},o=0;o<oPlayers.length;o++)n.sprite[o].img.style.width="100%",n.sprite[o].w=24,n.sprite[o].h=24;oMap.coins.push(n)}}addChallengeHud("coins",{title:toLanguage("Coins","Pièces"),value:clLocalVars.nbCoins,out_of:e.nb})},success:function(e){if(clLocalVars.nbCoins>=e.nb)return!0}},gold_cup:{verify:"end_gp",initRuleVars:function(){return{nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits)return 1==oPlayers[0].place},next_circuit:function(e){e.nbcircuits++}},gold_cups:{verify:"end_gp",initRuleVars:function(e){return{challenge:e,nbcircuits:0}},success:function(e,t){if(clLocalVars.endGP&&4==t.nbcircuits){if(1!=oPlayers[0].place)return!1;var a=(a=sessionStorage.getItem("cl"+t.challenge.id+".gold_cups"))||"{}";if(a=JSON.parse(a),!t.challenge.data.constraints.length)for(var n=0;n<ptsGP.length;n++)3==ptsGP.charAt(n)&&(a[cupIDs[n]]=!0);for(var o=a[cupIDs[oMap.ref/4-1]]=!0,n=0;n<cupIDs.length;n++){if(!a[cupIDs[n]]){o=!1;break}}if(o)return sessionStorage.removeItem("cl"+t.challenge.id+".gold_cups"),!0}},next_circuit:function(e){e.nbcircuits++},finish_gp:function(e){if(4==e.nbcircuits){var t=(t=sessionStorage.getItem("cl"+e.challenge.id+".gold_cups"))||"{}";(t=JSON.parse(t))[cupIDs[oMap.ref/4-1]]=!0,sessionStorage.setItem("cl"+e.challenge.id+".gold_cups",JSON.stringify(t));var a=!e.challenge.data.constraints.length;if(a)for(var n=0;n<ptsGP.length;n++)3==ptsGP.charAt(n)&&(t[cupIDs[n]]=!0);showChallengePartialSuccess(e.challenge,{nb:Object.keys(t).length,total:cupIDs.length,warning:!a})}}},finish_circuits_first:{verify:"end_game",initRuleVars:function(){return{nbcircuits:1}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){return 1==oPlayers[0].place&&(t.nbcircuits>=e.value||void 0)},next_circuit:function(e){e.nbcircuits++}},pts_greater:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{nbcircuits:1,initialscore:0}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){if(t.nbcircuits==e.value&&aScores[0]>=e.pts)return!0},next_circuit:function(e){e.nbcircuits++}},pts_equals:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{nbcircuits:1}},initSelected:function(e,t){t&&t.nbcircuits&&addChallengeHud("races",{title:toLanguage("Race","Course"),value:t.nbcircuits,out_of:e.value})},success:function(e,t){if(t.nbcircuits==e.value&&aScores[0]==e.pts)return!0},next_circuit:function(e){e.nbcircuits++}},game_mode:{success:function(e){return course==["VS","CM"][e.value]}},game_mode_cup:{success:function(e){return course==["GP","VS"][e.value]}},difficulty:{success:function(e){return iDificulty==4+.5*(2-e.value)}},no_teams:{success:function(e){return!iTeamPlay}},participants:{success:function(e){return aKarts.length==e.value}},balloons:{success:function(e){return(!oPlayers[0].lost||clLocalVars.gagnant==oPlayers[0])&&oPlayers[0].ballons.length+oPlayers[0].reserve>=e.value}},balloons_lost:{initSelected:function(e,t){addChallengeHud("balloons",{title:toLanguage("Balloons","Ballons"),value:clLocalVars.lostBalloons,out_of:e.value})},success:function(e){return(!oPlayers[0].loose||clLocalVars.gagnant==oPlayers[0])&&clLocalVars.lostBalloons<=e.value}},no_drift:{success:function(e){return!clLocalVars.drifted}},avoid_items:{success:function(e){return!clLocalVars.itemsGot}},no_item:{success:function(e){return!clLocalVars.itemsUsed}},avoid_decors:{initLocalVars:function(e){clLocalVars.decorsHit||(clLocalVars.decorsHit={})},success:function(e){for(var t in e.value)if(clLocalVars.decorsHit[t])return!1;return!0}},character:{success:function(e){return oPlayers[0].personnage==e.value}},falls:{initRuleVars:function(){return{falls:0}},initSelected:function(e,t){t&&addChallengeHud("falls",{title:toLanguage("Falls","Chutes"),value:clLocalVars.falls+t.falls,out_of:e.value})},success:function(e,t){if(t)return clLocalVars.falls+t.falls<=e.value},next_circuit:function(e){e&&(e.falls+=clLocalVars.falls)}},no_stunt:{success:function(e){return!clLocalVars.stunted}},backwards:{initSelected:function(e){clLocalVars.backwardsStart=!0},success:function(e){return!clLocalVars.forwards}},time:{success:function(e){return getActualGameTime()<=e.value}},time_delay:{initSelected:function(e){clLocalVars.delayedStart=e.value},success:function(e){return!clLocalVars.startedAt||67*(clLocalVars.startedAt-1)/1e3>=e.value}},mini_turbo:{initRuleVars:function(){return{miniTurbo:0}},initSelected:function(e,t){t&&addChallengeHud("miniTurbo",{title:"Mini Turbos",value:clLocalVars.miniTurbo+t.miniTurbo,out_of:e.value})},success:function(e,t){if(t&&t.miniTurbo+clLocalVars.miniTurbo>=e.value)return!0},next_circuit:function(e){e&&(e.miniTurbo+=clLocalVars.miniTurbo)}},super_turbo:{initRuleVars:function(){return{superTurbo:0}},initSelected:function(e,t){t&&addChallengeHud("superTurbo",{title:"Super Turbos",value:clLocalVars.superTurbo+t.superTurbo,out_of:e.value})},success:function(e,t){if(t&&t.superTurbo+clLocalVars.superTurbo>=e.value)return!0},next_circuit:function(e){e&&(e.superTurbo+=clLocalVars.superTurbo)}},stunts:{initRuleVars:function(){return{stunts:0}},initSelected:function(e,t){t&&addChallengeHud("stunts",{title:toLanguage("Stunts","Figures"),value:clLocalVars.stunts+t.stunts,out_of:e.value})},success:function(e,t){if(t&&t.stunts+clLocalVars.stunts>=e.value)return!0},next_circuit:function(e){e&&(e.stunts+=clLocalVars.stunts)}},position:{success:function(e){if(oPlayers[0].place==e.value)return!0}},with_pts:{verify:"end_game",initRuleVars:function(){return clGlobalVars.nbcircuits?{}:{firstAttempt:!0}},success:function(e,t){if(t.firstAttempt&&aScores[0]>=e.value)return!0}},different_circuits:{initRuleVars:function(){return{played_circuits:{}}},success:function(e,t){return!t.played_circuits[oMap.ref]},next_circuit:function(e){e.played_circuits[oMap.ref]=!0}}};function addCreationChallenges(e,t){var a=challenges[e][t];if(a)for(var n=a.list,o=0;o<n.length;o++){var i=n[o];if(!i.succeeded){var r=i.data,l=challengeRules[r.goal.type].verify;challengesForCircuit[l].push(i);for(var s=listChallengeRules(r),c=0;c<s.length;c++)initChallengeRule(i,s[c])}}}function listChallengeRules(e){var t=e.constraints.slice(0);return t.unshift(e.goal),t}function initChallengeRule(e,t){challengeRules[t.type].initRuleVars&&(clRuleVars[e.id]||(clRuleVars[e.id]={}),clRuleVars[e.id][t.type]||(clRuleVars[e.id][t.type]=challengeRules[t.type].initRuleVars(e)))}function reinitChallengeVars(){for(var e in challengesForCircuit)for(var t=challengesForCircuit[e],a=0;a<t.length;a++)for(var n=t[a],o=listChallengeRules(n.data),i=0;i<o.length;i++)initChallengeRule(n,o[i]);reinitLocalVars()}function reinitLocalVars(){for(var e in clLocalVars={drifted:!1,stunted:!1,itemsGot:!1,itemsUsed:!1,falls:0,miniTurbo:0,superTurbo:0,stunts:0,lostBalloons:0,cheated:!1},clHud={},challengesForCircuit)for(var t=challengesForCircuit[e],a=0;a<t.length;a++)for(var n=t[a],o=listChallengeRules(n.data),i=0;i<o.length;i++){var r,l=o[i];challengeRules[l.type].initLocalVars&&challengeRules[l.type].initLocalVars(l),clSelected===n&&challengeRules[l.type].initSelected&&(r=clRuleVars[n.id]?clRuleVars[n.id][l.type]:void 0,challengeRules[l.type].initSelected(l,r))}}function challengeCheck(e,t){if(!(clLocalVars.cheated||1<strPlayer.length))for(var a=challengesForCircuit[e],n=0;n<a.length;n++){var o=a[n],i=challengeRulesSatisfied(o,listChallengeRules(o.data));!0===i?(challengeSucceeded(o),a.splice(n,1),n--):!1===i?delete clRuleVars[o.id]:challengeHandleEvents(o,t)}}function challengeHandleEvents(e,t){if(t){var a=clRuleVars[e.id];if(a)for(var n=listChallengeRules(e.data),o=0;o<t.length;o++)for(var i=t[o],r=0;r<n.length;r++){var l=n[r];challengeRules[l.type][i]&&challengeRules[l.type][i](a[l.type])}}}var clSelectionFail=!1;function challengeHandleFail(){clSelectionFail||clSelected.succeeded||(clSelectionFail=!0,clHud={},oChallengeCpts.innerHTML="",1<timer&&showClFailedPopup())}function challengeRulesSatisfied(e,t){for(var a=!0,n=0;n<t.length;n++){var o=challengeRuleSatisfied(e,t[n]);if(!1===o)return!1;!0!==o&&(a=!1)}return!!a||null}function challengeRuleSatisfied(e,t){var a=clRuleVars[e.id]?clRuleVars[e.id][t.type]:void 0;return challengeRules[t.type].success(t,a)}function challengeSucceeded(i){i.succeeded||(i.succeeded=!0,clSelected==i&&(clSelected=void 0,clHud={}),"pending_completion"===i.status&&(i.status="pending_publication"),delete clRuleVars[i.id],xhr("challengeSucceeded.php","id="+i.id,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}if(showChallengePopup(i,t),t.rewards)for(var a=0;a<t.rewards.length;a++)for(var n=t.rewards[a].id,o=0;o<clRewards.length;o++)if(clRewards[o].id==n){clRewards[o].unlocked=1;break}return!0}))}function showChallengePartialSuccess(e,t){var a,n,o,i,r,l,s,c;document.getElementById("challenge-popup-"+e.id)||((a=document.createElement("div")).id="challenge-popup-"+e.id,a.className="challenge-popup challenge-popup-partial",a.style.width=56*iScreenScale+"px",a.style.left=12*iScreenScale+"px",a.style.top=Math.round(4.5*iScreenScale)+"px",a.style.padding=Math.round(1.5*iScreenScale)+"px",a.style.paddingBottom=5*iScreenScale+"px",a.style.border="inset "+Math.round(.5*iScreenScale)+"px #07B",a.style.fontSize=2*iScreenScale+"px",a.style.opacity=0,n=language?"Challenge being completed":"Défi en cours de réussite",o=e.description.main,i=language?"Cups completed: "+t.nb+"/"+t.total:"Coupes réussies: "+t.nb+"/"+t.total,r=language?"Caution, progress will be lost when you close the browser":"Attention, toute progression sera perdue à la fermeture du navigateur.",l=language?"Close":"Fermer",a.innerHTML='<div style="font-size: '+Math.round(2*iScreenScale)+'px"><img src="images/cups/cup2.png" alt="star" class="pixelated" style="width:'+Math.round(2.5*iScreenScale)+'px" /> <h1 class="challenge-popup-title" style="margin:'+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+'px">'+n+'</h1></div><div class="challenge-popup-header" style="font-size: '+Math.round(2.25*iScreenScale)+'px">'+o+'</div><div class="challenge-popup-award" style="margin:'+iScreenScale+'px 0">'+i+"</div>"+(t.warning?'<div class="challenge-popup-disclaimer" style="margin:'+iScreenScale+'px 0">'+r+"</div>":"")+'<div class="challenge-popup-close" style="font-size:'+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+'px"><a href="javascript:closeChallengePopup('+e.id+');">'+l+"</a></div>",(s=document.getElementsByClassName("challenge-popup")).length?$mkScreen.insertBefore(a,s[0]):$mkScreen.appendChild(a),c=0,function e(){c<1?(a.style.opacity=c,c+=.2,setTimeout(e,40)):a.style.opacity=1}(),focusOnChallengeClose())}function showChallengePopup(t,a){if(!document.getElementById("challenge-popup-"+t.id)){var e=a.pts,n=document.createElement("div");n.id="challenge-popup-"+t.id,n.className="challenge-popup",n.style.width=56*iScreenScale+"px",n.style.left=12*iScreenScale+"px",n.style.top=Math.round(4.5*iScreenScale)+"px",n.style.padding=Math.round(1.5*iScreenScale)+"px",n.style.paddingBottom=5*iScreenScale+"px",n.style.border="inset "+Math.round(.5*iScreenScale)+"px #7B0",n.style.fontSize=2*iScreenScale+"px",n.style.opacity=0;var o=language?"Challenge completed!":"Défi réussi !",i=t.description.main,r=language?"You receive a reward of <strong>"+e+" pt"+(2<=e?"s":"")+"</strong>.":"Vous recevez <strong>"+e+" pt"+(2<=e?"s":"")+"</strong> en récompense.",l=language?"Your challenge points goes from <strong>"+a.pts_before+"</strong> to <strong>"+a.pts_after+"</strong>!":"Vos points défis passent de <strong>"+a.pts_before+"</strong> à <strong>"+a.pts_after+"</strong> !",s=language?"Close":"Fermer";if(n.innerHTML='<div style="font-size: '+Math.round(2*iScreenScale)+'px"><img src="images/cups/cup1.png" alt="star" class="pixelated" style="width:'+Math.round(2.5*iScreenScale)+'px" /> <h1 class="challenge-popup-title" style="margin:'+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+'px">'+o+'</h1></div><div class="challenge-popup-header" style="font-size: '+Math.round(2.25*iScreenScale)+'px">'+i+"</div>"+(e?'<div class="challenge-popup-award" style="margin:'+iScreenScale+'px 0">'+r+"<br />"+l+"</div>":"")+(0<=a.rating?'<div class="challenge-rating" style="margin-left:'+Math.round(3.5*iScreenScale)+"px;font-size:"+Math.round(2.5*iScreenScale)+'px">'+toLanguage("Rate this challenge:","Notez ce défi :")+'<div class="challenge-rating-stars"></div><div class="challenge-rated">'+toLanguage("Thanks","Merci")+"</div></div>":"")+(a.publish?'<div class="challenge-publish" style="margin:'+iScreenScale+'px 0">'+toLanguage("You can now","Vous pouvez maintenant")+' <a href="javascript:publishChallenge('+t.id+')">'+toLanguage("publish challenge","publier le défi")+"</a>.</div>":"")+'<div class="challenge-popup-close" style="font-size:'+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+'px"><a href="javascript:closeChallengePopup('+t.id+');">'+s+"</a></div>",0<=a.rating){var c=n.getElementsByClassName("challenge-rating-stars");(c=c[0]).style.position="relative",c.style.marginLeft=Math.round(.4*iScreenScale)+"px",c.style.marginRight=Math.round(.4*iScreenScale)+"px",c.style.top=Math.round(.4*iScreenScale)+"px";function p(){for(var e=+this.rating,t=0;t<e;t++)m[t].src="images/star1.png";for(t=e;t<5;t++)m[t].src="images/star0.png"}function u(){for(var e=0;e<a.rating;e++)m[e].src="images/star1.png";for(e=a.rating;e<5;e++)m[e].src="images/star0.png"}function d(){var e=+this.rating;a.rating=a.rating==e?0:e,u(),h.style.visibility="hidden",xhr("challengeRate.php","challenge="+t.id+"&rating="+a.rating,function(e){return 1==e&&(h.style.visibility="visible",!0)})}for(var h=(h=n.getElementsByClassName("challenge-rated"))[0],m=[],g=0;g<5;g++){var y=document.createElement("img");y.alt="S",y.src="images/star0.png",y.style.width=3*iScreenScale+"px",y.style.marginLeft=Math.round(.4*iScreenScale)+"px",y.style.marginRight=Math.round(.4*iScreenScale)+"px",y.rating=g+1,y.onmouseover=p,y.onmouseout=u,y.onclick=d,m[g]=y,c.appendChild(y)}u()}var f=document.getElementsByClassName("challenge-popup");f.length?$mkScreen.insertBefore(n,f[0]):$mkScreen.appendChild(n);var S=0;if(!function e(){S<1?(n.style.opacity=S,S+=.2,setTimeout(e,40)):n.style.opacity=1}(),!pause&&document.onkeydown&&(clLocalVars.forcePause=!0,document.onkeydown({keyCode:findKeyCode("pause")}),delete clLocalVars.forcePause),(bMusic||iSfx)&&(challengeMusic||((challengeMusic=playSoundEffect("musics/events/challenge.mp3")).className="",endGPMusic?(pauseMusic(endGPMusic),challengeMusic.onended=function(){unpauseMusic(endGPMusic),challengeMusic=null}):willPlayEndMusic?(willPlayEndMusic=!1,challengeMusic.onended=function(){unpauseMusic(endingMusic),isEndMusicPlayed=!0,challengeMusic=null}):isEndMusicPlayed?(pauseMusic(endingMusic),challengeMusic.onended=function(){unpauseMusic(endingMusic),isEndMusicPlayed=!0,challengeMusic=null}):challengeMusic.onended=function(){challengeMusic=null})),a.unlocked)for(g=0;g<a.unlocked.length;g++)showChallengeRewardPopup(a.unlocked[g]);focusOnChallengeClose()}}function showChallengeRewardPopup(e){var t,a,n,o,i,r,l;document.getElementById("challenge-popup-reward-"+e.id)||((t=document.createElement("div")).id="challenge-popup-reward-"+e.id,t.className="challenge-popup",t.style.width=56*iScreenScale+"px",t.style.left=12*iScreenScale+"px",t.style.top=Math.round(4.5*iScreenScale)+"px",t.style.padding=Math.round(1.5*iScreenScale)+"px",t.style.paddingBottom=5*iScreenScale+"px",t.style.border="inset "+Math.round(.5*iScreenScale)+"px #7B0",t.style.fontSize=2*iScreenScale+"px",t.style.opacity=0,a=language?"New character unlocked!":"Nouveau perso débloqué !",n=language?"You can now play with <strong>"+e.name+"</strong>!":"Vous pouvez désormais jouer avec <strong>"+e.name+"</strong> !",(o=document.createElement("img")).src=getSpriteSrc(e.sprites),o.alt=e.name,o.className="pixelated",o.style.visibility="hidden",i=language?"Close":"Fermer",t.innerHTML='<div style="font-size: '+Math.round(2*iScreenScale)+'px"><img src="images/cups/cup1.png" alt="star" class="pixelated" style="width:'+Math.round(2.5*iScreenScale)+'px" /> <h1 class="challenge-popup-title" style="margin:'+Math.round(iScreenScale/2)+"px 0; font-size: "+Math.round(3.25*iScreenScale)+'px">'+a+'</h1></div><div class="challenge-popup-header" style="font-size: '+Math.round(2.25*iScreenScale)+'px">'+n+'</div><div class="challenge-popup-reward-ch"></div><div class="challenge-popup-close" style="font-size:'+2*iScreenScale+"px;bottom:"+iScreenScale+"px;right:"+Math.round(1.25*iScreenScale)+'px"><a href="javascript:closeChallengePopup(&quot;reward-'+e.id+'&quot;);">'+i+"</a></div>",t.getElementsByClassName("challenge-popup-reward-ch")[0].appendChild(o),o.onload=function(){var e=this.parentNode,t=iScreenScale/8,a=Math.round(t*this.naturalWidth/24),n=Math.round(t*this.naturalHeight);e.style.width=a+"px",e.style.height=n+"px",this.style.width=24*a+"px",this.style.height=n+"px",this.style.visibility=""},(r=document.getElementsByClassName("challenge-popup")).length?$mkScreen.insertBefore(t,r[0]):$mkScreen.appendChild(t),l=0,function e(){l<1?(t.style.opacity=l,l+=.2,setTimeout(e,40)):t.style.opacity=1}())}function focusOnChallengeClose(){var e,t,a=document.querySelectorAll(".challenge-popup .challenge-popup-close a");a.length?a[a.length-1].focus():(e=document.getElementById("reprendre"))?e.focus():(t=document.getElementById("octn"))&&t.focus()}function showClSelectedPopup(){var t=document.createElement("div");t.style.fontSize=2*iScreenScale+"px",t.className="clselected-popup",t.style.left=27*iScreenScale+"px",t.style.top=iHeight*iScreenScale+"px",t.innerHTML='<div class="clselected-close"><a href="#null">&times;</a></div><div class="clselected-ctn"><div>✔</div><div><strong>'+toLanguage("Challenge selected :","Défi sélectionné:")+"</strong> "+(clSelected.name||clSelected.description.main)+"</div></div>",t.querySelector(".clselected-close a").onclick=function(){return document.body.removeChild(t),!1},document.body.appendChild(t);var a=1;setTimeout(function e(){0<a?(t.style.opacity=a,a-=.04,setTimeout(e,40)):document.body.removeChild(t)},1500)}function showClFailedPopup(){var e=document.createElement("div");e.style.position="absolute",e.style.color="#C00",e.style.right=Math.round(iScreenScale/2)+"px",e.style.top=Math.round(2.5*iScreenScale)+"px",e.style.fontSize=Math.round(1.8*iScreenScale)+"px",e.style.display="flex",e.style.alignItems="center",e.style.fontFamily="Courier New",e.innerHTML='<strong style="color:#800;font-size:1.8em">&times;</strong>&nbsp;'+(language?"Challenge failed...":"Défi échoué..."),oChallengeCpts.parentNode.appendChild(e),!iSfx||finishing||oPlayers[0].cpu||playSoundEffect("musics/events/clfail.mp3")}window.closeChallengePopup=function(e){var t,a=document.getElementById("challenge-popup-"+e);a&&(clHud&&0===Object.keys(clHud).length&&oChallengeCpts.firstChild&&(oChallengeCpts.innerHTML=""),t=1,function e(){0<t?(a.style.opacity=t,t-=.2,setTimeout(e,40)):($mkScreen.removeChild(a),focusOnChallengeClose())}())},window.publishChallenge=function(e){for(var t in challenges)for(var a in challenges[t])for(var n=challenges[t][a],o=n.list,i=0;i<o.length;i++)o[i].id==e&&(n.main?openChallengeEditor():document.location.href="challenges.php?cl="+n.id)};var COL_KART=0,COL_OBJ=1,collisionTest,collisionPlayer,collisionTeam,collisionDecor,clLocalVars,clHud,clSelected;function isHitSound(e){return collisionTest==COL_OBJ||collisionTeam==e[2]&&{x:e[3],y:e[4]}}function handleHit(e){clLocalVars.myItems&&clLocalVars.currentKart&&clLocalVars.currentKart!=oPlayers[0]&&!clLocalVars.currentKart.tourne&&-1!=clLocalVars.myItems.indexOf(e)&&incChallengeHits(clLocalVars.currentKart)}function handleHit2(e,t){e==oPlayers[0]&&t!=oPlayers[0]&&incChallengeHits(t)}function incChallengeHits(e){clLocalVars.nbHits++,updateChallengeHud("hits",clLocalVars.nbHits),"BB"==course&&1==e.ballons.length&&clLocalVars.killed&&-1==clLocalVars.killed.indexOf(e)&&(clLocalVars.killed.push(e),clLocalVars.nbKills++,updateChallengeHud("kills",clLocalVars.nbKills)),challengeCheck("each_hit")}function touche_banane(e,t,a){for(var n=0;n<bananes.length;n++){var o=bananes[n];if(n!=a&&!o[5]&&e>o[3]-4&&e<o[3]+4&&t>o[4]-4&&t<o[4]+4)return handleHit(o),detruit(bananes,n,isHitSound(o)),collisionTeam!=o[2]}}function touche_fauxobjet(e,t,a){for(var n=0;n<fauxobjets.length;n++){var o=fauxobjets[n];if(n!=a&&!o[5]&&e>o[3]-4&&e<o[3]+4&&t>o[4]-4&&t<o[4]+4)return handleHit(o),detruit(fauxobjets,n,isHitSound(o)),collisionTeam!=o[2]}}function touche_cverte(e,t,a){for(var n=0;n<carapaces.length;n++){var o=carapaces[n];if(n!=a&&!o[5]&&e>o[3]-5&&e<o[3]+5&&t>o[4]-5&&t<o[4]+5)return handleHit(o),detruit(carapaces,n,isHitSound(o)),collisionTeam!=o[2]}}function touche_crouge(e,t,a){for(var n=0;n<carapacesRouge.length;n++){var o=carapacesRouge[n];if(!o[0][0].div.style.opacity&&n!=a&&!o[5]){if(-1!=o[7]&&e==o[3]&&t==o[4]){if(isOnline)detruit(carapacesRouge,n,isHitSound(o));else{handleHit(o);for(n=0;n<strPlayer.length;n++)o[0][n].div.style.opacity=.8}return collisionTeam!=o[2]}if(-1==o[7]&&e>o[3]-5&&e<o[3]+5&&t>o[4]-5&&t<o[4]+5)return handleHit(o),detruit(carapacesRouge,n,isHitSound(o)),collisionTeam!=o[2]}}}function touche_bobomb(e,t,a){for(var n=0;n<bobombs.length;n++){var o,i=bobombs[n];if(!i[5]&&n!=a)if(-1!=i[6]){var r=30;if(38<=i[8]?r=0:30<=i[8]&&(r=5),!i[7]&&e>i[3]-r&&e<i[3]+r&&t>i[4]-r&&t<i[4]+r){if(i[8]<=0){var l=collisionTeam!=i[2]&&(i[8]<-5?42:84);return l&&handleHit(i),l}i[8]=1}}else if(e>i[3]-5&&e<i[3]+5&&t>i[4]-5&&t<i[4]+5){for(j=0;j<aKarts.length;j++)aKarts[j].using[0]==bobombs&&n==aKarts[j].using[1]&&(aKarts[j].using=[!1],o=aKarts[j],j=aKarts.length);addNewItem(o,bobombs,[new Sprite("bob-omb"),-1,i[2],i[3],i[4],i[5],1,0,1]),detruit(bobombs,n),n--}}return!1}function touche_cbleue(e,t){for(var a=0;a<carapacesBleue.length;a++){var n=carapacesBleue[a];if(n[6]<0&&-10<=n[6]&&e>n[3]-30&&e<n[3]+30&&t>n[4]-30&&t<n[4]+30){var o=collisionTeam!=n[2]&&(n[6]<-5?42:84);return o&&handleHit(n),o}}return!1}function touche_asset(e,t,a,n){for(var o,i=["pointers","flippers"],r=0;r<i.length;r++){if(oMap[o=i[r]])for(var l=2*Math.PI,r=0;r<oMap[o].length;r++){var s=(e-(f=(b=oMap[o][r])[1][0]))*(e-f)+(t-(S=b[1][1]))*(t-S);if(s<(v=b[1][2]*(1-b[2][0]))*v){var c,p=b[2][2],u=Math.atan2(t-S,e-f),d=b[2][3];(a-f)*(a-f)+(n-S)*(n-S)<v*v&&(c=Math.atan2(n-S,a-f),d-=(c-=l*Math.round((c-u)/l))-u);var h=Math.sqrt(s),m=h/v,g=b[1][3]*(b[1][4]*(1-m)+b[1][5]*m)/h,y=0<d?(u-=l*Math.floor((u-p)/l))<p+d+g:p+d-g<(u-=l*Math.ceil((u-p)/l));if(y)return[o,b]}}}if(oMap[o="bumpers"])for(r=0;r<oMap[o].length;r++){if((a-(f=(b=oMap[o][r])[1][0]))*(a-f)+(n-(S=b[1][1]))*(n-S)<(v=b[1][2]/2)*v)return[o,b]}if(oMap[o="oils"])for(r=0;r<oMap[o].length;r++){var f=(b=oMap[o][r])[1][0],S=b[1][1],v=4;if(Math.abs(a-f)<v&&Math.abs(n-S)<v)return[o,b]}if(oMap[o="flowers"])for(r=0;r<oMap[o].length;r++){var b,M=(b=oMap[o][r])[1],C=M[0],x=M[1],P=Math.round(M[2]/2);if(pointInRectangle(a,n,[C-P,x-P,2*P,2*Math.round(M[3]/2)]))return[o,b]}return!1}function distKart(e){for(var t=1/0,a=0;a<oPlayers.length;a++){var n,o=oPlayers[a];!kartIsPlayer(o)||finishing||(n=Math.hypot(e.x-o.x,e.y-o.y))<t&&(t=n)}return t}function stuntKart(e){e.figstate=21,e.z+=1,e.heightinc+=.5,e==oPlayers[0]&&(clLocalVars.stunted=!0),playIfShould(e,"musics/events/stunt.mp3")}function places(e,t){for(var a=aKarts[e],n=!t,o=0;o<strPlayer.length;o++)oPlayers[o].cpu||oPlayers[o].loose||(n=!1);if(!n){var i=1;if("BB"!=course){if(a.tours>oMap.tours||!oMap.checkpoint.length)return;(s=a.demitours+1)>=oMap.checkpoint.length&&(s=0);for(var r=oMap.checkpoint[s][3],l=a.tours*oMap.checkpoint.length+getCpScore(a)-Math.abs(a[r?"y":"x"]-oMap.checkpoint[s][r])/1e4,o=0;o<aKarts.length;o++){var s,c=aKarts[o];(s=c.demitours+1)>=oMap.checkpoint.length&&(s=0),r=oMap.checkpoint[s][3],c!=a&&c.tours*oMap.checkpoint.length+getCpScore(c)-Math.abs(c[r?"y":"x"]-oMap.checkpoint[s][r])/1e4>l&&i++}}else for(o=0;o<aKarts.length;o++){var p=a.ballons.length?a.ballons.length+a.reserve:0,u=aKarts[o].ballons.length?aKarts[o].ballons.length+aKarts[o].reserve:0;(aKarts[o]!=a&&p<u||p==u&&a.initialPlace>aKarts[o].initialPlace)&&i++}a.loose||(a.place=i),e<strPlayer.length&&(document.getElementById("infoPlace"+e).innerHTML=toPlace(i))}}function getLastCp(e){return oMap.sections?1<e.tours&&e.tours<=oMap.tours?oMap.sections[e.tours-2]:oMap.checkpoint.length-1:0}function getNextCp(e){return oMap.sections?e.tours<=oMap.sections.length?oMap.sections[e.tours-1]:oMap.checkpoint.length-1:0}function getCpDiff(e){var t=getLastCp(e),a=getNextCp(e)-t;return a<=0&&(a+=oMap.checkpoint.length),a}function getCpScore(e){var t=getLastCp(e),a=e.demitours-t;return a<0&&(a+=oMap.checkpoint.length),a}function distanceToFirst(e){for(var t=1,a=0;a<aKarts.length;a++)if(aKarts[a].place==t){if(aKarts[a].tours<=oMap.tours){cible=a;break}t++,a=-1}if(-1==a)return 0;var n=aKarts[a],o=e.tours,i=e.demitours,r=0,l=e.x,s=e.y;for(oMap.sections&&(o=n.tours);o<n.tours||o==n.tours&&i<n.demitours;){++i>=oMap.checkpoint.length&&(i=0,o++);var c=oMap.checkpoint[i],p=c[0]+(c[3]?Math.round(c[2]/2):8),u=c[1]+(c[3]?8:Math.round(c[2]/2));r+=Math.hypot(p-l,u-s),l=p,s=u}return r+=Math.hypot(n.x-l,n.y-s)}function checkpoint(e,t,a){var n,o,i=[e.x-t,e.y-a],r=[t,a],l=[0<t,0<a],s=200<t*t+a*a,c=e.demitours;simplified||(o=((n=getNextCp(e))||oMap.checkpoint.length)-1);for(var p=0;p<oMap.checkpoint.length;p++){var u=oMap.checkpoint[p],d=[u[0],u[1],15,15];d[3-u[3]]=u[2];var h,m,g,y,f=pointInRectangle(e.x,e.y,d);if(!f&&s&&(!((m=l[h=u[3]])?i[h]<=u[h]&&i[h]+r[h]>=u[h]:i[h]>=u[h]+u[h+2]&&i[h]+r[h]<=u[h]+u[h+2])||(y=i[g=1-h]+((m?u[h]:u[h]+u[h+2])-i[h])*r[g]/r[h])>=u[g]&&y<=u[g]+u[2+g]&&(f=!0)),f)if(simplified){if(0==p&&oMap.checkpoint.length-c<5)return 1;if(c==p-1||c&&Math.abs(c-p)<5)return void(e.demitours=p)}else{if(p==n&&c==o)return 1;if(c==p-1||c==p+1)return void(e.demitours=p);if(0==p&&c==oMap.checkpoint.length-1)return void(e.demitours=p)}}}function resetDatas(){for(var oPlayer=oPlayers[0],params="BB"!=course?["x","y","z","speed","speedinc","heightinc","rotation","rotincdir","rotinc","size","tourne","tombe","tours","demitours","champi","etoile","megachampi","billball","eclair","place"]:["x","y","z","speed","speedinc","heightinc","rotation","rotincdir","rotinc","size","tourne","tombe","ballons","reserve","champi","etoile","megachampi"],paramsExcept=["demitours","ballons"],eParams={},i=0;i<paramsExcept.length;i++)eParams[paramsExcept[i]]=!0;for(var uSend="",i=0;i<params.length;i++)eParams[params[i]]||(uSend+=params[i]+"="+oPlayer[params[i]]+"&");"BB"==course?uSend+="ballons="+oPlayer.ballons.length+"&battle=1&":(uSend+="demitours="+getCpScore(oPlayer)+"&",3!=oMap.tours&&(uSend+="laps="+oMap.tours+"&"));var iObjets=[bananes,fauxobjets,carapaces,carapacesRouge,carapacesBleue,bobombs];oPlayer.using[0]&&(uSend+="i="+iObjets.indexOf(oPlayer.using[0])+"&j="+oPlayer.using[0][oPlayer.using[1]][1]+"&");var alpha="abcdef",idObjets=new Array;for(i=0;i<iObjets.length;i++){idObjets[i]=new Array;for(var j=0;j<iObjets[i].length;j++)idObjets[i][j]=iObjets[i][j][1]}for(nbNews=new Array,i=0;i<iObjets.length;i++){var iObjet=iObjets[i],lettre=alpha.charAt(i);for(nbNews[i]=new Array,j=0;j<iObjet.length;j++){for(var cObjet=iObjet[j],k=1;k<cObjet.length;k++)uSend+=lettre+j+"_"+(k-1)+"="+cObjet[k]+"&";-1==cObjet[1]&&nbNews[i].push(j)}}for(i=0;i<destructions.length;i++){for(var lettre=alpha.charAt(i),j=0;j<destructions[i].length;j++)uSend+=lettre+j+"="+destructions[i][j]+"&";destructions[i]=new Array}xhr("reload.php",uSend,function(reponse){if(refreshDatas=!0,reponse)if(-1!=reponse)try{for(var rCode=eval(reponse),aCodes=rCode[1],i=0;i<aCodes.length;i++)for(j=0;j<nbNews[i].length;j++)iObjets[i][nbNews[i]][1]=idObjets[i][nbNews[i]]=aCodes[i][aCodes[i].length-nbNews[i].length+j][0];var strSprites=["banane","objet","carapace","carapace-rouge","carapace-bleue","bob-omb"];for(i=0;i<aCodes.length;i++)for(j=0;j<aCodes[i].length;j++){for(var aID=aCodes[i][j][0],inArray=!0,k=0;k<idObjets[i].length;k++)if(idObjets[i][k]==aID){inArray=!1;break}if(inArray){var strSprite=strSprites[i];"carapace"==strSprite&&-1==aCodes[i][j][6]&&(strSprite="carapace-rouge");var toAdd=[new Sprite(strSprite),aID];for(k=1;k<aCodes[i][j].length;k++)toAdd.push(aCodes[i][j][k]);addNewItem(null,iObjets[i],toAdd)}}for(i=0;i<iObjets.length;i++)for(j=0;j<iObjets[i].length;j++){var oID=iObjets[i][j][1];if(-1!=oID){var inArray=!0;for(k=0;k<aCodes[i].length;k++)if(aCodes[i][k][0]==oID){inArray=!1;break}inArray&&(supprime(iObjets[i],j),j--)}}var jCodes=rCode[0];for(i=0;i<jCodes.length;i++){var jCode=jCodes[i];if(jCode[0][1]>=connecte){var pID=jCode[0][0];for(j=0;j<aKarts.length;j++)if(aKarts[j].id==pID){var pCode=jCode[1],aEtoile=aKarts[j].etoile,aBillBall=aKarts[j].billball,aEclair=aKarts[j].eclair,aTombe=aKarts[j].tombe,extraParams={};for(k=0;k<params.length;k++)eParams[params[k]]?extraParams[params[k]]=pCode[k]:aKarts[j][params[k]]=pCode[k];if("BB"==course){for(;aKarts[j].ballons.length<extraParams.ballons;)aKarts[j].ballons.length||(aKarts[j].sprite[0].div.style.opacity=1,aKarts[j].sprite[0].img.style.display="",oPlanCharacters[j].style.display="block",oPlanCharacters2[j].style.display="block",aKarts[j].loose=!1),addNewBalloon(aKarts[j]);for(;aKarts[j].ballons.length>extraParams.ballons;){var lg=aKarts[j].ballons.length-1;aKarts[j].ballons[lg][0].suppr(),aKarts[j].ballons.pop()}}else aKarts[j].demitours=(getLastCp(aKarts[j])+extraParams.demitours)%oMap.checkpoint.length;if(40<=aKarts[j].billball&&!aBillBall?(aKarts[j].sprite[0].img.src="images/sprites/sprite_billball.png",resetSpriteHeight(aKarts[j].sprite[0]),aKarts[j].aipoint=void 0):50<=aKarts[j].etoile&&!aEtoile?aKarts[j].sprite[0].img.src=getStarSrc(aKarts[j].personnage):(aEtoile&&!aKarts[j].etoile||aBillBall&&!aKarts[j].billball)&&(aKarts[j].sprite[0].img.src=getSpriteSrc(aKarts[j].personnage),resumeSpriteSize(aKarts[j].sprite[0])),90<=aKarts[j].eclair&&!aEclair){for(k=0;k<aKarts.length;k++){var kart=aKarts[k];friendlyFire(kart,aKarts[j])||(kart.protect?kart.megachampi=kart.megachampi<8||kart.etoile?kart.megachampi:8:(kart.size=.6,updateDriftSize(k),kart.arme=!1,kart.using[0]&&(kart.using[0][kart.using[1]][5]&&(kart.using[0][kart.using[1]][5]=0),kart.using=[!1]),kart.champi=0,kart.spin(20),kart.roulette=0,stopDrifting(k),supprArme(k)))}$mkScreen.style.opacity=.7,!iSfx||finishing||oPlayers[0].cpu||playSoundEffect("musics/events/lightning.mp3")}else aEclair&&!aKarts[j].eclair&&oPlayers[0].size<1&&(oPlayers[0].size=1,updateDriftSize(j),$mkScreen.style.opacity=1);if(updateProtectFlag(aKarts[j]),aTombe&&!aKarts[j].tombe&&(aKarts[j].sprite[0].img.style.display="block","BB"==course))for(var k=0;k<aKarts[j].ballons.length;k++)aKarts[j].ballons[k][0].img.style.display="block";if(!aTombe&&aKarts[j].tombe&&(aKarts[j].sprite[0].img.style.display="none",2<aKarts[j].tombe)){if("BB"==course)for(var k=0;k<aKarts[j].ballons.length;k++)aKarts[j].ballons[k][0].img.style.display="none";aKarts[j].marker&&(aKarts[j].marker.div[0].style.display="none")}!aKarts[j].turnSound&&aKarts[j].tourne&&(aKarts[j].turnSound=playDistSound(aKarts[j],"musics/events/spin.mp3","BB"==course?80:50)),aKarts[j].turnSound&&!aKarts[j].tourne&&(aKarts[j].turnSound=void 0);var uID=jCode[0][3];if(-1==uID)aKarts[j].using=[!1];else{aKarts[j].using=[!1];var iObjet=iObjets[jCode[0][2]];for(k=0;k<iObjet.length;k++)if(uID==iObjet[k][1]){aKarts[j].using=[iObjets[jCode[0][2]],k];break}}for(k=jCode[0][1];k<rCode[2];k++)move(j);break}}}if(connecte=rCode[2],rCode[3]){function displayRankings(){var e=oPlayers[0];"BB"==course&&(e.arme=!1,supprArme(e.speed=0)),e.speedinc=0,e.rotinc=0,e.rotincdir=0,e.sprite[0].setState(0),stopDrifting(0);var p=document.getElementById("infos0");p.innerHTML="",p.style.border="solid 1px black",p.style.opacity=.7,p.style.fontSize=Math.round(1.5*iScreenScale+4)+"pt",p.style.fontFamily="Courier",p.style.top=3*iScreenScale+"px",p.style.left=Math.round(25*iScreenScale+10)+"px",p.style.backgroundColor=iTeamPlay?"blue":"#063",p.style.color=primaryColor;var u=new Array,d=new Array;for(i=0;i<rCode[3].length;i++){var t=rCode[3][i],a=document.createElement("tr");d[i]=new Array,t[0]==identifiant?(a.style.backgroundColor=rankingColor(oPlayers[0].team),document.getElementById("infoPlace0").innerHTML=toPlace(i+1),document.getElementById("infoPlace0").style.visibility="visible"):1==t[4]&&(a.style.backgroundColor="red"),(o=document.createElement("td")).innerHTML=toPlace(i+1),d[i][0]=document.createElement("td"),d[i][0].innerHTML=t[1],d[i][1]=document.createElement("td"),d[i][1].innerHTML=t[2];var n=document.createElement("small");n.innerHTML=(t[3]<0?"":"+")+t[3],a.appendChild(o),a.appendChild(d[i][0]),d[i][1].appendChild(n),a.appendChild(d[i][1]),p.appendChild(a),u[i]=a}var o,a=document.createElement("tr");(o=document.createElement("td")).setAttribute("colspan",3);var h=document.createElement("input");h.type="button",h.value=toLanguage("CONTINUE","CONTINUER"),h.style.width="100%",h.style.height="100%",h.style.fontSize=3*iScreenScale+"pt";var r=!0;function l(){p.style.display="none";for(var e=0;e<rCode[3].length;e++)rCode[3][e][2]+=rCode[3][e][3];var t,a=rCode[3].length-1;for(e=0;e<a;e++){for(var n=0,o=0,i=e;i<rCode[3].length;i++)rCode[3][i][2]>=n&&(n=rCode[3][i][2],o=i);var r=rCode[3][e];rCode[3][e]=rCode[3][o],rCode[3][o]=r}for(e=0;e<d.length;e++){var l=rCode[3][e];d[e][0].innerHTML=toPerso(l[1]),d[e][1].innerHTML=l[2],l[0]==identifiant?u[e].style.backgroundColor=rankingColor(oPlayers[0].team):1==l[4]?u[e].style.backgroundColor="red":u[e].style.backgroundColor=""}if(iTeamPlay&&shareLink.options&&shareLink.options.localScore){for(var s=[0,0],e=0;e<rCode[3].length;e++)s[rCode[3][e][4]]+=rCode[3][e][2];t=createTeamTable(s)}var c=!0;setTimeout(function(){p.style.display="",t&&(t.style.visibility="visible"),isChatting()||h.focus()},500),setTimeout(function(){c&&continuer()},5e3),h.onclick=function(){c=!1,continuer()}}h.onclick=function(){r=!1,l()},setTimeout(function(){r&&l()},5e3),o.appendChild(h),a.appendChild(o),p.appendChild(a),p.style.display="",isChatting()||h.focus(),document.onkeydown=void 0,document.onkeyup=void 0,document.onmousedown=void 0,window.onbeforeunload=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0,supprArme(0),(bMusic||iSfx)&&startEndMusic(),finishing=!0,document.getElementById("racecountdown").innerHTML=rCode[4]-("BB"==course?6:5),document.getElementById("waitrace").style.visibility="visible",dRest(),document.getElementById("compteur0").innerHTML="",document.getElementById("roulette0").innerHTML="",document.getElementById("scroller0").style.visibility="hidden";var s=document.getElementById("lakitu0");s&&(s.style.display="none")}if(refreshDatas=!1,"BB"==course){for(var firstID=rCode[3][0][0],firstTeam=rCode[3][0][4],i=0;i<aKarts.length;i++){var oKart=aKarts[i];if((iTeamPlay?oKart.team!=firstTeam:oKart.id!=firstID)&&oKart.ballons.length&&!oKart.tourne){do{var lg=oKart.ballons.length-1;oKart.ballons[lg][0].suppr(),oKart.ballons.pop()}while(oKart.ballons.length);oKart.spin(20),oKart!=oPlayers[0]&&playDistSound(oKart,"musics/events/spin.mp3","BB"==course?80:50)}}setTimeout(displayRankings,1e3)}else displayRankings()}}catch(e){return!0}else iDeco(),pause=!0;return!0}),refreshDatas=!1}function loseBall(e){var t;"BB"==course&&(t=aKarts[e].ballons.length-1,!aKarts[e].tourne&&aKarts[e].ballons[t]&&(aKarts[e].ballons[t][0].suppr(),aKarts[e].ballons.pop(),aKarts[e].cpu||(clLocalVars.lostBalloons++,updateChallengeHud("balloons",clLocalVars.lostBalloons)),!isOnline||e||aKarts[e].ballons.length||(supprArme(e),document.getElementById("infoPlace0").style.visibility="hidden")))}function showTimer(e){for(var t=toLanguage("&nbsp;Time","Temps")+": "+timeStr(e),a=0;a<strPlayer.length;a++)document.getElementById("temps"+a).innerHTML=t}function move(e){var t=aKarts[e];collisionTest=COL_KART,collisionTeam=-1==(collisionPlayer=t).team?void 0:t.team,clLocalVars.currentKart=t;var a,n,o,t=aKarts[e];if(e<strPlayer.length&&!t.cpu&&!finishing&&(showTimer(67*timer),e||timer++,t.time&&(t.time--,document.getElementById("lakitu"+e).style.left=Math.round(iScreenScale*(20-t.time/5))+"px",document.getElementById("lakitu"+e).style.top=Math.round((18-Math.abs(t.time-20))*(iScreenScale-2))+"px",t.time&&!oPlayers[e].changeView?document.getElementById("lakitu"+e).style.display="block":document.getElementById("lakitu"+e).style.display="none",oLapTimeDiv&&t.time<25&&(t.time<5?(oContainers[0].removeChild(oLapTimeDiv),oLapTimeDiv=void 0):oLapTimeDiv.style.visibility=t.time%6<4?"visible":"hidden"))),t.tombe){if(t.tombe--,updateDriftSize(e),t.size=1,19==t.tombe&&playIfShould(t,"musics/events/rescue.mp3"),2==t.tombe){if("BB"==course)for(var i=0;i<strPlayer.length;i++)for(var r=0;r<t.ballons.length;r++)t.ballons[r][i].img.style.display="block"}else if(!t.tombe){if(loseBall(e),"BB"==course){if(t.cpu&&1==t.ballons.length){var l=1+Math.round(Math.random());for(i=0;i<l&&t.reserve;i++)addNewBalloon(t),t.reserve--}if(!t.ballons.length&&!t.loose)for(i=0;i<strPlayer.length;i++)t.sprite[i].div.style.opacity=1}for(i=0;i<strPlayer.length;i++)t.sprite[i].img.style.display="block"}t==oPlayers[e]&&(oContainers[e].style.opacity=Math.abs(t.tombe-10)/10)}else{if(t.rotincdir?(t.rotinc+=2*t.rotincdir,t.driftinc&&0<t.driftinc!=0<t.rotincdir&&(a=Math.max(1.1,1.6-Math.max(0,(t.driftcpt-20)/80)),0<t.driftinc?t.rotinc=Math.max(t.rotinc,-a):t.rotinc=Math.min(t.rotinc,a))):t.rotinc<0?t.rotinc=Math.min(0,t.rotinc+1):0<t.rotinc&&(t.rotinc=Math.max(0,t.rotinc-1)),handleDriftCpt(e),t.cpu?(t.rotinc=Math.min(t.rotinc,fMaxRotInCp),t.rotinc=Math.max(t.rotinc,-fMaxRotInCp)):(t.rotinc=Math.min(t.rotinc,fMaxRotInc),t.rotinc=Math.max(t.rotinc,-fMaxRotInc)),t.shift&&(t.rotation+=180*t.shift[2]/Math.PI),t.tourne||!t.speed||t.billball||t.figstate||t.cannon)if(t.tourne){if(t.figuring=!1,t.figstate=0,t.speed=(t.speed-Math.max(0,t.speedinc+.1))/1.5,t.tourne-=2,!t.tourne&&(t.frminv=t.cpu?16:10,"BB"==course)){if(t.cpu&&1==t.ballons.length){l=1+Math.round(Math.random());for(i=0;i<l&&t.reserve;i++)addNewBalloon(t),t.reserve--}if(!t.ballons.length&&!t.loose)for(i=0;i<strPlayer.length;i++)t.sprite[i].div.style.opacity=1}}else{t.figstate&&(t.figstate-=1+Math.round(.5*(11-Math.abs(11-t.figstate))),t.figstate<0&&(t.figstate=0),!t.figuring&&t.figstate<8&&(t.figuring=!0,t==oPlayers[0]&&(clLocalVars.stunts++,clSelected&&clRuleVars[clSelected.id]&&(me=clRuleVars[clSelected.id].stunts)&&updateChallengeHud("stunts",me.stunts+clLocalVars.stunts))))}else t.rotation+=(t.rotinc+1.5*(t.driftinc||0))*(t.speedinc<0||0==t.speedinc&&t.speed<0?-1:1)*Math.abs(Math.cos(angleDrift(t)*Math.PI/180)),t.frminv&&t.frminv--;t.rotation<0&&(t.rotation+=360),360<t.rotation&&(t.rotation-=360),kartIsPlayer(t)&&(!clLocalVars.startedAt&&1<t.speed&&(clLocalVars.startedAt=timer),clLocalVars.forwards||0<t.speed&&(0<t.speedinc||t.turbodrift)&&(clLocalVars.forwards=!0),n=t.sprite[e],t.changeView?t.tourne?(o=t.tourne%21,n.setState(o+(o<11?11:-11))):n.setState(11):t.figstate?n.setState((21-t.figstate)%21):t.driftinc?n.setState(0<t.driftinc?18:4):t.rotincdir&&!t.tourne?n.setState(0<t.rotincdir?23:22):n.setState(t.tourne%21));var s=t.maxspeed*t.size;t.speed>s&&(t.speed=s),t.speed<-s/4&&(t.speed=-s/4);var c,p,u,d,h,m,g,y,f,S,v,b,M,C,x,P,k,w,T,I,E,L,B,D=kartInstantSpeed(t),z=D[0],H=D[1],O=t.x+z,R=t.y+H,j=t.x,A=t.y;if(t.z||t.heightinc?(t.z+=.7*t.heightinc*Math.abs(t.heightinc),t.heightinc-=.5,t.z<=0&&(t.heightinc=0,t.z=0,delete t.jumped,kartIsPlayer(t)&&t.driftinc&&(document.getElementById("drift"+e).style.display="block",carDrift&&!t.driftSound&&(carDrift.currentTime=0,carDrift.play(),t.driftSound=carDrift))),t.driftinc&&(document.getElementById("drift"+e).style.top=Math.round(iScreenScale*(32-correctZ(t.z))+(t.sprite[e].h-32)*fSpriteScale*.15)+"px")):(t.speed+=t.speedinc,(isCup&&22!=oMap.skin&&30!=oMap.skin||!isCup&&oMap.smartjump)&&t.cpu&&(tombe(O,R)&&!sauts(j,A,z,H)||(pe=ralenti(O,R))&&(de=getOffroadProps(t,pe))&&t.speed-1.01*t.speedinc>de.speed&&!t.protect&&!t.champi)&&(t.z=1,t.heightinc=.5,t.jumped=!0)),(!e||!isOnline||finishing)&&!t.loose){var V=touche_bobomb(O,R,t.using[0]==bobombs?t.using[1]:-1)+touche_cbleue(O,R);if(!V||t.tourne||t.protect||t.fell){if(t.z<5){if((touche_fauxobjet(O,R,t.using[0]==fauxobjets?t.using[1]:-1)||touche_cverte(O,R,t.using[0]==carapaces?t.using[1]:-1)||touche_cverte(t.x,t.y,t.using[0]==carapaces?t.using[1]:-1)||touche_crouge(t.x,t.y,t.using[0]==carapacesRouge?t.using[1]:-1))&&!t.protect)loseBall(e),stopDrifting(e),t.spin(42),t.using=[!1];else if(touche_banane(O,R,t.using[0]==bananes?t.using[1]:-1)&&!t.protect)loseBall(e),stopDrifting(e),t.spin(20),t.using[0]&&(t.using[0][t.using[1]][5]&&(t.using[0][t.using[1]][5]=0),t.using=[!1]);else if(!t.tourne&&t.z<1.2){var F=!t.protect&&!t.frminv,N=touche_asset(j,A,O,R),_=!0,K=!1;if(N){var W=N[1][0].src;switch(N[0]){case"oils":F&&.5<Math.abs(t.speed)&&!t.tourne&&(stopDrifting(e),loseBall(e),t.spin(20)),_=!1;break;case"pointers":W="assets/pivothand",F?(stopDrifting(e),loseBall(e),t.spin(42)):_=!1;break;case"flippers":F&&(stopDrifting(e),loseBall(e),t.spin(42)),t.speed*=-1;var G=8;switch(N[1][3][0]){case 1:G=12;break;case 2:G=4}t.shift=[-G*direction(0,t.rotation),-G*direction(1,t.rotation),0];break;case"bumpers":F=!1,t.speed*=-1;var G=8,q=z,$=H,U=N[1];U[3]&&(q+=U[3][0]*Math.sin(U[3][1])*U[2][5],$-=U[3][0]*Math.cos(U[3][1])*U[2][5]);var J=j+q,Y=A+$,X=j-U[1][0],Q=A-U[1][1],Z=Math.hypot(X,Q),ee=X/Z,te=Q/Z,ae=q*ee+$*te,q=j+2*(J-ae*ee-j)-J,$=A+2*(Y-ae*te-A)-Y,ne=Math.hypot(q,$);t.shift=ne?[G*q/ne,G*$/ne,0]:[-G*direction(0,rotation),-G*direction(1,rotation),0],t.cpu&&(t.bounced=!0,t.bouncedsince=0);break;case"flowers":K=!(F=_=!1)}_&&(K=!0,stopDrifting(e),O=j,R=A,t.collideSound||(t.collideSound=playIfShould(t,"musics/events/collide.mp3"),t.collideSound&&(t.collideSound.onended=function(){t.collideSound=void 0,document.body.removeChild(this)}))),F&&(K=!0,t.using[0]&&(t.using[0][t.using[1]][5]&&(t.using[0][t.using[1]][5]=0),t.using=[!1])),K&&clLocalVars.decorsHit&&!t.cpu&&(clLocalVars.decorsHit[W]=!0)}}if(!t.cpu)for(;touche_piece(t.x,t.y);)clLocalVars.nbCoins++,updateChallengeHud("coins",clLocalVars.nbCoins),challengeCheck("each_coin"),playIfShould(t,"musics/events/coin.mp3")}}else loseBall(e),t.spin(V),t.using[0]&&(t.using[0][t.using[1]][5]&&(t.using[0][t.using[1]][5]=0),t.using=[!1]),stopDrifting(e),84==V&&(t.speed=0,t.heightinc=3,supprArme(e))}if(objet(O,R)){if(t.destroySound||(t.destroySound=playDistSound(t,"musics/events/item_destroy.mp3",80),t.destroySound&&(t.destroySound.onended=function(){t.destroySound=void 0,document.body.removeChild(this)})),!t.arme&&(t.tours<=oMap.tours||"BB"==course)&&!t.billball&&!finishing){if("BB"!=course){if(ie=randObj(t),1==t.tours&&getCpScore(t)<=getCpDiff(t)/2){if(otherObjects(t,["carapacebleue","eclair"]))for(;"carapacebleue"==ie||"eclair"==ie;)ie=randObj(t)}else for(i=0;i<aKarts.length;i++)if("carapacebleue"==aKarts[i].arme){if(otherObjects(t,["carapacebleue"]))for(;"carapacebleue"==ie;)ie=randObj(t);break}}else if(t.ballons.length)for(;"billball"==(ie=objets[Math.floor(75*Math.random())])||"carapacebleue"==ie;);else var oe=["fauxobjet","banane","carapace","bobomb"],ie=oe[Math.floor(Math.random()*oe.length)];t.arme=ie,shouldPlaySound(t)&&(t.rouletteSound=playSoundEffect("musics/events/roulette.mp3")),kartIsPlayer(t)&&(p=(c=document.getElementById("scroller"+e).getElementsByTagName("div")[0]).offsetHeight,u=7*iScreenScale,document.getElementById("scroller"+e).getElementsByTagName("div")[0].style.top=-Math.floor(Math.random()*p)+"px",document.getElementById("scroller"+e).style.visibility="visible",clLocalVars.itemsGot=!0)}clLocalVars.itemsHit&&!t.cpu&&(clLocalVars.itemsHit[touchedObject]||(clLocalVars.itemsHit[touchedObject]=!0,clLocalVars.nbItems++,updateChallengeHud("items",clLocalVars.nbItems),challengeCheck("each_item")))}if(t.arme&&25!=t.roulette&&(kartIsPlayer(t)&&(c||(p=(c=document.getElementById("scroller"+e).getElementsByTagName("div")[0]).offsetHeight,u=7*iScreenScale),0<(d=parseInt(c.style.top)+3*iScreenScale)&&(d+=u-p),c.style.top=d+"px"),t.roulette++,25<=t.roulette&&(t.roulette=25,kartIsPlayer(t)&&(document.getElementById("scroller"+e).style.visibility="hidden",document.getElementById("roulette"+e).innerHTML='<img alt="." class="pixelated" src="images/items/'+t.arme+'.gif" style="width: '+Math.round(8*iScreenScale-3)+'px;" />',t.rouletteSound&&(removeIfExists(t.rouletteSound),playSoundEffect("musics/events/gotitem.mp3"),t.rouletteSound=void 0)))),collisionDecor=null,t.cannon||canMoveTo(j,A,t.z,z,H,t.protect))t.x=O,t.y=R,t.cpu&&delete t.collided;else{t.collideSound||(t.collideSound=playIfShould(t,"musics/events/collide.mp3"),t.collideSound&&(t.collideSound.onended=function(){t.collideSound=void 0,document.body.removeChild(this)}));var re=getHorizontality(j,A,z,H);t.cpu&&(t.collided=!0,t.horizontality=re);var le=O-t.x,se=R-t.y,ce=le*re[0]+se*re[1];t.speed>t.speedinc&&(t.speed=Math.min(.75*t.speed,t.speed+.5-t.speedinc)),!collisionDecor&&3<t.speed&&5<=t.driftcpt&&t.driftcpt<fTurboDriftCpt2&&(t.driftcpt<fTurboDriftCpt||t.driftcpt>=fTurboDriftCpt+5)&&(t.driftcpt-=5);for(i=5;0<i&&(t.x+=re[0]*ce*i/5,t.y+=re[1]*ce*i/5,!canMoveTo(j,A,t.z,t.x-j,t.y-A,t.protect));i--)t.x=j,t.y=A;t.speedinc<=0&&(t.speed=Math.hypot(t.x-j,t.y-A))}if(collisionDecor&&(clLocalVars.decorsHit&&!t.cpu&&(clLocalVars.decorsHit[collisionDecor]=!0),!(h=decorBehaviors[collisionDecor].spin)||t.tourne||t.protect||(m=decorBehaviors[collisionDecor].minSpeedToSpin||2.5,Math.abs(t.speed)>m&&(loseBall(e),stopDrifting(e),t.spin(h),t.speed=2.5*Math.sign(t.speed),t.using[0]&&(t.using[0][t.using[1]][5]&&(t.using[0][t.using[1]][5]=0),t.using=[!1])))),t.speedinc||(t.speed*=t.sliding?.95:.9),t.sliding=void 0,!t.z){t.heightinc||(t.ctrled=!1,t.fell=!1),t.figuring&&(t.turbodrift=15,t.turbodrift0=t.turbodrift,t.driftcpt=0);var pe,ue,de,he=sauts(j,A,z,H);if(he&&!t.tourne)t.heightinc=1.5*he,t.speed=11,t.figuring=!1,t.figstate=0,t.bounceSound||(t.bounceSound=playIfShould(t,"musics/events/jump.mp3"),t.bounceSound&&(t.bounceSound.onended=function(){t.bounceSound=void 0,document.body.removeChild(this)}));else{if(isOnline&&e||"MK"==page&&"BB"==course&&t.cpu||(ue=tombe(t.x,t.y,oMap.checkpoint&&t.demitours?oMap.checkpoint[t.demitours+1!=oMap.checkpoint.length?t.demitours+1:0][3]:0)),ue){1==ue?isBattle&&simplified?(ue=[t.x,t.y,t.rotation],t.x>oMap.w-1?(ue[0]=oMap.w-50,t.y>oMap.h-1?(ue[1]=oMap.h-50,ue[2]=225):t.y<0?(ue[1]=50,ue[2]=315):(ue[1]=t.y-t.y%100+50,ue[2]=270)):t.y>oMap.h-1?(ue[1]=oMap.h-50,t.x<0?(ue[0]=50,ue[2]=135):(ue[0]=t.x-t.x%100+50,ue[2]=180)):t.x<0?(ue[0]=50,t.y<0?(ue[1]=50,ue[2]=45):(ue[1]=t.y-t.y%100+50,ue[2]=90)):(ue[1]=50,ue[0]=t.x-t.x%100+50,ue[2]=0)):ue=oMap.startposition[0]:isNaN(ue[0])&&(ue=oMap.startposition[(t.initialPlace-1)%oMap.startposition.length]),t.x=ue[0],t.y=ue[1],t.rotation=90*ue[2],t.speed=0,t.protect=!1,t.figuring=!1,t.figstate=0,t.fell=!0,stopDrifting(e),supprArme(e),t.using&&detruit(t.using[0],t.using[1]),t.champi=0,t.cpu&&(t.aipoint=void 0),t.tombe=20,t.ctrled=!0,t.z=10;for(i=t.tourne=0;i<strPlayer.length;i++)t.sprite[i].img.style.display="none",t.sprite[i].div.style.backgroundImage="",t.etoile&&(t.sprite[i].img.src=getSpriteSrc(t.personnage));for(var me,i=0;i<strPlayer.length;i++){if("BB"==course)for(r=0;r<t.ballons.length;r++)t.ballons[r][i].img.style.display="none";t.marker&&(t.marker.div[i].style.display="none")}resetPowerup(t),t.cpu||(clLocalVars.falls++,clSelected&&clRuleVars[clSelected.id]&&(me=clRuleVars[clSelected.id].falls)&&updateChallengeHud("falls",clLocalVars.falls+me.falls)),playIfShould(t,"musics/events/fall.mp3")}else{t.protect||t.champi||t.figuring||!(1.5<t.speed)||t.turbodrift>.8*t.turbodrift0||!(pe=ralenti(O,R))||((de=getOffroadProps(t,pe)).sliding&&(t.sliding=de.sliding),t.speed>de.speed&&(t.speed=de.speed),stopDrifting(e)),t.tourne||(g=flowShift(O,R,t.protect)),g&&t.cpu&&100<=g[0]*g[0]+g[1]*g[1]&&(z+g[0])*z+(H+g[1])*H<0&&(t.collided=!0,t.horizontality=[g[1],-g[0]])}t.figuring=!1,t.figstate=0}if(g){t.shift||(t.shift=[0,0,0]);for(i=0;i<3;i++)t.shift[i]=.7*t.shift[i]+.3*g[i];t.shift[0]*t.shift[0]+t.shift[1]*t.shift[1]+300*t.shift[2]*t.shift[2]<.01&&delete t.shift}else delete t.shift}if(t.cannon||(y=inCannon(t.x,t.y))&&(y[0]||y[1])&&(stopDrifting(e),t.cannon=[t.x+y[0],t.y+y[1],t.x,t.y],t.protect=!0,t.jumped=!0,t.tourne&&(t.tourne=2),delete t.shift,t.boostSound||(t.boostSound=playIfShould(t,"musics/events/boost.mp3"),t.boostSound&&(t.boostSound.onended=function(){t.boostSound=void 0,document.body.removeChild(this)}))),t.using[0]&&((f=t.using[0][t.using[1]])[3]=t.x-5*direction(0,t.rotation),f[4]=t.y-5*direction(1,t.rotation),f[5]=t.z),"BB"!=course){if(checkpoint(t,z,H)){var ge=aKarts.length;t.demitours=getNextCp(t),t.tours++;var ye,fe,Se=oMap.checkpoint[0];oMap.sections&&(Se=oMap.checkpoint[oMap.checkpoint.length-1]),ye=Se[3]?(fe=A<Se[1]?Se[1]-A:A-Se[1]-15,H):(fe=j<Se[0]?Se[0]-j:j-Se[0]-15,z);var ve=fe/Math.abs(ye),ve=Math.max(0,Math.min(ve,1));isNaN(ve-ve)&&(ve=.5);var be=Math.round(67*(timer+ve-1));if(t==oPlayers[0]&&!t.cpu){for(var Me=0,i=0;i<lapTimers.length;i++)Me+=lapTimers[i];lapTimers.push(be-Me)}if(t.tours==oMap.tours+1){for(var Ce,xe,i=t.place=0;i<ge;i++)aKarts[i].tours>oMap.tours&&t.place++;if(kartIsPlayer(t)&&!finishing)if(showTimer(timerMS=be),"CM"!=course&&(document.getElementById("infoPlace"+e).innerHTML=toPlace(t.place)),t.using[0]&&(Ce=bMusic,xe=iSfx,iSfx=bMusic=!1,arme(e),bMusic=Ce,iSfx=xe),t.arme=!1,stopDrifting(e),supprArme(e),t.cpu=!0,t.aipoint=0,t.lastAItime=0,t.maxspeed=5.7,!oPlayers[1-e]||oPlayers[1-e].cpu){if(isOnline){var Pe=document.getElementById("infos0");Pe.style.left=15*iScreenScale+"px",Pe.innerHTML="";var ke=document.createElement("tr"),we=document.createElement("td");we.style.fontSize=8*iScreenScale+"px",we.style.color="#F80",we.innerHTML=toLanguage("&nbsp; &nbsp; FINISH !","TERMIN&Eacute; !"),ke.appendChild(we);var Te=document.createElement("tr"),Ie=document.createElement("td");Ie.style.fontSize=Math.round(4.5*iScreenScale+10)+"px",Ie.style.color="#FF0",Ie.innerHTML=toLanguage("&nbsp; &nbsp; &nbsp; Please wait...","Veuillez patienter..."),Te.appendChild(Ie),Pe.appendChild(ke),Pe.appendChild(Te),Pe.style.display="",document.getElementById("infoPlace0").style.visibility="hidden",finishing=!0}else{if("CM"!=course){for(i=0;i<ge;i++)places(i,!0);var Ee=aKarts.slice(0);Ee.sort(function(e,t){return e.place-t.place});for(i=0;i<ge;i++)Ee[i].place=i+1;aPlaces=new Array;for(i=0;i<ge;i++)aPlaces[i]=aKarts[i].place;for(var Le='<tr style="font-size: '+2*iScreenScale+'px; background-color: white; color: black;"><td>Places</td><td>'+toLanguage("Player","Joueur")+"</td><td>Pts</td></tr>",Be=Math.round(1.25*aKarts.length),i=0;i<ge;i++)for(r=0;r<ge;r++){var De,ze=aKarts[r].personnage;aKarts[r].place==i+1&&(Je=1==aKarts[r].team?1:0,De=(aKarts.length-i-1)/(aKarts.length-1),Ye=Math.round(Be*(Math.exp(De)-1)/(Math.E-1)),12==aKarts.length&&(Ye=[15,12,10,8,7,6,5,4,3,2,1,0][i]),Le+='<tr id="fJ'+i+'" style="background-color: '+(r<strPlayer.length?r?Je?"brown":"navy":rankingColor(aKarts[r].team):Je?"red":"transparent")+'"><td>'+toPlace(i+1)+' </td><td class="maj" id="j'+i+'">'+toPerso(ze)+'</td><td id="pts'+i+'">'+aScores[r]+"<small>+"+Ye+"</small></td></tr>",aScores[r]+=Ye,r=ge)}Le+='<tr><td colspan="3" id="continuer"></td></tr>',document.getElementById("infos0").style.border="solid 1px black",document.getElementById("infos0").style.opacity=.7,document.getElementById("infos0").style.fontSize=Math.round(1.77*iScreenScale-.5)+"pt",document.getElementById("infos0").style.fontFamily="Courier",document.getElementById("infos0").style.top=3*iScreenScale+"px",document.getElementById("infos0").style.left=Math.round(24*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.backgroundColor=iTeamPlay?"blue":"#063",document.getElementById("infos0").style.color=primaryColor,document.getElementById("infos0").innerHTML=Le,(qe=document.createElement("input")).type="button",qe.id="octn",qe.value=toLanguage("CONTINUE","CONTINUER"),qe.style.width="100%",qe.style.height="100%",qe.style.fontSize=3*iScreenScale+"pt",qe.onclick=classement,document.getElementById("continuer").appendChild(qe),document.getElementById("infos0").style.display="";var He=document.body.scrollTop;qe.focus(),document.body.scrollTop=He}else{document.getElementById("infos0").style.fontSize=5*iScreenScale+"px",document.getElementById("infos0").style.fontWeight="bold",document.getElementById("infos0").style.color="white";var Oe=Math.ceil(iScreenScale/4)+"px";sShadow="-"+Oe+" 0 "+(_e="black")+", 0 "+Oe+" "+_e+", "+Oe+" 0 "+_e+", 0 -"+Oe+" "+_e;for(var Re="",je=lapTimers[0],i=1;i<lapTimers.length;i++)je=Math.min(je,lapTimers[i]);for(i=0;i<lapTimers.length;i++){var Ae="-"+(Oe=Math.ceil(iScreenScale/8)+"px")+" 0 "+(_e=lapTimers[i]==je?"#e99c00":"black")+", 0 "+Oe+" "+_e+", "+Oe+" 0 "+_e+", 0 -"+Oe+" "+_e;Re+='<div style="color:'+(lapTimers[i]==je?"#fffdbe":"#DDD")+";text-shadow:"+Ae+'">'+(i+1)+". "+timeStr(lapTimers[i])+"</div>"}document.getElementById("infos0").style.top=7*iScreenScale+10+"px",document.getElementById("infos0").innerHTML='<tr><td style="text-decoration: blink;font-family:Courier New;font-size:'+Math.round(4*iScreenScale)+"px;text-shadow:"+sShadow+'">'+document.getElementById("temps0").innerHTML+'</td></tr><tr><td id="continuer"></td></tr><tr><td style="padding-top:'+iScreenScale+";font-size:"+Math.round(2.5*iScreenScale)+'px">'+Re+"</td></tr>",document.getElementById("infos0").style.display="",(qe=document.createElement("input")).type="button",qe.id="octn",qe.value=toLanguage("CONTINUE","CONTINUER"),qe.style.width="100%",qe.style.height="100%",qe.style.fontSize=3*iScreenScale+"pt",qe.onclick=function(){document.getElementById("infos0").style.display="none";var e=document.createElement("div");e.style.color="black",e.style.position="absolute",e.style.left=5*iScreenScale+10+"px",e.style.top=5*iScreenScale+10+"px",e.style.fontSize=4*iScreenScale+"pt",e.style.backgroundColor="#FF6",e.style.opacity=.8,e.style.border="double 4px black",e.style.textAlign="center",e.style.width=70*iScreenScale-10+"px",e.style.height=25*iScreenScale-10+"px",e.style.zIndex=2e4;var t=document.createElement("p");t.innerHTML=toLanguage('Save the time to the <a href="classement.php" target="_blank" style="color: orange">record list</a> ?','Enregistrer le temps dans la <a href="'+rankingsLink(oMap)+'" target="_blank" style="color: orange">liste des records</a> ?'),t.style.margin=iScreenScale+"px";var a=t.cloneNode(!1),n=document.createElement("input");n.type="button",n.value="  "+toLanguage("Yes","Oui")+"  ",n.style.marginRight=iScreenScale+"px",n.style.fontSize=4*iScreenScale+"px",n.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",o.style.fontSize=4*iScreenScale+"px"},n.onclick=function(){$mkScreen.removeChild(e),continuer(),document.getElementById("enregistrer").getElementsByTagName("input")[0].onclick()},a.appendChild(n);var o=document.createElement("input");o.type="button",o.value="  "+toLanguage("No","Non")+"  ",o.style.fontSize=4*iScreenScale+"px",o.style.marginLeft=iScreenScale+"px",o.onmouseover=function(){this.style.fontSize=5*iScreenScale+"px",n.style.fontSize=4*iScreenScale+"px"},o.onclick=function(){$mkScreen.removeChild(e),document.getElementById("infos0").style.display="",continuer()},a.appendChild(o),e.appendChild(t),e.appendChild(a),$mkScreen.appendChild(e),"MK"==page&&gRecord<=timerMS?o.focus():n.focus()},document.getElementById("continuer").appendChild(qe),document.getElementById("infos0").style.display="",qe.focus()}handleEndRace()}document.onkeydown=void 0,document.onkeyup=void 0,document.onmousedown=void 0,window.onbeforeunload=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0}oMap.sections&&1<t.billball&&(t.billball=1)}else if(!(isOnline?e||finishing:t.cpu)){if(document.getElementById("tour"+e).innerHTML=t.tours,document.getElementById("lakitu"+e).getElementsByTagName("div")[0].innerHTML=(oMap.sections?"Sec":toLanguage("Lap","Tour"))+"<small>&nbsp;</small>"+t.tours,t.time=40,bMusic||iSfx)if(t.tours==oMap.tours){for(var Ve,Fe=!0,i=0;i<oPlayers.length;i++)if(oPlayers[i]!=t&&3<=oPlayers[i].tours){Fe=!1;break}Fe&&(Ve=postStartMusic("musics/events/lastlap.mp3"),iSfx&&(fadeOutMusic(carEngine,1,.6,-1),fadeOutMusic(carEngine2,1,.6,-1)),Ve.removeAttribute("loop"),setTimeout(function(){bMusic&&(document.body.contains(Ve)?(document.body.removeChild(Ve),startMapMusic(!0)):fastenMusic(mapMusic)),iSfx&&(carEngine.volume=1,carEngine2.volume=1)},2700))}else iSfx&&playSoundEffect("musics/events/nextlap.mp3");if("CM"==course){oLapTimeDiv&&oContainers[0].removeChild(oLapTimeDiv),(oLapTimeDiv=document.createElement("div")).style.position="absolute",oLapTimeDiv.style.zIndex=2e4,oLapTimeDiv.style.left=Math.round(iScreenScale*iWidth/2)+"px",oLapTimeDiv.style.top=Math.round(iScreenScale*iHeight/2)+"px",oLapTimeDiv.style.textAlign="center",oLapTimeDiv.style.transform=oLapTimeDiv.style.WebkitTransform=oLapTimeDiv.style.MozTransform="translate(-50%, -100%)";var Ne=document.createElement("div");Ne.className="lap-time",Ne.innerHTML=timeStr(lapTimers[lapTimers.length-1]),Ne.style.fontSize=4*iScreenScale+"px",Ne.style.fontFamily="Courier New",Ne.style.color="#DDD";var Oe=Math.ceil(iScreenScale/4)+"px",_e="black";if(Ne.style.textShadow="-"+Oe+" 0 "+_e+", 0 "+Oe+" "+_e+", "+Oe+" 0 "+_e+", 0 -"+Oe+" "+_e,oLapTimeDiv.appendChild(Ne),iLapTimes){for(var Ke=0,i=0;i<lapTimers.length;i++)Ke+=lapTimers[i]-iLapTimes[i];var We=document.createElement("div");We.innerHTML=(0<=Ke?"+":"-")+" "+timeStr(Math.abs(Ke)),We.style.fontSize=Math.round(2.5*iScreenScale)+"px",We.style.fontFamily="Courier New",We.style.color=0<=Ke?"#FDD":"#DFD",Oe=Math.ceil(iScreenScale/8)+"px",_e=0<=Ke?"#C00":"#0A0",We.style.textShadow="-"+Oe+" 0 "+_e+", 0 "+Oe+" "+_e+", "+Oe+" 0 "+_e+", 0 -"+Oe+" "+_e,oLapTimeDiv.appendChild(We)}oContainers[0].appendChild(oLapTimeDiv)}}}}else if(!isOnline){if(!oPlayers[0].loose||oPlayers[1]&&!oPlayers[1].loose)if(iTeamPlay){var Ge=[!1,!1];for(i=0;i<aKarts.length;i++)aKarts[i].loose||(aKarts[i].cpu||(S=aKarts[i]),Ge[aKarts[i].team]=!0);Ge[0]&&Ge[1]&&(S=void 0)}else{Ge=!1;for(i=0;i<aKarts.length;i++)aKarts[i].loose||(Ge?(S=void 0,i=aKarts[i].length):(Ge=!0,S=aKarts[i]))}else{for(;(S=aKarts[Math.floor(Math.random()*(aKarts.length-strPlayer.length))+strPlayer.length]).loose;);for(i=strPlayer.length;i<aKarts.length;i++)aKarts[i].loose=!0}if(S){for(clLocalVars.gagnant=S,i=0;i<strPlayer.length;i++)stopDrifting(i),supprArme(i);for(var qe,Le='<tr style="font-size: '+2*iScreenScale+'px; background-color: white; color: black;"><td>Places</td><td>'+toLanguage("Player","Joueur")+"</td><td>Pts</td></tr>",$e="",Ue=1,i=0;i<aKarts.length;i++){var Je=1==aKarts[i].team?1:0,Ye=aKarts[i]==S,ze=aKarts[i].personnage,Xe=Ye?0:Ue,Qe='<tr id="fJ'+Xe+'" style="background-color:'+(i<strPlayer.length?i?Je?"brown":"navy":rankingColor(aKarts[i].team):Je?"red":"transparent")+'"><td>'+toPlace(Xe+1)+' </td><td class="maj" id="j'+Xe+'">'+toPerso(ze)+'</td><td id="pts'+Xe+'">'+aScores[i]+(Ye?"<small>+1</small>":"")+"</td></tr>";Ye?$e=Qe+$e:($e+=Qe,Ue++),aScores[i]+=Ye}Le+=$e,Le+='<tr><td colspan="3" id="continuer"></td></tr>',document.getElementById("infos0").style.border="solid 1px black",document.getElementById("infos0").style.opacity=.7,document.getElementById("infos0").style.fontSize=Math.round(1.77*iScreenScale-.5)+"pt",document.getElementById("infos0").style.fontFamily="Courier",document.getElementById("infos0").style.top=3*iScreenScale+"px",document.getElementById("infos0").style.left=Math.round(24*iScreenScale+10+(strPlayer.length-1)/2*(iWidth*iScreenScale+2))+"px",document.getElementById("infos0").style.backgroundColor=iTeamPlay?"blue":"#063",document.getElementById("infos0").style.color=primaryColor,document.getElementById("infos0").innerHTML=Le,(qe=document.createElement("input")).type="button",qe.id="octn",qe.value=toLanguage("CONTINUE","CONTINUER"),qe.style.width="100%",qe.style.height="100%",qe.style.fontSize=3*iScreenScale+"pt",qe.onclick=classement,document.getElementById("continuer").appendChild(qe),document.getElementById("infos0").style.display="";He=document.body.scrollTop;for(qe.focus(),document.body.scrollTop=He,i=0;i<aKarts.length;i++)aKarts[i].loose=!0;handleEndRace(),document.onkeydown=void 0,document.onkeyup=void 0,document.onmousedown=void 0,window.onbeforeunload=void 0,window.removeEventListener("blur",window.releaseOnBlur),window.releaseOnBlur=void 0}}if(t.cpu?"BB"==course?t.maxspeed=5.7:(v=iDificulty,b=1,(M=oPlayers.length+1-aKarts.length)&&(b=Math.pow(.96,6*((strPlayer.length-e)/M-.5))),v*=b*iDificulty/5,C=1.25,4.75<iDificulty&&8<aKarts.length&&(C*=Math.log(1+100*aKarts.length/8)/5.5),t.maxspeed>v*C?t.maxspeed=v*C:t.maxspeed<v&&(t.maxspeed=v),t.place<=oPlayers[0].place?t.maxspeed-=(t.maxspeed*b-v*t.size)/100:t.maxspeed+=(v*C*1.12*t.size-t.maxspeed*b)/100):t.maxspeed=5.4*t.stats.speed,t.turbodrift&&(x=8,15<t.turbodrift&&(x+=Math.pow(2*(t.turbodrift-15)/15,2),t.turbodrift--,t.turbodrift0--),t.speed>-x&&(t.maxspeed=x,t.speed=Math.max(x,t.speed)),t.turbodrift--),t.champi&&(t.maxspeed=11,t.champi--),t.billball){if(t.z=2,t.heightinc=0,t.speed=9,null!=t.aipoint)(et=t.aipoints[t.aipoint][0]-t.x)*et+(tt=t.aipoints[t.aipoint][1]-t.y)*tt<1600&&(t.aipoint++,t.aipoint>=t.aipoints.length&&(t.aipoint=0));else{var Ze=t.demitours+1;Ze>=oMap.checkpoint.length&&(Ze=0);for(var et=(at=oMap.checkpoint[Ze])[0]+(at[3]?Math.round(at[2]/2):8)-t.x,tt=at[1]+(at[3]?8:Math.round(at[2]/2))-t.y,i=0;i<t.aipoints.length;i++){var at=t.aipoints[i];if(t.x>at[0]-35&&t.x<at[0]+35&&t.y>at[1]-35&&t.y<at[1]+35){var nt=i+1;nt==t.aipoints.length&&(nt=0);var J=t.aipoints[nt][0],Y=t.aipoints[nt][1],ot=t.rotation*Math.PI/180,it=Math.abs(normalizeAngle(Math.atan2(J-t.x,Y-t.y)-ot,2*Math.PI)),rt=Math.abs(normalizeAngle(Math.atan2(et,tt)-ot,2*Math.PI));if(it<Math.max(rt,Math.PI/4)){t.aipoint=nt,et=J-t.x,tt=Y-t.y;break}}}}var lt=et*direction(1,t.rotation)-tt*direction(0,t.rotation),st=et*direction(0,t.rotation)+tt*direction(1,t.rotation),ct=Math.atan2(lt,st)/Math.PI*180;if(10<Math.abs(ct)&&(ct=60<Math.abs(ct)?(t.speed=1,0<ct?20:-20):0<ct?10:-10),t.rotation+=ct,t.rotation=t.rotation%360,t.billball--,t.billball){!t.billjump&&t.billball<12&&(z=t.speed*direction(0,t.rotation),H=t.speed*direction(1,t.rotation),sauts(t.x,t.y,z,H)&&(t.billball=12,t.billjump=!0))}else{for(i=0;i<strPlayer.length;i++)t.sprite[i].img.src=getSpriteSrc(t.personnage),resumeSpriteSize(t.sprite[i]);t.size=1,t.z=0,updateDriftSize(e),t.jumped=!1,delete t.billjump,updateProtectFlag(t),t.cpu||delete t.aipoint}}if(t.etoile&&(t.maxspeed*=1.35,t.etoile--,t.etoile<15)){for(var pt,i=0;i<strPlayer.length;i++)t.sprite[i].img.src=(t.etoile%2?getStarSrc:getSpriteSrc)(t.personnage);t.etoile||(updateProtectFlag(t),pt=t.cpu?1:t.stats.acceleration*t.size,t.speedinc=Math.min(t.speedinc,pt),stopStarMusic(t))}if(t.megachampi&&(t.megachampi--,41<t.megachampi?t.size*=1.05:t.megachampi<8&&(t.size/=1.05,t.megachampi||(updateProtectFlag(t),stopMegaMusic(t))),updateDriftSize(e)),t.eclair&&(t.eclair--,(isOnline||80<t.eclair)&&t.eclair<=88&&($mkScreen.style.opacity=1),t.eclair<1))for(i=0;i<aKarts.length;i++){var ut=aKarts[i];friendlyFire(ut,t)||!(ut.size<1)||isOnline&&ut!=oPlayers[0]||(ut.size=1,updateDriftSize(i))}if(t.cannon&&(t.speed=(3*t.speed+20)/4,t.billball&&(t.speed=20),t.maxspeed=t.speed/t.size,t.speedinc||(t.speedinc=.01),t.z=(3*t.z+4)/4,t.heightinc=0,t.rotinc=0,P=t.cannon[2]-t.x,k=t.cannon[3]-t.y,w=t.cannon[0]-t.cannon[2],T=t.cannon[1]-t.cannon[3],I=Math.hypot(w,T),(E=Math.hypot(P,k)/I)<.2?(L=t.cannon[0]-t.x,B=t.cannon[1]-t.y,t.rotation=nearestAngle(180*Math.atan2(L,B)/Math.PI,t.rotation,360)):I-40<=E*I&&(Math.abs(t.speedinc)<=.01&&(t.speedinc=0),delete t.cannon,t.fell=!0,updateProtectFlag(t))),!t.z&&accelere(O,R)&&(t.champi=20,t.maxspeed=11,t.speed=11,t.boostSound||(t.boostSound=playIfShould(t,"musics/events/boost.mp3"),t.boostSound&&(t.boostSound.onended=function(){t.boostSound=void 0,document.body.removeChild(this)}))),!iSfx||t!=oPlayers[0]||finishing||t.cpu||t.loose&&!isOnline||(bMusic&&(t.etoile||t.megachampi)||t.tombe||t.turbodrift||t.turboSound?(updateEngineSound(),t.turbodrift==t.turbodrift0-1&&(carEngine3.currentTime=0,carEngine3.volume=1,carEngine3.play(),t.turboSound=carEngine3,clearTimeout(t.turboHandler),t.turboHandler=setTimeout(function(){t.turboSound&&(t.turboSound.pause(),t.turboSound=void 0)},2e3),t.sparkSound&&(fadeOutMusic(t.sparkSound,1,.8,!1),t.sparkSound=void 0)),bMusic&&t.protect&&t.turboSound&&(t.turboSound.volume=0)):updateEngineSound(3<t.speed?carEngine2:carEngine)),"BB"==course&&!t.ballons.length&&!t.tourne&&!t.loose){for(var dt=t.sprite[0].div.style.opacity-.1,i=0;i<strPlayer.length;i++)t.sprite[i].div.style.opacity=dt;if(dt<(isOnline&&t==oPlayers[0]?.4:.01)){if(!isOnline||t!=oPlayers[0])for(i=0;i<strPlayer.length;i++)t.sprite[i].img.style.display="none",t.marker&&(t.marker.div[i].style.display="none");t.loose=!0,challengeCheck("each_kill")}}}}function kartIsPlayer(e){return isOnline?e==oPlayers[0]:!e.cpu}function handleDriftCpt(e){var t,a=aKarts[e];a.driftinc?(a.rotincdir&&(0<a.rotincdir==0<a.driftinc?(a.drift+=a.driftinc,0<a.driftinc?6<a.drift?a.drift=6:a.drift<0&&(a.drift=Math.ceil(a.drift/2)):a.drift<-6?a.drift=-6:0<a.drift&&(a.drift=Math.floor(a.drift/2))):0<a.rotincdir?(a.drift++,0<a.drift&&(a.drift=0)):(a.drift--,a.drift<0&&(a.drift=0))),a.driftcpt<fTurboDriftCpt2&&(t=a.driftcpt,a.rotincdir?0<a.rotincdir==0<a.driftinc?a.driftcpt+=6*Math.max(.7,Math.pow(Math.abs(a.rotincdir)/.6,.8)):a.driftcpt++:a.driftcpt+=2,a.driftcpt>=fTurboDriftCpt2?(getDriftImg(e).src="images/turbo-drift-2.png",carSpark&&a!=oPlayers[1]&&(carSpark.currentTime=0,carSpark.volume=1,carSpark.play(),a.sparkSound=carSpark)):t<fTurboDriftCpt&&a.driftcpt>=fTurboDriftCpt&&(getDriftImg(e).src="images/turbo-drift.png",carSpark&&a!=oPlayers[1]&&(carSpark.currentTime=0,carSpark.volume=.7,carSpark.play(),a.sparkSound=carSpark)))):a.drift&&(a.drift<0?a.drift=Math.min(0,a.drift+1):0<a.drift&&(a.drift=Math.max(0,a.drift-1)))}function angleDrift(e){return kartIsPlayer(e)?e.sliding?e.rotinc*e.sliding:6*e.drift:0}function angleShoot(e,t){var a=e.rotation;return t&&(a+=180),a}function kartInstantSpeed(e){var t=e.rotation-angleDrift(e),a=e.speed*direction(0,t),n=e.speed*direction(1,t);return e.shift&&(a+=e.shift[0],n+=e.shift[1]),[a,n]}function updateDriftSize(e){var t;kartIsPlayer(aKarts[e])&&(t=aKarts[e].size-1,getDriftImg(e).style.left=-Math.round(2*iScreenScale*t)+"px",getDriftImg(e).style.top=Math.round(2*iScreenScale*t)+"px",getDriftImg(e).style.width=Math.round(8*iScreenScale+4*iScreenScale*t)+"px")}function getDriftImg(e){return document.getElementById("drift"+e).getElementsByClassName("driftimg")[0]}function timeStr(e){var t=Math.floor(e/6e4);e-=6e4*t,t+="";var a=Math.floor(e/1e3);for(e-=1e3*a,(a+="").length<2&&(a="0"+a),e+="";e.length<3;)e="0"+e;return t+":"+a+":"+e}function openCheats(){var e=prompt("MKPC Console command");e&&(processCode(e)?(clLocalVars.cheated=!0,clSelected&&challengeHandleFail()):alert("Invalid command"))}function processCode(e){if("/"==e.charAt(0)){e=e.substring(1);var t=oPlayers[0],a=/^give (\w+)$/g.exec(e);if(a){var n=a[1];return-1==objets.indexOf(n)?void 0:(t.arme=n,t.roulette=25,document.getElementById("scroller0").style.visibility="hidden",document.getElementById("roulette0").innerHTML='<img alt="." class="pixelated" src="images/items/'+n+'.gif" style="width: '+Math.round(8*iScreenScale-3)+'px;" />',1)}var o=/^tp ([\d\-+\.]+) ([\d\-+\.]+)$/g.exec(e);if(o=o||/^tp ([\d\-+\.]+) ([\d\-+\.]+) ([\d\-+\.]+)$/g.exec(e)){var r=parseFloat(o[1]),l=parseFloat(o[2]);if(isNaN(r)||isNaN(l))return;var s=parseFloat(o[3]);return t.x=r,t.y=l,isNaN(s)||(t.rotation=s),1}var c=/^lap(?: ([1-3]|c))?(?: (\d+|c))?$/g.exec(e);if(c){var p=parseInt(c[1]),u=parseInt(c[2]);return("c"==c[1]&&(p=t.tours),c[1]||(p=oMap.tours,u=oMap.checkpoint.length-1),"c"==c[2]&&(u=t.demitours),c[2]||(u=oMap.checkpoint.length-1),isNaN(p)||isNaN(u))?void 0:(t.tours=p,t.demitours=u,document.getElementById("tour0").innerHTML=t.tours,1)}if("pos"==e)return alert("x: "+Math.round(t.x)+"\ny: "+Math.round(t.y)+"\ntheta: "+Math.round(t.rotation)),1;if("xs"==e)return t.size=.6;if("md"==e)return t.size=1;if("xl"==e)return t.size=Math.pow(1.05,8),1;if("BB"==course){"balloon"==e&&(e+=" 1");var d=/^balloon (\d+)$/g.exec(e);if(d){var h=parseInt(d[1]);if(h){for(t.reserve+=h,document.getElementById("compteur0").innerHTML="&nbsp;",i=0;i<t.reserve;i++)document.getElementById("compteur0").innerHTML+='<img src="'+balloonSrc(t.team)+'" style="width: '+2*iScreenScale+'" />';return 1}}}}}function distToAiPoints(e,t,a){for(var n=1/0,o=0;o<a.length;o++){var i=(o+1)%a.length,r=a[o][0],l=a[o][1],s=a[i][0],c=a[i][1],p=projete(e,t,r,l,s,c);p<0&&(p=0),1<p&&(p=1);var u=r+(s-r)*p,d=l+(c-l)*p,n=Math.min(n,(u-e)*(u-e)+(d-t)*(d-t))}return n}Math.hypot||(Math.hypot=function(e,t){return Math.sqrt(e*e+t*t)});var fMaxRotInCp=10;function ai(e){var t=isBattle&&simplified,a=isBattle&&complete,n=!isBattle&&complete;if(null==e.aipoint)if("BB"!=course)for(var o=1/0,i=0;i<e.aipoints.length;i++){var r=(x=e.aipoints[i])[0]-e.x,l=x[1]-e.y;(C=2*(M=Math.sqrt(r*r+l*l))+M*Math.abs(nearestAngle(Math.atan2(r,l)-e.rotation*Math.PI/180,0,2*Math.PI)))<o&&(e.aipoint=i,e.lastAItime=0,o=C)}else t&&(e.aipoint=Math.floor(e.x/100)+6*Math.floor(e.y/100),e.lastAItime=0,e.lastAI=-1);if(!e.billball&&!e.tombe){if(oMap.sections&&e.tours>oMap.tours||e.ballons&&!e.ballons.length)return e.speedinc=0,e.rotinc=0,void(e.rotincdir=0);if(e.tourne)return e.speedinc=!e.z&&1<e.speed?1:0,e.rotinc=0,void(e.rotincdir=0);if(e.aipoints.length){for(var s=0,c=2*Math.PI,p=0,u=0;u<e.aipoints.length;u++){var d,h,m,g=e.aipoint;if("BB"!=course){var y=g-1;y<0&&(y+=e.aipoints.length);var f=g+1;f>=e.aipoints.length&&(f=0),d=e.aipoints[y],h=e.aipoints[g],m=e.aipoints[f]}else if(t){d=[e.lastAI%6*100+50,100*Math.floor(e.lastAI/6)+50],h=[e.aipoint%6*100+50,100*Math.floor(e.aipoint/6)+50],m=[d[0]+2*(h[0]-d[0]),d[1]+2*(h[1]-d[1])];var S,v=Math.floor(e.x/100)+6*Math.floor(e.y/100);if(v!=e.lastAI){if(27!=oMap.skin||(h[0]-e.x)*(h[0]-e.x)+(h[1]-e.y)*(h[1]-e.y)<1500||e.speed<0||e.tombe){(P=e.aipoints[v])&&P.length||(P=[],v%6&&P.push(v-1),v%6<5&&P.push(v+1),6<=v&&P.push(v-6),v<30&&P.push(v+6),-1!=(S=P.indexOf(e.lastAI))&&P.splice(S,1));var b=e.lastAI;for(e.lastAI=v;e.aipoint=P[Math.floor(Math.random()*P.length)],b==e.aipoint&&1<P.length;);}e.nextAiStop=void 0,e.randShift=void 0}}else{if(null==e.aipoint){e.lastAI=void 0,e.nextAI=void 0;for(var M,C,o=1/0,i=0;i<e.aipoints.length;i++){i!=e.lastAI&&0==(x=e.aipoints[i])[0]&&(r=x[1]-e.x,l=x[2]-e.y,(C=2*(M=Math.sqrt(r*r+l*l))+M*Math.abs(nearestAngle(Math.atan2(r,l)-e.rotation*Math.PI/180,0,2*Math.PI)))<o&&(e.aipoint=i,e.lastAItime=0,o=C))}}if(h=e.aipoints[e.aipoint].slice(1),d=e.lastAI?e.aipoints[e.lastAI].slice(1):(e.lastAIpt||(e.lastAIpt=[e.x,e.y]),e.lastAIpt),!e.nextAI){for(var x,P=new Array,i=0;i<e.aipoints.length;i++){1==(x=e.aipoints[i])[0]&&(x[1]==e.aipoint?P.push(x[2]):x[2]==e.aipoint&&P.push(x[1]))}if(P.length)for(;e.nextAI=P[Math.floor(Math.random()*P.length)],e.lastAI==e.nextAI&&1<P.length;);else e.nextAI=-1}m=-1!=e.nextAI?e.aipoints[e.nextAI].slice(1):d}e.speedinc=1,e.lastAItime++;var k,w,T=h[0]-d[0],I=h[1]-d[1],E=Math.hypot(T,I),L=m[0]-h[0],B=m[1]-h[1],D=fMaxRotInCp*Math.PI/180,z=a?15:20;e.nextAiStop||(e.nextAiStop=nextAiStop(d[0],d[1],T,I,h[0],h[1],L,B,e.maxspeed/D),k=1-50/E,e.nextAiStop<k&&(e.nextAiStop=k)),e.randShift||(e.randShift=10*Math.random()-5,null!=oMap.randshift&&(e.randShift*=oMap.randshift),a?e.randShift/=1.5:n&&(w=E/10,Math.abs(e.randShift)>w&&(e.randShift=w*Math.sign(e.randShift))));var H=projete(e.x,e.y,d[0],d[1],h[0],h[1]),O=d[0]+H*(h[0]-d[0]),R=d[1]+H*(h[1]-d[1]),j=Math.hypot(e.x-O,e.y-R);if(T||I||(j=0,e.nextAiStop=0,H=1),!(H>=e.nextAiStop&&j<z)||t){var A,V,F,N,_=!1;if(e.bounced)e.bouncedsince?e.rotinc=0:e.rotinc=fMaxRotInCp*Math.random(),e.bouncedsince++,10==e.bouncedsince&&(delete e.bouncedsince,delete e.bounced),_=!0;else if(e.collided){delete e.recovering,delete e.minDecor,e.recovertime||(e.recovertime=21+Math.floor(10*Math.random())),e.collidesince?e.collidesince>e.recovertime&&(e.randShift=Math.random()*e.recovertime/2-e.recovertime/4,e.recovertime+=30,e.decision=-e.decision,e.collidesince=1,t&&(e.lastAI=e.aipoint)):(e.collidesince=1,e.decision||(A=direction(0,e.rotation),V=direction(1,e.rotation),F=e.horizontality[0],N=e.horizontality[1],e.decision=0<A*F+V*N!=0<A*N-V*F?1:-1)),e.collidesince++,e.horizontality?(A=direction(0,e.rotation),V=direction(1,e.rotation),F=e.horizontality[0],N=e.horizontality[1],(.1<Math.abs(A*N-V*F)||150<e.lastAItime)&&(e.rotinc=e.decision*fMaxRotInCp)):e.rotinc=e.decision*fMaxRotInCp,_=!0}else{var K,W,G,q,$,U,J,Y,X,s=(e.nextAiStop-H)*E;e.collidesince&&(e.recovering||(e.recovering=1),e.recovering++,_=!0,20<=e.recovering&&(delete e.recovering,delete e.recovertime,delete e.decision,delete e.collidesince)),K=j<z?(U=h[0]+e.randShift*I/E,J=h[1]-e.randShift*T/E,Math.atan2(U-e.x,J-e.y)):(W=followCircleWithAngle(e.x,e.y,h[0],h[1],T,I),G=d[0]+(e.x-O)*z/j,q=d[1]+(e.y-R)*z/j,U=G+($=intersectionLineCircle(W[0],W[1],W[2],G,q,T,I))*T,J=q+$*I,Y=W[1]-e.y,X=e.x-W[0],Y*(O-e.x)+X*(R-e.y)<0&&(Y=-Y,X=-X),Math.atan2(Y,X));var Q,Z,ee,te,ae,ne,oe,ie,re,le,se,ce=e.x,pe=e.y,ue=U,de=J,he=Math.hypot(ue-ce,de-pe),me=(ue-ce)*e.speed/he,ge=(de-pe)*e.speed/he,ye=1;if(!isCup)for(var fe in decorPos){var Se=decorBehaviors[fe].hitbox||DEFAULT_DECOR_HITBOX;Se*=1.1;for(i=0;i<decorPos[fe].length;i++)for(var ve=decorPos[fe][i],be=[[ve.x-Se,ve.y-Se,2*Se,0],[ve.x-Se,ve.y-Se,0,2*Se],[ve.x-Se,ve.y+Se,2*Se,0],[ve.x+Se,ve.y-Se,0,2*Se]],Me=me-ve.vX,Ce=ge-ve.vY,xe=0;xe<be.length;xe++){var Pe=be[xe],ke=secants(ce,pe,ce+16*Me,pe+16*Ce,Pe[0],Pe[1],Pe[0]+Pe[2],Pe[1]+Pe[3]);ke&&ke[0]<ye&&(Q={type:fe,i:i,line:Pe,inter:ke,box:[Pe[0]+16*ve.vX*ke[1],Pe[1]+16*ve.vY*ke[1],Pe[2],Pe[3]]},ye=ke[0])}}Q?(Z=Q.box[0],ee=Q.box[1],te=Q.box[0]+Q.box[2],ae=Q.box[1]+Q.box[3],ne=distToAiPoints(Z,ee,e.aipoints),oe=distToAiPoints(te,ae,e.aipoints),Z-=Q.box[2]/1.5,ee-=Q.box[3]/1.5,te+=Q.box[2]/1.5,ae+=Q.box[3]/1.5,J=ne<oe?(U=Z,ee):(U=te,ae),K=Math.atan2(U-e.x,J-e.y),e.minDecor={x:U,y:J,t:10}):e.minDecor&&(ie=e.minDecor.x,re=e.minDecor.y,e.minDecor.t--,e.minDecor.t<0||(e.x-ie)*(e.x-ie)+(e.y-re)*(e.y-re)<300?delete e.minDecor:(le=direction(0,e.rotation),se=direction(1,e.rotation),(ie-e.x)*le+(re-e.y)*se<0&&delete e.minDecor),e.minDecor&&(U=ie,J=re));var we,Te,Ie=e.rotation,Ee=e.speed;!e.shift||isCup||(we=flowShift(e.x,e.y,e.protect))&&(Te=kartInstantSpeed(e),we[2]?Ee=Math.min(Ee,Math.hypot(Te[0],Te[1])):(Ie=180*Math.atan2(Te[0],Te[1])/Math.PI,10<=we[0]*we[0]+we[1]*we[1]&&(Ie+=.15*(Ie-e.rotation))),isNaN(Ie)&&(Ie=e.rotation)),K=nearestAngle(180*K/Math.PI,Ie,360),isNaN(K)&&(K=Ie),isNaN(U)&&(U=h[0]),isNaN(J)&&(J=h[1]);var Le=K-Ie;e.rotinc=Math.max(Math.min(Le,fMaxRotInCp),-fMaxRotInCp);var Be=Math.abs(Le),c=Be;isBattle&&(Be*=Math.pow(Be/10,1.5)),s=Math.hypot(U-e.x,J-e.y);var De,ze,He=Math.atan2(U-d[0],J-d[1])-e.rotation,p=s*D/(Math.abs(Math.sin(He))+Be*Math.PI/180/2);fMaxRotInCp<Be&&(j<z&&((De=aiMarginLimitSpeed(e.x,e.y,direction(0,e.rotation),direction(1,e.rotation),h[0],h[1],T,I,2*z,D))<p&&(p=De)),ze=p,ze=(ze/=.9)||.01,32==oMap.skin&&6<Ee&&ze<Ee-1?(e.speed=Math.max(ze,e.speed-2),e.speedinc=0):e.speedinc=Math.max(Math.min(ze-Ee,1),-1),e.speedinc<0&&(e.rotinc=-e.rotinc))}_&&e.lastAItime>250+50*Math.random()&&!t&&(e.aipoint=void 0);break}"BB"!=course?(e.aipoint++,e.aipoint>=e.aipoints.length&&(e.aipoint=0)):(e.lastAI=e.aipoint,delete e.lastAIpt,-1!=e.nextAI?e.aipoint=e.nextAI:e.aipoint=void 0,e.nextAI=void 0),e.nextAiStop=void 0,e.randShift=void 0,e.lastAItime=0}if((25==e.roulette||e.using[0])&&!e.tourne&&!e.cannon){var Oe,Re=!1;if(e.using[0])switch(e.using[2]){case"carapacerouge":if("BB"==course)for(i=0;i<strPlayer.length;i++)!aKarts[i].loose&&Math.pow(aKarts[i].x-e.x-15*direction(0,e.rotation),2)+Math.pow(aKarts[i].y-e.y-15*direction(1,e.rotation),2)<1e3&&(arme(aKarts.indexOf(e)),i=strPlayer.length);else Re=!0;break;default:Re=!0}else switch(arme){case"champi":case"megachampi":case"etoile":11<=p&&100<=s&&c<=10&&arme(aKarts.indexOf(e));break;default:Re=!0}Re&&.98<Math.random()&&(Oe=(e.place<oPlayers[0].place||"BB"==course)&&.5<Math.random(),arme(aKarts.indexOf(e),Oe))}oMap.jumpable&&4<iDificulty&&(!e.z||e.jumped||e.billball||e.figstate||e.figuring||e.tourne||!(0<e.heightinc)||8<=p&&(oMap.jumpexc&&-1!=oMap.jumpexc.indexOf(e.aipoint)||(e.figstate=21)))}}}function moveDecor(){for(var e in decorPos={},oMap.decor)if(decorBehaviors[e].dodgable){decorPos[e]=[];for(var t=oMap.decor[e],a=0;a<t.length;a++)decorPos[e].push({aX:t[a][0],aY:t[a][1],x:t[a][0],y:t[a][1],vX:0,vY:0})}var n={};for(var e in oMap.decor){var t=oMap.decor[e],o=decorBehaviors[e];if(o.move){var i=getDecorActualType(o),r=0;n[i]?r=n[i]:n[i]=0;for(a=0;a<t.length;a++)o.move(t[a],a,a+r);n[i]+=t.length}}var l=2*Math.PI;for(var e in decorPos)for(t=oMap.decor[e],a=0;a<t.length;a++)decorPos[e][a].x=t[a][0],decorPos[e][a].y=t[a][1],decorPos[e][a].vX=decorPos[e][a].x-decorPos[e][a].aX,decorPos[e][a].vY=decorPos[e][a].y-decorPos[e][a].aY;if(oMap.pointers)for(a=0;a<oMap.pointers.length;a++){var s=oMap.pointers[a];s[2][2]+=s[2][3],s[2][2]%=l,s[0].redraw(s)}if(oMap.flippers)for(a=0;a<oMap.flippers.length;a++){var c=oMap.flippers[a],p=c[3][0];switch(p){case 0:--c[3][1]<=0&&(c[3][0]=1,c[3][1]=c[2][2],c[2][3]=.13*c[2][4]);break;case 1:case 2:var u=1==p?c[3][1]+c[2][4]:c[3][1];c[2][2]+=c[2][3],c[2][2]*c[2][3]>=u*c[2][3]&&(c[2][2]=u,1==p?(c[3][0]=2,c[2][3]=-c[2][3]):(c[3][0]=0,c[2][3]=0,c[3][1]=1+Math.floor(50*Math.random())))}p&&c[0].redraw(c)}if(oMap.bumpers)for(a=0;a<oMap.bumpers.length;a++){var d,h,m=oMap.bumpers[a];m[2][5]&&(m[3]||(d=Math.hypot(m[1][0]-m[2][3],m[1][1]-m[2][4]),h=Math.atan2(m[1][1]-m[2][4],m[1][0]-m[2][3]),m[3]=[d,h]),m[3][1]+=m[2][5],m[3][1]%=l,m[1][0]=m[2][3]+m[3][0]*Math.cos(m[3][1]),m[1][1]=m[2][4]+m[3][0]*Math.sin(m[3][1]),m[0].redraw(m))}if(oMap.coins)for(a=0;a<oMap.coins.length;a++){var g=oMap.coins[a];g.theta+=.25,g.theta>=l&&(g.theta-=l)}}function cycle(){pause||(setTimeout(cycle,67),runOneFrame())}var decorPos={};function runOneFrame(){if("CM"!=course)for(var e=0;e<aKarts.length;e++)colKart(e);for(var t,a,e=0;e<aKarts.length;e++){(i=aKarts[e]).pushVector&&(36<(t=i.pushVector[0]*i.pushVector[0]+i.pushVector[1]*i.pushVector[1])&&(a=Math.sqrt(t),i.pushVector[0]*=6/a,i.pushVector[1]*=6/a),i.shift||(i.shift=[0,0,0]),i.shift[0]+=i.pushVector[0],i.shift[1]+=i.pushVector[1],delete i.pushVector)}for(e=0;e<aKarts.length;e++){var n,o,i=aKarts[e];if(e&&"CM"==course&&!i.cpu){var r=jTrajets[e-1];if(timer<=r.length){var l=r[timer-1];i.tombe&&(i.tombe--,i.tombe||(i.sprite[0].img.style.display="block")),i.x=l[0],i.y=l[1],i.z=l[2],i.rotation=l[3],l[4]&&"1"==l[4][0]&&(i.tombe=20,i.sprite[0].img.style.display="none");continue}i.cpu=!0,i.aipoint=0,i.lastAItime=0,i.arme=!1}i.loose&&!isOnline||(i.cpu&&ai(i),move(e),"CM"!=course||i.cpu||(n=[Math.round(i.x),Math.round(i.y),i.z,Math.round(i.rotation)],o="0000".split(""),20==i.tombe&&(o[0]="1"),i.ctrl&&(o[1]="1",0<i.rotincdir?o[2]="1":i.rotincdir<0&&(o[3]="1")),-1!=o.indexOf("1")&&n.push(o.join("")),iTrajet.push(n)))}if("CM"!=course)for(e=0;e<aKarts.length;e++)places(e);moveDecor(),oPlayers[0].cpu||(clSelected&&!clSelectionFail&&!1===challengeRulesSatisfied(clSelected,clSelected.data.constraints)&&challengeHandleFail(),challengeCheck("each_frame")),refreshDatas&&resetDatas(),render()}var gameControls={};document.onkeydown=function(e){var t=gameControls[e.keyCode];switch(t){case"up":return(oPlayers[0].speedinc=1)<document.getElementById("decompte0").innerHTML&&updateEngineSound(carEngine2),!1;case"left":return!(oPlayers[0].rotincdir=1);case"right":return!(oPlayers[0].rotincdir=-1)}if(oPlayers[1])switch(t){case"up_p2":oPlayers[1].speedinc=1;break;case"left_p2":oPlayers[1].rotincdir=1;break;case"right_p2":oPlayers[1].rotincdir=-1}},document.onkeyup=function(e){var t=gameControls[e.keyCode];switch(t){case"up":oPlayers[0].speedinc=0,updateEngineSound(carEngine);break;case"left":case"right":oPlayers[0].rotincdir=0}if(oPlayers[1])switch(t){case"up_p2":oPlayers[1].speedinc=0;break;case"left_p2":oPlayers[1].rotincdir=0;break;case"right_p2":oPlayers[1].rotincdir=0}};var virtualButtonW=60,virtualButtonH=50,myPersosCache;function addButton(e,t,a,n,o,i,r){o=(o||1)*virtualButtonW,i=(i||1)*virtualButtonH;var l=document.createElement("button");return l.style.position="absolute",l.style.left=Math.round(a*virtualButtonW*1.2)+"px",l.style.top=Math.round(n*virtualButtonH*1.3)+"px",l.style.width=o+"px",l.style.height=i+"px",l.style.textAlign="center",l.style.padding="0px",r&&(l.style.fontSize=r+"px"),l.innerHTML=e,l.dataset.key=t,l.ontouchstart=onButtonTouch,l.ontouchend=onButtonPress,document.getElementById("virtualkeyboard").appendChild(l),l}function isCustomPerso(a){var e;return a.startsWith("cp-")&&(customPersos[a]||(cp[a]=[.5,.5,.5,.5],e=PERSOS_DIR+a+"-ld.png",customPersos[a]={name:language?"Deleted character":"Perso supprimé",map:e,podium:e,music:"mario"},xhr("getCP.php","perso="+a,function(e){if(-1==e)return!0;if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return cp[a][0]=t.acceleration,cp[a][1]=t.speed,cp[a][2]=t.handling,cp[a][3]=t.mass,customPersos[a]=t,!0})),1)}function getWinnerSrc(e){return isCustomPerso(e)?customPersos[e].podium:"images/winners/w_"+e+".png"}function getEndingSrc(e){return isCustomPerso(e)&&(e=customPersos[e].music),baseCp[e]?"musics/endings/ending_"+e+".mp3":e}function getStarSrc(e){return isCustomPerso(e)?PERSOS_DIR+e+"-star.png":"images/star/star_"+e+".png"}function getSpriteSrc(e){return isCustomPerso(e)?PERSOS_DIR+e+".png":"images/sprites/sprite_"+e+".png"}function getCustomDecorData(e,t){var o=e.id,i=e.type,a=!1;if(customDecorData[o]){if(void 0!==customDecorData[o].data)return void t(customDecorData[o].data);a=!0}else customDecorData[o]={callbacks:[]};customDecorData[o].callbacks.push(t),a||xhr("getDecorData.php?id="+o+"&full",null,function(e){var t;try{t=JSON.parse(e)}catch(e){t={id:o,hd:"images/sprites/sprite_"+i+".png",map:"images/map_icons/"+i+".png",size:{hd:{w:32,h:32}},original_size:{hd:{w:32,h:32}}}}customDecorData[o].data=t;for(var a=customDecorData[o].callbacks,n=0;n<a.length;n++)customDecorData[o].callbacks[n](t);return!(a.length=0)})}function getMapIcSrc(e){return isCustomPerso(e)?customPersos[e].map:"images/map_icons/"+e+".png"}function getMapSelectorSrc(e){return isCup?complete?"trackicon.php?id="+oMaps[aAvailableMaps[e]].map+"&type="+("BB"==course?2:1):"trackicon.php?id="+oMaps[aAvailableMaps[e]].id+"&type=0":"images/selectors/select_"+aAvailableMaps[e]+".png"}function getMapId(e){var t=isBattle?nid:simplified?e.id:e.map;return void 0===t&&(t=-1),t}function privateGame(t){var e=document.createElement("div"),a=e.style;a.width=iWidth*iScreenScale+"px",a.height=iHeight*iScreenScale+"px",a.border="solid 1px black",a.backgroundColor="black",e.appendChild(toTitle(toLanguage("Private game","Partie privée"),0));var n=document.createElement("div");n.style.position="absolute",n.style.left=6*iScreenScale+"px",n.style.top=12*iScreenScale+"px",n.style.fontSize=Math.round(2.5*iScreenScale)+"px",n.style.color="#DFC",n.innerHTML=language?"The &quot;private game&quot; option allows you to play only with people you want.<br />The principle is simple: a private link is generated, you send this link to the concerned members, and you can start playing.":"L'option &quot;partie privée&quot; vous permet de jouer uniquement avec les personnes de votre choix.<br />Le principe est simple : un lien privé est généré, vous envoyez ce lien aux membres concernés, et vous pouvez commencer à jouer.",e.appendChild(n);var o=document.createElement("input");o.type="button",o.value=toLanguage("Generate private link","Générer un lien privé"),o.style.fontSize=3*iScreenScale+"px",o.style.position="absolute",o.style.width=35*iScreenScale+"px",o.style.left=23*iScreenScale+"px",o.style.top=28*iScreenScale+"px",o.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),privateLink(t)},e.appendChild(o),(o=document.createElement("input")).type="button",o.value=toLanguage("Back","Retour"),o.style.fontSize=2*iScreenScale+"px",o.style.position="absolute",o.style.left=2*iScreenScale+"px",o.style.top=35*iScreenScale+"px",o.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),shareLink.options=null,selectPlayerScreen(0)},e.appendChild(o),(o=document.createElement("input")).type="button",o.value=toLanguage("Private game options...","Options de la partie privée..."),o.style.fontSize=2*iScreenScale+"px",o.style.position="absolute",o.style.left=52*iScreenScale+"px",o.style.top=35*iScreenScale+"px",o.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),privateGameOptions(shareLink.options,function(e){e&&(shareLink.options=e,t=e),privateGame(t)})},e.appendChild(o),oContainers[0].appendChild(e)}function privateGameOptions(e,l){var t,s=document.createElement("div"),a=s.style;a.width=iWidth*iScreenScale+"px",a.height=iHeight*iScreenScale+"px",a.border="solid 1px black",a.backgroundColor="black",(t=toTitle(isOnline?toLanguage("Private game options","Options partie privée"):toLanguage("Online game options","Options mode en ligne"),0)).style.fontSize=7*iScreenScale+"px",s.appendChild(t);var n=document.createElement("form");n.style.position="absolute",n.style.left="0px",n.style.top=8*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px",n.onsubmit=function(e){e.preventDefault();var t=this.elements["option-teams"].checked?1:0,a=this.elements["option-manualTeams"].checked?1:0;t||(a=0);var n=this.elements["option-friendly"].checked?1:0,o=+this.elements["option-localScore"].checked?1:0;n||(o=0);var i=+this.elements["option-minPlayers"].value,r=+this.elements["option-maxPlayers"].value;l({team:t,manualTeams:a,friendly:n,localScore:o,minPlayers:i,maxPlayers:r}),s.innerHTML="",oContainers[0].removeChild(s)};var o=document.createElement("div");o.style.height=(isOnline?24:20)*iScreenScale+"px",o.style.overflow="auto";var i=document.createElement("table");i.style.marginLeft="auto",i.style.marginRight="auto";var r=document.createElement("tr");(p=document.createElement("td")).style.textAlign="center",p.style.width=8*iScreenScale+"px";var c=document.createElement("input");c.style.transform=c.style.WebkitTransform=c.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",c.id="option-teams",c.name="option-teams",c.type="checkbox",e&&e.team&&(c.checked=!0),c.onchange=function(){this.checked?document.getElementById("option-manualTeams-ctn").style.display="":document.getElementById("option-manualTeams-ctn").style.display="none"},p.appendChild(c),r.appendChild(p);var p=document.createElement("td"),u=document.createElement("label");u.style.cursor="pointer",u.setAttribute("for","option-teams");var d=document.createElement("h1");d.style.fontSize=3*iScreenScale+"px",d.style.marginBottom="0px",d.innerHTML=toLanguage("Team games","Parties par équipe"),u.appendChild(d);var h=document.createElement("div");h.style.fontSize=2*iScreenScale+"px",h.style.color="white",h.innerHTML=toLanguage("If enabled, 2 teams are selected in each game. You object: defeat the opposing team.","Si activé, 2 équipes sont sélectionnées à chaque partie. Votre objectif : vaincre l'équipe adverse."),u.appendChild(h),p.appendChild(u),p.style.padding=Math.round(1.5*iScreenScale)+"px 0",r.appendChild(p),i.appendChild(r),(r=document.createElement("tr")).id="option-manualTeams-ctn",e&&e.team||(r.style.display="none"),(p=document.createElement("td")).style.textAlign="center",p.style.width=8*iScreenScale+"px",(c=document.createElement("input")).style.position="relative",c.style.left=Math.round(1.5*iScreenScale)+"px",c.style.transform=c.style.WebkitTransform=c.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",c.id="option-manualTeams",c.name="option-manualTeams",c.type="checkbox",e&&e.team&&e.manualTeams&&(c.checked=!0),p.appendChild(c),r.appendChild(p);p=document.createElement("td");(u=document.createElement("label")).style.cursor="pointer",u.style.display="inline-block",u.setAttribute("for","option-manualTeams"),(d=document.createElement("h1")).style.marginTop=0,d.style.marginLeft=Math.round(1.5*iScreenScale)+"px",d.style.fontSize=3*iScreenScale+"px",d.style.marginBottom="0px",d.innerHTML=toLanguage("Manual selection","Sélection manuelle"),u.appendChild(d),(h=document.createElement("div")).style.paddingLeft=Math.round(1.5*iScreenScale)+"px",h.style.fontSize=2*iScreenScale+"px",h.style.color="white",h.innerHTML=toLanguage("If enabled, teams are selected manually at each game.","Si activé, les équipes sont sélectionnées manuellement à chaque partie. Sinon, les équipes sont formées automatiquement en fonction du niveau de chaque joueur."),u.appendChild(h),p.appendChild(u),p.style.paddingBottom=Math.round(1.5*iScreenScale)+"px",r.appendChild(p),i.appendChild(r);r=document.createElement("tr");(p=document.createElement("td")).style.textAlign="center",p.style.width=8*iScreenScale+"px",(c=document.createElement("input")).id="option-friendly",c.name="option-friendly",c.type="checkbox",e&&e.friendly&&(c.checked=!0),c.onchange=function(){this.checked&&isOnline?document.getElementById("option-localScore-ctn").style.display="":document.getElementById("option-localScore-ctn").style.display="none"},c.style.transform=c.style.WebkitTransform=c.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",p.appendChild(c),r.appendChild(p);p=document.createElement("td");(u=document.createElement("label")).style.cursor="pointer",u.setAttribute("for","option-friendly"),p.appendChild(u),(d=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("Friendly game","Matchs amicaux"),d.style.marginBottom="0px",u.appendChild(d),(h=document.createElement("div")).style.fontSize=2*iScreenScale+"px",h.style.color="white",h.innerHTML=toLanguage("If enabled, games won't make you win or lose points in the online mode.","Si activé, les parties ne vous feront pas gagner ou perdre de points dans le mode en ligne."),u.appendChild(h),p.appendChild(u),r.appendChild(p),i.appendChild(r),(r=document.createElement("tr")).id="option-localScore-ctn",e&&e.friendly||(r.style.display="none"),(p=document.createElement("td")).style.textAlign="center",p.style.width=8*iScreenScale+"px",(c=document.createElement("input")).style.position="relative",c.style.left=Math.round(1.5*iScreenScale)+"px",c.style.transform=c.style.WebkitTransform=c.style.MozTransform="scale("+Math.round(iScreenScale/3)+")",c.id="option-localScore",c.name="option-localScore",c.type="checkbox",e&&e.friendly&&e.localScore&&isOnline&&(c.checked=!0),p.appendChild(c),r.appendChild(p);p=document.createElement("td");(u=document.createElement("label")).style.cursor="pointer",u.style.display="inline-block",u.setAttribute("for","option-localScore"),(d=document.createElement("h1")).style.marginTop=0,d.style.marginLeft=Math.round(1.5*iScreenScale)+"px",d.style.fontSize=3*iScreenScale+"px",d.style.marginBottom="0px",d.innerHTML=toLanguage("Local scoring","Classement local"),u.appendChild(d),(h=document.createElement("div")).style.paddingLeft=Math.round(1.5*iScreenScale)+"px",h.style.fontSize=2*iScreenScale+"px",h.style.color="white",h.innerHTML=toLanguage("If enabled, an ranking internal to this room will be calculated instead of the classic online mode ranking.","Si activé, un classement interne à la partie privée sera calculé à la place du classement en ligne classique."),u.appendChild(h),p.appendChild(u),p.style.paddingBottom=Math.round(1.5*iScreenScale)+"px",r.appendChild(p),i.appendChild(r);r=document.createElement("tr");isOnline||(r.style.display="none"),(p=document.createElement("td")).setAttribute("colspan",2);var m=document.createElement("div");m.style.display="flex",m.style.flexDirection="row",m.style.alignItems="center";var g=document.createElement("div");g.style.paddingLeft=3*iScreenScale+"px",g.style.paddingRight=3*iScreenScale+"px",(u=document.createElement("label")).style.cursor="pointer",u.setAttribute("for","option-minPlayers"),(d=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("Minimum number of players","Nombre de joueurs minimum"),d.style.marginTop=iScreenScale+"px",d.style.marginBottom="0px",u.appendChild(d),(h=document.createElement("div")).style.fontSize=2*iScreenScale+"px",h.style.color="white",h.innerHTML=toLanguage("Minimum number of players before the game begins.","Nombre minimum de joueurs pour que la partie commence"),u.appendChild(h),g.appendChild(u),m.appendChild(g),(g=document.createElement("div")).style.display="inline-block";var y=document.createElement("input");y.id="option-minPlayers",y.name="option-minPlayers",y.type="number",y.setAttribute("min",2),y.setAttribute("max",99),y.setAttribute("step",1),y.setAttribute("required",!0),y.style.backgroundColor="#F6F6F6",y.style.width=6*iScreenScale+"px",e&&e.minPlayers?y.value=e.minPlayers:y.value=defaultGameOptions.minPlayers,y.style.fontSize=3*iScreenScale+"px",y.style.marginTop=Math.round(1.5*iScreenScale)+"px",g.appendChild(y),m.appendChild(g),p.appendChild(m),r.appendChild(p),i.appendChild(r);r=document.createElement("tr");isOnline||(r.style.display="none"),(p=document.createElement("td")).setAttribute("colspan",2),(m=document.createElement("div")).style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",(g=document.createElement("div")).style.paddingLeft=3*iScreenScale+"px",g.style.paddingRight=3*iScreenScale+"px",(u=document.createElement("label")).style.cursor="pointer",u.setAttribute("for","option-maxPlayers"),(d=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",d.innerHTML=toLanguage("Maximum number of players","Nombre de joueurs maximum"),d.style.marginTop=iScreenScale+"px",d.style.marginBottom="0px",u.appendChild(d),(h=document.createElement("div")).style.fontSize=2*iScreenScale+"px",h.style.color="white",h.innerHTML=toLanguage("Maximum number of players that can join the game.","Nombre maximum de joueurs qui peuvent rejoindre la partie"),u.appendChild(h),g.appendChild(u),m.appendChild(g),(g=document.createElement("div")).style.display="inline-block",(y=document.createElement("input")).id="option-maxPlayers",y.name="option-maxPlayers",y.type="number",y.setAttribute("min",2),y.setAttribute("max",99),y.setAttribute("step",1),y.setAttribute("required",!0),y.style.backgroundColor="#F6F6F6",y.style.width=6*iScreenScale+"px",e&&e.maxPlayers?y.value=e.maxPlayers:y.value=defaultGameOptions.maxPlayers,y.style.fontSize=3*iScreenScale+"px",y.style.marginTop=Math.round(1.5*iScreenScale)+"px",g.appendChild(y),m.appendChild(g),p.appendChild(m),r.appendChild(p),i.appendChild(r),o.appendChild(i),n.appendChild(o),(h=document.createElement("div")).style.textAlign="center",h.style.marginTop=2*iScreenScale+"px";var f=document.createElement("input");f.type="submit",f.value=toLanguage("Validate","Valider"),f.style.fontSize=3*iScreenScale+"px",f.style.width=18*iScreenScale+"px",h.appendChild(f),n.appendChild(h),s.appendChild(n);var S=document.createElement("input");S.type="button",S.value=toLanguage("Cancel","Annuler"),S.style.fontSize=2*iScreenScale+"px",S.style.position="absolute",S.style.left=2*iScreenScale+"px",S.style.top=35*iScreenScale+"px",S.onclick=function(){s.innerHTML="",oContainers[0].removeChild(s),l(null)},s.appendChild(S),oContainers[0].appendChild(s)}function privateLink(e){var i=document.createElement("div"),t=i.style;t.width=iWidth*iScreenScale+"px",t.height=iHeight*iScreenScale+"px",t.border="solid 1px black",t.backgroundColor="black",i.appendChild(toTitle(toLanguage("Private game","Partie privée"),0)),xhr("privateGame.php",isCustomOptions(e)?"options="+encodeURIComponent(JSON.stringify(e)):null,function(e){if(e){var t=shareLink.url,a=shareLink.params.slice(0);a.push("key="+e);var n=t+"?"+a.join("&"),o=document.createElement("div");return o.style.position="absolute",o.style.left="0px",o.style.top=13*iScreenScale+"px",o.style.width=iWidth*iScreenScale+"px",o.style.textAlign="center",o.style.fontSize=3*iScreenScale+"px",o.style.color="#CFC",o.innerHTML=language?'The following private link has been generated:<br /><a href="'+n+'" style="color:AAF">'+n+"</a><br /><br />Enjoy game :)":'Le lien privé suivant a été généré :<br /><a href="'+n+'" style="color:AAF">'+n+"</a><br /><br />Bonne partie :)",i.appendChild(o),!0}return!1}),oContainers[0].appendChild(i)}function selectTypeScreen(){var e,t=document.createElement("div"),a=t.style;a.width=iWidth*iScreenScale+"px",a.height=iHeight*iScreenScale+"px",a.border="solid 1px black",a.backgroundColor="black";var n=new Image;if(n.src="images/mariokart.png",n.style.position="absolute",n.style.width=Math.round(42.5*iScreenScale)+"px",n.style.height=5*iScreenScale+"px",n.style.left=Math.round((iWidth-42.5)/2*iScreenScale)+"px",n.style.top=2*iScreenScale+"px",t.appendChild(n),(a=t.style).width=iWidth*iScreenScale+"px",a.height=iHeight*iScreenScale+"px",a.border="solid 1px black",a.backgroundColor="black",oContainers[0].appendChild(t),"MK"==page){var o=11;(s=document.createElement("input")).type="button",s.value="Grand Prix",s.style.fontSize=3*iScreenScale+"px",s.style.position="absolute",s.style.left=10*iScreenScale+"px",s.style.top=o*iScreenScale+"px",s.style.width=29*iScreenScale+"px",s.onclick=function(){course="GP",e.style.display="none",t.innerHTML="",oContainers[0].removeChild(t),selectPlayerScreen(0)},t.appendChild(s),(s=document.createElement("input")).type="button",s.value=toLanguage("Time trial","Contre-la-montre"),s.style.fontSize=3*iScreenScale+"px",s.style.position="absolute",s.style.left=41*iScreenScale+"px",s.style.top=o*iScreenScale+"px",s.style.width=29*iScreenScale+"px",s.onclick=function(){course="CM",e.style.display="none",t.innerHTML="",oContainers[0].removeChild(t),selectPlayerScreen(0)},t.appendChild(s),(s=document.createElement("input")).type="button",s.value=toLanguage("VS","Course VS"),s.style.fontSize=3*iScreenScale+"px",s.style.position="absolute",s.style.left=iScreenScale+"px",s.style.top=(o+8)*iScreenScale+"px",s.style.width=29*iScreenScale+"px",s.onclick=function(){course="VS",e.style.display="none",t.innerHTML="",oContainers[0].removeChild(t),selectNbJoueurs()},t.appendChild(s),(s=document.createElement("input")).type="button",s.value=toLanguage("Battle","Bataille"),s.style.fontSize=3*iScreenScale+"px",s.style.position="absolute",s.style.left=50*iScreenScale+"px",s.style.top=(o+8)*iScreenScale+"px",s.style.width=29*iScreenScale+"px",s.onclick=function(){course="BB",e.style.display="none",t.innerHTML="",oContainers[0].removeChild(t),selectNbJoueurs()},t.appendChild(s),(s=document.createElement("input")).type="button",s.value=toLanguage("Track builder","Éditeur de circuit"),s.style.fontSize=3*iScreenScale+"px",s.style.position="absolute",s.style.left=10*iScreenScale+"px",s.style.top=(o+16)*iScreenScale+"px",s.style.width=29*iScreenScale+"px",s.onclick=function(){e.style.display="none",t.innerHTML="",oContainers[0].removeChild(t),selectTypeCreate()},t.appendChild(s),(s=document.createElement("input")).type="button",s.value=toLanguage("Online race","Course en ligne"),s.style.fontSize=3*iScreenScale+"px",s.style.position="absolute",s.style.left=41*iScreenScale+"px",s.style.top=(o+16)*iScreenScale+"px",s.style.width=29*iScreenScale+"px",s.onclick=function(){course="VS",e.style.display="none",t.innerHTML="",oContainers[0].removeChild(t),selectOnlineScreen()},t.appendChild(s),(s=document.createElement("input")).type="button",s.value=toLanguage("Home","Accueil"),s.style.fontSize=2*iScreenScale+"px",s.style.position="absolute",s.style.left=2*iScreenScale+"px",s.style.top=35*iScreenScale+2+"px",s.onclick=function(){document.location.href="index.php"},t.appendChild(s)}else{var r,l,s,o=12,c=[toLanguage("VS","Course VS")],p=["VS"];for(isSingle||(c.unshift("Grand Prix"),p.unshift("GP")),(hasChallenges()||myCircuit)&&(c.push(toLanguage("Challenges","Défis")),p.push("CH")),!nid&&isSingle||(c.push(toLanguage("Time Trial","Contre-la-montre")),p.push("CM")),!nid||isSingle&&complete&&!cShared||(c.push(toLanguage("Online race","Course en ligne")),p.push("CL")),!isSingle&&cupScore&&((r=new Image).src="images/cups/cup"+(4-cupScore)+".png",r.style.width=Math.round(4*iScreenScale)+"px",r.style.height=Math.round(4*iScreenScale)+"px",r.style.position="absolute",c.length<5?(r.style.left=3*iScreenScale+"px",r.style.top=Math.round((o+4)*iScreenScale)+"px"):(r.style.left=5*iScreenScale+"px",r.style.top=Math.round(o*iScreenScale)+"px"),r.className="pixelated",t.appendChild(r)),i=0;i<c.length;i++){(s=document.createElement("input")).type="button",s.value=c[i],s.style.position="absolute",c.length<4?(n.style.top=3*iScreenScale+"px",s.style.left=20*iScreenScale+"px",s.style.top=Math.round((o+6.5*i)*iScreenScale)+"px",s.style.width=38*iScreenScale+"px",s.style.fontSize=Math.round(3.5*iScreenScale)+"px"):4==c.length?(n.style.top=4*iScreenScale+"px",s.style.left=(8+i%2*36)*iScreenScale+"px",s.style.top=(o+4+8*Math.floor(i/2))*iScreenScale+"px",s.style.width=28*iScreenScale+"px",s.style.fontSize=3*iScreenScale+"px"):(l=[[10,o-1],[40,o-1],[25,o+7],[10,o+15],[40,o+15]][i],s.style.left=l[0]*iScreenScale+"px",s.style.top=l[1]*iScreenScale+"px",s.style.fontSize=3*iScreenScale+"px",s.style.width=29*iScreenScale+"px"),s.dataset||(s.dataset={}),s.dataset.course=p[i],s.onclick=function(){course=this.dataset.course,"CL"==course?document.location.href="online.php?"+(isMCups?"mid="+nid:(isSingle?complete?"i":"id":complete?"cid":"sid")+"="+nid):(e.style.display="none",t.innerHTML="",oContainers[0].removeChild(t),"VS"==course?selectNbJoueurs():"CH"==course?selectChallengesScreen():selectPlayerScreen(0))},t.appendChild(s)}(s=document.createElement("input")).type="button",s.value=toLanguage("Back","Retour"),s.style.fontSize=2*iScreenScale+"px",s.style.position="absolute",s.style.left=2*iScreenScale+"px",s.style.top=35*iScreenScale+"px",s.onclick=function(){exitCircuit()},t.appendChild(s)}var u,d,h,m,g,y=!(e=document.getElementById("fb-root"));y?((e=document.createElement("div")).id="fb-root",e.style.position="absolute"):e.style.display="",e.style.left=16*iScreenScale-12+"px",e.style.top=36*iScreenScale+2+"px",e.style.transform=e.style.WebkitTransform=e.style.MozTransform="scale("+iScreenScale/7+")",y&&((u=document.createElement("div")).className="fb-share-button",u.dataset.href=document.location.href,u.dataset.layout="button",e.appendChild(u),document.body.appendChild(e),d=document,h="facebook-jssdk",g=d.getElementsByTagName("script")[0],d.getElementById(h)||((m=d.createElement("script")).id=h,m.src="//connect.facebook.net/"+(language?"en_EN":"fr_FR")+"/sdk.js#xfbml=1&version=v2.4",g.parentNode.insertBefore(m,g)));var f=document.createElement("img");f.src="images/english.png",f.alt="En",f.style.position="absolute",f.style.left=68*iScreenScale+"px",f.style.top=35*iScreenScale+"px",f.style.width=4*iScreenScale+"px",f.style.height=Math.round(8*iScreenScale/3)+"px";var S=document.createElement("img");S.src="images/french.png",f.alt="Fr",S.style.position="absolute",S.style.left=74*iScreenScale+"px",S.style.top=35*iScreenScale+"px",S.style.width=4*iScreenScale+"px",S.style.height=Math.round(8*iScreenScale/3)+"px";var v=language?f:S,b=language?S:f;v.style.border="solid 1px "+primaryColor,b.style.border="solid 1px transparent",b.style.cursor="pointer",b.onmouseover=function(){b.style.border="solid 1px "+primaryColor},b.onmouseout=function(){b.style.border="solid 1px transparent"},b.onclick=function(){language=!language,xhr("setLanguage.php","nLanguage="+ +language,function(e){return 1==e&&(location.reload(),!0)})},t.appendChild(f),t.appendChild(S),updateMenuMusic(0)}function selectMainPage(){switch(page){case"OL":mId?selectPlayerScreen(0):connexion();break;case"MK":selectTypeScreen();break;case"CI":case"MA":nid?selectTypeScreen():(course="VS",selectNbJoueurs());break;case"BA":case"AR":course="BB",selectNbJoueurs()}}function selectNbJoueurs(e){if(!clSelected||e){var t=document.createElement("div"),a=t.style;a.width=iWidth*iScreenScale+"px",a.height=iHeight*iScreenScale+"px",a.border="solid 1px black",a.backgroundColor="black",t.appendChild(toTitle(toLanguage("Number of players","Nombre de joueurs"),.5));var n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){isBattle||isCup&&!nid?exitCircuit():(t.innerHTML="",oContainers[0].removeChild(t),selectTypeScreen())},t.appendChild(n);var o=isBattle&&cShared;for(i=1;i<=2;i++){(n=document.createElement("input")).type="button",n.id="select-nbj-"+i,n.value=i+(i<2?"  ":" ")+toLanguage("player","joueur")+(i<2?" ":"s"),n.style.fontSize=4*iScreenScale+"px",n.style.position="absolute",n.style.left=(o?26:27)*iScreenScale+"px",n.style.top=((o?7:10)+i*(o?7:8))*iScreenScale+"px",o&&(n.style.paddingLeft=2*iScreenScale+"px",n.style.paddingRight=2*iScreenScale+"px"),n.onclick=function(){var e;t.innerHTML="",oContainers[0].removeChild(t),"2"==this.value.charAt(0)&&(clSelected=null,(e=oContainers[0].cloneNode(!1)).style.left=12+iWidth*iScreenScale+"px",oContainers.push(e)),selectPlayerScreen(0)},t.appendChild(n)}o&&((n=document.createElement("input")).type="button",n.value=toLanguage("Online mode","Mode en ligne"),n.style.fontSize=3*iScreenScale+"px",n.style.position="absolute",n.style.left=26*iScreenScale+"px",n.style.top=30*iScreenScale+"px",n.style.paddingTop=Math.round(.5*iScreenScale)+"px",n.style.paddingBottom=Math.round(.5*iScreenScale)+"px",n.onclick=function(){document.location.href="online.php?"+(complete?"i":"id")+"="+nid+"&battle"},t.appendChild(n)),oContainers[0].appendChild(t),!myCircuit&&!hasChallenges()||nid&&!isBattle||((n=document.createElement("input")).type="button",n.value=toLanguage("Challenges...","Défis..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.right=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectChallengesScreen()},t.appendChild(n)),updateMenuMusic(0)}else selectPlayerScreen(0)}function selectOnlineScreen(t){var e=document.createElement("div"),a=e.style;a.width=iWidth*iScreenScale+"px",a.height=iHeight*iScreenScale+"px",a.border="solid 1px black",a.backgroundColor="black",e.appendChild(toTitle(toLanguage("Online mode","Mode en ligne"),2));var n=document.createElement("input");n.type="button",n.value=toLanguage("Back","Retour"),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=2*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),selectTypeScreen()},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=toLanguage("More options...","Plus d'options..."),n.style.fontSize=2*iScreenScale+"px",n.style.position="absolute",n.style.left=60*iScreenScale+"px",n.style.top=35*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),privateGameOptions(t,function(e){e&&(isCustomOptions(t=e)||(t=null)),selectOnlineScreen(t)})},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=language?"VS mode":"Course VS",n.style.fontSize=Math.round(3.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=22*iScreenScale+"px",n.style.top=17*iScreenScale+"px",n.style.width=36*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),openOnlineMode(!1,t)},e.appendChild(n),(n=document.createElement("input")).type="button",n.value=language?"Battle mode":"Bataille de ballons",n.style.fontSize=Math.round(3.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=22*iScreenScale+"px",n.style.top=25*iScreenScale+"px",n.style.width=36*iScreenScale+"px",n.onclick=function(){e.innerHTML="",oContainers[0].removeChild(e),openOnlineMode(!0,t)},e.appendChild(n),oContainers[0].appendChild(e),updateMenuMusic(0)}function openOnlineMode(t,e){e?xhr("onlineOptions.php","options="+encodeURIComponent(JSON.stringify(e)),function(e){return!!e&&(document.location.href="online.php?"+(t?"battle&":"")+"key="+e,!0)}):document.location.href="online.php"+(t?"?battle":"")}function openChallengeEditor(){clId&&!edittingCircuit?document.location.href="challenges.php?cl="+clId:document.location.href=document.location.href.replace(/\/(\w+)\.php\?(.+)$/g,"/challenges.php?page=$1&$2")}function selectTypeCreate(){var d=document.createElement("div"),e=d.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black",d.appendChild(toTitle(toLanguage("Track builder","Éditeur de circuit"),.5));var t=document.createElement("div");t.style.color="white",t.style.fontWeight="normal",t.style.position="absolute",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.left=2*iScreenScale+"px",t.style.top=Math.round(14.5*iScreenScale)+"px",t.style.width=20*iScreenScale+"px",t.style.textAlign="right",t.innerHTML=toLanguage("Quick mode :","Mode simplifié :"),d.appendChild(t);var a=document.createElement("input");a.type="button",a.value="Circuit",a.style.fontSize=Math.round(2.5*iScreenScale)+"px",a.style.position="absolute",a.style.left=24*iScreenScale+"px",a.style.top=14*iScreenScale+"px",a.style.width=10*iScreenScale+"px",a.onclick=function(){document.location.href="create.php"},d.appendChild(a),(a=document.createElement("input")).type="button",a.value=toLanguage("Arena","Arène"),a.style.fontSize=Math.round(2.5*iScreenScale)+"px",a.style.position="absolute",a.style.left=36*iScreenScale+"px",a.style.top=14*iScreenScale+"px",a.style.width=10*iScreenScale+"px",a.onclick=function(){document.location.href="arene.php"},d.appendChild(a),(a=document.createElement("input")).type="button",a.value=toLanguage("Cup","Coupe"),a.style.fontSize=Math.round(2.5*iScreenScale)+"px",a.style.position="absolute",a.style.left=48*iScreenScale+"px",a.style.top=14*iScreenScale+"px",a.style.width=10*iScreenScale+"px",a.onclick=function(){document.location.href="simplecup.php"},d.appendChild(a),(a=document.createElement("input")).type="button",a.value=toLanguage("Multi Cup","Multicoupe"),a.style.fontSize=Math.round(2.5*iScreenScale)+"px",a.style.position="absolute",a.style.left=60*iScreenScale+"px",a.style.top=14*iScreenScale+"px",a.style.width=16*iScreenScale+"px",a.onclick=function(){document.location.href="simplecups.php"},d.appendChild(a),(t=document.createElement("div")).style.position="absolute",t.style.color="white",t.style.fontWeight="normal",t.style.fontSize=Math.round(2.5*iScreenScale)+"px",t.style.left=2*iScreenScale+"px",t.style.top=Math.round(21.5*iScreenScale)+"px",t.style.width=20*iScreenScale+"px",t.style.textAlign="right",t.innerHTML=toLanguage("Complete mode :","Mode complet :"),d.appendChild(t),(a=document.createElement("input")).type="button",a.value="Circuit",a.style.fontSize=Math.round(2.5*iScreenScale)+"px",a.style.position="absolute",a.style.left=24*iScreenScale+"px",a.style.top=Math.round(21*iScreenScale)+"px",a.style.width=10*iScreenScale+"px",a.onclick=function(){document.location.href="draw.php"},d.appendChild(a),(a=document.createElement("input")).type="button",a.value=toLanguage("Arena","Arène"),a.style.fontSize=Math.round(2.5*iScreenScale)+"px",a.style.position="absolute",a.style.left=36*iScreenScale+"px",a.style.top=Math.round(21*iScreenScale)+"px",a.style.width=10*iScreenScale+"px",a.onclick=function(){document.location.href="course.php"},d.appendChild(a),(a=document.createElement("input")).type="button",a.value=toLanguage("Cup","Coupe"),a.style.fontSize=Math.round(2.5*iScreenScale)+"px",a.style.position="absolute",a.style.left=48*iScreenScale+"px",a.style.top=Math.round(21*iScreenScale)+"px",a.style.width=10*iScreenScale+"px",a.onclick=function(){document.location.href="completecup.php"},d.appendChild(a),(a=document.createElement("input")).type="button",a.value=toLanguage("Multi Cup","Multicoupe"),a.style.fontSize=Math.round(2.5*iScreenScale)+"px",a.style.position="absolute",a.style.left=60*iScreenScale+"px",a.style.top=Math.round(21*iScreenScale)+"px",a.style.width=16*iScreenScale+"px",a.onclick=function(){document.location.href="completecups.php"},d.appendChild(a);var n=document.createElement("a");n.style.color="#CCF",n.style.fontSize=Math.round(2.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=24*iScreenScale+"px",n.style.top=Math.round(29.5*iScreenScale)+"px",n.href="#null",n.innerHTML=toLanguage("Help","Aide"),n.onclick=function(){var u=document.createElement("div");u.style.position="absolute",u.style.left="0px",u.style.top="0px",u.style.width=iScreenScale*iWidth+"px",u.style.height=iScreenScale*iHeight+"px",u.style.backgroundColor="rgba(0,0,0,0.7)",u.style.fontWeight="normal";var e=document.createElement("table");e.style.position="absolute",e.style.left=30*iScreenScale+"px",e.style.width=50*iScreenScale+"px",e.style.top=2*-iScreenScale+"px",e.style.color="#333",e.style.opacity=.93,e.style.textAlign="center",e.style.borderSpacing="0 "+5*iScreenScale+"px",e.style.fontSize=2*iScreenScale+"px";var t=document.createElement("tr");t.style.backgroundColor="#CCC";var a=document.createElement("td");language?a.innerHTML="<strong>Quick mode:</strong> create a track in a few clics thanks to ready-made pieces":a.innerHTML="<strong>Mode simplifié :</strong> créez un circuit en quelques clics grâce à des pièces toutes faites",a.style.padding=2*iScreenScale+"px "+3*iScreenScale+"px",t.appendChild(a),(a=document.createElement("td")).style.width=10*iScreenScale+"px",a.style.height=14*iScreenScale+"px",a.innerHTML='<img src="images/help/mode-simple.png" style="height: 100%" alt="Simplify" />',t.appendChild(a),e.appendChild(t),(t=document.createElement("tr")).style.backgroundColor="#CCC";a=document.createElement("td");language?a.innerHTML="<strong>Complete mode:</strong> create entierely the track from an image you draw yourself":a.innerHTML="<strong>Mode complet :</strong> créez entièrement le circuit à partir d'une image dessinée par vous-même",a.style.padding=2*iScreenScale+"px "+3*iScreenScale+"px",t.appendChild(a),(a=document.createElement("td")).style.width=10*iScreenScale+"px",a.style.height=14*iScreenScale+"px",a.innerHTML='<img src="images/help/mode-complete.png" style="height: 100%" alt="Complify" />',t.appendChild(a),e.appendChild(t),u.appendChild(e);var n=document.createElement("div");n.style.color="white",n.style.position="absolute",n.style.fontSize=Math.round(2.5*iScreenScale)+"px",n.style.right=(iWidth-22.9)*iScreenScale+"px",n.style.top=Math.round(14*iScreenScale)+"px",n.style.textAlign="right",n.style.border="solid "+Math.round(.4*iScreenScale)+"px #99C",n.style.padding=Math.round(.1*iScreenScale)+"px "+Math.round(.5*iScreenScale)+"px",n.innerHTML=toLanguage("Quick mode :","Mode simplifié :"),u.appendChild(n);var o=.3*Math.PI,i=3,r=document.createElement("div");r.style.position="absolute",r.style.left=21*iScreenScale+"px",r.style.top=Math.round((14.15-i)*iScreenScale)+"px",r.style.width=Math.round(.5*iScreenScale)+"px",r.style.height=Math.round(i/Math.cos(o)*iScreenScale)+"px",r.style.backgroundColor="#99C",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="rotate("+Math.round(180*o/Math.PI)+"deg)",r.style.transformOrigin=r.style.WebkitTransformOrigin=r.style.MozTransformOrigin="top center",u.appendChild(r);var l=document.createElement("div");l.style.position="absolute",l.style.left=21*iScreenScale+"px",l.style.top=Math.round((14.05-i)*iScreenScale)+"px",l.style.width=Math.round(9*iScreenScale)+"px",l.style.height=Math.round(.4*iScreenScale)+"px",l.style.backgroundColor="#99C",u.appendChild(l);var s=document.createElement("div");s.style.color="white",s.style.position="absolute",s.style.fontSize=Math.round(2.5*iScreenScale)+"px",s.style.right=(iWidth-22.9)*iScreenScale+"px",s.style.top=Math.round(21*iScreenScale)+"px",s.style.textAlign="right",s.style.border="solid "+Math.round(.4*iScreenScale)+"px #99C",s.style.padding=Math.round(.1*iScreenScale)+"px "+Math.round(.5*iScreenScale)+"px",s.innerHTML=toLanguage("Complete mode :","Mode complet :"),u.appendChild(s);o=.3*Math.PI,i=3;(r=document.createElement("div")).style.position="absolute",r.style.left=21*iScreenScale+"px",r.style.top=Math.round((25.35-i)*iScreenScale)+"px",r.style.width=Math.round(.5*iScreenScale)+"px",r.style.height=Math.round(i/Math.cos(o)*iScreenScale)+"px",r.style.backgroundColor="#99C",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="rotate("+Math.round(180*-o/Math.PI)+"deg)",r.style.transformOrigin=r.style.WebkitTransformOrigin=r.style.MozTransformOrigin="bottom center",u.appendChild(r),(l=document.createElement("div")).style.position="absolute",l.style.left=21*iScreenScale+"px",l.style.top=Math.round((24.3+i)*iScreenScale)+"px",l.style.width=Math.round(9*iScreenScale)+"px",l.style.height=Math.round(.4*iScreenScale)+"px",l.style.backgroundColor="#99C",u.appendChild(l);var c=document.createElement("input");return c.type="button",c.style.position="absolute",c.style.left=8*iScreenScale+"px",c.style.bottom=5*iScreenScale+"px",c.style.fontSize=3*iScreenScale+"px",c.value="Ok →",c.onclick=function(){for(;u.childNodes.length;)u.removeChild(u.firstChild);var e=document.createElement("div");e.style.position="absolute",e.style.left=29*iScreenScale+"px",e.style.top=12*iScreenScale+"px",e.style.width=Math.round(.5*iScreenScale)+"px",e.style.height=3*iScreenScale+"px",e.style.backgroundColor="#99C",u.appendChild(e);var t=document.createElement("div");t.style.position="absolute",t.style.left=41*iScreenScale+"px",t.style.top=17*iScreenScale+"px",t.style.width=Math.round(.5*iScreenScale)+"px",t.style.height=3*iScreenScale+"px",t.style.backgroundColor="#99C",u.appendChild(t);var a=document.createElement("div");a.style.position="absolute",a.style.left=53*iScreenScale+"px",a.style.top=12*iScreenScale+"px",a.style.width=Math.round(.5*iScreenScale)+"px",a.style.height=3*iScreenScale+"px",a.style.backgroundColor="#99C",u.appendChild(a);var n=document.createElement("div");n.style.position="absolute",n.style.left=68*iScreenScale+"px",n.style.top=17*iScreenScale+"px",n.style.width=Math.round(.5*iScreenScale)+"px",n.style.height=3*iScreenScale+"px",n.style.backgroundColor="#99C",u.appendChild(n);var o=document.createElement("input");o.type="button",o.value="Circuit",o.style.fontSize=Math.round(2.5*iScreenScale)+"px",o.style.position="absolute",o.style.left=24*iScreenScale+"px",o.style.top=14*iScreenScale+"px",o.style.width=10*iScreenScale+"px",o.style.backgroundColor="#372F1A",o.style.color="#F6DA14",u.appendChild(o),(o=document.createElement("input")).type="button",o.value=toLanguage("Arena","Arène"),o.style.fontSize=Math.round(2.5*iScreenScale)+"px",o.style.position="absolute",o.style.left=36*iScreenScale+"px",o.style.top=14*iScreenScale+"px",o.style.width=10*iScreenScale+"px",o.style.backgroundColor="#372F1A",o.style.color="#F6DA14",u.appendChild(o),(o=document.createElement("input")).type="button",o.value=toLanguage("Cup","Coupe"),o.style.fontSize=Math.round(2.5*iScreenScale)+"px",o.style.position="absolute",o.style.left=48*iScreenScale+"px",o.style.top=14*iScreenScale+"px",o.style.width=10*iScreenScale+"px",o.style.backgroundColor="#372F1A",o.style.color="#F6DA14",u.appendChild(o),(o=document.createElement("input")).type="button",o.value=toLanguage("Multi Cup","Multicoupe"),o.style.fontSize=Math.round(2.5*iScreenScale)+"px",o.style.position="absolute",o.style.left=60*iScreenScale+"px",o.style.top=14*iScreenScale+"px",o.style.width=16*iScreenScale+"px",o.style.backgroundColor="#372F1A",o.style.color="#F6DA14",u.appendChild(o);var i=document.createElement("div");i.style.position="absolute",i.style.left=24*iScreenScale+"px",i.style.top=14*iScreenScale+"px",i.style.width=52*iScreenScale+"px",i.style.height=4*iScreenScale+"px",u.appendChild(i);var r=document.createElement("div");r.style.position="absolute",r.style.left=12*iScreenScale+"px",r.style.bottom=(iHeight-12)*iScreenScale+"px",r.style.width=20*iScreenScale+"px",r.style.padding=Math.round(.5*iScreenScale)+"px "+iScreenScale+"px",r.style.backgroundColor="#CCC",r.style.color="#333",r.style.fontSize=2*iScreenScale+"px",language?r.innerHTML='<strong>Circuit:</strong> Create a track and play against your opponents in <strong style="color:#393">VS mode</strong>':r.innerHTML='<strong>Circuit :</strong> Créez une piste et affrontez vos adversaires en <strong style="color:#393">course VS</strong>',u.appendChild(r);var l=document.createElement("div");l.style.position="absolute",l.style.left=28*iScreenScale+"px",l.style.top=20*iScreenScale+"px",l.style.width=20*iScreenScale+"px",l.style.padding=Math.round(.5*iScreenScale)+"px "+iScreenScale+"px",l.style.backgroundColor="#CCC",l.style.color="#333",l.style.fontSize=2*iScreenScale+"px",language?l.innerHTML='<strong>Arena:</strong> Create a battle course and play in mode <strong style="color:#393">Balloon battle</strong>':l.innerHTML='<strong>Arène :</strong> Créez une zone de combat et jouez en mode <strong style="color:#393">bataille de ballons</strong>',u.appendChild(l);var s=document.createElement("div");s.style.position="absolute",s.style.left=44*iScreenScale+"px",s.style.bottom=(iHeight-12)*iScreenScale+"px",s.style.width=20*iScreenScale+"px",s.style.padding=Math.round(.5*iScreenScale)+"px "+iScreenScale+"px",s.style.backgroundColor="#CCC",s.style.color="#333",s.style.fontSize=2*iScreenScale+"px",language?s.innerHTML='<strong>Cup:</strong> Create a <strong style="color:#393">Grand Prix</strong> cup from 4 of your circuits':s.innerHTML='<strong>Coupe :</strong> Créer une coupe <strong style="color:#393">Grand Prix</strong> à partir de 4 de vos circuits',u.appendChild(s);var c=document.createElement("div");c.style.position="absolute",c.style.left=58*iScreenScale+"px",c.style.top=20*iScreenScale+"px",c.style.width=20*iScreenScale+"px",c.style.padding=Math.round(.5*iScreenScale)+"px "+iScreenScale+"px",c.style.backgroundColor="#CCC",c.style.color="#333",c.style.fontSize=2*iScreenScale+"px",language?c.innerHTML='<strong>Multicup:</strong> Merge <strong style="color:#393">several cups</strong> in a same page to form a series!':c.innerHTML='<strong>Multicoupe :</strong> Réunissez <strong style="color:#393">plusieurs coupes</strong> sur une seule page pour former une série !',u.appendChild(c);var p=document.createElement("input");p.type="button",p.style.position="absolute",p.style.left=8*iScreenScale+"px",p.style.bottom=5*iScreenScale+"px",p.style.fontSize=3*iScreenScale+"px",p.value="Ok ✓",p.onclick=function(){d.removeChild(u)},u.appendChild(p)},u.appendChild(c),d.appendChild(u),!1},d.appendChild(n),(n=document.createElement("a")).style.color="#CCF",n.style.fontSize=Math.round(2.5*iScreenScale)+"px",n.style.position="absolute",n.style.left=34*iScreenScale+"px",n.style.top=Math.round(29.5*iScreenScale)+"px",n.href="creations.php",n.innerHTML=toLanguage("List of creations","Liste des créations"),d.appendChild(n),oContainers[0].appendChild(d),(a=document.createElement("input")).type="button",a.value=toLanguage("Back","Retour"),a.style.fontSize=2*iScreenScale+"px",a.style.position="absolute",a.style.left=2*iScreenScale+"px",a.style.top=35*iScreenScale+"px",a.onclick=function(){d.innerHTML="",oContainers[0].removeChild(d),selectTypeScreen()},d.appendChild(a),updateMenuMusic(0)}function selectPlayerScreen(IdJ,newP,nbSels){var isCustomSel=void 0!==nbSels,force=-1===IdJ;if(force&&(IdJ=0),!IdJ){for(joueurs in strPlayer=[],aPlayers=[],cp)aPlayers.push(joueurs);updateCommandSheet()}fInfos=fInfos||{};var oScr=document.createElement("div");newP&&(oScr.style.visibility="hidden");var oStyle=oScr.style,oTitle,oMsg,oMsg,oTitle;oStyle.width=iWidth*iScreenScale+"px",oStyle.height=iHeight*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black",isCustomSel?(oMsg=IdJ>=oContainers.length?toLanguage("Choose CPU","Choisissez ordi")+" "+(IdJ+1-oContainers.length):1==oContainers.length?toLanguage("Choose player","Choisissez joueur"):toLanguage("Choose player ","Choisissez joueur ")+(IdJ+1),oTitle=toTitle(oMsg,0),oTitle.style.color="#F90"):oTitle=toTitle(toLanguage("Choose a player","Choisissez un joueur"),0),oScr.appendChild(oTitle);var cTable=document.createElement("table");cTable.style.display="none",cTable.style.position="absolute",cTable.style.top=36*iScreenScale+16+"px",cTable.style.left=25*iScreenScale-60+"px",cTable.style.textAlign="left",cTable.style.fontSize=2*iScreenScale+"px",cTable.style.color="white",cTable.setAttribute("cellpadding",2),cTable.setAttribute("cellspacing",2),document.body.appendChild(cTable);var hTr=document.createElement("tr"),hTd1=document.createElement("td");hTd1.innerHTML="&nbsp;",hTr.appendChild(hTd1);var hTd2=document.createElement("td");hTd2.className="maj",hTd2.innerHTML="&nbsp;",hTd2.style.fontWeight="bold",hTr.appendChild(hTd2),cTable.appendChild(hTr);for(var sCaracteristiques=[toLanguage("Acceleration","Accélération"),toLanguage("Max speed","Vitesse max"),toLanguage("Handling","Maniabilité"),toLanguage("Weight","Poids")],dCaracteristiques=new Array,i=0,rotateHandler;i<sCaracteristiques.length;i++){var oTr=document.createElement("tr"),oTd1=document.createElement("td");oTd1.className="rgt",oTd1.innerHTML=sCaracteristiques[i]+" :",oTr.appendChild(oTd1);var oTd2=document.createElement("td");dCaracteristiques[i]=document.createElement("div"),dCaracteristiques[i].style.backgroundColor="#838057",dCaracteristiques[i].style.border="solid 1px silver",dCaracteristiques[i].style.height=2*iScreenScale+"px",dCaracteristiques[i].innerHTML="&nbsp;",oTd2.appendChild(dCaracteristiques[i]),oTr.appendChild(oTd2),cTable.appendChild(oTr)}var jScreenScale=iScreenScale;function tourner(e){var t,a=Math.round(5*jScreenScale*(e.naturalWidth/768)),n=parseFloat(e.style.left);-21*a<n?e.style.left=n-a+"px":e.naturalWidth?(t=Math.min(5*e.naturalWidth/768,5.8),e.style.left=-Math.round(jScreenScale*(5*e.naturalWidth/768-t)/2)+"px"):e.style.left="0px",rotateHandler=setTimeout(function(){tourner(e)},100)}function createPersoSelector(e){var t=document.createElement("div");t.style.backgroundColor="#78D0F8",t.style.position="absolute",t.style.width=5*jScreenScale+"px",t.style.height=5*jScreenScale+"px",t.style.borderTop="double 4px black",t.style.borderLeft="double 4px #F8F8F8",t.style.borderRight="double 4px #F8F8F8",t.style.borderBottom="solid 5px #00B800";var u=document.createElement("div");u.style.position="absolute",u.style.display="inline-block",u.style.width=5*jScreenScale+"px",u.style.height=5*jScreenScale+"px",u.style.overflow="hidden";var a=new Image;if(a.style.height=5*jScreenScale+"px",a.style.position="absolute",a.className="pixelated",pUnlocked[e]){for(var n=!0,o=aPlayers[e],i=0;i<strPlayer.length;i++)strPlayer[i]==o&&(n=!1,i=strPlayer.length);a.src=(n?getSpriteSrc:getStarSrc)(o),a.alt=aPlayers[e],a.nb=e,a.style.left=-30*jScreenScale+"px",a.style.cursor="pointer",a.id="perso-selector-"+o,a.j=IdJ,a.onload=function(){var e=Math.min(5*this.naturalWidth/768,5.8),t=Math.min(5*this.naturalHeight/32,5.8);u.style.width=Math.round(e*jScreenScale)+"px",u.style.height=Math.round(t*jScreenScale)+"px",this.style.width=24*Math.round(5*this.naturalWidth/768*jScreenScale)+"px",this.style.height=Math.round(5*this.naturalHeight/32*jScreenScale)+"px",this.style.left=-Math.round(6*Math.round(5*jScreenScale*this.naturalWidth/768)+jScreenScale*(5*this.naturalWidth/768-e)/2)+"px",this.style.top=Math.round((t-5*this.naturalHeight/32)*jScreenScale/2)+"px",u.style.left=Math.round((5-e)/2*jScreenScale)+"px",u.style.top=Math.round(1+(5-t)/2*jScreenScale)+"px"},u.onmouseover=function(){cTable.style.display="block";var e=u.firstChild;hTd2.innerHTML=toPerso(e.alt);for(var t=0;t<dCaracteristiques.length;t++)dCaracteristiques[t].style.width=5*iScreenScale*(8*cp[e.alt][t]+1)+"px";clearTimeout(rotateHandler),tourner(e)},u.onmouseout=function(){cTable.style.display="none";var e,t=u.firstChild;t.naturalWidth?(e=Math.min(5*t.naturalWidth/768,5.8),t.style.left=-Math.round(6*Math.round(5*jScreenScale*t.naturalWidth/768)+jScreenScale*(5*t.naturalWidth/768-e)/2)+"px"):t.style.left=-30*jScreenScale+"px",clearTimeout(rotateHandler)},u.onclick=function(){clearTimeout(rotateHandler);var e=u.firstChild;strPlayer[e.j]=e.alt;var t="";if(isOnline||(t="VS"==course?(iDificulty=4+.5*selectedDifficulty,"difficulty="+selectedDifficulty+"&players="+fInfos.nbPlayers+"&team="+fInfos.teams):"players="+fInfos.nbPlayers+"&team="+fInfos.teams),oScr.innerHTML="",e.j++,oContainers[0].removeChild(oScr),document.body.removeChild(cTable),addMyPersos=function(){},e.j==(isCustomSel?nbSels:oContainers.length)){if(isOnline)aPlayers=[strPlayer[0]];else if("CM"==course)aPlayers=[];else{if(aPlayers=[],isCustomSel){for(var a=strPlayer.length-1;a>=oContainers.length;a--)aPlayers.push(strPlayer[a]);strPlayer.splice(oContainers.length)}else{a=0;for(joueurs in cp)pUnlocked[a]&&(aPlayers.push(joueurs),a++);if(aPlayers.sort(function(){return.5-Math.random()}),aPlayers.length<fInfos.nbPlayers){var n=aPlayers.length;aPlayers.length=aPlayers.length*Math.ceil(fInfos.nbPlayers/aPlayers.length);for(a=n;a<aPlayers.length;a++)aPlayers[a]=aPlayers[a%n]}else for(a=0;a<aPlayers.length;a++)for(var o=aPlayers[a],i=0;i<strPlayer.length;i++)strPlayer[i]==o&&(aPlayers.splice(a,1),a--,i=strPlayer.length);var r="GP"!=course?aPlayers.length-fInfos.nbPlayers+strPlayer.length:aPlayers.length-7;aPlayers.splice(0,r)}aPlaces=[],resetScores(),"GP"!=course&&(selectedPlayers=fInfos.nbPlayers,selectedTeams=fInfos.teams,xhr("updateCourseOptions.php",t,function(e){return 1==e}))}if(isOnline){var l={},s={minPlayers:1,maxPlayers:1,localScore:1,friendly:1};for(var c in shareLink.options)s[c]||(l[c]=shareLink.options[c]);(isCustomOptions(l)&&!shareLink.accepted&&shareLink.player!=identifiant?acceptRulesScreen:searchCourse)()}else isTeamPlay()?selectTeamScreen(0):selectTrackScreen()}else selectPlayerScreen(e.j,void 0,nbSels);var p=/^cp-\w+-(\d+)$/g.exec(e.alt);p&&xhr("selectPerso.php","id="+p[1],function(){return!0})}}else a.src="images/kart_locked.png";return u.appendChild(a),t.appendChild(u),t}for(var i=0;i<nBasePersos;i++){var oDiv=createPersoSelector(i);oDiv.style.left=Math.round((i%8*7.2+8)*iScreenScale)+"px",oDiv.style.top=(10+7*Math.floor(i/8))*iScreenScale+"px",oScr.appendChild(oDiv)}var pDiv=document.createElement("div");pDiv.style.backgroundColor="#78D0F8",pDiv.style.position="absolute",pDiv.style.width=5*iScreenScale+"px",pDiv.style.height=5*iScreenScale+"px",pDiv.style.left=67*iScreenScale+"px",pDiv.style.top=24*iScreenScale+"px",pDiv.style.borderTop="double 4px black",pDiv.style.borderLeft="double 4px #F8F8F8",pDiv.style.borderRight="double 4px #F8F8F8",pDiv.style.borderBottom="solid 5px #00B800",pDiv.style.overflow="hidden";var pPImg=new Image,aDeconnexion,eClassement,oPInput,oPInput,oClassement;if(pPImg.style.height=5*iScreenScale+"px",pPImg.style.position="absolute",pPImg.src="images/kart_persos.png",pPImg.style.cursor="pointer",pPImg.title=language?"Character editor":"Éditeur de personnages",pPImg.className="pixelated",pPImg.onclick=function(){window.open("choosePerso.php","chose","scrollbars=1, resizable=1, width=500, height=500")},pDiv.appendChild(pPImg),oScr.appendChild(pDiv),oContainers[0].appendChild(oScr),isOnline&&(aDeconnexion=document.createElement("a"),aDeconnexion.style.color="white",aDeconnexion.style.fontSize=2*iScreenScale+"px",aDeconnexion.style.position="absolute",aDeconnexion.style.left=24*iScreenScale+"px",aDeconnexion.style.top=34*iScreenScale+"px",aDeconnexion.innerHTML=toLanguage("Deconnection","Déconnexion"),aDeconnexion.href="#null",aDeconnexion.onclick=function(){return oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.removeChild(cTable),displayCommands(),mPseudo="",mCode="",connexion(),xhr("deco.php",null,function(){return!0}),!1},oScr.appendChild(aDeconnexion),eClassement=document.createElement("a"),eClassement.style.fontSize=2*iScreenScale+"px",eClassement.style.position="absolute",eClassement.style.left=41*iScreenScale+"px",eClassement.style.top=34*iScreenScale+"px",eClassement.innerHTML=toLanguage("Ranking","Classement"),shareLink.options&&shareLink.options.localScore?(eClassement.title=toLanguage("Private game ranking","Classement partie privée"),eClassement.style.color="#CF8",eClassement.setAttribute("href","localscores.php"+window.location.search)):(eClassement.style.color="white",eClassement.setAttribute("href","bestscores.php"+("BB"==course?"?battle":""))),oScr.appendChild(eClassement),shareLink.key?shareLink.player==identifiant&&(oPInput=document.createElement("input"),oPInput.type="button",oPInput.value=toLanguage("Private game options...","Options partie privée..."),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=56*iScreenScale+"px",oPInput.style.top=34*iScreenScale+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),privateGameOptions(shareLink.options,function(t){t&&(isCustomOptions(t)||isCustomOptions(shareLink.options))?xhr("privateGameOptions.php","key="+shareLink.key+"&options="+encodeURIComponent(JSON.stringify(t)),function(e){return 1==e&&(shareLink.options||(shareLink.options={}),shareLink.options.team=t.team,shareLink.options.manualTeams=t.manualTeams,shareLink.options.localScore=t.localScore,shareLink.options.friendly=t.friendly,shareLink.options.minPlayers=t.minPlayers,shareLink.options.maxPlayers=t.maxPlayers,selectedTeams=t.team,selectPlayerScreen(0),!0)}):selectPlayerScreen(0)})},oScr.appendChild(oPInput)):(oPInput=document.createElement("input"),oPInput.type="button",oPInput.value=toLanguage("Private game...","Partie privée..."),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=62*iScreenScale+"px",oPInput.style.top=34*iScreenScale+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),privateGame()},oScr.appendChild(oPInput))),isOnline||"VS"!=course&&"BB"!=course){"CM"==course&&isSingle&&(oClassement=document.createElement("input"),oClassement.type="button",oClassement.value=toLanguage("Rankings","Classement"),oClassement.style.position="absolute",oClassement.style.fontSize=3*iScreenScale+"px",oClassement.style.position="absolute",oClassement.style.left=30*iScreenScale-10+"px",oClassement.style.top=32*iScreenScale+"px",oClassement.style.width=20*iScreenScale+"px",oClassement.onclick=openRankings,oScr.appendChild(oClassement))}else{var oForm=document.createElement("form");if(oForm.onsubmit=function(){return!1},oForm.style.position="absolute",oForm.style.top=32*iScreenScale-5+"px",oForm.style.left=18*iScreenScale+"px",oForm.style.fontSize=2*iScreenScale+"px",oForm.style.zIndex=2,IdJ||newP||(iDificulty=selectedDifficulty,fInfos.nbPlayers=selectedPlayers,fInfos.teams=selectedTeams),"VS"==course){oForm.appendChild(document.createTextNode(toLanguage("Difficulty: ","Difficulté : ")));var iDifficulties=[toLanguage("Easy","Facile"),toLanguage("Medium","Moyen"),toLanguage("Difficult","Difficile")],oSelect=document.createElement("select");oSelect.name="difficulty",oSelect.style.width="auto",oSelect.style.fontSize=2*iScreenScale+"px",oSelect.style.marginRight="10px",oSelect.onchange=function(){selectedDifficulty=this.selectedIndex};for(var i=0;i<iDifficulties.length;i++){var oOption=document.createElement("option");oOption.value=i,oOption.innerHTML=iDifficulties[i],selectedDifficulty==i&&(oOption.selected="selected"),oSelect.appendChild(oOption)}oForm.appendChild(oSelect)}else iDificulty=4.5;if("VS"==course||"BB"==course){oForm.appendChild(document.createTextNode(toLanguage("Teams: ","Équipes : ")));var oSelect=document.createElement("select");oSelect.name="difficulty",oSelect.style.width=15*iScreenScale+15+"px",oSelect.style.fontSize=2*iScreenScale+"px",oSelect.onchange=function(){fInfos.teams=this.selectedIndex};for(var iTeams=[toLanguage("No teams","Chacun pour soi"),toLanguage("Team Game","Match par équipes")],i=0;i<iTeams.length;i++){var oOption=document.createElement("option");oOption.value=i,oOption.innerHTML=iTeams[i],selectedTeams==i&&(oOption.selected="selected"),oSelect.appendChild(oOption)}oForm.appendChild(oSelect)}oForm.appendChild(document.createElement("br")),oForm.appendChild(document.createTextNode(toLanguage("Number of participants","Nombre de participants ")+": "));var oSelect=document.createElement("select");function setCustomValue(e,t){for(var a=e.getElementsByTagName("option"),n=0;n<a.length;n++){var o=+a[n].value;if(o==t){e.selectedIndex=n;break}if(-1==o||t<o){var i=document.createElement("option");i.value=t,i.innerHTML=t,e.insertBefore(i,a[n]),e.selectedIndex=n;break}}e.value=t}oSelect.name="nbj",oSelect.style.width=3*iScreenScale+20+"px",oSelect.style.fontSize=2*iScreenScale+"px";for(var i=2;i<=8;i++){var oOption=document.createElement("option");oOption.value=i,oOption.innerHTML=i,oSelect.appendChild(oOption)}var oOption=document.createElement("option");oOption.value=-1,oOption.innerHTML=toLanguage("More...","Plus..."),oSelect.appendChild(oOption),setCustomValue(oSelect,fInfos.nbPlayers),oSelect.onchange=function(){var e;-1==this.value&&(e=parseInt(prompt(toLanguage("Enter number","Nombre de joueurs :"))),!isNaN(e)&&1<e?setCustomValue(this,Math.min(e,999)):(isNaN(e)||alert(toLanguage("Invalid value","Valeur invalide")),setCustomValue(this,fInfos.nbPlayers))),fInfos.nbPlayers=parseInt(this.value)},oForm.appendChild(oSelect);var oChoosePerso=document.createElement("a"),oStepCtn,oStepBack,oStepValue;oChoosePerso.innerHTML=toLanguage("Choose characters...","Choix des persos..."),oChoosePerso.href="#null",oChoosePerso.style.display="inline-block",oChoosePerso.style.marginLeft=2*iScreenScale+"px",oChoosePerso.style.color="white",oChoosePerso.onclick=function(){return selectedDifficulty=iDificulty,selectedPlayers=fInfos.nbPlayers,selectedTeams=fInfos.teams,clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),selectPlayerScreen(IdJ,!1,fInfos.nbPlayers),!1},oForm.appendChild(oChoosePerso),oScr.appendChild(oForm),isCustomSel&&(oForm.style.display="none",oStepCtn=document.createElement("div"),oStepCtn.style.position="absolute",oStepCtn.style.left="0px",oStepCtn.style.width=iWidth*iScreenScale+"px",oStepCtn.style.textAlign="center",oStepCtn.style.top=32*iScreenScale+"px",oStepBack=document.createElement("input"),oStepBack.type="button",oStepBack.style.fontSize=3*iScreenScale+"px",IdJ?(oStepBack.value="◄",oStepBack.style.marginRight=3*iScreenScale+"px"):(oStepBack.style.width="0px",oStepBack.value=" ",oStepBack.style.visibility="hidden"),oStepBack.onclick=function(){clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),strPlayer.pop(),selectPlayerScreen(IdJ-1,!1,fInfos.nbPlayers)},oStepCtn.appendChild(oStepBack),oStepValue=document.createElement("span"),oStepValue.style.fontSize=3*iScreenScale+"px",oStepValue.innerHTML=toLanguage("Character","Perso")+" "+(IdJ+1)+"/"+nbSels,oStepCtn.appendChild(oStepValue),oStepBack.style.color=oStepValue.style.color="#F90",oScr.appendChild(oStepCtn))}var oPInput=document.createElement("input");if(oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=35*iScreenScale+"px",isOnline&&(oPInput.style.top=34*iScreenScale+"px"),oPInput.onclick=function(){if(oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.removeChild(cTable),isCustomSel)selectPlayerScreen(0);else if(displayCommands(),isOnline)quitter();else if("VS"==course||"BB"==course){for(var e=1;e<oContainers.length;e++)oContainers.splice(e,1);selectNbJoueurs(!0)}else selectTypeScreen()},isCustomSel&&(oPInput.style.color="#F90"),oScr.appendChild(oPInput),clSelected&&clSelected.autoset&&clSelected.autoset.selectedPerso&&!force){var persoSelector=document.getElementById("perso-selector-"+clSelected.autoset.selectedPerso);if(persoSelector&&persoSelector.parentNode&&persoSelector.parentNode.onclick)return void persoSelector.parentNode.onclick()}function addMyPersos(e){var t=cp;for(var a in cp={},baseCp)cp[a]=baseCp[a];customPersos={};for(var n=0;n<e.length;n++){var o=e[n];cp[o.sprites]=[o.acceleration,o.speed,o.handling,o.mass],customPersos[o.sprites]=o}for(a in aPlayers=[],cp)aPlayers.push(a);for(var a in t)cp[a]||(cp[a]=t[a]);for(n=0;n<e.length;n++){var i=nBasePersos+n;pUnlocked[i]=1;var r=createPersoSelector(i);if(newP&&!n&&r.firstChild.onclick)return void r.firstChild.onclick();r.style.left=67*iScreenScale+"px",r.style.top=(10+7*n)*iScreenScale+"px",oScr.insertBefore(r,pDiv)}oScr.style.visibility="visible"}newP&&(myPersosCache=void 0),myPersosCache?addMyPersos(myPersosCache):xhr("myPersos.php",null,function(res){var newPersos=[];try{newPersos=eval(res)}catch(e){}return newPersos.length?(addMyPersos(newPersos),myPersosCache=newPersos):oScr.style.visibility="visible",!0}),selectPerso=function(e){clearTimeout(rotateHandler),oScr.innerHTML="",oContainers[0].removeChild(oScr),xhr("selectPerso.php","id="+e,function(e){return selectPlayerScreen(IdJ,!0,nbSels),!0})},updateMenuMusic(isOnline?0:1)}String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t});var defaultGameOptions={team:!1,manualTeams:!1,localScore:!1,friendly:!1,minPlayers:2,maxPlayers:12},startMusicHandler,driftButton,$commandes,$commandes;function isCustomOptions(e){if(e)for(var t in defaultGameOptions)if(void 0!==e[t]&&e[t]!=defaultGameOptions[t])return 1}function hasChallenges(){for(var e in challenges)for(var t in challenges[e])return!0}function isTeamPlay(){switch(course){case"BB":case"VS":return selectedTeams}return 0}function selectTeamScreen(a){a||(aTeams.length=0);var n=document.createElement("div"),e=n.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black";var t=toLanguage("Select team","Sélectionner équipe");1<strPlayer.length&&(t+=" ("+toLanguage("P","J")+(a+1)+")");var o=toTitle(t,.5);1<strPlayer.length&&(o.style.fontSize=Math.round(7*iScreenScale)+"px"),n.appendChild(o);var r=document.createElement("input");for(r.type="button",r.value=toLanguage("Back","Retour"),r.style.fontSize=2*iScreenScale+"px",r.style.position="absolute",r.style.left=2*iScreenScale+"px",r.style.top=35*iScreenScale+"px",r.onclick=function(){n.innerHTML="",oContainers[0].removeChild(n),selectPlayerScreen(-1)},n.appendChild(r),i=0;i<2;i++){(r=document.createElement("input")).type="button",r.value=i?toLanguage("Red team","Équipe rouge"):toLanguage("Blue team","Équipe bleue"),r.i=i,r.style.fontSize=4*iScreenScale+"px",r.style.position="absolute",r.style.left=25*iScreenScale+"px",r.style.top=(16+9*i)*iScreenScale+"px",r.style.width=30*iScreenScale+"px",r.onclick=function(){n.innerHTML="",oContainers[0].removeChild(n);var e=+this.i;if(aTeams.push(e),aTeams.length>=strPlayer.length){for(var t=0;t<strPlayer.length;t++)aTeams.push(1-aTeams[t]);for(t=strPlayer.length;t<aPlayers.length;t++)aTeams.push((t+e+aPlayers.length)%2);selectTrackScreen()}else selectTeamScreen(a+1)},n.appendChild(r)}oContainers[0].appendChild(n),updateMenuMusic(1)}function selectTrackScreen(){"BB"!=course||"MK"==page?selectMapScreen():selectRaceScreen(0)}function selectGamersScreen(){!isOnline&&isTeamPlay()?selectTeamScreen(0):selectPlayerScreen(-1)}function acceptRulesScreen(){var e,t=document.createElement("div"),a=t.style;a.width=iWidth*iScreenScale+"px",a.height=iHeight*iScreenScale+"px",a.border="solid 1px black",a.backgroundColor="black",(e=shareLink.options.public?toTitle(toLanguage("Game rules","Règles parties"),0):toTitle(toLanguage("Private game rules","Règles partie privée"),0)).style.fontSize=7*iScreenScale+"px",t.appendChild(e);var n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top=9*iScreenScale+"px",n.style.width=iWidth*iScreenScale+"px";var o=document.createElement("div");o.style.maxHeight=24*iScreenScale+"px",o.style.overflow="auto";var i=document.createElement("div");i.style.textAlign="center",i.style.color="#F90",i.style.fontSize=2*iScreenScale+"px",i.style.lineHeight=3*iScreenScale+"px",shareLink.options.public?i.innerHTML="⚠ "+toLanguage("Games from this mode have special rules","Les parties de ce mode utilisent des règles spécifiques"):i.innerHTML="⚠ "+toLanguage("Games from this private link have special rules","Les parties de ce lien privé utilisent des règles spécifiques"),o.appendChild(i);var r,l,s,c,p=document.createElement("table");p.style.marginLeft="auto",p.style.marginRight="auto",shareLink.options.team&&(r=document.createElement("tr"),l=document.createElement("td"),(s=document.createElement("label")).setAttribute("for","option-teams"),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.style.marginTop="0px",c.style.marginBottom="0px",c.innerHTML=toLanguage("Team games","Parties par équipe"),s.appendChild(c),(i=document.createElement("div")).style.fontSize=2*iScreenScale+"px",i.style.color="white",i.innerHTML=toLanguage("2 teams are selected in each game. You object: defeat the opposing team.","2 équipes sont sélectionnées à chaque partie. Votre objectif : vaincre l'équipe adverse."),s.appendChild(i),l.appendChild(s),r.appendChild(l),p.appendChild(r)),shareLink.options.manualTeams&&(r=document.createElement("tr"),l=document.createElement("td"),(s=document.createElement("label")).setAttribute("for","option-friendly"),l.appendChild(s),(c=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",c.innerHTML=toLanguage("Manual selection","Sélection manuelle"),c.style.marginBottom="0px",s.appendChild(c),(i=document.createElement("div")).style.fontSize=2*iScreenScale+"px",i.style.color="white",i.innerHTML=toLanguage("Teams are selected manually by one of the players.","Les équipes sont sélectionnées manuellement par l'un des joueurs."),s.appendChild(i),l.appendChild(s),r.appendChild(l),p.appendChild(r)),o.appendChild(p),n.appendChild(o),(i=document.createElement("div")).style.textAlign="center",i.style.marginTop=2*iScreenScale+"px";var u=document.createElement("input");u.type="button",u.value=toLanguage("Accept and play","Accepter et jouer"),u.style.fontSize=3*iScreenScale+"px",u.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),shareLink.accepted=!0,searchCourse()},i.appendChild(u),n.appendChild(i),t.appendChild(n);var d=document.createElement("input");d.type="button",d.value=toLanguage("Back","Retour"),d.style.fontSize=2*iScreenScale+"px",d.style.position="absolute",d.style.left=2*iScreenScale+"px",d.style.top=35*iScreenScale+"px",d.onclick=function(){t.innerHTML="",oContainers[0].removeChild(t),selectPlayerScreen(0)},t.appendChild(d),oContainers[0].appendChild(t)}function selectChallengesScreen(){var n=document.createElement("div"),e=n.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black";var t=toTitle(toLanguage("Challenges","Défis"),0);t.style.fontSize=7*iScreenScale+"px",n.appendChild(t);var a=document.createElement("div");a.style.position="absolute",a.style.left="0px",a.style.top=9*iScreenScale+"px",a.style.width=iWidth*iScreenScale+"px";var o,i=document.createElement("div");i.style.maxHeight=24*iScreenScale+"px",i.style.overflowX="hidden",i.style.overflowY="auto";var r,l=hasChallenges();if(l){document.getElementById("comment-connect")&&((r=document.createElement("div")).style.width=(iWidth-5)*iScreenScale+"px",r.style.marginLeft="auto",r.style.marginRight="auto",r.style.marginBottom=Math.round(1.5*iScreenScale)+"px",r.style.textAlign="center",r.innerHTML=language?'You are not connected. The challenges you complete will not be saved. <a href="forum.php" target="_blank" style="color:white">Click here</a> to log in or register.':'Vous n\'êtes pas connecté. Les défis réussis ne seront pas sauvegardés. <a href="forum.php" target="_blank" style="color:white">Cliquez ici</a> pour vous connecter ou vous inscrire.',r.style.fontSize=Math.round(1.8*iScreenScale)+"px",i.appendChild(r));var s=document.createElement("table");for(var c in s.style.width=(iWidth-3)*iScreenScale+"px",s.style.marginLeft="auto",s.style.marginRight="auto",s.style.borderCollapse="collapse",challenges)for(var p in challenges[c]){var u=challenges[c][p];if(u.main)o=u.id;else{(y=document.createElement("tr")).style.border="solid 1px white",(b=document.createElement("td")).setAttribute("colspan",2);var d=document.createElement("h1"),h="";switch(c){case"mcup":h=toLanguage("Multicup","Multicoupe");break;case"cup":h=toLanguage("Cup","Coupe");break;case"track":h=toLanguage("Track","Circuit")}d.innerHTML=h+' <span style="color:#FDB">'+u.name+"</span>",d.style.textAlign="center",d.style.margin="0px",d.style.fontSize=Math.round(4*iScreenScale)+"px",d.style.paddingTop=Math.round(.5*iScreenScale)+"px",d.style.paddingBottom=Math.round(.5*iScreenScale)+"px",d.style.backgroundColor="#fa7c1b",d.style.color="white",b.appendChild(d),y.appendChild(b),s.appendChild(y)}for(var m=u.list,g=0;g<m.length;g++){var y,f=m[g],S="active"==f.status&&f.succeeded,v=S?"#9E9":"white";(y=document.createElement("tr")).style.border="solid 1px "+v,S&&(y.style.backgroundColor="#031"),(b=document.createElement("td")).style.padding=iScreenScale+" "+iScreenScale+"px",f.name&&((d=document.createElement("h1")).style.fontSize=3*iScreenScale+"px",d.style.marginTop="0px",d.style.marginBottom="0px",d.innerText=f.name,b.appendChild(d));var b,M,C=document.createElement("div");if(f.name||f.description.extra?C.style.fontSize=2*iScreenScale+"px":C.style.fontSize=Math.round(2.5*iScreenScale)+"px",C.style.color=v,C.style.fontWeight="bold",C.innerHTML=f.description.main,b.appendChild(C),f.description.extra&&((C=document.createElement("div")).style.fontSize=Math.round(1.6*iScreenScale)+"px",C.style.color=v,C.innerHTML=f.description.extra,b.appendChild(C)),"active"!=f.status){switch((C=document.createElement("div")).style.fontSize=Math.round(1.6*iScreenScale)+"px",C.style.color="#FC0",f.status){case"pending_completion":C.innerHTML=toLanguage("This challenge is pending completion. Succeed it to publish it.","Ce défi est en attente de réussite. Réussissez-le pour le publier.");break;case"pending_publication":C.innerHTML=toLanguage("This challenge is pending publication. Click on &quot;Manage challenges&quot; to publish it.","Ce défi est en attente de publication. Cliquez sur &quot;Gérer les défis&quot; pour le publier.");break;case"pending_moderation":C.innerHTML=toLanguage("This challenge is pending moderation. It will be published once a validator validates it.","Ce défi est en attente de modération. Il sera publié dès qu'un modérateur l'aura validé.")}C.style.fontWeight="bold",b.appendChild(C)}y.appendChild(b),(b=document.createElement("td")).style.padding=iScreenScale+" "+iScreenScale+"px",b.style.width=12*iScreenScale+"px",b.style.textAlign="center",f.succeeded&&((M=document.createElement("div")).innerHTML='<span style="color:#CFC;display:inline-block;margin-right:2px">✔</span>'+toLanguage("Completed","Réussi"),M.style.whiteSpace="nowrap",M.style.fontSize=Math.round(iScreenScale*(language?2:2.2))+"px",M.style.backgroundColor="#33A033",M.style.display="inline-block",M.style.padding="0px "+Math.round(.8*iScreenScale)+"px",M.style.borderRadius=Math.round(.6*iScreenScale)+"px",M.style.color="white",M.style.marginBottom=Math.round(.5*iScreenScale)+"px",M.style.marginTop=Math.round(.5*iScreenScale)+"px",b.appendChild(M));var x,P=document.createElement("div"),k=document.createElement("img");if(k.src="images/challenges/difficulty"+f.difficulty.level+".png",k.alt="D",k.style.width=2*iScreenScale+"px",P.appendChild(k),(w=document.createElement("span")).style.color=f.difficulty.color,w.style.fontSize=Math.round(1.7*iScreenScale)+"px",w.style.position="relative",w.style.top="-1px",w.innerHTML=" "+f.difficulty.name,P.appendChild(w),b.appendChild(P),f.winners.length){(P=document.createElement("div")).style.cursor="help";var w,T=document.createElement("img");f.succeeded||(P.style.marginBottom=Math.round(.5*iScreenScale)+"px"),T.src="images/cups/cup1.png",T.alt="W",T.style.width=2*iScreenScale+"px",P.appendChild(T),(w=document.createElement("span")).style.color="white",w.style.fontSize=Math.round(1.7*iScreenScale)+"px",w.style.position="relative",w.style.top="-2px",w.innerHTML=" "+f.winners.length;for(var I='<small style="color:#CFC">'+toLanguage("Succeeded by:","Réussi par :")+"</small>",E=0;E<f.winners.length;E++)I+='<br /><span style="color:#CFC;display:inline-block;margin-right:2px">✔</span>'+f.winners[E].nick;P.dataset||(P.dataset={}),P.dataset.title=I,P.appendChild(w),P.onmouseover=function(e){var t;O||((O=document.createElement("div")).className="ranking_activeplayertitle",O.innerHTML=this.dataset.title,O.style.position="fixed",O.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",O.style.borderRadius=iScreenScale+"px",O.style.zIndex=10,O.style.backgroundColor="rgba(51,160,51, 0.95)",O.style.color="white",O.style.fontSize=Math.round(1.8*iScreenScale)+"px",O.style.lineHeight=Math.round(2*iScreenScale)+"px",O.style.visibility="hidden",$mkScreen.appendChild(O),t=this.getBoundingClientRect(),O.style.left=Math.round(t.left+(this.scrollWidth-O.scrollWidth)/2)+"px",O.style.top=t.top+this.scrollHeight+5+"px",O.style.visibility="visible")},P.onmouseout=function(e){O&&($mkScreen.removeChild(O),O=void 0)},b.appendChild(P)}f.succeeded||((x=document.createElement("input")).type="button",x.value=toLanguage("Take up","Relever"),x.style.width=11*iScreenScale+"px",x.style.fontSize=Math.round(2.4*iScreenScale)+"px",function(e,t,a){x.onclick=function(){n.innerHTML="",oContainers[0].removeChild(n),(clSelected=e).trackId=t,clSelected.trackType=a,xhr("challengeTry.php","challenge="+e.id,function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(e){return!1}for(var t in clSelected.autoset=e,course="",e)window[t]=e[t];return course?selectPlayerScreen(0):selectMainPage(),delete window.selectedPerso,showClSelectedPopup(),!0})}}(f,p,c),b.appendChild(x)),y.appendChild(b),s.appendChild(y)}}i.appendChild(s)}else{i.style.textAlign="center",(C=document.createElement("div")).style.fontSize=3*iScreenScale+"px",C.style.marginTop=3*iScreenScale+"px",C.style.marginBottom=2*iScreenScale+"px",C.style.marginLeft="auto",C.style.marginRight="auto",C.style.width=60*iScreenScale,C.style.color="white",C.innerHTML=toLanguage("This circuit has no challenges. Create some right now, it's fast and easy!","Ce circuit ne comporte aucun défi. Créez-en dès maintenant, c'est facile et rapide !"),i.appendChild(C);var L=document.createElement("input");L.type="button",L.style.fontSize=3*iScreenScale+"px",L.style.paddingLeft=2*iScreenScale+"px",L.style.paddingRight=2*iScreenScale+"px",L.value=toLanguage("Go to challenge editor","Accéder à l'éditeur de défis"),L.onclick=function(){openChallengeEditor()},i.appendChild(L)}a.appendChild(i),n.appendChild(a);var B=document.createElement("input");if((B.type="button",B.value=toLanguage("Back","Retour"),B.style.fontSize=2*iScreenScale+"px",B.style.position="absolute",B.style.left=2*iScreenScale+"px",B.style.top=35*iScreenScale+"px",B.onclick=function(){n.innerHTML="",oContainers[0].removeChild(n),selectMainPage()},n.appendChild(B),l)&&(myCircuit&&((B=document.createElement("input")).type="button",B.value=toLanguage("Edit challenges...","Gérer les défis..."),B.style.fontSize=2*iScreenScale+"px",B.style.position="absolute",B.style.right=2*iScreenScale+"px",B.style.top=35*iScreenScale+"px",B.onclick=function(){openChallengeEditor()},n.appendChild(B)),clRewards.length)){var D=document.createElement("a");D.href="persoLocked.php?cl="+o,D.target="_blank",D.style.color="white",D.style.textDecoration="none",D.onclick=function(){return window.open(this.href,"persoLock","scrollbars=1, resizable=1, width=500, height=500"),!1};var z=document.createElement("img");z.src="images/challenges/unlocking.png",z.alt=toLanguage("Unlocking characters","Persos à débloquer"),z.style.height=2*iScreenScale+"px",z.style.marginRight=Math.round(.55*iScreenScale)+"px",z.style.position="relative",z.style.top=Math.round(.2*iScreenScale)+"px",D.appendChild(z);var H=0;if(myCircuit)D.innerHTML+=clRewards.length;else{for(g=0;g<clRewards.length;g++)clRewards[g].unlocked&&H++;D.innerHTML+=H+"/"+clRewards.length}D.style.fontSize=2*iScreenScale+"px",D.style.position="absolute",D.style.right=(myCircuit?22:2)*iScreenScale+"px",D.style.top=35*iScreenScale+"px",D.dataset||(D.dataset={});var O,R=clRewards.length-H,j=1<R?"s":"";R<=0?(D.dataset.title=toLanguage("All characters unlocked,<br />congratulations!","Tous les persos ont été<br />débloqués, félicitations !"),D.style.color="#0F8",D.style.fontWeight="bold"):D.dataset.title=H?toLanguage(R,"Plus que "+R)+" "+toLanguage("character"+j+" left to unlock","perso"+j+" à débloquer"):R+" "+toLanguage("character"+j+" to unlock","perso"+j+" à débloquer"),D.onmouseover=function(){var e;this.style.opacity=.7,O||((O=document.createElement("div")).className="ranking_activeplayertitle",O.style.textAlign="center",O.innerHTML=this.dataset.title,O.style.position="fixed",O.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",O.style.borderRadius=iScreenScale+"px",O.style.zIndex=10,O.style.backgroundColor="rgba(102,153,160, 0.95)",O.style.color="white",O.style.fontSize=Math.round(1.8*iScreenScale)+"px",O.style.lineHeight=Math.round(2*iScreenScale)+"px",O.style.visibility="hidden",$mkScreen.appendChild(O),e=this.getBoundingClientRect(),O.style.left=Math.round(e.left+(this.scrollWidth-O.scrollWidth)/2)+"px",O.style.top=e.top-O.scrollHeight-5+"px",O.style.visibility="visible")},D.onmouseout=function(){this.style.opacity="",O&&($mkScreen.removeChild(O),O=void 0)},n.appendChild(D)}oContainers[0].appendChild(n)}function searchCourse(){var i=document.createElement("div"),e=i.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black";var t=document.createElement("div");t.style.position="absolute",t.style.left="0px",t.style.top=4*iScreenScale+"px",t.style.width=iScreenScale*iWidth+"px",t.style.fontSize=4*iScreenScale+"",t.style.textAlign="center",t.innerHTML=toLanguage("Searching for other players<br />Please wait...","Recherche d'autres joueurs<br />Veuillez patienter..."),i.appendChild(t);var a=document.createElement("label");a.style.position="absolute",a.style.left="0px",a.style.top=15*iScreenScale-9+"px",a.style.width=iScreenScale*iWidth+"px",a.style.textAlign="center";var r=document.createElement("input");r.type="checkbox",r.id="iAlert",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="scale("+iScreenScale/6+") translateY(8%)",r.style.transformOrigin=r.style.WebkitTransformOrigin=r.style.MozTransformOrigin="bottom right",a.appendChild(r);var n=document.createElement("span");n.setAttribute("for","iAlert"),n.style.fontSize=2*iScreenScale+"pt",n.style.marginLeft="5px",n.innerHTML=toLanguage("Notify me when opponents have been found","M'alerter lorsque des adversaires ont été trouvés"),a.appendChild(n),i.appendChild(a);var o=0,l=document.createElement("div");l.style.position="absolute",l.style.left="0px",l.style.top=21*iScreenScale+"px",l.style.width=41*iScreenScale*2+"px",l.style.height=Math.round(8.5*iScreenScale)+"px",l.style.overflow="hidden";for(var s=0;s<41;s++){var c=document.createElement("img");c.src="images/cLoading.png",c.className="pixelated",c.style.width=2*iScreenScale+"px",c.style.position="absolute",c.style.left=s*iScreenScale*2+"px",c.style.top="0px",l.appendChild(c)}i.appendChild(l);var p=document.createElement("div");p.style.position="absolute",p.style.left="0px",p.style.top=Math.round(17.5*iScreenScale)+"px",p.style.width=iScreenScale*iWidth+"px",p.style.textAlign="center",p.style.fontSize=2*iScreenScale+"px",p.style.color="#0B0",p.style.display="none",p.style.backgroundColor="rgba(0,0,0, 0.7)",p.innerHTML=toLanguage('<span id="nb-active-players" style="color:#0E0"></span> currently online. You\'ll join them as soon as they finish their '+(isBattle?"battle":"race"),'<span id="nb-active-players" style="color:#0E0"></span> actuellement en ligne. Vous les rejoindrez une fois leur partie terminée'),i.appendChild(p);var u=document.createElement("div");u.style.position="absolute",u.style.left="0px",u.style.top=Math.round(17.5*iScreenScale)+"px",u.style.width=iScreenScale*iWidth+"px",u.style.textAlign="center",u.style.fontSize=2*iScreenScale+"px",u.style.color="#0B0",u.style.display="none",u.style.backgroundColor="rgba(0,0,0, 0.7)",u.innerHTML=toLanguage('<span id="nb-pending-players" style="color:#0E0"></span> currently waiting, <span id="nb-missing-players" style="color:#0E0"></span> left before the game begins...','<span id="nb-pending-players" style="color:#0E0"></span> actuellement en attente. Plus que <span id="nb-missing-players" style="color:#0E0"></span> pour que la partie commence'),i.appendChild(u);var d=1,h=iScreenScale/2,m="";function g(){d&&(--d||xhr("getCourse.php",m,function(e){if(!e)return!1;try{e=JSON.parse(e)}catch(e){return!1}var t,a,n,o;return e.found?(t=r.checked,i.innerHTML="",oContainers[0].removeChild(i),t&&((a=document.createElement("embed")).src="musics/mkalert.wav",a.setAttribute("loop",!1),a.setAttribute("autostart",!0),a.style.position="absolute",a.style.left="-1000px",a.style.top="-1000px",document.body.appendChild(a),n=(new Date).getTime(),alert(toLanguage("Opponents have been found !\nGood luck !","Des adversaires ont été trouvés !\nBonne chance !")),e.time-=Math.round(((new Date).getTime()-n)/1e3),document.body.removeChild(a)),e.time<1&&(e.time=1),document.getElementById("racecountdown").innerHTML=e.time-5,selectMapScreen(),dRest(),setTimeout(setChat,1e3)):(d=10,e.nb_players?(e.nb_players<2&&(e.nb_players=2),document.getElementById("nb-active-players").innerHTML=e.nb_players+" "+toLanguage("players","joueurs"),u.style.display="none",p.style.display="block"):e.pending_players?(document.getElementById("nb-pending-players").innerHTML=e.pending_players+" "+toLanguage("player","joueur")+(1<e.pending_players?"s":""),(o=e.min_players-e.pending_players)<1&&(o=1),document.getElementById("nb-missing-players").innerHTML=o+" "+toLanguage("player","joueur")+(1<o?"s":""),p.style.display="none",u.style.display="block"):(p.style.display="none",u.style.display="none")),!0})),--o<=-4&&(o=0),l.style.left=Math.round(o*h)+"px",setTimeout(g,100)}isCup?isMCups?m+="mid="+nid:isSingle?m+=(complete?"i":"id")+"="+nid+(isBattle?"&battle":""):m+=(complete?"c":"s")+"id="+nid:isBattle?m+="battle":noDS&&(m+="nods"),shareLink.key&&(m+=(m?"&":"")+"key="+shareLink.key),g(),shareLink.key||xhr("sendCourseNotifs.php",null,function(e){return!0});var y=document.createElement("input");y.type="button",y.value=toLanguage("Back","Retour"),y.style.fontSize=2*iScreenScale+"px",y.style.position="absolute",y.style.left=2*iScreenScale+"px",y.style.top=35*iScreenScale+"px",y.onclick=function(){g=function(){},i.innerHTML="",oContainers[0].removeChild(i),selectPlayerScreen(0)},i.appendChild(y),oContainers[0].appendChild(i),updateMenuMusic(0)}function chooseRandMap(){"MK"==page?"BB"!=course?choose(Math.ceil(Math.random()*NBCIRCUITS)):choose(NBCIRCUITS+Math.ceil(8*Math.random())):isSingle?choose(1):isBattle?choose(NBCIRCUITS+Math.ceil(8*Math.random()),!0):choose(Math.ceil(Math.random()*NBCIRCUITS),!0)}function selectMapScreen(e){if(isCup&&!isMCups||isBattle&&isCup)selectRaceScreen(0);else{if(clSelected&&!e)switch(clSelected.trackType){case"cup":if(-1!==(a=cupIDs.indexOf(clSelected.trackId)))return void selectRaceScreen(4*a);break;case"track":var t=aAvailableMaps.find(function(e){var t=oMaps[e];return("CI"===page?t.id:t.map)==clSelected.trackId});if(t){var a,n=oMaps[t];return void selectRaceScreen(4*(a=Math.floor((n.ref-1)/4)))}}var o=document.createElement("div"),i=o.style,r=!0;i.width=iWidth*iScreenScale+"px",i.height=iHeight*iScreenScale+"px",i.border="solid 1px black",i.backgroundColor="black","BB"!=course?o.appendChild(toTitle(toLanguage("Choose cup","Choisissez la coupe"),.5)):o.appendChild(toTitle(toLanguage("Choose stage","Choisissez une arène"),.5));var l=document.createElement("input");l.type="button",l.value=toLanguage("Back","Retour"),l.style.fontSize=2*iScreenScale+"px",l.style.position="absolute",l.style.left=2*iScreenScale+"px",l.style.top=isOnline?30*iScreenScale+"px":35*iScreenScale+"px",l.onclick=function(){pause&&!isOnline?(removeMenuMusic(!1),quitter()):(r=!1,o.innerHTML="",oContainers[0].removeChild(o),isOnline&&(document.getElementById("waitrace").style.visibility="hidden"),chatting=!1,selectGamersScreen())};var s=document.createElement("div");s.style.position="absolute",s.style.zIndex=10,s.style.top=Math.round(35.5*iScreenScale-6)+"px",s.style.left=25*iScreenScale-5+"px",s.style.width=25*iScreenScale+6+"px",s.style.height=Math.round(3.9*iScreenScale)+"px",s.style.border="solid 1px white",s.style.color="white",s.style.backgroundColor="black",s.style.borderBottom="none",s.style.textAlign="center",s.style.display="none",s.style.flexDirection="column",s.style.justifyContent="center";var c=document.createElement("div");c.style.maxHeight=Math.round(3.9*iScreenScale)+"px",c.style.overflow="hidden",s.appendChild(c),o.appendChild(s),o.appendChild(l),"GP"!=course&&oContainers[0].appendChild(o),document.getElementById("dMaps").style.top=40*iScreenScale+"px",document.getElementById("dMaps").style.left=7+25*iScreenScale+"px",document.getElementById("dMaps").style.width=25*iScreenScale+"px",document.getElementById("dMaps").style.height=10*iScreenScale+"px";var p=["champi","etoile","carapace","carapacebleue","speciale","carapacerouge","banane","feuille","megachampi","eclair","upchampi","fireflower","bobomb","minichampi","egg","iceflower","plume","cloudchampi"],u=NBCIRCUITS/4,d=6;"BB"==course&&(p=["snes","gba"],u=2);var h=Math.ceil(u/d);cupOpts.lines&&(h=cupOpts.lines.length);var m=d=Math.ceil(u/h);if(cupOpts.lines)for(var g=m=0;g<cupOpts.lines.length;g++)m=Math.max(m,cupOpts.lines[g]);var y=Math.min(Math.round(10.5/Math.pow(Math.max(u/5,h,.5),.6)),16/h,60/m),f=Math.min(4,20/m),S=4/h,v=38;"BB"==course&&(y=Math.round(1.5*y),f=Math.round(2*f),v-=3);for(var b,M,C,x=0,P=0,g=0;g<u;g++){cupOpts.lines?(C=cupOpts.lines[P],b=x,M=P,++x>=cupOpts.lines[P]&&(x=0,P++)):(C=Math.min(d,u-(g-g%d)),b=g%d,M=Math.floor(g/d));var k=document.createElement("img");k.className="pixelated",k.style.width=y*iScreenScale+"px",k.style.height=y*iScreenScale+"px",k.style.cursor="pointer",k.style.position="absolute";var w=(iWidth+f+1)/2+(b-C/2)*(y+f),T=(S+v)/2+(M-h/2)*(y+S);k.style.left=Math.round(w*iScreenScale)+"px",k.style.top=Math.round(T*iScreenScale)+"px",cupOpts.icons?"number"==typeof cupOpts.icons[g]?k.src="images/cups/"+p[cupOpts.icons[g]]+".gif":function(e,t){k.onload=function(){this.naturalWidth>this.naturalHeight?(this.style.width=y*iScreenScale+"px",this.style.top=Math.round((t+y*(1-this.naturalHeight/this.naturalWidth)/2)*iScreenScale)+"px",this.style.height="auto"):(this.style.width="auto",this.style.height=y*iScreenScale+"px",this.style.left=Math.round((e+y*(1-this.naturalWidth/this.naturalHeight)/2)*iScreenScale)+"px")},k.src=cupOpts.icons[g]}(w,T):k.src="images/cups/"+p[g]+".gif","BB"==course?k.alt=g+NBCIRCUITS/4:k.alt=g;var I,E,L,B,D,z,H=iScreenScale;k.onmouseover=function(){var e=new Image;e.src=getMapSelectorSrc(g),e.alt=4*this.alt+4,e.style.border="double 4px white",e.style.width="100%",e.style.height="100%",e.id="maps",document.getElementById("dMaps").appendChild(e);var t,a=mapNameOf(H,4*this.alt);a.id="oMapName",document.getElementById("dMaps").appendChild(a),document.getElementById("dMaps").style.display="block",function e(t){document.getElementById("maps")&&document.getElementById("maps").alt==t&&(t%4!=0?t++:t-=3,document.getElementById("oMapName").innerHTML=lCircuits[t-1],document.getElementById("maps").alt=t,document.getElementById("maps").src=getMapSelectorSrc(t-1),setTimeout(function(){e(t)},1e3))}(4*this.alt+4),cupNames[this.alt]&&(c.innerHTML=cupNames[this.alt],t=Math.min(Math.max(8/Math.sqrt(stripSpecialChars(cupNames[this.alt]).length),1.45),3),s.style.fontSize=Math.round(t*iScreenScale)+"px",s.style.display="flex")},k.onmouseout=function(){document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",s.style.display="none"},k.onclick=function(){document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",o.innerHTML="",oContainers[0].removeChild(o),selectRaceScreen(4*this.alt)},"BB"==course&&(I=[toLanguage("SNES Stages","Arènes SNES"),toLanguage("GBA Stages","Arènes GBA")],(E=document.createElement("div")).style.position="absolute",E.style.left=Math.round((w-f/2)*iScreenScale)+"px",E.style.top=Math.round((T+.9*y)*iScreenScale)+"px",E.style.width=(y+f)*iScreenScale+"px",E.style.fontSize=3*iScreenScale+"px",E.style.color="white",E.style.textAlign="center",E.innerHTML=I[g],o.appendChild(E)),o.appendChild(k),"GP"==course?(L=+ptsGP.charAt(g))&&((B=new Image).src="images/cups/cup"+(4-L)+".png",B.style.width=Math.round(4*iScreenScale*y/7)+"px",B.style.height=Math.round(4*iScreenScale*y/7)+"px",B.style.position="absolute",B.style.left=Math.round((w+4*y/7)*iScreenScale)+"px",B.style.top=Math.round((T+4*y/7)*iScreenScale)+"px",B.className="pixelated",o.appendChild(B)):isMCups&&!isOnline&&((D=document.createElement("a")).style.position="absolute",D.style.left=Math.round((w+5*y/7)*iScreenScale)+"px",D.style.top=Math.round((T+5*y/7)*iScreenScale)+"px",D.style.backgroundColor="rgba(0,50,128, 0.5)",D.style.padding="4px",D.style.borderRadius="50%",D.href="?cid="+cupIDs[g],D.title=toLanguage("Link to this cup","Lien vers cette coupe"),D.onmouseover=function(){this.style.backgroundColor="rgba(0,102,153, 0.8)"},D.onmouseout=function(){this.style.backgroundColor="rgba(0,50,128, 0.5)"},(z=document.createElement("img")).src="images/clink.png",z.style.width=Math.round(y*iScreenScale*2/7)+"px",D.appendChild(z),o.appendChild(D))}"VS"==course||"BB"==course?((l=document.createElement("input")).type="button",l.value=toLanguage("Random","Aléatoire"),l.style.fontSize=3*iScreenScale+"px",l.style.position="absolute",l.style.left=34*iScreenScale-10+"px",l.style.top=30*iScreenScale+"px",l.onclick=function(){r=!1,o.innerHTML="",oContainers[0].removeChild(o),chooseRandMap()},o.appendChild(l)):"GP"==course?oContainers[0].appendChild(o):"CM"==course&&((l=document.createElement("input")).type="button",l.value=toLanguage("Ranking","Classement"),l.style.fontSize=3*iScreenScale+"px",l.style.position="absolute",l.style.left=33*iScreenScale-10+"px",l.style.top=30*iScreenScale+"px",l.onclick=openRankings,o.appendChild(l)),isOnline&&setTimeout(function(){r&&(document.getElementById("dMaps").style.display="none",document.getElementById("dMaps").innerHTML="",o.innerHTML="",oContainers[0].removeChild(o),chooseRandMap())},1e3*document.getElementById("racecountdown").innerHTML)}isOnline&&(setSRest(),document.getElementById("waitrace").style.visibility="visible"),updateMenuMusic(1)}function setMapSrc(e,t,a,n){isCup?setTimeout(function(){e.src=n},100*(a-t)):e.src=n}function rankingsLink(e){switch(page){case"MK":return"classement.php?map="+e.map;case"CI":return"classement.php?circuit="+e.id;case"MA":return"classement.php?draw="+e.map}}function openRankings(){if(isMCups)open("classement.php?mcup="+nid);else switch(page){case"MK":open("classement.php");break;case"CI":open("classement.php"+(isSingle?"?circuit="+nid:"?scup="+nid));break;case"MA":open("classement.php"+(isSingle?"?draw="+nid:"?ccup="+nid))}}function exitCircuit(){var e=document.getElementById("changeRace"),t=document.getElementById("supprRace");e&&!t?e.click():document.location.href="index.php"}function appendContainers(){for(var e=1;e<oContainers.length;e++)$mkScreen.appendChild(oContainers[e])}function selectRaceScreen(cup){var cupNb;if(!isOnline&&(isSingle||"GP"==course))return"GP"==course&&(iDificulty="MK"!=page?5:(cupNb=Math.floor(cup/4)%5,cup<40?Math.min(4.5+cupNb/7,5):Math.min(4.6+cupNb/7,5))),cup++,strMap="map"+cup,appendContainers(),void resetGame(strMap);var oScr=document.createElement("div"),oStyle=oScr.style,forceClic4=!0;oStyle.width=iWidth*iScreenScale+"px",oStyle.height=iHeight*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black",oContainers[0].appendChild(oScr),"BB"!=course?oScr.appendChild(toTitle(toLanguage("Choose track","Choisissez un circuit"),isSingle?2.5:.5)):oScr.appendChild(toTitle(toLanguage("Choose stage","Choisissez une arène"),isSingle?2.5:.5));var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=isOnline?30*iScreenScale+"px":35*iScreenScale+"px",oPInput.onclick=function(){forceClic4=!1,oScr.innerHTML="",oContainers[0].removeChild(oScr),isOnline&&isCup&&!isMCups?(document.getElementById("waitrace").style.visibility="hidden",chatting=!1,selectPlayerScreen(0)):"BB"!=course?isCup&&!isMCups?pause?(removeMenuMusic(!1),quitter()):selectGamersScreen():selectMapScreen(!0):isCup?pause?(removeMenuMusic(!1),quitter()):selectGamersScreen():selectMapScreen(!0)},oScr.appendChild(oPInput);for(var mScreenScale=iScreenScale,trackSelected=clSelected&&"track"===clSelected.trackType?clSelected.trackId:null,divSelected,lCup=isSingle?cup+1:cup+4,i=cup,oPInput;i<lCup;i++){var mDiv=document.createElement("div");mDiv.style.width=25*iScreenScale+"px",mDiv.style.height=10*iScreenScale+"px",mDiv.style.cursor="pointer",mDiv.style.position="absolute";var j=i-cup;isSingle?(mDiv.style.left=27*iScreenScale+"px",mDiv.style.top=15*iScreenScale+"px"):(mDiv.style.left=((iWidth-113)/2+25*(j-2*Math.floor(j/2))+(j-2*Math.floor(j/2)))*iScreenScale+30*iScreenScale+"px",mDiv.style.top=10*iScreenScale+11*iScreenScale*Math.floor(j/2)+"px"),mDiv.map=aAvailableMaps[i],mDiv.ref=i+1;var oPImg=new Image,mLink,iMap,iLink;setMapSrc(oPImg,cup,i,getMapSelectorSrc(i)),oPImg.style.width="100%",oPImg.style.height="100%",oPImg.style.border="double 4px silver",oPImg.className="pixelated",mDiv.appendChild(oPImg),mDiv.appendChild(mapNameOf(mScreenScale,i)),isCup&&!isOnline&&(mLink=document.createElement("a"),mLink.style.position="absolute",mLink.style.right="-3px",mLink.style.top="5px",mLink.style.backgroundColor="rgba(0,50,128, 0.5)",mLink.style.padding="4px",mLink.style.borderRadius="50%",iMap=oMaps[aAvailableMaps[i]],mLink.href="MA"==page?"?i="+iMap.map:"?id="+iMap.id,mLink.title=toLanguage("Link to this circuit","Lien vers ce circuit"),mLink.onclick=function(e){e.stopPropagation()},mLink.onmouseover=function(){this.style.backgroundColor="rgba(0,102,153, 0.8)"},mLink.onmouseout=function(){this.style.backgroundColor="rgba(0,50,128, 0.5)"},iLink=document.createElement("img"),iLink.src="images/clink.png",iLink.style.width=2*iScreenScale+"px",mLink.appendChild(iLink),mDiv.appendChild(mLink)),mDiv.onclick=function(){var tMap,iMap;forceClic4=!1,oScr.innerHTML="",oContainers[0].removeChild(oScr),isOnline?choose(this.ref):"CM"!=course?(appendContainers(),resetGame(this.map)):"MK"!=page?(gPersos.length=0,resetGame(this.map)):(document.body.style.cursor="progress",tMap=this.map,iMap=tMap.replace(/^[a-zA-Z]+([0-9]+)$/,"$1"),xhr("ghostsave.php","map="+iMap,function(reponse){var ghostSaves;try{ghostSaves=eval(reponse)}catch(e){return!1}return selectFantomeScreen(ghostSaves||void 0,iMap-1),!0}))};var oMap=oMaps[mDiv.map],mId="CI"===page?oMap.id:oMap.map;mId==trackSelected&&(divSelected=mDiv),oScr.appendChild(mDiv)}!isCup||isSingle||isMCups||(oPInput=document.createElement("input"),oPInput.type="button","CM"!=course?oPInput.value=toLanguage("Random","Aléatoire"):oPInput.value=toLanguage("Rankings","Classement"),oPInput.style.position="absolute",isOnline?(oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.left=67*iScreenScale+"px",oPInput.style.top=30*iScreenScale+"px"):(oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.left=34*iScreenScale-10+"px",oPInput.style.top=34*iScreenScale+"px"),oPInput.onclick=function(){"CM"!=course?(forceClic4=!1,oScr.innerHTML="",oContainers[0].removeChild(oScr),chooseRandMap()):openRankings()},oScr.appendChild(oPInput)),isOnline&&(setSRest(),setTimeout(function(){forceClic4&&(oScr.innerHTML="",oContainers[0].removeChild(oScr),chooseRandMap())},1e3*document.getElementById("racecountdown").innerHTML)),divSelected?divSelected.click():updateMenuMusic(1)}function choose(map,rand){if(!isOnline)return appendContainers(),void resetGame("map"+map);var choixJoueurs=[],oTable=document.createElement("table");oTable.border=1,oTable.setAttribute("cellspacing",2),oTable.setAttribute("cellpadding",2),oTable.style.position="absolute",oTable.style.fontSize=2*iScreenScale+"pt",oTable.style.textAlign="center",oTable.style.left=25*iScreenScale+"px",oTable.style.top=2*iScreenScale+"px",oTable.style.width=30*iScreenScale+"px";var oTBody=document.createElement("tbody");function refreshTab(reponse){if(reponse){if(-1!=reponse){var rCode;try{rCode=eval(reponse)}catch(e){return!1}choixJoueurs=rCode[0];for(var trs=oTBody.getElementsByTagName("tr");trs.length;)oTBody.removeChild(trs[0]);for(i=0;i<choixJoueurs.length;i++){var oTr=document.createElement("tr"),oTd=document.createElement("td"),isChoix=choixJoueurs[i][2],isRandom=choixJoueurs[i][3];oTd.innerHTML=isChoix?isRandom?"???":lCircuits[isChoix-1]:toLanguage("Not chosen","Non choisi"),oTr.appendChild(oTd),oTBody.appendChild(oTr)}if(-1==rCode[1])setTimeout(waitForChoice,1e3);else if(choixJoueurs.length>=rCode[4].minPlayers){for(aPlayers=new Array,aIDs=new Array,aPlaces=new Array,aPseudos=new Array,aTeams=new Array,i=0;i<choixJoueurs.length;i++){var aID=choixJoueurs[i][0];aID!=identifiant?(aIDs.push(aID),aPlayers.push(choixJoueurs[i][1]),isCustomPerso(choixJoueurs[i][1]),aPlaces.push(choixJoueurs[i][4]),aPseudos.push(choixJoueurs[i][5]),aTeams.push(choixJoueurs[i][6])):(aPlaces.unshift(choixJoueurs[i][4]),aPseudos.unshift(choixJoueurs[i][5]),aTeams.unshift(choixJoueurs[i][6]))}selectedTeams=-1==aTeams.indexOf(-1),selectedTeams||(aTeams.length=0),tnCourse=(new Date).getTime()+rCode[2],isSingle?rCode[2]=0:rCode[4].manualTeams?playerIsSelecter()?rCode[2]=0:rCode[2]-=12e3:tnCourse+=5e3,connecte=rCode[3]+1;var cCursor=0,cTime=50;function moveCursor(){var e=!0;if(cCursor==rCode[1]){for(var t=0,a=cTime,n=0;n<choixJoueurs.length;n++)t+=a=Math.round(1.05*a);t>=rCode[2]&&(e=!1)}e?(trs[cCursor].style.backgroundColor="",trs[cCursor].style.color="",++cCursor==choixJoueurs.length&&(cCursor=0),trs[cCursor].style.backgroundColor="#F80",trs[cCursor].style.color="white",cTime=Math.round(1.05*cTime),rCode[2]-=cTime,setTimeout(moveCursor,cTime)):clignote(0)}function clignote(e){trs[cCursor].style.backgroundColor=e%2?"":"#F80",trs[cCursor].style.color=e%2?"":"white",e<4?setTimeout(function(){clignote(e+1)},100):setTimeout(function(){$mkScreen.removeChild(oTable),proceedOnlineRaceSelection(rCode)},500),1==e&&(trs[cCursor].getElementsByTagName("td")[0].innerHTML=lCircuits[choixJoueurs[cCursor][2]-1])}moveCursor(),oMap=oMaps[aAvailableMaps[choixJoueurs[rCode[1]][2]-1]]}else{var oDiv=document.createElement("div");oDiv.style.position="absolute",oDiv.style.left=10*iScreenScale+10+"px",oDiv.style.top=20*iScreenScale+10+"px",oDiv.style.fontSize=2*iScreenScale+"pt",1<choixJoueurs.length?oDiv.innerHTML=toLanguage("Sorry, there are not enough players to begin the race...","D&eacute;sol&eacute;, il n'y a pas assez de joueurs pour commencer la course..."):oDiv.innerHTML=toLanguage("Sorry, all your opponents have left the race...","D&eacute;sol&eacute;, tous vos adversaires ont quitt&eacute; la course..."),oDiv.appendChild(document.createElement("br"));var nSearch=document.createElement("a");nSearch.style.color="white",nSearch.innerHTML=toLanguage("Search for new players","Rechercher de nouveaux joueurs"),nSearch.setAttribute("href","#null"),nSearch.onclick=function(){return $mkScreen.removeChild(oTable),$mkScreen.removeChild(oDiv),removeMenuMusic(),removeGameMusics(),formulaire.screenscale.disabled=!1,formulaire.quality.disabled=!1,formulaire.music.disabled=!1,formulaire.sfx.disabled=!1,chatting=!1,searchCourse(),!1},oDiv.appendChild(nSearch),oDiv.appendChild(document.createElement("br"));var nSearch=document.createElement("a");nSearch.style.color="white",nSearch.innerHTML=toLanguage("Back to Mario Kart PC","Retour à Mario Kart PC"),nSearch.setAttribute("href","index.php"),oDiv.appendChild(nSearch),$mkScreen.appendChild(oDiv),choixJoueurs.length<=1&&(chatting=!1),clearInterval(startMusicHandler)}}else iDeco();return!0}return!1}function playerIsSelecter(){for(var e,t=0;t<choixJoueurs.length;t++)if(choixJoueurs[t][0]==shareLink.player){e=choixJoueurs[t];break}return(e=e||choixJoueurs[0])[0]==identifiant}function proceedOnlineRaceSelection(e){var t=e[4],a=aAvailableMaps[choixJoueurs[e[1]][2]-1];t.manualTeams?selectOnlineTeams(a,choixJoueurs,playerIsSelecter()):resetGame(a)}function waitForChoice(){xhr("getMap.php","BB"==course?"battle":"",refreshTab)}xhr("chooseMap.php","joueur="+strPlayer+"&map="+map+("BB"==course?"&battle":"")+(rand?"&rand":""),refreshTab),oTable.appendChild(oTBody),$mkScreen.appendChild(oTable),document.getElementById("waitrace").style.visibility="hidden",updateMenuMusic(1),formulaire.screenscale.disabled=!0,formulaire.quality.disabled=!0,formulaire.music.disabled=!0,formulaire.sfx.disabled=!0,bMusic&&(startMusicHandler=setInterval(function(){oMapImg&&(loadMapMusic(),clearInterval(startMusicHandler))},500))}function selectOnlineTeams(c,e,t){var m=document.createElement("div"),a=m.style;a.width=iWidth*iScreenScale+"px",a.height=iHeight*iScreenScale+"px",a.border="solid 1px black",a.backgroundColor="black";var n=toTitle(toLanguage("Team selection","Sélection des équipes"),.5);n.style.fontSize=Math.round(7*iScreenScale)+"px",m.appendChild(n);var p=document.createElement("div");p.style.display="none",p.style.position="absolute",p.style.zIndex=5e4,p.style.left=iScreenScale+"px",p.style.top=10*iScreenScale+"px",p.style.width=(iWidth-2)*iScreenScale+"px",p.style.textAlign="center";var g=document.createElement("table");g.style.marginLeft="auto",g.style.marginRight="auto",g.style.fontSize=Math.round(2.4*iScreenScale)+"px";var u=document.createElement("div");u.style.zIndex=50002,u.style.display="none",u.style.position="absolute",u.style.right=3*iScreenScale+"px",u.style.bottom=5*iScreenScale+"px";var o=document.createElement("input");o.type="button",o.style.display="block",o.style.marginTop=Math.round(iScreenScale/2)+"px",o.value=toLanguage("No teams","Chacun pour soi"),o.style.fontSize=2*iScreenScale+"px",o.style.width=18*iScreenScale+"px",o.style.textAlign="center",o.onclick=function(){r(toLanguage("No teams?","Jouer sans équipes ?"),toLanguage("Please confirm that you want to play without teams","Confirmez que vous souhaitez jouer en mode <em>chacun pour soi</em>."),function(){clearTimeout(v);var e="noteams";isBattle&&(e+="&battle"),isSingle&&(e+="&single"),h(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return l(t),!0})})},u.appendChild(o);var i=document.createElement("input");function r(e,t,a){var n=document.createElement("div");n.id="online-teams-confirm",n.style.position="absolute",n.style.left=0,n.style.top=0,n.style.width=iWidth*iScreenScale+"px",n.style.height=iHeight*iScreenScale+"px",n.style.backgroundColor="rgba(0,0,0, 0.5)",n.style.zIndex=6e4;var o=document.createElement("div");o.style.position="absolute",o.style.zIndex=6e4,o.style.left=Math.round(iScreenScale*iWidth/2)+"px",o.style.top=Math.round(iScreenScale*iHeight/2)+"px",o.style.width=40*iScreenScale+"px",o.style.transform=o.style.WebkitTransform=o.style.MozTransform="translate(-50%, -50%)",o.style.backgroundColor="gray",o.style.border="solid 1px silver",o.onclick=function(e){e.stopPropagation()};var i=document.createElement("div");i.style.marginTop=iScreenScale+"px",i.style.marginBottom=Math.round(iScreenScale/2)+"px",i.style.fontSize=Math.round(2.5*iScreenScale)+"px",i.style.textAlign="center",i.style.marginLeft=2*iScreenScale+"px",i.style.marginRight=2*iScreenScale+"px",i.style.color="#FE9",i.innerHTML=e,o.appendChild(i);var r=document.createElement("div");r.style.marginBottom=iScreenScale+"px",r.style.textAlign="center",r.style.marginLeft=Math.round(1.5*iScreenScale)+"px",r.style.marginRight=Math.round(1.5*iScreenScale)+"px",r.style.fontSize=Math.round(1.8*iScreenScale)+"px",r.style.color="white",r.innerHTML=t,o.appendChild(r);var l=document.createElement("div");l.style.textAlign="center",l.style.marginBottom=iScreenScale+"px";var s=document.createElement("input");s.type="button",s.style.marginRight=Math.round(iScreenScale/2)+"px",s.value="Ok",s.style.fontSize=Math.round(2*iScreenScale)+"px",s.onclick=function(){return m.removeChild(n),a(),!1},l.appendChild(s);var c=document.createElement("input");return c.type="button",c.value=toLanguage("Cancel","Annuler"),c.style.marginLeft=Math.round(iScreenScale/2)+"px",c.style.fontSize=Math.round(2*iScreenScale)+"px",c.onclick=n.onclick=function(){return m.removeChild(n),!1},l.appendChild(c),o.appendChild(l),n.appendChild(o),m.appendChild(n),setTimeout(function(){s.focus()},1),n}function y(e){g.innerHTML="";for(var t=Math.max(f[0].length,f[1].length),a=0;a<t;a++){for(var n=document.createElement("tr"),o=0;o<2;o++){var i,r,l=document.createElement("td"),s=f[o][a];s?(selectedTeams?(l.style.backgroundColor=o?"#fba":"#abf",l.style.color=o?"red":"blue"):(l.style.backgroundColor="#ccc",l.style.color="#222"),l.style.position="relative",l.style.textAlign="center",l.style.userSelect="none",(i=document.createElement("span")).style.display="block",i.style.top="1px",i.style.position="relative",i.innerHTML=s[5],i.style.whiteSpace="nowrap",i.style.textOverflow="ellipsis",i.style.overflow="hidden",i.style.width=16*iScreenScale+"px",l.appendChild(i),e&&((r=document.createElement("span")).innerHTML=o?"◀":"▶",r.style.position="absolute",o?(r.style.left="0px",l.style.paddingLeft=3*iScreenScale+"px",l.style.paddingRight=iScreenScale+"px"):(r.style.right="0px",l.style.paddingRight=3*iScreenScale+"px",l.style.paddingLeft=iScreenScale+"px"),r.style.top="48%",r.style.color="#F80",r.style.padding=Math.round(iScreenScale/2)+"px",r.style.transform=r.style.WebkitTransform=r.style.MozTransform="translateY(-50%)",r.style.cursor="pointer",r.style.opacity=.9,r.onmouseover=function(){this.style.opacity=.45},r.onmouseout=function(){this.style.opacity=.9},r.dataset||(r.dataset={}),r.dataset.i=a,r.dataset.j=o,r.onclick=d,l.appendChild(r))):(l.innerHTML="&nbsp;",l.style.width=20*iScreenScale+"px"),n.appendChild(l)}g.appendChild(n)}f[0].length&&f[1].length?(M.style.opacity=1,M.disabled=!1,M.style.cursor=""):(M.style.opacity=.4,M.disabled=!0,M.style.cursor="not-allowed")}function d(){var p=document.createElement("div");p.style.position="absolute",p.style.left="0px",p.style.top="0px",p.style.width=iScreenScale*iWidth+"px",p.style.height=iScreenScale*iWidth+"px",p.style.zIndex=5e4,m.appendChild(p);var u=+this.dataset.i,d=+this.dataset.j,e=f[d][u];f[d].splice(u,1),f[1-d].splice(Math.min(u,f[1-d].length),0,e);var h=this.parentNode;h.style.backgroundColor="#ccc",function e(t,a,n){var o=t;if(a<(t+=n))m.removeChild(p),y(!0);else{h.style.left=Math.round(20*iScreenScale*t/a*(d?-1:1))+"px";var i=a/2;o<i&&i<=t&&(h.style.backgroundColor=d?"#abf":"#fba",h.style.color=d?"blue":"red");for(var r=g.getElementsByTagName("tr"),l=0;l<2;l++)for(var s=l==d,c=s?u+1:u;c<r.length;c++)r[c].getElementsByTagName("td")[l].style.top=Math.round(3*iScreenScale*t/a*(s?-1:1))+"px";b=setTimeout(function(){e(t,a,n)},n)}}(0,150,20)}function l(e){tnCourse=(new Date).getTime()+e.time;for(var t=e.teams,a={},n=0;n<2;n++)for(var o=0;o<f[n].length;o++)a[f[n][o][0]]=f[n][o];for(n=0;n<t.length;n++)a[t[n].id][6]=t[n].team;for(n=0;n<strPlayer.length;n++)aTeams[n]=a[identifiant][6];for(n=0;n<aPlayers.length;n++){var i=aIDs[n],r=n+strPlayer.length;aTeams[r]=a[i][6]}if(selectedTeams=-1==aTeams.indexOf(-1),f[0].length=0,f[1].length=0,selectedTeams)for(n=0;n<t.length;n++)f[t[n].team].push(a[t[n].id]);else for(n=0;n<t.length;n++)f[n%2].push(a[t[n].id]);y(!1),p.removeChild(M),m.removeChild(u);var l=document.createElement("div");l.style.textAlign="center",l.style.fontSize=3*iScreenScale+"px",l.style.marginTop=iScreenScale+"px",l.style.color="#DFC",l.innerHTML=selectedTeams?toLanguage("Teams have been selected !","Les équipes ont été sélectionnées !"):toLanguage("Mode &quot;no teams&quot; selected. In this game, you're playing for yourself!","Mode &quot;Chacun pour soi&quot; sélectionné. Cette partie se déroulera sans équipes"),p.appendChild(l),p.style.display="block";var s=tnCourse-(new Date).getTime();setTimeout(function(){m.innerHTML="",oContainers[0].removeChild(m),resetGame(c)},Math.min(2e3,s-1e3))}function s(){oContainers[0].removeChild(m),m.innerHTML="";var e=document.createElement("div");e.style.position="absolute",e.style.left=10*iScreenScale+10+"px",e.style.top=15*iScreenScale+10+"px",e.style.fontSize=2*iScreenScale+"pt",e.innerHTML=toLanguage("The game has been cancelled by the teams selector.","Partie annulée par le sélectionneur des équipes."),e.appendChild(document.createElement("br"));var t=document.createElement("a");t.style.color="white",t.innerHTML=toLanguage("Search for new players","Rechercher de nouveaux joueurs"),t.setAttribute("href","#null"),t.onclick=function(){return $mkScreen.removeChild(e),removeMenuMusic(),removeGameMusics(),formulaire.screenscale.disabled=!1,formulaire.quality.disabled=!1,formulaire.music.disabled=!1,formulaire.sfx.disabled=!1,chatting=!1,searchCourse(),!1},e.appendChild(t),e.appendChild(document.createElement("br")),(t=document.createElement("a")).style.color="white",t.innerHTML=toLanguage("Back to Mario Kart PC","Retour à Mario Kart PC"),t.setAttribute("href","index.php"),e.appendChild(t),$mkScreen.appendChild(e),clearInterval(startMusicHandler)}function h(){p.style.display="none",u.style.display="none";var e=document.getElementById("online-teams-confirm");e&&m.removeChild(e),document.getElementById("waitteam").style.visibility="hidden"}i.type="button",i.style.display="block",i.style.marginTop=Math.round(iScreenScale/2)+"px",i.value=toLanguage("Cancel game","Annuler la partie"),i.style.fontSize=2*iScreenScale+"px",i.style.width=18*iScreenScale+"px",i.style.color="#F60",i.style.textAlign="center",i.onclick=function(){r(toLanguage("Cancel game?","Annuler la partie ?"),toLanguage("Caution, you're about to cancel the game <strong style=\"color:#FEB\">for all players</strong>. Use this option if you're waiting for more players for example.",'Attention, vous êtes sur le point d\'annuler la partie <strong style="color:#FEB">pour tous les joueurs</strong>. Utilisez cette option si vous attendez plus de joueurs par exemple.'),function(){clearTimeout(v);var e="cancel";isBattle&&(e+="&battle"),h(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;try{JSON.parse(e)}catch(e){return!1}return s(),!0})})},u.appendChild(i),m.appendChild(u);for(var f=[[],[]],S=0;S<e.length;S++)f[e[S][6]].push(e[S]);var v,b,M=document.createElement("input");M.type="button",M.style.fontSize=3*iScreenScale+"px",M.style.marginTop=iScreenScale+"px",M.value=toLanguage("Validate","Valider"),M.onclick=function(){clearTimeout(v);for(var e="",t=0,a=0;a<2;a++)for(var n=0;n<f[a].length;n++)t&&(e+="&"),e+="j"+f[a][n][0]+"="+a,t++;isBattle&&(e+="&battle"),isSingle&&(e+="&single"),h(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return l(t),!0})},p.appendChild(g),p.appendChild(M),m.appendChild(p);var C=(new Date).getTime(),x=tnCourse-C-2e3;if(t)document.getElementById("teamcountdown").innerHTML=Math.round(x/1e3),setSRest("team"),document.getElementById("waitteam").style.visibility="visible",dRest("team"),v=setTimeout(function(){clearTimeout(b);var e="";isBattle&&(e="battle"),h(),xhr("chooseTeams.php",e,function(e){if(!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}return l(t),!0})},1e3*document.getElementById("teamcountdown").innerHTML),y(!0),p.style.display="block",u.style.display="block";else{m.style.visibility="hidden";var P=document.createElement("div");P.style.position="absolute",P.style.left=6*iScreenScale+"px",P.style.top=12*iScreenScale+"px",P.style.fontSize=Math.round(2.5*iScreenScale)+"px",P.style.color="#DFC",P.innerHTML=language?"Teams are being selected... Please don't exit game":"Les équipes sont cours de sélection... Ne pas quitter la partie.",m.appendChild(P);var k=41,w=document.createElement("div");w.style.position="absolute",w.style.left="0px",w.style.top=19*iScreenScale+"px",w.style.width=iScreenScale*k*2+"px",w.style.height=Math.round(8.5*iScreenScale)+"px",w.style.overflow="hidden";for(S=0;S<k;S++){var T=document.createElement("img");T.src="images/cLoading.png",T.className="pixelated",T.style.width=2*iScreenScale+"px",T.style.position="absolute",T.style.left=S*iScreenScale*2+"px",T.style.top="0px",T.style.opacity=.5,w.appendChild(T)}m.appendChild(w);var I=0;!function a(){xhr("getTeams.php","",function(e){if(m.style.visibility="",!e)return!1;var t;try{t=JSON.parse(e)}catch(e){return!1}switch(t.state){case"selecting_teams":!function(){for(var e=w.getElementsByTagName("img"),t=(new Date).getTime(),a=Math.round(k*Math.min((t-C)/x,1));I<a;)e[I].style.opacity=1,I++}(),setTimeout(a,1e3);break;case"teams_selected":m.removeChild(P),m.removeChild(w),l(t);break;default:m.removeChild(P),m.removeChild(w),s()}return!0})}()}oContainers[0].appendChild(m)}function iDeco(){var e=document.createElement("div");e.style.position="absolute",e.style.left=15*iScreenScale+"px",e.style.top=8*iScreenScale+"px",e.style.width=50*iScreenScale+"px",e.style.height=15*iScreenScale+"px",e.style.fontSize=3*iScreenScale+"px",e.style.backgroundColor="gray",e.style.color="white",e.style.border="solid 1px silver",e.style.fontWeight="bold",e.style.textAlign="center",e.style.paddingTop=5*iScreenScale+"px",e.style.zIndex=2e4,e.innerHTML=toLanguage("You have been disconnected","Vous avez &eacute;t&eacute; d&eacute;connect&eacute;");for(var t=0;t<2;t++)e.appendChild(document.createElement("br"));var a=document.createElement("input");a.type="button",a.value=toLanguage("Back","Retour"),a.style.fontSize=3*iScreenScale+"px",a.onclick=function(){location.reload()},e.appendChild(a),$mkScreen.appendChild(e),chatting=!1,window.onbeforeunload=void 0}function dRest(e){var t;e=e||"race",isOnline&&(t=document.getElementById(e+"countdown").innerHTML-1,(document.getElementById(e+"countdown").innerHTML=t)&&"visible"==document.getElementById("wait"+e).style.visibility&&setTimeout(function(){dRest(e)},1e3))}function setSRest(e){e=e||"race",isOnline&&(document.getElementById("wait"+e).style.left=2*iScreenScale+10+"px",document.getElementById("wait"+e).style.top=35*iScreenScale+10+"px",document.getElementById("wait"+e).style.minWidth=iScreenScale*(iWidth-4)+"px",document.getElementById("wait"+e).style.fontSize=3*iScreenScale+"px")}function connexion(){var a,n=document.createElement("div"),e=n.style;e.width=iWidth*iScreenScale+"px",e.height=iHeight*iScreenScale+"px",e.border="solid 1px black",e.backgroundColor="black",n.appendChild(toTitle(toLanguage("Connection","Connexion"),-.5));var t=document.createElement("form");t.style.position="absolute",t.style.left=16*iScreenScale+"px",t.style.top=10*iScreenScale+"px",t.onsubmit=function(){return f.style.visibility="hidden",a.disabled=!0,xhr("testcode.php","pseudo="+s.value+"&code="+h.value,function(e){if(!e||isNaN(e))return!1;var t=+e;return t?(mId=identifiant=t,mPseudo=s.value,mCode=h.value,n.innerHTML="",oContainers[0].removeChild(n),selectPlayerScreen(0)):(f.style.visibility="visible",a.disabled=!1),!0}),!1};var o=document.createElement("table");o.border=2,o.setAttribute("cellpadding",1),o.setAttribute("cellspacing",2);var i=document.createElement("tr"),r=document.createElement("td");r.style.textAlign="right";var l=document.createElement("label");l.style.fontSize=3*iScreenScale+"px",l.setAttribute("for","iPseudo"),l.innerHTML=toLanguage(" &nbsp; &nbsp; Nick :","Pseudo :"),r.appendChild(l);var s,c=document.createElement("td");(s=document.createElement("input")).type="text",s.name="iPseudo",s.id="iPseudo",s.value=mPseudo,s.style.fontSize=3*iScreenScale+"px",s.style.backgroundColor="#FE7",c.appendChild(s),i.appendChild(r),i.appendChild(c);var p=document.createElement("tr"),u=document.createElement("td");u.style.textAlign="right";var d=document.createElement("label");d.style.fontSize=3*iScreenScale+"px",d.setAttribute("for","iCode"),d.innerHTML="Code :",u.appendChild(d);var h,m=document.createElement("td");(h=document.createElement("input")).type="password",h.name="iCode",h.id="iCode",h.value=mCode,h.style.fontSize=3*iScreenScale+"px",h.style.backgroundColor="#FE7",m.appendChild(h),p.appendChild(u),p.appendChild(m);var g=document.createElement("tr"),y=document.createElement("td");y.setAttribute("colspan",2),y.style.textAlign="center",(a=document.createElement("input")).type="submit",a.style.fontSize=4*iScreenScale+"px",a.value=toLanguage("Submit","Valider"),y.appendChild(a),g.appendChild(y),o.appendChild(i),o.appendChild(p),o.appendChild(g),t.appendChild(o),n.appendChild(t);var f=document.createElement("div");f.style.color="red",f.style.fontSize=2*iScreenScale+"pt",f.style.position="absolute",f.style.left=21*iScreenScale+"px",f.style.top=31*iScreenScale+"px",f.innerHTML=toLanguage("Incorrect nick or password","Pseudo ou mot de passe incorrect"),f.style.visibility="hidden",n.appendChild(f);var S=document.createElement("a");S.style.color="white",S.style.fontSize=2*iScreenScale+"pt",S.style.position="absolute",S.style.left=20*iScreenScale+"px",S.style.top=35*iScreenScale+"px",S.innerHTML=toLanguage("Register","Inscription"),S.setAttribute("href","inscription.php"+("BB"==course?"?battle":"")),n.appendChild(S);var v=document.createElement("a");v.style.color="white",v.style.fontSize=2*iScreenScale+"pt",v.style.position="absolute",v.style.left=45*iScreenScale+"px",v.style.top=35*iScreenScale+"px",v.innerHTML=toLanguage("Ranking","Classement"),v.setAttribute("href","bestscores.php"+("BB"==course?"?battle":"")),n.appendChild(v);var b=document.createElement("input");b.type="button",b.value=toLanguage("Back","Retour"),b.style.fontSize=2*iScreenScale+"px",b.style.position="absolute",b.style.left=2*iScreenScale+"px",b.style.top=35*iScreenScale+"px",b.onclick=quitter,n.appendChild(b),oContainers[0].appendChild(n),updateMenuMusic(0)}function selectFantomeScreen(ghostsData,map,otherGhostsData){var oScr=document.createElement("div"),oStyle=oScr.style;oStyle.width=iWidth*iScreenScale+"px",oStyle.height=iHeight*iScreenScale+"px",oStyle.border="solid 1px black",oStyle.backgroundColor="black",oScr.appendChild(toTitle(lCircuits[map],.4));var oTable=document.createElement("table");oTable.setAttribute("border","4px"),oTable.style.borderStyle="double",oTable.style.borderColor="gray",oTable.style.height=8*iScreenScale+"px",oTable.style.position="absolute",oTable.style.left=22*iScreenScale+"px",oTable.style.top=10*iScreenScale+"px",oTable.style.width=35*iScreenScale+"px";var oGhost=document.createElement("tr"),oPersoImage=document.createElement("td");oPersoImage.style.width=5*iScreenScale+"px",oPersoImage.style.paddingRight="6px";var cDiv=document.createElement("div");cDiv.style.textAlign="center";var oDiv=document.createElement("div");oDiv.style.position="relative",oDiv.style.width=5*iScreenScale+"px",oDiv.style.height=5*iScreenScale+"px",oDiv.style.marginLeft="auto",oDiv.style.marginRight="auto",oDiv.style.overflow="hidden";var oPImg=new Image;oPImg.style.height=5*iScreenScale+"px",oPImg.style.position="absolute",oPImg.className="pixelated",ghostsData&&(oPImg.alt=ghostsData[0]),oPImg.nb=i,oPImg.style.left=-30*iScreenScale+"px",oPImg.style.top="0px",oDiv.appendChild(oPImg),cDiv.appendChild(oDiv);var oSpan=document.createElement("span");oSpan.style.display="inline-block",oSpan.style.color="white",oSpan.style.maxWidth=15*iScreenScale+"px",oSpan.style.fontSize=2*iScreenScale+"px",oSpan.style.overflow="hidden",oSpan.style.textOverflow="ellipsis",oSpan.style.whiteSpace="nowrap",cDiv.appendChild(oSpan),oPersoImage.appendChild(cDiv),oGhost.appendChild(oPersoImage);var oTimeTd=document.createElement("td");oTimeTd.style.textAlign="center";var oPersoTime=document.createElement("span");oPersoTime.style.fontSize=Math.round(5.5*iScreenScale)+"px",oPersoTime.style.color="white",oPersoTime.style.marginLeft=2*iScreenScale+"px",oTimeTd.appendChild(oPersoTime);var oPersoLapTimes=document.createElement("img"),$fancyTitle,gTimes;function writeTime(e,t,a,n,o,i){if(i=i||oPersoTime,(o=o||oPImg).src=getSpriteSrc(e),i.innerHTML=timeStr(a),oSpan.innerText=t,oSpan.title=t,oTable.style.left=Math.round((iScreenScale*iWidth+20-oTable.offsetWidth)/2)+"px",oTable.style.top=Math.round((28*iScreenScale-oTable.offsetHeight)/2)+"px",i==oPersoTime){for(var r='<small style="color:#CCF">'+toLanguage("Lap times:","Temps au tour :")+"</small>",l=0;l<n.length;l++)r+='<br /><span style="color:#CCF;display:inline-block">'+(l+1)+".</span> "+timeStr(n[l]);oPersoLapTimes.dataset.title=r}}function multiGhosts(n){oScr.innerHTML="";var e=gID-3,t=gID+4;e<0?t-=e:t>n.length&&(e-=t-n.length),e=Math.max(e,0),t=Math.min(t,n.length),(gIDs=new Array).length=t-e;for(var a=0,o=e;o<t;o++){gIDs[a]=o;var i=document.createElement("div");i.style.position="absolute",i.style.left=o==t-1?20*iScreenScale+"px":a%2*iScreenScale*40+"px",i.style.top=(1+8*Math.floor(a/2))*iScreenScale+"px",i.style.width=40*iScreenScale+"px";var r=document.createElement("table");r.setAttribute("border","2px"),r.style.marginLeft="auto",r.style.marginRight="auto",r.style.borderStyle="double",r.style.borderColor="gray",r.style.width=24*iScreenScale+"px",r.style.height=4*iScreenScale+"px";var l=document.createElement("tr"),s=document.createElement("td");s.style.width=3*iScreenScale+"px",s.style.paddingRight="5px";var c=document.createElement("div");c.style.position="relative",c.style.width=3*iScreenScale+"px",c.style.height=3*iScreenScale+"px",c.style.overflow="hidden";var p=new Image;p.style.height=3*iScreenScale+"px",p.style.position="absolute",p.className="pixelated",ghostsData&&(p.alt=ghostsData[0]),p.nb=o,p.style.left=-18*iScreenScale+"px",p.style.top="0px",c.appendChild(p),s.appendChild(c),l.appendChild(s);var u=document.createElement("td");u.style.textAlign="center",u.style.fontSize=Math.round(3.5*iScreenScale)+"px",u.style.color="white",writeTime(n[gIDs[a]][1],n[gIDs[a]][2],n[gIDs[a]][3],n[gIDs[a]][4],p,u);var d=document.createElement("input");d.type="button",d.value="←",d.style.fontSize=4*iScreenScale+"px",d.style.position="absolute",d.style.left=iScreenScale+"px",d.style.top=Math.round(.5*iScreenScale)+"px",function(e,t,a){d.onclick=function(){gIDs[e]--,gIDs[e]<0&&(gIDs[e]=n.length-1),writeTime(n[gIDs[e]][1],n[gIDs[e]][2],n[gIDs[e]][3],n[gIDs[e]][4],t,a)}}(a,p,u),i.appendChild(d);var h=document.createElement("input");h.type="button",h.value="→",h.style.fontSize=4*iScreenScale+"px",h.style.position="absolute",h.style.left=32.5*iScreenScale+"px",h.style.top=Math.round(.5*iScreenScale)+"px",function(e,t,a){h.onclick=function(){gIDs[e]++,gIDs[e]>=n.length&&(gIDs[e]=0),writeTime(n[gIDs[e]][1],n[gIDs[e]][2],n[gIDs[e]][3],n[gIDs[e]][4],t,a)}}(a,p,u),i.appendChild(h),l.appendChild(u),r.appendChild(l),i.appendChild(r),oScr.appendChild(i),a++}var m=document.createElement("input");m.type="button",m.value=toLanguage("Back","Retour"),m.style.fontSize=2*iScreenScale+"px",m.style.position="absolute",m.style.left=2*iScreenScale+"px",m.style.top=36*iScreenScale+"px",m.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),selectFantomeScreen(ghostsData,map,{times:n,id:gID})},oScr.appendChild(m),(m=document.createElement("input")).type="button",m.value=toLanguage("Let's go","Commencer"),m.style.fontSize=3*iScreenScale+"px",m.style.position="absolute",m.style.left=52*iScreenScale-10+"px",m.style.top=34*iScreenScale+"px",m.onclick=function(){seeGhost(!1)},oScr.appendChild(m)}function showGhosts(){if(gTimes.length){for(i=0;i<gTimes.length-1;i++){var e=i;for(j=i+1;j<gTimes.length;j++)gTimes[j][3]<gTimes[e][3]&&(e=j);var t=gTimes[e];gTimes[e]=gTimes[i],gTimes[i]=t}if(-1==gID)if(ghostsData)for(gID=gTimes.length-1;gID&&gTimes[gID][3]>=ghostsData[2];)gID--;else gID=0;var a=document.createElement("input");a.id="fGauche",a.type="button",a.value="←",a.style.fontSize=6*iScreenScale+"px",a.style.position="absolute",a.style.left=10*iScreenScale+"px",a.style.top=Math.round(10.5*iScreenScale)+"px",a.onclick=function(){--gID<0&&(gID=gTimes.length-1),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(a);var n,o=document.createElement("input");o.id="fDroite",o.type="button",o.value="→",o.style.fontSize=6*iScreenScale+"px",o.style.position="absolute",o.style.left=65*iScreenScale+"px",o.style.top=Math.round(10.5*iScreenScale)+"px",o.onclick=function(){++gID>=gTimes.length&&(gID=0),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4])},oScr.appendChild(o),ghostsData?oScr.style.visibility="visible":oContainers[0].appendChild(oScr),writeTime(gTimes[gID][1],gTimes[gID][2],gTimes[gID][3],gTimes[gID][4]),OPFace&&(OPFace.style.display="none"),document.body.style.cursor="default",(OPFace7=document.createElement("input")).type="button",OPFace7.value=toLanguage("7 ghosts...","7 fantômes..."),OPFace7.style.fontSize=2*iScreenScale+"px",OPFace7.style.position="absolute",OPFace7.style.right=2*iScreenScale+"px",OPFace7.style.top=36*iScreenScale+"px",OPFace7.onmouseover=function(){n||((n=document.createElement("div")).style.position="absolute",n.style.textAlign="center",n.style.fontSize=2*iScreenScale+"px",n.style.width=30*iScreenScale+"px",n.style.right=2*iScreenScale+"px",n.style.bottom=4*iScreenScale+"px",n.style.backgroundColor="rgba(204,192,178,0.95)",n.style.padding=Math.round(iScreenScale/2)+" "+iScreenScale+"px",n.style.color="#363330",n.innerHTML=toLanguage("Play with 7 ghosts with the same level as the ghost above","Affronter 7 fantômes du même niveau que le fantôme ci-dessus"),n.style.borderBottomLeftRadius=iScreenScale+"px",n.style.borderTopRightRadius=iScreenScale+"px",oScr.appendChild(n))},OPFace7.onmouseout=function(){n&&(oScr.removeChild(n),n=null)},OPFace7.onclick=function(){n&&(oScr.removeChild(n),n=null),multiGhosts(gTimes)},oScr.appendChild(OPFace7)}else if(ghostsData){try{alert(language?"No other record for this circuit yet":"Aucun autre record pour ce circuit")}catch(e){}oScr.style.visibility="visible",gID=-1,document.body.style.cursor="default"}else{oScr.innerHTML="";try{oContainers[0].removeChild(oScr)}catch(e){}document.body.style.cursor="default",gPersos.length=0,resetGame(aAvailableMaps[map])}}function otherGhosts(){document.body.style.cursor="progress",ghostsData&&(oScr.style.visibility="hidden"),xhr("otherghosts.php","map="+(map+1),function(reponse){if(reponse){try{gTimes=eval(reponse)}catch(e){return!1}return showGhosts(),!0}return!1})}function seeGhost(replay){if(replay&&(pause=!0,fInfos.replay=!0,gSelectedPerso=strPlayer[0]),-1==gID)oScr.innerHTML="",oContainers[0].removeChild(oScr),gOverwriteRecord=1,replay?(strPlayer[0]=ghostsData[0],iRecord=ghostsData[2],iLapTimes=ghostsData[3],iTrajet=ghostsData[4]):(gPersos=[ghostsData[0]],iLapTimes=ghostsData[3],jTrajets=[ghostsData[4]]),resetGame(aAvailableMaps[map]);else{var xhrUrl,xhrData;if(oScr.innerHTML="",oContainers[0].removeChild(oScr),document.body.style.cursor="progress",gIDs){xhrUrl="ghostsrace.php",xhrData="";for(var i=0;i<gIDs.length;i++)i&&(xhrData+="&"),xhrData+="id"+i+"="+gTimes[gIDs[i]][0]}else xhrUrl="ghostrace.php",xhrData="id="+gTimes[gID][0];xhr(xhrUrl,xhrData,function(reponse){if(reponse){var gCourse;try{gCourse=eval(reponse)}catch(e){return!1}if(replay)strPlayer[0]=gTimes[gID][1],iRecord=gTimes[gID][3],iLapTimes=gTimes[gID][4],iTrajet=gCourse;else if(gIDs){gPersos=[];for(var i=0;i<gIDs.length;i++)gPersos.push(gTimes[gIDs[i]][1]);jTrajets=gCourse}else gPersos=[gTimes[gID][1]],iLapTimes=gTimes[gID][4],jTrajets=[gCourse];return resetGame(aAvailableMaps[map]),!0}return!1})}}oPersoLapTimes.src="images/about.png",oPersoLapTimes.style.position="relative",oPersoLapTimes.style.top=-Math.round(.5*iScreenScale)+"px",oPersoLapTimes.style.width=Math.round(2.5*iScreenScale)+"px",oPersoLapTimes.style.marginLeft=iScreenScale+"px",oPersoLapTimes.style.marginRight=2*iScreenScale+"px",oPersoLapTimes.dataset||(oPersoLapTimes.dataset={}),oTimeTd.appendChild(oPersoLapTimes),oPersoLapTimes.onmouseover=function(e){var t;$fancyTitle||(($fancyTitle=document.createElement("div")).className="ranking_activeplayertitle",$fancyTitle.innerHTML=this.dataset.title,$fancyTitle.style.position="absolute",$fancyTitle.style.padding=Math.round(iScreenScale/2)+"px "+iScreenScale+"px",$fancyTitle.style.borderRadius=iScreenScale+"px",$fancyTitle.style.zIndex=10,$fancyTitle.style.backgroundColor="rgba(60,109,165, 0.95)",$fancyTitle.style.color="white",$fancyTitle.style.fontSize=Math.round(1.8*iScreenScale)+"px",$fancyTitle.style.lineHeight=Math.round(2*iScreenScale)+"px",$fancyTitle.style.visibility="hidden",$mkScreen.appendChild($fancyTitle),t=this.getBoundingClientRect(),$fancyTitle.style.left=Math.round(t.left+(this.scrollWidth-$fancyTitle.scrollWidth)/2)+"px",$fancyTitle.style.top=t.top+this.scrollHeight+5+"px",$fancyTitle.style.visibility="visible")},oPersoLapTimes.onmouseout=function(e){$fancyTitle&&($mkScreen.removeChild($fancyTitle),$fancyTitle=void 0)},gRecord=ghostsData?ghostsData[2]:void 0;var gID=-1,gIDs;oGhost.appendChild(oTimeTd),oTable.appendChild(oGhost),oScr.appendChild(oTable);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Face with this ghost","Affronter ce fantôme"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=20*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){seeGhost(!1)},oScr.appendChild(oPInput);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("See race","Voir la course"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=25*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){seeGhost(!0)},oScr.appendChild(oPInput);var oPInput=document.createElement("input");oPInput.type="button",oPInput.value=toLanguage("Play alone","Jouer seul"),oPInput.style.fontSize=3*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=22*iScreenScale-10+"px",oPInput.style.top=30*iScreenScale+"px",oPInput.style.width=37*iScreenScale+31+"px",oPInput.onclick=function(){oScr.innerHTML="",oContainers[0].removeChild(oScr),gPersos.length=0,resetGame(aAvailableMaps[map])},oScr.appendChild(oPInput);var oPInput=document.createElement("input"),OPFace,OPFace7,OPFace;oPInput.type="button",oPInput.value=toLanguage("Back","Retour"),oPInput.style.fontSize=2*iScreenScale+"px",oPInput.style.position="absolute",oPInput.style.left=2*iScreenScale+"px",oPInput.style.top=36*iScreenScale+"px",oPInput.onclick=function(){-1!=gID&&ghostsData?(writeTime(ghostsData[0],ghostsData[1],ghostsData[2],ghostsData[3]),oScr.removeChild(document.getElementById("fGauche")),oScr.removeChild(document.getElementById("fDroite")),oScr.removeChild(OPFace7),OPFace.style.display="",gID=-1):(oScr.innerHTML="",oContainers[0].removeChild(oScr),selectRaceScreen(map-map%4))},oScr.appendChild(oPInput),ghostsData?(OPFace=document.createElement("input"),OPFace.type="button",OPFace.value=toLanguage("Face with another player...","Affronter un autre joueur..."),OPFace.style.fontSize=2*iScreenScale+"px",OPFace.style.position="absolute",OPFace.style.right=2*iScreenScale+"px",OPFace.style.top=36*iScreenScale+"px",OPFace.onclick=otherGhosts,oScr.appendChild(OPFace),oContainers[0].appendChild(oScr),ghostsData&&writeTime(ghostsData[0],ghostsData[1],ghostsData[2],ghostsData[3]),document.body.style.cursor="default",otherGhostsData&&(gID=otherGhostsData.id,gTimes=otherGhostsData.times,showGhosts())):otherGhosts(),updateMenuMusic(1)}function stripSpecialChars(e){return e.replace(/&[#\w]+;/g,"_")}function mapNameOf(e,t){var a=lCircuits[t],n=document.createElement("div"),o=isCup?Math.min(Math.max(9/Math.sqrt(stripSpecialChars(a).length),1.4),4):2.1;return n.style.fontSize=Math.round(e*o)+"px",n.style.width=26*e+"px",n.style.bottom=-Math.round(e/2)+"px",n.className="mapname",n.style.textAlign="center",n.innerHTML=a,n}function addOption(e,t,a,n,o,i){document.getElementById(e).innerHTML=t.replace(/ /g,"&nbsp;"),document.getElementById(a).innerHTML="";var r,l=document.createElement("select");l.name=n;for(var s=0;s<o.length;s++){var c=document.createElement("option"),p=o[s][0];c.value=p,c.innerHTML=o[s][1],p==i&&(r=s),l.appendChild(c)}l.selectedIndex=r,document.getElementById(a).appendChild(l)}function optionOf(e){return formulaire?+formulaire.elements[e].value:baseOptions[e]}function displayCommands(e){var t,a=document.getElementById("commandes");a&&(t=!e,a.innerHTML=(e||"")+'<img src="images/edit-controls.png" alt="Edit" id="commandes-edit"'+(t?' class="nocommand"':"")+' title="'+toLanguage("More settings","Plus de paramètres")+'" />',document.getElementById("commandes-edit").onclick=function(){editCommands()})}function updateCommandSheet(){var n=getCommands(),o=0<=navigator.platform.toUpperCase().indexOf("MAC");function e(e,t){return 1==oContainers.length?e:"J1 : "+e+"; J2 : "+t}function t(e){var t=n[e],a=t[0];return t[1]&&o&&(a=t[1]),getKeyName(a)}displayCommands("<strong>"+toLanguage("Move","Se diriger")+"</strong> : "+e(t("up")+t("left")+t("down")+t("right"),"ESDF")+"<br /><strong>"+toLanguage("Use item","Utiliser un objet")+"</strong> : "+e(t("item"),toLanguage("A","Q"))+"<br /><strong>"+toLanguage("Item backwards","Objet en arrière")+"</strong> : "+e(t("item_back"),toLanguage("W","A"))+"<br /><strong>"+toLanguage("Jump/drift","Sauter/déraper")+"</strong> : "+e(t("jump"),"G")+("BB"==course?"<br /><strong>"+toLanguage("Inflate a balloon","Gonfler un ballon")+"</strong> : "+e(t("balloon"),"R"):"")+"<br /><strong>"+toLanguage("Rear/Front view","Vue arri&egrave;re/avant")+"</strong> : "+e(t("rear"),toLanguage("W","Z"))+"<br /><strong>"+toLanguage("Pause","Mettre en pause")+"</strong> : "+t("pause")+"<br /><strong>"+toLanguage("Quit","Quitter")+"</strong> : "+t("quit"))}function editCommands(e,a){a=a||0;var t=document.getElementById("control-editor-mask");if(!t||(document.body.removeChild(t),e)){(t=document.createElement("div")).id="control-editor-mask",t.onclick=function(){editCommands()};var n=document.createElement("div");n.className="control-editor",n.onclick=function(e){e.stopPropagation()};var o=document.createElement("div");o.className="control-header";var i=document.createElement("div");i.innerHTML=toLanguage("Game settings","Paramètres du jeu"),o.appendChild(i);var r=document.createElement("button");r.className="control-close",r.innerHTML="&times;",r.onclick=function(){editCommands()},o.appendChild(r),n.appendChild(o);var l=document.createElement("div");l.className="control-tabs";for(var s=[toLanguage("Edit controls","Modifier les contrôles"),toLanguage("Advanced settings","Paramètres avancés")],c=0;c<s.length;c++)!function(e){var t=document.createElement("div");e||(t.className="control-tab-active"),t.innerHTML=s[e],t.onclick=function(){document.querySelector(".control-tabs .control-tab-active").classList.remove("control-tab-active"),this.classList.add("control-tab-active"),document.querySelector(".control-window .control-window-active").classList.remove("control-window-active"),document.querySelectorAll(".control-window > div")[e].classList.add("control-window-active"),a=e},l.appendChild(t)}(c);n.appendChild(l);var p=document.createElement("div");p.className="control-window";var u=document.createElement("div");u.className="control-window-active";var d=[{name:toLanguage("Move forward","Avancer"),key:"up"},{name:toLanguage("Move back","Reculer"),key:"down"},{name:toLanguage("Turn left","Tourner à gauche"),key:"left"},{name:toLanguage("Turn right","Tourner à droite"),key:"right"},{name:toLanguage("Use item","Utiliser un objet"),key:"item"},{name:toLanguage("Item backwards","Objet en arrière"),key:"item_back"},{name:toLanguage("Jump/drift","Sauter/déraper"),key:"jump"},{name:toLanguage("Inflate balloon","Gonfler un ballon"),key:"balloon"},{name:toLanguage("Rear view","Vue arrière"),key:"rear"},{name:toLanguage("Pause","Pause"),key:"pause"},{name:toLanguage("Quit","Quitter"),key:"quit"}],h=getCommands(),m=JSON.parse(localStorage.getItem("controls")||"{}"),g=0<=navigator.platform.toUpperCase().indexOf("MAC"),y=document.createElement("div");y.className="control-editor-grid";for(c=0;c<d.length;c++)!function(t){var e=h[t.key],a=e[0];e[1]&&g&&(a=e[1]);var n=document.createElement("div"),o=document.createElement("div");o.className="control-label",o.innerHTML=t.name,n.appendChild(o);var i=document.createElement("button");i.className="control-input",i.innerHTML=getKeyName(a),i.onfocus=function(){this.innerHTML="..."},i.onblur=function(){this.innerHTML=getKeyName(a)},i.onclick=function(){this.focus()},i.onkeydown=function(e){e.preventDefault(),e.stopPropagation(),a=e.keyCode,m[t.key]=a,localStorage.setItem("controls",JSON.stringify(m)),gameControls=gameControls&&getGameControls(),this.blur()},n.appendChild(i),y.appendChild(n)}(d[c]);u.appendChild(y);var f=document.createElement("div");f.className="control-reset";var S=document.createElement("a");S.href="#null",S.innerHTML=toLanguage("Reset controls","Rétablir les contrôles par défaut"),S.onclick=function(){return confirm(toLanguage("Reset to default controls?","Confirmer la réinitialisation des contrôles ?"))&&(localStorage.removeItem("controls"),gameControls=gameControls&&getGameControls(),editCommands(!0,a)),!1},f.appendChild(S),u.appendChild(f),p.appendChild(u);var v=document.createElement("div");v.className="control-settings";var b=document.createElement("div");b.className="control-settings-info",b.innerHTML=toLanguage("Those settings allow you to disable some graphics elements from the game. Use them if you experience some lag for example.","Ces paramètres vous permettent de désactiver certains éléments graphiques du jeu. Utilisez-les si vous avez des problèmes de lags par exemple."),v.appendChild(b);var M={ld:toLanguage("Don't display heavy elements (trees, decors)","Désactiver l'affichage des éléments lourds (arbres, décors)"),nogif:toLanguage("Disable animation in gif-format tracks","Désactiver les animations des circuits au format gif"),nomap:toLanguage("Disable mini-map display","Désactiver l'affichage de la mini-map")},C=(C=localStorage.getItem("settings"))?JSON.parse(C):{};for(var x in M)!function(e){var t=document.createElement("label"),a=document.createElement("input");a.type="checkbox",a.checked=!!C[e],t.appendChild(a);var n=document.createElement("span");n.innerHTML=M[e],t.appendChild(n),a.onclick=function(){this.checked?C[e]=1:delete C[e],localStorage.setItem("settings",JSON.stringify(C))},v.appendChild(t)}(x);(f=document.createElement("div")).className="control-reset",(S=document.createElement("a")).href="#null",S.innerHTML=toLanguage("Reset settings","Rétablir les paramètres par défaut"),S.onclick=function(){return confirm(toLanguage("Reset settings to default?","Réinitiliser les paramètres à ceux par défaut ?"))&&(localStorage.removeItem("settings"),editCommands(!0,a)),!1},f.appendChild(S),v.appendChild(f),p.appendChild(v),n.appendChild(p),t.appendChild(n),document.body.appendChild(t),p.style.width=p.scrollWidth+"px",p.style.height=p.scrollHeight+"px",a&&document.querySelectorAll(".control-tabs > div")[a].click()}else document.querySelector("#commandes strong")&&updateCommandSheet()}function getKeyName(e){return this.keyMatching||(this.keyMatching=["","","","Break","","","","","Backspace","Tab","","","Clear","Enter","","","Shift","Ctrl","Alt","Pause","CapsLock","Hangul","","","","Hanja","",toLanguage("Escape","Échap"),"Conversion","Non-conversion","","",toLanguage("Spacebar","Espace"),"PageUp","PageDown","End","Home","&larr;","&uarr;","&rarr;","&darr;","Select","Print","Execute",toLanguage("Print Screen","ImpEcr"),"Inser",toLanguage("Delete","Suppr"),"Help","0","1","2","3","4","5","6","7","8","9",":","=","&lt;","=","","SS","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Meta","Meta","Meta","","Sleep","0","1","2","3","4","5","6","7","8","9","&times;","+",".","-",".","/","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NumLock","ScrollLock","","","","","","","","","","","","","","","^","!","؛","#","$","Ù","PageDown","PageUp","Refresh",")","*","~","Home","-","Vol. down","Vol. up","Next","Previous","Stop","Play/pause","@","Mute","Vol. down","Vol. up","","","Ñ","=",",","#",".","/","%","°",",","","","","","","","","","","","","","","","","","","","","","","","","","{","\\","}","'","`","Meta","AltGr","&lt;","","","","Compose","Ç","","Forward","Back","Non-conversion","","","","","Alphanumeric","","Hiragana","Half-width","Kanji","","","","","","","Unlock Trackpad","","","","Toggle Touchpad"]),this.keyMatching[e]?this.keyMatching[e]:"#"+e}function getCommands(){var e={up:[38],down:[40],left:[37],right:[39],item:[32],item_back:[67],jump:[17,18],balloon:[16],rear:[88],pause:[80],quit:[27],cheat:[120,33,57,105]};1<strPlayer.length&&(e.up_p2=[69],e.down_p2=[68],e.left_p2=[83],e.right_p2=[70],e.item_p2=[toLanguage(65,81)],e.item_back_p2=[toLanguage(87,65)],e.jump_p2=[71],e.balloon_p2=[82],e.rear_p2=[toLanguage(87,90)]);var t=e,a=localStorage.getItem("controls");if(a)for(var n in a=JSON.parse(a))t[n]=[a[n]];return t}function getGameControls(){var e={},t=getCommands();for(var a in t)for(var n=0;n<t[a].length;n++){var o=t[a][n];e[o]||(e[o]=a)}return e}function findKeyCode(e){for(var t in gameControls)if(gameControls[t]==e)return t;return""}function toLanguage(e,t){return language?e:t}function toPlace(e){var t;if(language)switch(e){case 1:t="st";break;case 2:t="nd";break;case 3:t="rd";break;default:t="th"}else t=1!=e?"e":"er";return e+"<sup>"+t+"</sup>"}function toTitle(e,t){var a=document.createElement("div");return a.style.width=iWidth*iScreenScale+"px",a.style.fontSize=Math.round(8*iScreenScale)+"px",a.style.fontWeight="normal",a.style.position="absolute",a.style.left="0px",a.style.top=Math.round(t*iScreenScale)+"px",a.style.textAlign="center",a.style.color=primaryColor,a.innerHTML=e,a.style.fontFamily="Tahoma",a}function toPerso(e){if(isCustomPerso(e))return customPersos[e].name;if(language){if("maskass"==e)return"shy guy";if("skelerex"==e)return"dry bones";if("harmonie"==e)return"rosalina";if("roi_boo"==e)return"king boo";if("frere_marto"==e)return"hammer bro";if("bowser_skelet"==e)return"dry bowser";if("flora_piranha"==e)return"petey piranha"}else if("frere_marto"==e)return"frère marto";return e=e.replace(/_/g," ")}function isMobile(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)}function isChatting(){return isOnline&&document.activeElement==document.forms[1].elements.rMessage}function applyButtonCode(e,t){for(var a=t.split(","),n=0;n<a.length;n++)document[e]({keyCode:parseInt(a[n])})}function onButtonTouch(e){return e.preventDefault(),this.style.backgroundColor="#603",navigator.vibrate(30),applyButtonCode("onkeydown",this.dataset.key),!1}function onButtonPress(e){this.style.backgroundColor="",applyButtonCode("onkeyup",this.dataset.key)}function setChat(){chatting=!0;var oChat=document.createElement("div");oChat.className="online-chat",oChat.style.position="absolute",oChat.style.zIndex=3,oChat.style.backgroundColor="black",oChat.style.right="10px",oChat.style.top="5%",oChat.style.width="350px",oChat.style.height="90%",oChat.style.border="double 4px silver";var oConnectes=document.createElement("p");oConnectes.style.paddingBottom="2px",oConnectes.style.borderBottom="solid 1px silver";var iConnectes=document.createElement("span");iConnectes.innerHTML=toLanguage("Online opponent(s) : ","Adversaire(s) en ligne : "),oConnectes.appendChild(iConnectes);var jConnectes=document.createElement("span");jConnectes.style.color="white",oConnectes.appendChild(jConnectes);var bConnectes=document.createElement("a"),oBlockDialog;function removeBlockDialog(){return oBlockDialog&&(oChat.removeChild(oBlockDialog),oBlockDialog=null,1)}bConnectes.href="#null",bConnectes.style.textDecoration="none",bConnectes.title=language?"Ignore player":"Ignorer un joueur",bConnectes.style.marginLeft="10px",bConnectes.style.opacity=.7,oConnectes.onmouseover=function(){bConnectes.style.opacity=1},oConnectes.onmouseout=function(){bConnectes.style.opacity=.7},bConnectes.style.position="relative",bConnectes.style.top="2px",bConnectes.onmouseover=function(){biConnectes.src="images/ic_block_h.png"},bConnectes.onmouseout=function(){biConnectes.src="images/ic_block.png"},bConnectes.onclick=function(){if(removeBlockDialog())return!1;oBlockDialog=document.createElement("div"),oBlockDialog.style.position="absolute",oBlockDialog.style.left="85px",oBlockDialog.style.top="8%",oBlockDialog.style.width="200px",oBlockDialog.style.border="double 4px silver",oBlockDialog.style.backgroundColor="#222";var oBlockTitle=document.createElement("h1");oBlockTitle.style.fontSize="1.1em",oBlockTitle.style.marginTop="24px",oBlockTitle.style.marginBottom="2px",oBlockTitle.style.textAlign="center",oBlockTitle.innerHTML=language?"Ignore member":"Ignorer un membre",oBlockTitle.style.color="white",oBlockTitle.style.textDecoration="underline",oBlockDialog.appendChild(oBlockTitle);var oBlockClose=document.createElement("input");oBlockClose.type="button",oBlockClose.onclick=function(){removeBlockDialog()},oBlockClose.style.position="absolute",oBlockClose.style.right="5px",oBlockClose.style.top="5px",oBlockClose.value="×",oBlockDialog.appendChild(oBlockClose);var oBlockMembers=document.createElement("div");return oBlockMembers.style.margin="3px 4px",xhr("listCoursePlayers.php","",function(reponse){if(reponse){try{var rCode=eval(reponse)}catch(e){return!1}function stylishMember(e){e.dataset.blocked?(e.style.color="red",e.style.textDecoration="line-through",e.style.opacity=.8):(e.style.color="#F90",e.style.textDecoration="",e.style.opacity=1)}for(var i=0;i<rCode.length;i++){var memberId=rCode[i][0],memberPseudo=rCode[i][1],memberBlocked=rCode[i][2],oBlockMember=document.createElement("div");oBlockMember.dataset||(oBlockMember.dataset={}),oBlockMember.dataset.id=memberId,oBlockMember.dataset.blocked=memberBlocked?"1":"",oBlockMember.innerHTML=memberPseudo,oBlockMember.style.padding="2px 5px",oBlockMember.style.cursor="pointer",oBlockMember.style.margin="1px",oBlockMember.style.backgroundColor="#666",oBlockMember.style.color=oBlockMember.dataset.blocked?"red":"#F90",oBlockMember.onmouseover=function(){this.style.backgroundColor="#777",this.style.color="#FC0"},oBlockMember.onmouseout=function(){this.style.backgroundColor="#666",this.style.color=this.dataset.blocked?"red":"#F90"},stylishMember(oBlockMember),oBlockMember.onclick=function(){this.dataset.blocked=this.dataset.blocked?"":"1";var t=this;xhr(this.dataset.blocked?"ignore.php":"unignore.php","member="+this.dataset.id,function(e){return 1==e&&(stylishMember(t),!0)})},oBlockMembers.appendChild(oBlockMember)}return!0}return!1}),oBlockDialog.appendChild(oBlockMembers),oChat.appendChild(oBlockDialog),!1};var biConnectes=document.createElement("img");biConnectes.alt="Block",biConnectes.src="images/ic_block.png",biConnectes.style.height="16px",bConnectes.appendChild(biConnectes),oConnectes.appendChild(bConnectes);var oMessages=document.createElement("div");oMessages.style.paddingTop="2px";var oRepondre=document.createElement("form");oRepondre.style.position="absolute",oRepondre.style.bottom="0",oRepondre.style.left="10px";var rP=document.createElement("p");rP.style.textAlign="center";var rMessage=document.createElement("input");rMessage.setAttribute("size",35),rMessage.type="text",rMessage.name="rMessage",rMessage.onkeydown=function(e){38==e.keyCode?this.blur():e.stopPropagation()},rMessage.onkeyup=function(e){e.stopPropagation()},rMessage.style.backgroundColor="#FE7";var rEnvoi=document.createElement("input");function refreshChat(){chatting?xhr("chat.php","",function(reponse){if(reponse){try{var rCode=eval(reponse)}catch(e){return!1}if(-1!=rCode){for(var noms=rCode[0],sNoms="",i=0;i<noms.length;i++)sNoms+=(i?", ":"")+noms[i];jConnectes.innerHTML=sNoms;for(var messages=rCode[1],pMessages=oMessages.getElementsByTagName("p");pMessages.length;)oMessages.removeChild(pMessages[0]);for(var i=0;i<messages.length;i++){var oP=document.createElement("p"),sPseudo=document.createElement("span");sPseudo.innerHTML=messages[i][0]+" : ",oP.appendChild(sPseudo);var sMessage=document.createElement("span");sMessage.style.color="white",sMessage.style.fontWeight="normal",sMessage.innerHTML=messages[i][1],oP.appendChild(sMessage),oMessages.appendChild(oP)}setTimeout(refreshChat,1e3)}else chatting=!1;return!0}return!1}):document.body.removeChild(oChat)}rEnvoi.type="submit",rEnvoi.value=toLanguage("Send","Envoyer"),rP.appendChild(rMessage),rP.appendChild(rEnvoi),oRepondre.onsubmit=function(){return rMessage.value&&(xhr("parler.php","msg="+encodeURIComponent(rMessage.value).replace(/\+/g,"%2B"),function(e){return"1"==e}),rMessage.value=""),!1},oRepondre.appendChild(rP),oChat.appendChild(oConnectes),oChat.appendChild(oMessages),oChat.appendChild(oRepondre),refreshChat(),document.body.appendChild(oChat)}formulaire=document.forms.modes,pause?(formulaire.screenscale.disabled=!1,formulaire.quality.disabled=!1,formulaire.music.disabled=!1,formulaire.sfx.disabled=!1,isSingle&&!isOnline?choose(1):null!=fInfos.map?loadMap(fInfos.map):"VS"==course?selectMapScreen():"BB"==course?isCup?selectRaceScreen(NBCIRCUITS):selectMapScreen():fInfos.player&&selectMapScreen()):(addOption("pQuality",toLanguage("Quality","Qualit&eacute;"),"vQuality","quality",[[5,toLanguage("Pixelated","Pixelisé")],[4,toLanguage("Low","Inf&eacute;rieure")],[2,toLanguage("Medium","Moyenne")],[1,toLanguage("High","Sup&eacute;rieure")]],iRendering),addOption("pSize",toLanguage("Screen Size","Taille de l'&eacute;cran"),"vSize","screenscale",[[4,toLanguage("Very small","Tr&egrave;s petite")],[6,toLanguage("Small","Petite")],[8,toLanguage("Medium","Moyenne")],[10,toLanguage("Large","Large")],[12,toLanguage("Very large","Tr&egrave;s large")],[-1,toLanguage("Full (F11)","Plein (F11)")]],+$mkScreen.dataset.lastsc||iScreenScale),addOption("pMusic",toLanguage("Music","Musique"),"vMusic","music",[[0,toLanguage("Off","D&eacute;sactiv&eacute;e")],[1,toLanguage("On","Activ&eacute;e")]],bMusic),addOption("pSfx",toLanguage("Sound effects","Bruitages"),"vSfx","sfx",[[0,toLanguage("Off","D&eacute;sactiv&eacute;s")],[1,toLanguage("On","Activ&eacute;s")]],iSfx),selectMainPage(),window.turnEvents||(isMobile()&&(navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate||function(){},addButton(' <span style="position:absolute;left:8px;top:-5px">↑</span><span style="position:absolute;right:6px;bottom:8px;font-size:10px;text-align:right">'+(language?"+ Jump<br/>Drift":"+ Saut<br/>Dérapage")+"</span>",[38,17],0,0),addButton(" ↑ ",38,1,0),addButton("Obj",32,2,0,null,null,25),addButton("❚❚",80,3,0,null,null,25),document.getElementById("virtualkeyboard").appendChild(document.createElement("br")),document.getElementById("virtualkeyboard").appendChild(document.createElement("br")),driftButton=addButton(language?"Jump<br/>Drift":"Saut<br/>Dérapage",17,0,1,null,null,11),addButton(" ↓ ",40,1,1),addButton(" ← ",37,2,1),addButton(" → ",39,3,1),reposKeyboard(),document.getElementById("virtualkeyboard").ontouchstart=function(e){return e.preventDefault(),!1},document.getElementById("virtualkeyboard").style.display="block",$commandes=document.getElementById("commandes"),$commandes&&($commandes.style.display="none")),window.turnEvents=!0),formulaire.quality.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setQuality(e)},formulaire.screenscale.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setScreenScale(e)},formulaire.music.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setMusic(e)},formulaire.sfx.onchange=function(){var e=parseInt(this.item(this.selectedIndex).value);MarioKartControl.setSfx(e)},window.fsevent||(window.fsevent=function(e){if(122==e.keyCode){e.preventDefault();var t=iScreenScale;return iScreenScale=+formulaire.screenscale.value,formulaire.screenscale.value=-1,formulaire.screenscale.onchange(),formulaire.screenscale.disabled&&(iScreenScale=t),!1}},window.addEventListener("keydown",window.fsevent)),"undefined"==typeof course&&(course=""),$commandes=document.getElementById("commandes"),$commandes&&$commandes.innerHTML.length<10&&displayCommands(),isFirstLoad&&(isFirstLoad=!1,hasChallenges()&&xhr("getClSelected.php",null,function(e){if(e)for(var t in challenges)for(var a in challenges[t])for(var n=challenges[t][a].list,o=0;o<n.length;o++){var i=n[o];if(i.id==e)return clSelected||i.succeeded||((clSelected=i).trackType=t,clSelected.trackId=a,showClSelectedPopup()),!0}return!0}))),window.MarioKartControl={setQuality:function(e){setQuality(e)},setScreenScale:function(e){setScreenScale(e)},setMusic:function(e){setMusic(e)},setSfx:function(e){setSfx(e)}}}void 0===selectedTeams&&(selectedTeams=0),void 0===challenges&&(challenges={mcup:[],cup:[],track:[]},clRewards=[]),void 0===cupNames&&(cupNames=[]);var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);